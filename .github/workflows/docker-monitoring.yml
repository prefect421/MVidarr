name: Docker Build and Size Monitoring

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

jobs:
  build-and-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build context analysis
      run: |
        echo "üîç Analyzing Docker build context..."
        ./scripts/build-context-analyzer.sh || echo "‚ö†Ô∏è Build context needs optimization"
    
    - name: Build Docker image
      run: |
        echo "üèóÔ∏è Building Docker image..."
        docker build -f Dockerfile.production -t mvidarr:test .
        
    - name: Measure build time
      run: |
        echo "‚è±Ô∏è Measuring build performance..."
        START_TIME=$(date +%s)
        docker build --no-cache -f Dockerfile.production -t mvidarr:timed-build . 
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        echo "Build completed in ${BUILD_TIME} seconds"
        
        # Alert if build takes too long
        if [ $BUILD_TIME -gt 600 ]; then
          echo "üö® WARNING: Build time exceeded 10 minutes ($BUILD_TIME seconds)"
          exit 1
        fi
        
    - name: Docker image size monitoring
      run: |
        echo "üìä Monitoring Docker image size..."
        # Install bc for calculations
        sudo apt-get update && sudo apt-get install -y bc
        # Use locally built image for monitoring
        ./scripts/docker-size-monitor.sh mvidarr test --local
        
    - name: Validate image functionality
      run: |
        echo "‚úÖ Testing basic functionality..."
        docker run --rm --entrypoint="" mvidarr:test python -c "
        try:
            import flask, sqlalchemy, cv2
            print('‚úÖ All core imports successful')
        except ImportError as e:
            print(f'‚ùå Import failed: {e}')
            exit(1)
        "
        
    - name: Report results
      if: always()
      run: |
        echo "üìã Build Monitoring Summary"
        echo "=========================="
        echo "‚úÖ Build context analyzed"
        echo "‚úÖ Docker image built successfully"  
        echo "‚úÖ Build time measured and validated"
        echo "‚úÖ Image size monitored and validated"
        echo "‚úÖ Basic functionality tested"
        echo ""
        echo "üéØ Build reliability maintained!"