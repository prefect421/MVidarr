<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MVidarr{% endblock %}</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="96x96" href="{{ url_for('static', filename='favicon-96x96.png') }}">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    
    <!-- Android Chrome Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='android-chrome-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='android-chrome-512x512.png') }}">
    
    <!-- Microsoft Tile -->
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='mstile-150x150.png') }}">
    <meta name="msapplication-TileColor" content="#1e3a8a">
    <meta name="msapplication-config" content="{{ url_for('static', filename='browserconfig.xml') }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MVidarr">
    
    <!-- Cache busting headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='main.css') }}" id="main-theme">
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='themes.css') }}" id="themes-stylesheet">
    
    <!-- UI/UX Enhancement System -->
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='typography.css') }}">
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='accessibility.css') }}">
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='loading-feedback.css') }}">
    <link rel="stylesheet" href="{{ url_for('frontend.css_files', filename='ux-enhancements.css') }}">
    
    <script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>
    <!-- Test if Iconify works at all -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Testing Iconify...');
            // Create a test element to verify Iconify is working
            const testEl = document.createElement('iconify-icon');
            testEl.setAttribute('icon', 'mdi:home');
            testEl.style.display = 'none';
            document.body.appendChild(testEl);
            
            setTimeout(() => {
                if (testEl.shadowRoot || testEl.innerHTML) {
                    console.log('✅ Iconify is working');
                } else {
                    console.log('❌ Iconify is not loading properly');
                    // Fallback to text labels
                    document.querySelectorAll('iconify-icon').forEach(icon => {
                        const iconName = icon.getAttribute('icon').split(':')[1] || 'icon';
                        icon.outerHTML = `<span class="${icon.className}">[${iconName}]</span>`;
                    });
                }
            }, 2000);
        });
    </script>
    <style>
        
        /* Genre Tag Styles */
        .genre-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .genre-tag {
            background-color: var(--bg-tertiary, #e3f2fd);
            color: var(--text-accent, #1976d2);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid var(--border-secondary, #bbdefb);
            transition: all 0.2s ease;
        }
        
        .genre-tag:hover {
            background-color: var(--bg-hover, #bbdefb);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--shadow, rgba(0, 0, 0, 0.1));
        }
        
        /* Apply Bauhaus styling to common elements */
        /* Navigation Dropdown */
        .nav-dropdown {
            position: relative;
        }
        
        .nav-dropdown-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .nav-dropdown-menu {
            position: absolute;
            top: calc(100% - 2px);  /* Small overlap to prevent gaps */
            left: 0;
            background-color: var(--bg-secondary, #2d2d2d);
            border: 1px solid var(--border-primary, #444);
            border-radius: 4px;
            box-shadow: 0 4px 6px var(--shadow, rgba(0, 0, 0, 0.3));
            min-width: 180px;
            z-index: 1500;
            padding: 8px 0;
            padding-top: 10px;  /* Add top padding to compensate for overlap */
        }
        
        .nav-dropdown-menu li {
            list-style: none;
            margin: 0;
        }
        
        .nav-dropdown-menu a {
            display: block;
            padding: 8px 16px;
            color: var(--text-secondary, #ccc);
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .nav-dropdown-menu a:hover {
            background-color: var(--nav-hover, #444);
            color: var(--nav-active, #00d4ff);
        }
        
        /* Improved hover behavior with transition delay */
        .nav-dropdown {
            transition: all 0.2s ease;
        }
        
        .nav-dropdown-menu {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            transition-delay: 0s;  /* No delay when showing */
        }
        
        .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;  /* No delay when showing */
        }
        
        /* Add a small delay before hiding to prevent accidental closing */
        .nav-dropdown:not(:hover) .nav-dropdown-menu {
            transition-delay: 0.1s;  /* Small delay when hiding */
        }
        
        /* Theme Toggle Button - Match other sidebar items */
        .theme-toggle-btn {
            /* Remove all special styling to match other sidebar items */
        }
        
        /* Light Theme */
        body.light-theme {
            background: linear-gradient(135deg, var(--light-bg-gradient-start, #667eea) 0%, var(--light-bg-gradient-end, #764ba2) 100%);
            color: var(--light-text-primary, #333);
        }
        
        body.light-theme .navbar {
            background-color: var(--light-navbar-bg, #aaaabb);
            border-bottom: 1px solid var(--light-navbar-border, #9999aa);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .nav-logo a {
            color: var(--light-text-primary, #333);
        }
        
        body.light-theme .nav-menu li a {
            color: var(--light-text-secondary, #666);
        }
        
        body.light-theme .nav-menu li a:hover {
            color: var(--light-accent-primary, #667eea);
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        /* Iconify icon styling */
        iconify-icon {
            display: inline-block;
            vertical-align: middle;
            font-size: inherit;
        }
        
        .sidebar-icon {
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }
        
        .tab-icon {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        
        
        /* Dark theme adjustments */
		body .main-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin: 1rem;
            margin-top: calc(60px + 1rem); /* Account for fixed header height + margin */
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
		
        
        /* Theme section positioning */
        .sidebar-theme-section {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .sidebar-theme-section {
            border-top-color:  rgba(0, 0, 0, 0.1);
        }
        
        /* Logout section styling */
        .sidebar-logout-section {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-logout-item {
            color: var(--danger-light, #ff6b6b) !important;
            transition: all 0.2s ease;
        }
        
        .sidebar-logout-item:hover {
            background-color: var(--danger-bg, rgba(255, 107, 107, 0.1)) !important;
            color: var(--danger-hover, #ff5252) !important;
        }
        
        .sidebar-logout-item .sidebar-icon {
            color: var(--danger-light, #ff6b6b);
        }
        
        /* Light theme logout styling */
        body.light-theme .sidebar-logout-section {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .sidebar-logout-item {
            color: var(--light-danger, #d32f2f) !important;
        }
        
        body.light-theme .sidebar-logout-item:hover {
            background-color: var(--light-danger-bg, rgba(211, 47, 47, 0.1)) !important;
        }
        
        body.light-theme .sidebar-logout-item .sidebar-icon {
            color: var(--light-danger, #d32f2f);
        }
        
        /* Sidebar toggle icon styling */
        .sidebar-toggle {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-direction: row !important;
            gap: 0 !important;
        }
        
        .sidebar-toggle iconify-icon {
            font-size: 18px;
            color: inherit;
        }
        
        /* Theme toggle button inherits light theme sidebar item styling */
        
        body.light-theme .main-content {
            background: var(--bg-primary, rgba(255, 255, 255, 0.4));
            border-radius: 12px;
            margin: 1rem;
            margin-top: calc(60px + 1rem); /* Account for fixed header height + margin */
            box-shadow: 0 20px 40px var(--shadow, rgba(0,0,0,0.1));
        }
        
        body.light-theme .footer {
            background-color: var(--nav-active, #667eea);
            color: var(--text-inverse, #fff);
        }
        
        /* Light theme cards and components */
        body.light-theme .artists-actions,
        body.light-theme .videos-actions {
            background: var(--bg-card, white);
            border: 1px solid var(--border-primary, #e1e5e9);
            box-shadow: 0 2px 4px var(--shadow, rgba(0, 0, 0, 0.1));
            border-radius: 8px;
        }
        
        body.light-theme .advanced-search-panel {
            background: var(--bg-card, white);
            border: 1px solid var(--border-primary, #e1e5e9);
            box-shadow: 0 2px 8px var(--shadow, rgba(0, 0, 0, 0.1));
        }
        
        body.light-theme .advanced-search-panel:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        body.light-theme .search-results-info {
            background: var(--light-card-bg, white);
            border: 1px solid var(--light-border, #e1e5e9);
            color: var(--light-text-primary, #333);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .pagination-container {
            background: var(--light-card-bg, white);
            border: 1px solid var(--light-border, #e1e5e9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .pagination-info {
            color: var(--light-text-primary, #333);
        }
        
        body.light-theme .artist-selection-overlay input[type="checkbox"] {
            accent-color: var(--light-accent-primary, #667eea);
        }
        
        body.light-theme .artist-card,
        body.light-theme .video-card {
            background: var(--light-card-bg, white);
            border: 1px solid var(--light-border, #e1e5e9);
            color: var(--light-text-primary, #333);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .artist-card:hover,
        body.light-theme .video-card:hover {
            background: var(--light-bg-hover, #f0f0ff);
            border-color: var(--light-accent-primary, #667eea);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        body.light-theme .artist-card h3,
        body.light-theme .video-card h3 {
            color: var(--light-accent-primary, #667eea);
        }
        
        body.light-theme .filter-group input,
        body.light-theme .filter-group select {
            background: var(--light-input-bg, #fff);
            border: 2px solid var(--light-input-border, #e1e5e9);
            color: var(--light-input-text, #333);
            border-radius: 8px;
            padding: 0.75rem;
            transition: border-color 0.3s;
        }
        
        body.light-theme .filter-group input:focus,
        body.light-theme .filter-group select:focus {
            border-color: var(--light-accent-primary, #667eea);
            box-shadow: none;
            outline: none;
        }
        
        body.light-theme .filter-group label {
            color: var(--light-text-primary, #333);
        }
        
        /* Button styles now handled by CSS variables in themes.css */
        
        /* Additional light theme overrides removed - now handled by CSS variables */
        
        /* Genre tag hover now handled by CSS variables */
        
        /* User info section styling - compact and interactive */
        .sidebar-user-info {
            display: flex;
            align-items: center;
            gap: 0.1rem;
            margin-bottom: 0.1rem;
        }
        
        .sidebar-user-info:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        .sidebar-user-info:hover .sidebar-username {
            text-decoration: underline;
        }
        
        .sidebar-user-avatar {
            flex-shrink: 0;
        }
        
        .sidebar-user-details {
            flex: 1;
            min-width: 0;
        }
        
        .sidebar-username {
            display: block;
            font-weight: 600;
            font-size: 0.875rem;
            line-height: 1.2;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-user-role {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            line-height: 1;
        }
        
        /* Light theme user info styling */
        body.light-theme .sidebar-user-info:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }
        
        /* Light theme user element colors */
        body.light-theme .sidebar-user-avatar iconify-icon {
            color: white;
        }
        
        body.light-theme .sidebar-username {
            color: var(--light-text-primary, #333);
        }
        
        body.light-theme .sidebar-user-role {
            color: var(--light-text-secondary, #666);
        }
        
        /* Light theme sidebar */
        body.light-theme .sidebar {
            background: var(--light-sidebar-bg, #ddddff);
            border-right: 1px solid var(--light-border-primary, #e1e5e9);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .sidebar-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .sidebar-logo a {
            color: var(--light-accent-primary, #667eea);
        }
        
        body.light-theme .sidebar-item {
            color: var(--light-text-primary, #333);
        }
        
        body.light-theme .sidebar-item:hover {
            background-color: rgba(102, 126, 234, 0.1);
            color: var(--light-accent-primary, #667eea);
        }
        
        body.light-theme .sidebar-item.active {
            background-color: var(--light-accent-primary, #667eea);
            color: white;
        }
        
        body.light-theme .sidebar-text {
            color: inherit;
        }
        
        body.light-theme .sidebar-icon {
            color: inherit;
        }
        
        /* Light theme form elements */
        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background: var(--light-input-bg, white);
            border: 2px solid var(--light-input-border, #e1e5e9);
            color: var(--light-input-text, #333);
            border-radius: 8px;
            padding: 0.75rem;
            transition: border-color 0.3s;
        }
        
        body.light-theme input:focus,
        body.light-theme select:focus,
        body.light-theme textarea:focus {
            border-color: var(--light-accent-primary, #667eea);
            box-shadow: none;
            outline: none;
        }
        
        /* Compact user menu styling */
        .sidebar-user-menu {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .sidebar-user-menu li {
            margin: 0;
            padding: 0;
        }
        
        .sidebar-user-menu .sidebar-user-item {
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.1rem;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
        }
        
        /* Light theme user menu */
        body.light-theme .sidebar-user-menu .sidebar-user-item {
            color: var(--light-text-primary, #333);
        }
        
        body.light-theme .sidebar-user-menu .sidebar-user-item:hover {
            background-color: rgba(102, 126, 234, 0.1);
            color: var(--light-accent-primary, #667eea);
        }
        
        /* Version display styling */
        .version-display {
            color: var(--text-muted, #888) !important;
        }
        
        body.light-theme .version-display {
            color: var(--text-muted, #666) !important;
        }
        
        .sidebar-bottom-section {
            margin-top: auto;
            border-top: 1px solid var(--border-primary, #444);
            padding-top: 0.5rem;
        }
        
        /* Universal Search Styles */
        .universal-search-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: inherit;
            padding: 1rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.light-theme .universal-search-container {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        .universal-search-input-wrapper {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .universal-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            color: var(--text-muted, #6b7280);
            pointer-events: none;
        }
        
        .universal-search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 3rem;
            font-size: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
            transition: all 0.3s ease;
        }
        
        .universal-search-input:focus {
            outline: none;
            border-color: var(--search-focus-border, #3b82f6);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        body.light-theme .universal-search-input {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.2);
        }
        
        body.light-theme .universal-search-input:focus {
            border-color: var(--light-search-focus-border, #3b82f6);
            background: var(--light-input-bg, #fff);
        }
        
        .universal-search-clear {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted, #6b7280);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            font-size: 1.25rem;
            transition: color 0.2s ease;
        }
        
        .universal-search-clear:hover {
            color: var(--danger, #ef4444);
        }
        
        .universal-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-width: 600px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            margin-top: 0.5rem;
        }
        
        body.light-theme .universal-search-results {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .universal-search-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-muted, #6b7280);
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .universal-search-section {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.light-theme .universal-search-section {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        .universal-search-section:last-child {
            border-bottom: none;
        }
        
        .universal-search-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary, #9ca3af);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        body.light-theme .universal-search-section-header {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .universal-search-section-count {
            margin-left: auto;
            background: rgba(59, 130, 246, 0.2);
            color: var(--search-accent, #3b82f6);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }
        
        .universal-search-section-results {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .universal-search-result-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .universal-search-result-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        body.light-theme .universal-search-result-item {
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }
        
        body.light-theme .universal-search-result-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .universal-search-result-item:last-child {
            border-bottom: none;
        }
        
        .universal-search-result-icon {
            font-size: 1.25rem;
            color: var(--text-muted, #6b7280);
            flex-shrink: 0;
        }
        
        .universal-search-result-content {
            flex: 1;
            min-width: 0;
        }
        
        .universal-search-result-title {
            font-weight: 500;
            color: inherit;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .universal-search-result-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted, #6b7280);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .universal-search-result-action {
            background: rgba(59, 130, 246, 0.2);
            color: var(--search-accent, #3b82f6);
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .universal-search-result-action:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .universal-search-no-results {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 3rem 2rem;
            color: var(--text-muted, #6b7280);
            text-align: center;
        }
        
        .universal-search-no-results iconify-icon {
            font-size: 3rem;
            opacity: 0.5;
        }
        
        .universal-search-more {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        body.light-theme .universal-search-more {
            border-top-color: rgba(0, 0, 0, 0.1);
        }
        
        .universal-search-more-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.5rem;
            color: var(--search-accent, #3b82f6);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .universal-search-more-button:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .universal-search-more-button iconify-icon {
            font-size: 1.125rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .universal-search-input-wrapper {
                margin: 0 1rem;
            }
            
            .universal-search-results {
                left: 1rem;
                right: 1rem;
                max-width: none;
            }
        }
        
        /* Header Bar Styles */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: var(--top-bar-bg, #2d2d2d);
            border-bottom: 1px solid var(--border-primary, rgba(255, 255, 255, 0.1));
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            transition: left 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow, rgba(0, 0, 0, 0.2));
            height: 60px;
        }
        
        body.light-theme .app-header {
            background: var(--top-bar-bg, #ddddff);
            border-bottom-color: var(--border-primary, rgba(0, 0, 0, 0.1));
            box-shadow: 0 4px 15px var(--shadow, rgba(0, 0, 0, 0.08));
        }
        
        /* Dynamic width based on sidebar state */
        :root {
            --sidebar-width: 250px;
        }
        
        .sidebar.collapsed ~ .app-header,
        body.sidebar-collapsed .app-header {
            --sidebar-width: 60px;
        }
        
        .header-left {
            flex: 1;
            display: flex;
            justify-content: center;
            max-width: none;
        }
        
        .header-right {
            position: absolute;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Header Universal Search adjustments */
        .app-header .universal-search-container {
            position: static;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
            width: 100%;
            max-width: 500px;
        }
        
        .app-header .universal-search-input-wrapper {
            max-width: none;
            margin: 0;
            width: 100%;
        }
        
        .app-header .universal-search-input {
            padding: 0.5rem 2.5rem 0.5rem 2.5rem;
            font-size: 0.875rem;
            background: var(--search-bar-bg, rgba(255, 255, 255, 0.05));
            border: 2px solid var(--border-secondary, rgba(255, 255, 255, 0.1));
            color: inherit;
        }
        
        .app-header .universal-search-input::placeholder {
            color: var(--text-muted, #6b7280);
        }
        
        .app-header .universal-search-input:focus {
            background: var(--input-bg, rgba(255, 255, 255, 0.1));
            border-color: var(--border-focus, #3b82f6);
            color: inherit;
            box-shadow: 0 0 0 3px var(--border-focus-shadow, rgba(59, 130, 246, 0.1));
        }
        
        .app-header .universal-search-icon {
            color: var(--text-muted, #6b7280);
        }
        
        .app-header .universal-search-clear {
            color: var(--text-muted, #6b7280);
        }
        
        .app-header .universal-search-clear:hover {
            color: var(--danger, #ef4444);
        }
        
        /* Light theme search adjustments */
        body.light-theme .app-header .universal-search-input {
            background: var(--search-bar-bg, rgba(255, 255, 255, 0.15));
            border-color: var(--border-secondary, rgba(255, 255, 255, 0.25));
            color: var(--text-primary, white);
        }
        
        body.light-theme .app-header .universal-search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        body.light-theme .app-header .universal-search-input:focus {
            background: var(--input-bg, rgba(255, 255, 255, 0.25));
            border-color: var(--border-focus, rgba(255, 255, 255, 0.5));
            color: var(--text-primary, white);
            box-shadow: 0 0 0 3px var(--border-focus-shadow, rgba(255, 255, 255, 0.1));
        }
        
        body.light-theme .app-header .universal-search-icon {
            color: rgba(255, 255, 255, 0.8);
        }
        
        body.light-theme .app-header .universal-search-clear {
            color: rgba(255, 255, 255, 0.8);
        }
        
        body.light-theme .app-header .universal-search-clear:hover {
            color: rgba(255, 255, 255, 1);
        }
        
        /* Header Theme Toggle */
        .header-theme-toggle {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
        }
        
        .header-theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        body.light-theme .header-theme-toggle {
            background: transparent;
        }
        
        body.light-theme .header-theme-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        /* Header User Section */
        .header-user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.25rem;
        }
        
        .header-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background: transparent;
            border: none;
            transition: all 0.2s ease;
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }
        
        .header-user-info:visited {
            color: inherit;
        }
        
        .header-user-info:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        body.light-theme .header-user-info {
            background: transparent;
            color: white;
        }
        
        body.light-theme .header-user-info:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .header-user-avatar {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.2);
            color: var(--search-accent, #3b82f6);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        body.light-theme .header-user-avatar {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .header-user-avatar iconify-icon {
            font-size: 1.25rem;
        }
        
        .header-user-details {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        
        .header-username {
            font-size: 0.875rem;
            font-weight: 600;
            color: inherit;
            line-height: 1.2;
        }
        
        .header-user-role {
            font-size: 0.75rem;
            color: var(--text-muted, #6b7280);
            line-height: 1.2;
        }
        
        body.light-theme .header-username {
            color: white;
        }
        
        body.light-theme .header-user-role {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .header-logout-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            color: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .header-logout-button:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger, #ef4444);
            transform: translateY(-1px);
        }
        
        body.light-theme .header-logout-button {
            background: transparent;
            color: white;
        }
        
        body.light-theme .header-logout-button:hover {
            background: rgba(239, 68, 68, 0.3);
            color: var(--danger, #ef4444);
        }
        
        .header-logout-button iconify-icon {
            font-size: 1.5rem;
        }
        
        /* Mobile header responsiveness */
        @media (max-width: 1024px) {
            .app-header {
                left: 0;
                right: 0;
                padding: 0.5rem;
            }
            
            .header-left {
                max-width: none;
            }
            
            .header-user-details {
                display: none;
            }
            
            .header-logout-text {
                display: none;
            }
            
            .header-user-section {
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .app-header {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .header-left {
                order: 2;
                flex: 1 1 100%;
            }
            
            .header-right {
                order: 1;
                flex: none;
                gap: 0.5rem;
            }
            
            .header-user-info {
                padding: 0.375rem;
                gap: 0;
            }
            
            .header-logout-button {
                padding: 0.375rem;
                gap: 0;
            }
        }
        
        @media (max-width: 480px) {
            .header-theme-toggle {
                padding: 0.375rem;
            }
            
            .header-user-avatar {
                width: 1.5rem;
                height: 1.5rem;
            }
            
            .header-user-avatar iconify-icon {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Left Sidebar Navigation -->
    <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-header" style="padding: 0.75rem 1rem; height: 60px;">
            <div class="sidebar-logo">
                <a href="{{ url_for('frontend.index') }}" style="font-size: 1.5rem;">
                    <img width="32" src="{{ url_for('frontend.static_files', filename='MVidarr.png') }}">
                    <span class="sidebar-logo-text">MVidarr</span>
                </a>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <iconify-icon icon="tabler:menu-deep"></iconify-icon>
            </button>
        </div>
        
        <div class="sidebar-content">
            <ul class="sidebar-menu">
               <li><a href="{{ url_for('frontend.index') }}" class="sidebar-item">
                    <iconify-icon icon="tabler:dashboard" class="sidebar-icon"></iconify-icon>
                    <span class="sidebar-text">Dashboard</span>
                </a></li> 
				<li><a href="{{ url_for('frontend.artists') }}" class="sidebar-item">
                    <iconify-icon icon="tabler:users" class="sidebar-icon"></iconify-icon>
                    <span class="sidebar-text">Artists</span>
                </a></li>
                <li><a href="{{ url_for('frontend.videos') }}" class="sidebar-item">
                    <iconify-icon icon="tabler:video" class="sidebar-icon"></iconify-icon>
                    <span class="sidebar-text">Videos</span>
                </a></li>
                <li><a href="{{ url_for('frontend.playlists') }}" class="sidebar-item">
                    <iconify-icon icon="tabler:playlist" class="sidebar-icon"></iconify-icon>
                    <span class="sidebar-text">Playlists</span>
                </a></li>
                <li><a href="{{ url_for('frontend.mvtv') }}" class="sidebar-item">
                    <iconify-icon icon="tabler:device-tv" class="sidebar-icon"></iconify-icon>
                    <span class="sidebar-text">MvTV</span>
                </a></li>
                 <li><a href="{{ url_for('frontend.settings') }}" class="sidebar-item">
                    <iconify-icon icon="tabler:settings" class="sidebar-icon"></iconify-icon>
                    <span class="sidebar-text">Settings</span>
                </a></li>
                {% if current_user %}
                    <!-- Profile management removed in simplified authentication system -->
                    <!-- User credentials can be updated in Settings > General -->
                {% endif %}
            </ul>
            
            <!-- Theme Toggle - Always visible at bottom of sidebar -->
            <!-- Version Display -->
            <div class="sidebar-bottom-section">
                <div class="version-display" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                    <span id="versionInfo">Loading...</span>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Mobile overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Header Bar -->
    <header class="app-header" id="appHeader">
        <div class="header-left">
            <!-- Universal Search Component -->
            <div class="universal-search-container" id="universalSearchContainer">
                <div class="universal-search-input-wrapper">
                    <iconify-icon icon="tabler:search" class="universal-search-icon"></iconify-icon>
                    <input type="text" id="universalSearchInput" class="universal-search-input" placeholder="Search videos, artists, or discover new content..." autocomplete="off">
                    <button class="universal-search-clear" id="universalSearchClear" style="display: none;">
                        <iconify-icon icon="tabler:x"></iconify-icon>
                    </button>
                </div>
                
                <!-- Search Results Dropdown -->
                <div class="universal-search-results" id="universalSearchResults" style="display: none;">
                    <div class="universal-search-loading" id="universalSearchLoading" style="display: none;">
                        <iconify-icon icon="tabler:loader-2" class="spinning"></iconify-icon>
                        <span>Searching...</span>
                    </div>
                    
                    <!-- Videos Section -->
                    <div class="universal-search-section" id="videosSection" style="display: none;">
                        <div class="universal-search-section-header">
                            <iconify-icon icon="tabler:video"></iconify-icon>
                            <span>Videos</span>
                            <span class="universal-search-section-count" id="videosCount"></span>
                        </div>
                        <div class="universal-search-section-results" id="videosResults"></div>
                    </div>
                    
                    <!-- Artists Section -->
                    <div class="universal-search-section" id="artistsSection" style="display: none;">
                        <div class="universal-search-section-header">
                            <iconify-icon icon="tabler:users"></iconify-icon>
                            <span>Artists</span>
                            <span class="universal-search-section-count" id="artistsCount"></span>
                        </div>
                        <div class="universal-search-section-results" id="artistsResults"></div>
                    </div>
                    
                    <!-- External Search Results Section -->
                    <div class="universal-search-section" id="externalSection" style="display: none;">
                        <div class="universal-search-section-header">
                            <iconify-icon icon="tabler:world"></iconify-icon>
                            <span>Discover</span>
                            <span class="universal-search-section-count" id="externalCount"></span>
                        </div>
                        <div class="universal-search-section-results" id="externalResults"></div>
                    </div>
                    
                    <!-- No Results -->
                    <div class="universal-search-no-results" id="noResultsMessage" style="display: none;">
                        <iconify-icon icon="tabler:search-off"></iconify-icon>
                        <span>No results found</span>
                    </div>
                    
                    <!-- Search More Button -->
                    <div class="universal-search-more" id="searchMoreSection" style="display: none;">
                        <button class="universal-search-more-button" id="searchMoreButton">
                            <iconify-icon icon="tabler:world-search"></iconify-icon>
                            <span>Search IMVDb & YouTube for more results</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header-right">
            
            <!-- User Info Section -->
            <div class="header-user-section" id="headerUserSection" style="display: flex;">
                <!-- User Info Display -->
                <a href="/settings" class="header-user-info" title="View Profile & Settings">
                    <div class="header-user-avatar">
                        <iconify-icon icon="tabler:user-circle"></iconify-icon>
                    </div>
                    <div class="header-user-details" id="headerUserDetails">
                        <span class="header-username" id="headerUsername">admin</span>
                        <span class="header-user-role" id="headerUserRole">Admin</span>
                    </div>
                </a>
                
                <!-- Logout Button -->
                <button class="header-logout-button" onclick="logout(); return false;" title="Logout">
                    <iconify-icon icon="tabler:logout"></iconify-icon>
                </button>
            </div>
        </div>
    </header>

    <!-- Main content area -->
    <div class="app-layout">
        <main class="main-content" id="mainContent" role="main" aria-label="Main content">
            <a href="#mainContent" class="skip-link">Skip to main content</a>
            {% block content %}{% endblock %}
        </main>
    </div>


    <script src="{{ url_for('frontend.static_files', filename='toast.js') }}"></script>
    <script src="{{ url_for('frontend.static_files', filename='main.js') }}"></script>
    <script src="{{ url_for('frontend.static_files', filename='loading-feedback.js') }}"></script>
    <script>
        
        
        
        // Function to apply theme.park themes
        function applyThemeParkTheme(theme) {
            // Remove existing theme stylesheets
            const existingThemeLink = document.getElementById('theme-stylesheet');
            if (existingThemeLink) {
                existingThemeLink.remove();
            }
            
            // Remove theme classes
            const body = document.body;
            body.classList.remove('bauhaus-theme');
            body.className = body.className.replace(/\btheme-\w+/g, '');
            
            // Load theme.park CSS file
            const link = document.createElement('link');
            link.id = 'theme-stylesheet';
            link.rel = 'stylesheet';
            link.href = `/css/themepark/${theme}.css`;
            document.head.appendChild(link);
            
            // Add theme class to body
            body.classList.add(`theme-${theme}`);
            
            // Keep main theme enabled for layout structure, only disable bauhaus
            const mainTheme = document.getElementById('main-theme');
            const bauhausTheme = document.getElementById('bauhaus-theme');
            if (mainTheme) mainTheme.disabled = false; // Keep main.css enabled
            if (bauhausTheme) bauhausTheme.disabled = true;
        }
        

        // Enhanced Theme Management System
        // Use global variables to avoid redeclaration conflicts
        window.currentTheme = window.currentTheme || 'default';
        
        // Load saved theme and mode on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedTheme();
            initializeThemeSystem();
        });
        
        function loadSavedTheme() {
            
            // Load saved theme using themes API
            fetch('/api/themes/current')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        // Theme not set yet, use default
                        return null;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .then(data => {
                    if (data && data.current_theme) {
                        window.currentTheme = data.current_theme;
                        loadThemeVariables(data.current_theme);
                    } else {
                        applyCurrentTheme();
                    }
                })
                .catch(error => {
                    console.log('Current theme not found, using default');
                    applyCurrentTheme();
                });
        }
        
        // Load theme CSS variables
        async function loadThemeVariables(themeId) {
            try {
                // First try to get it as a custom theme
                let response = await fetch(`/api/themes/${themeId}`);
                
                if (response.ok) {
                    const themeData = await response.json();
                    if (themeData.theme_data) {
                        Object.entries(themeData.theme_data).forEach(([cssVar, value]) => {
                            document.documentElement.style.setProperty(cssVar, value);
                        });
                    }
                } else {
                    // Try as built-in theme
                    response = await fetch(`/api/themes/built-in/${themeId}/extract`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const extractData = await response.json();
                        if (extractData.variables) {
                            Object.entries(extractData.variables).forEach(([cssVar, value]) => {
                                document.documentElement.style.setProperty(cssVar, value);
                            });
                        }
                    }
                }
                
                applyCurrentTheme();
                
            } catch (error) {
                console.error('Failed to load theme variables:', error);
                applyCurrentTheme();
            }
        }
        
        function initializeThemeSystem() {
            const toggleBtn = document.getElementById('themeSlider');
            const toggleIcon = document.getElementById('themeSliderIcon');
            
        }
        
        function applyCurrentTheme() {
            // Apply theme data attributes to document
            document.documentElement.setAttribute('data-theme', window.currentTheme);
            
            // Update settings page preview if it exists
            if (typeof updateThemePreviewMode === 'function') {
                updateThemePreviewMode();
            }
        }
        
        // User Authentication and Menu Management
        function checkUserAuthentication() {
            fetch('/auth/check')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated && data.user) {
                        // Show user menu
                        const userMenu = document.getElementById('userMenu');
                        const username = document.getElementById('username');
                        
                        if (userMenu && username) {
                            userMenu.style.display = 'block';
                            username.textContent = data.user.username;
                        }
                        
                        // User management menu item removed
                    } else {
                        // Hide user menu if not authenticated
                        const userMenu = document.getElementById('userMenu');
                        const userMgmtSidebarItem = document.getElementById('userManagementSidebarItem');
                        
                        if (userMenu) {
                            userMenu.style.display = 'none';
                        }
                        if (userMgmtSidebarItem) {
                            userMgmtSidebarItem.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    // Hide user menu on error
                    const userMenu = document.getElementById('userMenu');
                    const userMgmtSidebarItem = document.getElementById('userManagementSidebarItem');
                    
                    if (userMenu) {
                        userMenu.style.display = 'none';
                    }
                    if (userMgmtSidebarItem) {
                        userMgmtSidebarItem.style.display = 'none';
                    }
                });
        }
        
        
        function goToUserCredentials() {
            // Navigate to settings page and show user credentials section
            window.location.href = '{{ url_for("frontend.settings") }}';
            
            // After navigation, scroll to user credentials section
            setTimeout(() => {
                const userCredentialsSection = document.getElementById('userCredentialsSection');
                if (userCredentialsSection) {
                    // Make sure the section is visible first
                    if (userCredentialsSection.style.display === 'none') {
                        userCredentialsSection.style.display = 'block';
                    }
                    // Then scroll to it
                    userCredentialsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
        
        // showChangePassword() function removed - users can change credentials by clicking username
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/auth/dynamic-logout', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => {
                        console.log('Logout response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Logout response data:', data);
                        if (data.success) {
                            // Hide user menu
                            const userMenu = document.getElementById('userMenu');
                            if (userMenu) {
                                userMenu.style.display = 'none';
                            }
                            // Redirect to login page
                            window.location.href = '/simple-login';
                        } else {
                            console.error('Logout failed - response indicates failure:', data);
                            alert('Logout failed: ' + (data.error || data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error during logout:', error);
                        alert('Logout failed: ' + error.message);
                    });
            }
        }
        
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Hide admin items by default until authentication is confirmed
            const userMgmtSidebarItem = document.getElementById('userManagementSidebarItem');
            const userMenu = document.getElementById('userMenu');
            
            if (userMgmtSidebarItem) {
                userMgmtSidebarItem.style.display = 'none';
            }
            if (userMenu) {
                userMenu.style.display = 'none';
            }
            
            // Check authentication status after a short delay to ensure page is ready
            setTimeout(checkUserAuthentication, 100);
            
            // Initialize sidebar functionality
            initializeSidebar();
            
            // Load version information
            loadVersionInfo();
        });
        
        // Sidebar functionality
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');
            
            if (!sidebar || !sidebarToggle || !sidebarOverlay) {
                console.warn('Sidebar elements not found');
                return;
            }
            
            // Toggle sidebar collapse/expand
            sidebarToggle.addEventListener('click', function() {
                toggleSidebar();
            });
            
            // Close sidebar when clicking overlay (mobile)
            sidebarOverlay.addEventListener('click', function() {
                closeSidebar();
            });
            
            // Handle responsive behavior
            handleResponsiveSidebar();
            window.addEventListener('resize', handleResponsiveSidebar);
            
            // Set active navigation item
            setActiveNavItem();
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                // Mobile: Toggle visibility
                if (sidebar.classList.contains('mobile-hidden')) {
                    sidebar.classList.remove('mobile-hidden');
                    sidebarOverlay.classList.add('active');
                } else {
                    sidebar.classList.add('mobile-hidden');
                    sidebarOverlay.classList.remove('active');
                }
            } else {
                // Desktop: Toggle collapse
                sidebar.classList.toggle('collapsed');
                // Save state
                localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.add('mobile-hidden');
                sidebarOverlay.classList.remove('active');
            }
        }
        
        function handleResponsiveSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                // Mobile: Hide sidebar by default
                sidebar.classList.add('mobile-hidden');
                sidebar.classList.remove('collapsed');
                sidebarOverlay.classList.remove('active');
            } else {
                // Desktop: Show sidebar, restore collapsed state
                sidebar.classList.remove('mobile-hidden');
                sidebarOverlay.classList.remove('active');
                
                // Restore collapsed state from localStorage
                const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
                if (isCollapsed) {
                    sidebar.classList.add('collapsed');
                } else {
                    sidebar.classList.remove('collapsed');
                }
            }
        }
        
        function setActiveNavItem() {
            const currentPath = window.location.pathname;
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                
                const href = item.getAttribute('href');
                if (href && href !== '#') {
                    // Check if current path matches this menu item
                    if (currentPath === href || 
                        (currentPath === '/' && href.includes('index')) ||
                        (currentPath.includes('/artists') && href.includes('artists')) ||
                        (currentPath.includes('/videos') && href.includes('videos')) ||
                        (currentPath.includes('/mvtv') && href.includes('mvtv')) ||
                        (currentPath.includes('/settings') && href.includes('settings'))) {
                        item.classList.add('active');
                    }
                }
            });
        }
        
        // Load version information from API
        function loadVersionInfo() {
            fetch('/api/health/version')
                .then(response => response.json())
                .then(data => {
                    const versionElement = document.getElementById('versionInfo');
                    if (versionElement) {
                        const version = data.version || 'unknown';
                        const commit = data.git_commit || 'unknown';
                        versionElement.textContent = `v${version} (${commit})`;
                    }
                })
                .catch(error => {
                    console.warn('Failed to load version info:', error);
                    const versionElement = document.getElementById('versionInfo');
                    if (versionElement) {
                        versionElement.textContent = 'v1.0.0';
                    }
                });
        }
        
        // Universal Search Functionality
        class UniversalSearch {
            constructor() {
                this.searchInput = document.getElementById('universalSearchInput');
                this.searchResults = document.getElementById('universalSearchResults');
                this.clearButton = document.getElementById('universalSearchClear');
                this.loadingElement = document.getElementById('universalSearchLoading');
                this.noResultsElement = document.getElementById('noResultsMessage');
                this.searchMoreSection = document.getElementById('searchMoreSection');
                this.searchMoreButton = document.getElementById('searchMoreButton');
                
                this.videosSection = document.getElementById('videosSection');
                this.artistsSection = document.getElementById('artistsSection');
                this.externalSection = document.getElementById('externalSection');
                
                this.videosResults = document.getElementById('videosResults');
                this.artistsResults = document.getElementById('artistsResults');
                this.externalResults = document.getElementById('externalResults');
                
                this.videosCount = document.getElementById('videosCount');
                this.artistsCount = document.getElementById('artistsCount');
                this.externalCount = document.getElementById('externalCount');
                
                this.searchTimeout = null;
                this.isSearching = false;
                this.currentQuery = '';
                
                this.init();
            }
            
            init() {
                if (!this.searchInput) return;
                
                // Input event listener with debouncing
                this.searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    if (query.length === 0) {
                        this.clearResults();
                        this.clearButton.style.display = 'none';
                        return;
                    }
                    
                    this.clearButton.style.display = 'block';
                    
                    if (query.length < 2) {
                        this.clearResults();
                        return;
                    }
                    
                    // Debounce search
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.performSearch(query);
                    }, 300);
                });
                
                // Clear button
                this.clearButton.addEventListener('click', () => {
                    this.searchInput.value = '';
                    this.clearResults();
                    this.clearButton.style.display = 'none';
                    this.searchInput.focus();
                });
                
                // Close results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.universal-search-container')) {
                        this.hideResults();
                    }
                });
                
                // Keep results open when clicking inside
                this.searchResults.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // Focus handling
                this.searchInput.addEventListener('focus', () => {
                    if (this.searchInput.value.trim().length >= 2) {
                        this.showResults();
                    }
                });
                
                // Search more button handler
                if (this.searchMoreButton) {
                    this.searchMoreButton.addEventListener('click', () => {
                        // Open discover page with the current search query
                        console.log('🔧 Search More button clicked, current query:', this.currentQuery);
                        
                        // Get query from search input if currentQuery is not set
                        const searchInput = document.getElementById('universalSearchInput');
                        const queryToUse = this.currentQuery || (searchInput ? searchInput.value.trim() : '');
                        
                        console.log('🔧 Query to use for discovery page:', queryToUse);
                        
                        if (queryToUse) {
                            const discoverUrl = `/discover?q=${encodeURIComponent(queryToUse)}`;
                            console.log('🔧 Opening discover page URL:', discoverUrl);
                            window.location.href = discoverUrl;
                        } else {
                            console.warn('⚠️ No search query available for discovery page');
                            // Open discovery page without query as fallback
                            window.location.href = '/discover';
                        }
                    });
                }
            }
            
            async performSearch(query) {
                if (this.isSearching) return;
                
                this.isSearching = true;
                this.currentQuery = query;
                this.showLoading();
                
                try {
                    const response = await fetch(`/api/videos/universal-search?q=${encodeURIComponent(query)}`);
                    
                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.displayResults(data);
                    
                } catch (error) {
                    console.error('Search error:', error);
                    this.showError('Search failed. Please try again.');
                } finally {
                    this.isSearching = false;
                    this.hideLoading();
                }
            }
            
            displayResults(data) {
                this.clearSections();
                
                if (data.total === 0) {
                    this.showNoResults();
                    this.showSearchMore();
                    return;
                }
                
                // Display videos
                if (data.videos && data.videos.length > 0) {
                    this.displayVideos(data.videos);
                }
                
                // Display artists
                if (data.artists && data.artists.length > 0) {
                    this.displayArtists(data.artists);
                }
                
                // Display external results
                if (data.external && data.external.length > 0) {
                    this.displayExternal(data.external);
                }
                
                // Always show search more button for additional discovery
                this.showSearchMore();
                
                this.showResults();
            }
            
            displayVideos(videos) {
                this.videosCount.textContent = videos.length;
                this.videosResults.innerHTML = '';
                
                videos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'universal-search-result-item';
                    item.innerHTML = `
                        <iconify-icon icon="tabler:video" class="universal-search-result-icon"></iconify-icon>
                        <div class="universal-search-result-content">
                            <div class="universal-search-result-title">${this.escapeHtml(video.title)}</div>
                            <div class="universal-search-result-subtitle">${this.escapeHtml(video.artist)} ${video.year ? `• ${video.year}` : ''}</div>
                        </div>
                        <button class="universal-search-result-action" data-video-id="${video.id}">View</button>
                    `;
                    
                    item.addEventListener('click', () => {
                        window.location.href = video.url;
                    });
                    
                    this.videosResults.appendChild(item);
                });
                
                this.videosSection.style.display = 'block';
            }
            
            displayArtists(artists) {
                this.artistsCount.textContent = artists.length;
                this.artistsResults.innerHTML = '';
                
                artists.forEach(artist => {
                    const item = document.createElement('div');
                    item.className = 'universal-search-result-item';
                    item.innerHTML = `
                        <iconify-icon icon="tabler:user" class="universal-search-result-icon"></iconify-icon>
                        <div class="universal-search-result-content">
                            <div class="universal-search-result-title">${this.escapeHtml(artist.name)}</div>
                            <div class="universal-search-result-subtitle">${artist.video_count} video${artist.video_count !== 1 ? 's' : ''}</div>
                        </div>
                        <button class="universal-search-result-action" data-artist-id="${artist.id}">View</button>
                    `;
                    
                    item.addEventListener('click', () => {
                        window.location.href = artist.url;
                    });
                    
                    this.artistsResults.appendChild(item);
                });
                
                this.artistsSection.style.display = 'block';
            }
            
            displayExternal(external) {
                this.externalCount.textContent = external.length;
                this.externalResults.innerHTML = '';
                
                external.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'universal-search-result-item';
                    
                    const sourceIcon = result.source === 'YouTube' ? 'tabler:brand-youtube' : 'tabler:world';
                    
                    item.innerHTML = `
                        <iconify-icon icon="${sourceIcon}" class="universal-search-result-icon"></iconify-icon>
                        <div class="universal-search-result-content">
                            <div class="universal-search-result-title">${this.escapeHtml(result.title)}</div>
                            <div class="universal-search-result-subtitle">${this.escapeHtml(result.artist)} • ${result.source}</div>
                        </div>
                        <button class="universal-search-result-action" data-source="${result.source}" data-video-id="${result.video_id}">Add</button>
                    `;
                    
                    const addButton = item.querySelector('.universal-search-result-action');
                    addButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.addToLibrary(result);
                    });
                    
                    this.externalResults.appendChild(item);
                });
                
                this.externalSection.style.display = 'block';
            }
            
            async addToLibrary(result) {
                try {
                    const source = result.source;
                    const videoId = result.video_id;
                    const title = result.title;
                    const artist = result.artist;
                    const url = result.source === 'YouTube' ? `https://youtube.com/watch?v=${videoId}` : '';
                    
                    // Use the existing addVideoToLibrary function if available
                    if (typeof addVideoToLibrary === 'function') {
                        await addVideoToLibrary(source, videoId, title, artist, url);
                    } else {
                        // Fallback to direct API call
                        const endpoint = source === 'YouTube' ? '/api/videos/import-from-youtube' : '/api/videos/import-from-imvdb';
                        
                        const payload = source === 'YouTube' ? {
                            youtube_id: videoId,
                            url: url,
                            title: title,
                            artist: artist,
                            auto_download: true
                        } : {
                            imvdb_id: videoId,
                            auto_download: true
                        };
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) {
                            showToast('Video added to library successfully!', 'success');
                        } else {
                            const error = await response.text();
                            showToast(`Failed to add video: ${error}`, 'error');
                        }
                    }
                    
                    this.hideResults();
                    
                } catch (error) {
                    console.error('Add to library error:', error);
                    showToast('Failed to add video to library', 'error');
                }
            }
            
            showLoading() {
                this.loadingElement.style.display = 'flex';
                this.showResults();
            }
            
            hideLoading() {
                this.loadingElement.style.display = 'none';
            }
            
            showResults() {
                this.searchResults.style.display = 'block';
            }
            
            hideResults() {
                this.searchResults.style.display = 'none';
            }
            
            clearResults() {
                this.hideResults();
                this.clearSections();
            }
            
            clearSections() {
                this.videosSection.style.display = 'none';
                this.artistsSection.style.display = 'none';
                this.externalSection.style.display = 'none';
                this.noResultsElement.style.display = 'none';
                this.searchMoreSection.style.display = 'none';
                this.hideLoading();
            }
            
            showNoResults() {
                this.noResultsElement.style.display = 'flex';
                this.showResults();
            }
            
            showError(message) {
                showToast(message, 'error');
                this.hideResults();
            }
            
            showSearchMore() {
                if (this.searchMoreSection && this.currentQuery) {
                    this.searchMoreSection.style.display = 'block';
                }
            }
            
            async performExtendedSearch(query) {
                if (!query || this.isSearching) return;
                
                this.isSearching = true;
                this.searchMoreButton.innerHTML = `
                    <iconify-icon icon="tabler:loader-2" class="spinning"></iconify-icon>
                    <span>Searching IMVDb & YouTube...</span>
                `;
                this.searchMoreButton.disabled = true;
                
                try {
                    // Force a more extensive external search by requesting more results
                    const response = await fetch(`/api/videos/universal-search?q=${encodeURIComponent(query)}&extended=true`);
                    
                    if (!response.ok) {
                        throw new Error(`Extended search failed: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // If we get more external results, update just the external section
                    if (data.external && data.external.length > 0) {
                        this.displayExternal(data.external);
                        this.externalSection.style.display = 'block';
                        showToast(`Found ${data.external.length} additional results from IMVDb & YouTube!`, 'success');
                    } else {
                        showToast('No additional results found on IMVDb & YouTube', 'info');
                    }
                    
                } catch (error) {
                    console.error('Extended search error:', error);
                    showToast('Extended search failed. Please try again.', 'error');
                } finally {
                    this.isSearching = false;
                    this.searchMoreButton.innerHTML = `
                        <iconify-icon icon="tabler:world-search"></iconify-icon>
                        <span>Search IMVDb & YouTube for more results</span>
                    `;
                    this.searchMoreButton.disabled = false;
                }
            }
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }
        
        // Initialize universal search when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('universalSearchInput')) {
                window.universalSearch = new UniversalSearch();
            }
            
            // Initialize header functionality
            initializeHeader();
        });
        
        // Header functionality
        function initializeHeader() {
            // Synchronize header theme slider with main theme slider
            
            // Header user menu is now a direct link to settings page
            // No dropdown functionality needed - link goes directly to /settings
            
            // Show/hide header user section based on authentication
            updateHeaderUserSection();
            
            // Update header width on initialization
            updateHeaderWidth();
            
            // Add sidebar toggle event listeners
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    // Add a small delay to allow the sidebar animation to start
                    setTimeout(updateHeaderWidth, 50);
                });
            }
            
            // Listen for window resize to update header width
            window.addEventListener('resize', updateHeaderWidth);
            
            // Use MutationObserver to watch for sidebar class changes
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            updateHeaderWidth();
                        }
                    });
                });
                observer.observe(sidebar, { attributes: true });
            }
        }
        
        
        function updateHeaderUserSection() {
            const headerUserSection = document.getElementById('headerUserSection');
            const headerUsername = document.getElementById('headerUsername');
            const sidebarUserMenu = document.getElementById('userMenu');
            const sidebarUsername = document.getElementById('username');
            
            if (!headerUserSection) return;
            
            // Sync with sidebar user menu visibility and username
            if (sidebarUserMenu && sidebarUsername) {
                const isVisible = sidebarUserMenu.style.display !== 'none';
                headerUserSection.style.display = isVisible ? 'flex' : 'none';
                
                if (headerUsername && isVisible) {
                    headerUsername.textContent = sidebarUsername.textContent || 'User';
                }
            }
        }
        
        function updateHeaderWidth() {
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('appHeader');
            
            if (!sidebar || !header) return;
            
            const isCollapsed = sidebar.classList.contains('collapsed');
            const sidebarWidth = isCollapsed ? '60px' : '250px';
            
            // Update CSS custom property
            document.documentElement.style.setProperty('--sidebar-width', sidebarWidth);
            
            // Force update for immediate visual feedback on desktop
            if (window.innerWidth > 1024) {
                header.style.left = sidebarWidth;
            } else {
                // On mobile, header spans full width
                header.style.left = '0';
            }
        }
        
        // Override the existing functions to sync with header
        const originalShowUserMenu = window.showUserMenu;
        if (originalShowUserMenu) {
            window.showUserMenu = function() {
                originalShowUserMenu();
                updateHeaderUserSection();
            };
        }
        
        const originalHideUserMenu = window.hideUserMenu;
        if (originalHideUserMenu) {
            window.hideUserMenu = function() {
                originalHideUserMenu();
                updateHeaderUserSection();
            };
        }
    </script>
</body>
</html>