{% extends "base.html" %}

{% block title %}Discover - MVidarr{% endblock %}

{% block content %}
<div class="discover-container">
    <div class="discover-header">
        <h1>🌟 Discover Music Videos</h1>
        <p class="page-description">Search across multiple sources to discover new music videos</p>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-form">
            <div class="search-input-wrapper">
                <input type="text" id="discoverSearchInput" class="search-input" placeholder="Search for artists, songs, or music videos..." value="{{ query or '' }}">
                <button id="discoverSearchButton" class="search-button">
                    <iconify-icon icon="tabler:search"></iconify-icon>
                    Search
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Discovery Section -->
    <div class="enhanced-discovery-section">
        <div class="section-header">
            <h2>✨ Enhanced Artist Discovery</h2>
            <p>Multi-source artist discovery with intelligent metadata enrichment</p>
        </div>
        
        <div class="discovery-features">
            <div class="feature-card" onclick="showEnhancedSearch()">
                <iconify-icon icon="tabler:search"></iconify-icon>
                <h3>Smart Search</h3>
                <p>Search across Spotify, Last.fm, and Wikipedia simultaneously</p>
            </div>
            
            <div class="feature-card" onclick="showDuplicateDetection()">
                <iconify-icon icon="tabler:copy"></iconify-icon>
                <h3>Duplicate Detection</h3>
                <p>Find and merge duplicate artists in your library</p>
            </div>
            
            <div class="feature-card" onclick="showMetadataEnrichment()">
                <iconify-icon icon="tabler:database-import"></iconify-icon>
                <h3>Metadata Enrichment</h3>
                <p>Automatically enrich artist profiles with genres, biographies, and more</p>
            </div>
            
            <div class="feature-card" onclick="showRecommendations()">
                <iconify-icon icon="tabler:bulb"></iconify-icon>
                <h3>Recommendations</h3>
                <p>Get personalized artist recommendations based on your library</p>
            </div>
        </div>
    </div>

    <!-- Enhanced Discovery Modals -->
    <div id="enhancedSearchModal" class="enhanced-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Smart Multi-Source Search</h3>
                <button class="modal-close" onclick="closeEnhancedModal('enhancedSearchModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="search-form">
                    <input type="text" id="enhancedSearchInput" placeholder="Search for artists...">
                    <button onclick="performEnhancedSearch()">Search All Sources</button>
                </div>
                <div id="enhancedSearchResults" class="enhanced-results"></div>
            </div>
        </div>
    </div>

    <div id="duplicateModal" class="enhanced-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Duplicate Artist Detection</h3>
                <button class="modal-close" onclick="closeEnhancedModal('duplicateModal')">×</button>
            </div>
            <div class="modal-body">
                <button onclick="detectDuplicates()">Scan for Duplicates</button>
                <div id="duplicateResults" class="enhanced-results"></div>
            </div>
        </div>
    </div>

    <div id="enrichmentModal" class="enhanced-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Metadata Enrichment</h3>
                <button class="modal-close" onclick="closeEnhancedModal('enrichmentModal')">×</button>
            </div>
            <div class="modal-body">
                <p>Select artists to enrich with metadata from multiple sources:</p>
                <div class="artist-selection">
                    <button onclick="loadArtistsForEnrichment()">Load Artists</button>
                </div>
                <div id="enrichmentResults" class="enhanced-results"></div>
            </div>
        </div>
    </div>

    <div id="recommendationsModal" class="enhanced-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Artist Recommendations</h3>
                <button class="modal-close" onclick="closeEnhancedModal('recommendationsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="artist-selection">
                    <select id="recommendationArtist">
                        <option value="">Select an artist...</option>
                    </select>
                    <button onclick="getRecommendations()">Get Recommendations</button>
                </div>
                <div id="recommendationResults" class="enhanced-results"></div>
            </div>
        </div>
    </div>

    <!-- Search Status -->
    <div id="searchStatus" class="search-status" style="display: none;">
        <div class="loading-spinner">
            <img src="{{ url_for('static', filename='MVidarr.png') }}" alt="MVidarr" class="spinning mvidarr-logo-spinner" style="width: 20px; height: 20px;">
            <span id="searchStatusText">Searching YouTube...</span>
        </div>
    </div>

    <!-- Search Results -->
    <div id="searchResults" class="search-results-container" style="display: none;">
        <div class="results-header">
            <h2 id="resultsTitle">Search Results</h2>
            <p id="resultsCount" class="results-count"></p>
        </div>

        <!-- YouTube Results -->
        <div id="youtubeResults" class="results-section" style="display: none;">
            <h3 class="section-title">
                <iconify-icon icon="tabler:brand-youtube"></iconify-icon>
                YouTube Results
            </h3>
            <div id="youtubeResultsList" class="results-grid"></div>
        </div>

        <!-- No Results -->
        <div id="noResults" class="no-results" style="display: none;">
            <iconify-icon icon="tabler:search-off"></iconify-icon>
            <h3>No Results Found</h3>
            <p>Try different search terms or check your spelling</p>
        </div>
    </div>
</div>

<!-- Include the shared Add Video Modal component -->
{% include 'components/add_video_modal.html' %}

<style>
.discover-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.discover-header {
    text-align: center;
    margin-bottom: 40px;
}

.discover-header h1 {
    color: #00d4ff;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-description {
    color: #ccc;
    font-size: 1.1rem;
    margin: 0;
}

.search-section {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #444;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.1);
}

.search-input-wrapper {
    display: flex;
    gap: 15px;
    align-items: center;
}

.search-input {
    flex: 1;
    padding: 15px 20px;
    font-size: 16px;
    border: 2px solid #444;
    border-radius: 8px;
    background: #1a1a1a;
    color: #fff;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

.search-input::placeholder {
    color: #666;
}

.search-button {
    padding: 15px 25px;
    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.search-button:hover {
    background: linear-gradient(135deg, #0099cc 0%, #007799 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
}

.search-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

.search-status {
    text-align: center;
    padding: 30px;
    color: #00d4ff;
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 1.1rem;
}

.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.search-results-container {
    margin-top: 30px;
}

.results-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #00d4ff;
}

.results-header h2 {
    color: #00d4ff;
    font-size: 2rem;
    margin-bottom: 10px;
}

.results-count {
    color: #ccc;
    font-size: 1rem;
    margin: 0;
}

.results-section {
    margin-bottom: 40px;
}

.section-title {
    color: #00d4ff;
    font-size: 1.4rem;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.result-card {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #444;
    border-radius: 12px;
    padding: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    cursor: pointer;
}

.result-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.2);
    border-color: #00d4ff;
}

.result-content {
    display: flex;
    gap: 15px;
}

.result-thumbnail {
    flex-shrink: 0;
    width: 120px;
    height: 90px;
    border-radius: 8px;
    overflow: hidden;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
}

.result-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.result-thumbnail .placeholder {
    color: #666;
    font-size: 2rem;
}

.result-info {
    flex: 1;
    min-width: 0;
}

.result-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.result-artist {
    color: #00d4ff;
    font-size: 1rem;
    margin-bottom: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.result-meta {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.result-source {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #aaa;
    font-size: 0.9rem;
}

.result-year {
    color: #aaa;
    font-size: 0.9rem;
}

.result-actions {
    display: flex;
    gap: 10px;
}

.btn-add-video {
    padding: 8px 16px;
    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-add-video:hover {
    background: linear-gradient(135deg, #0099cc 0%, #007799 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
}

.no-results {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.no-results iconify-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.no-results h3 {
    color: #aaa;
    margin-bottom: 10px;
}

.no-results p {
    color: #666;
    margin: 0;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .discover-container {
        padding: 15px;
    }
    
    .discover-header h1 {
        font-size: 2rem;
    }
    
    .search-input-wrapper {
        flex-direction: column;
        gap: 15px;
    }
    
    .search-button {
        align-self: stretch;
        justify-content: center;
    }
    
    .results-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .result-content {
        flex-direction: column;
        text-align: center;
    }
    
    .result-thumbnail {
        align-self: center;
    }
    
    .result-title, .result-artist {
        white-space: normal;
        text-align: center;
    }
    
    .result-meta {
        justify-content: center;
    }
    
    .result-actions {
        justify-content: center;
    }
}

/* Enhanced Discovery Styles */
.enhanced-discovery-section {
    background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%);
    border: 1px solid #5a2d82;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(90, 45, 130, 0.2);
}

.section-header {
    text-align: center;
    margin-bottom: 30px;
}

.section-header h2 {
    color: #00d4ff;
    font-size: 1.8rem;
    margin-bottom: 8px;
}

.section-header p {
    color: #ccc;
    font-size: 1rem;
    margin: 0;
}

.discovery-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.feature-card {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #444;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.feature-card:hover {
    background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
    border-color: #00d4ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
}

.feature-card iconify-icon {
    font-size: 2.5rem;
    color: #00d4ff;
    margin-bottom: 15px;
    display: block;
}

.feature-card h3 {
    color: #fff;
    font-size: 1.1rem;
    margin-bottom: 10px;
}

.feature-card p {
    color: #aaa;
    font-size: 0.9rem;
    line-height: 1.4;
    margin: 0;
}

/* Enhanced Modal Styles */
.enhanced-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.enhanced-modal .modal-content {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #444;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.enhanced-modal .modal-header {
    background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #444;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.enhanced-modal .modal-header h3 {
    color: #00d4ff;
    font-size: 1.3rem;
    margin: 0;
}

.enhanced-modal .modal-close {
    background: none;
    border: none;
    color: #ccc;
    font-size: 1.5rem;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.enhanced-modal .modal-close:hover {
    background: #444;
    color: #fff;
}

.enhanced-modal .modal-body {
    padding: 25px;
}

.enhanced-modal .search-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.enhanced-modal .search-form input {
    flex: 1;
    padding: 10px;
    background: #2d2d2d;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    font-size: 1rem;
}

.enhanced-modal .search-form input:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
}

.enhanced-modal .search-form button,
.enhanced-modal .artist-selection button {
    padding: 10px 20px;
    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.enhanced-modal .search-form button:hover,
.enhanced-modal .artist-selection button:hover {
    background: linear-gradient(135deg, #0099cc 0%, #007799 100%);
    transform: translateY(-1px);
}

.enhanced-modal .artist-selection {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.enhanced-modal .artist-selection select {
    flex: 1;
    padding: 10px;
    background: #2d2d2d;
    border: 1px solid #444;
    border-radius: 6px;
    color: #fff;
    font-size: 1rem;
}

.enhanced-results {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 15px;
    max-height: 400px;
    overflow-y: auto;
}

.enhanced-results:empty {
    display: none;
}

.enhanced-result-item {
    background: #2d2d2d;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.enhanced-result-item:hover {
    border-color: #00d4ff;
    box-shadow: 0 2px 8px rgba(0, 212, 255, 0.1);
}

.enhanced-result-item h4 {
    color: #00d4ff;
    margin: 0 0 8px 0;
    font-size: 1.1rem;
}

.enhanced-result-item p {
    color: #ccc;
    margin: 5px 0;
    font-size: 0.9rem;
}

.enhanced-result-item .result-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.enhanced-result-item .result-meta span {
    background: #444;
    color: #ccc;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
}

.loading-indicator {
    text-align: center;
    padding: 20px;
    color: #aaa;
}

.loading-indicator img {
    margin-bottom: 10px;
}

@media (max-width: 768px) {
    .discovery-features {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .enhanced-modal .modal-content {
        width: 95%;
        margin: 20px;
    }
    
    .enhanced-modal .search-form,
    .enhanced-modal .artist-selection {
        flex-direction: column;
    }
}
</style>

<script>
// Discover page JavaScript functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('discoverSearchInput');
    const searchButton = document.getElementById('discoverSearchButton');
    const searchStatus = document.getElementById('searchStatus');
    const searchResults = document.getElementById('searchResults');
    const searchStatusText = document.getElementById('searchStatusText');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsCount = document.getElementById('resultsCount');
    const youtubeResults = document.getElementById('youtubeResults');
    const youtubeResultsList = document.getElementById('youtubeResultsList');
    const noResults = document.getElementById('noResults');

    // Auto-search if query parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get('q');
    if (initialQuery) {
        searchInput.value = initialQuery;
        performSearch(initialQuery);
    }

    // Search button click handler
    searchButton.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query) {
            performSearch(query);
            // Update URL without page reload
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('q', query);
            window.history.pushState({}, '', newUrl);
        }
    });

    // Enter key handler
    searchInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            searchButton.click();
        }
    });

    async function performSearch(query) {
        console.log('🔍 Starting discover search for:', query);
        showSearchStatus(true);
        hideResults();

        try {
            // Search YouTube only
            const youtubeData = await searchYouTube(query);

            console.log('📺 YouTube results:', youtubeData.length);

            if (youtubeData.length > 0) {
                displayResults(query, [], youtubeData);
            } else {
                showNoResults();
            }

        } catch (error) {
            console.error('❌ Search error:', error);
            showError('Search failed. Please try again.');
        } finally {
            showSearchStatus(false);
        }
    }

    async function searchYouTube(query) {
        try {
            const response = await fetch('/api/youtube/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    q: query,
                    maxResults: 50,  // Increased from 20 to YouTube API maximum
                    videoCategoryId: '10' // Music category
                })
            });
            
            if (!response.ok) {
                console.warn('⚠️ YouTube search failed:', response.status);
                return [];
            }
            
            const data = await response.json();
            const videos = data.items || [];
            
            return videos.map(video => ({
                id: video.id.videoId || video.id,
                title: video.snippet?.title || video.title || 'Unknown Title',
                artist: video.snippet?.channelTitle || 'Unknown Artist',
                source: 'YouTube',
                sourceIcon: '📺',
                thumbnail: video.snippet?.thumbnails?.medium?.url || video.thumbnail || '',
                url: `https://www.youtube.com/watch?v=${video.id.videoId || video.id}`,
                year: video.snippet?.publishedAt ? new Date(video.snippet.publishedAt).getFullYear() : null
            }));
        } catch (error) {
            console.error('❌ YouTube search error:', error);
            return [];
        }
    }

    function displayResults(query, imvdbData, youtubeData) {
        const totalResults = youtubeData.length;
        
        resultsTitle.textContent = `Search Results for "${query}"`;
        resultsCount.textContent = `Found ${totalResults} results`;
        
        // Display YouTube results only
        if (youtubeData.length > 0) {
            youtubeResultsList.innerHTML = youtubeData.map(video => createResultCard(video)).join('');
            youtubeResults.style.display = 'block';
        } else {
            youtubeResults.style.display = 'none';
        }
        
        searchResults.style.display = 'block';
        
        // Add event listeners to Add to Library buttons
        attachAddVideoListeners();
    }

    function createResultCard(video) {
        const escapedTitle = escapeHtml(video.title);
        const escapedArtist = escapeHtml(video.artist);
        
        return `
            <div class="result-card">
                <div class="result-content">
                    <div class="result-thumbnail">
                        ${video.thumbnail ? 
                            `<img src="${video.thumbnail}" alt="Thumbnail" onerror="this.src='/static/default-thumbnail.png'; this.onerror=null;">` :
                            `<div class="placeholder">🎵</div>`
                        }
                    </div>
                    <div class="result-info">
                        <div class="result-title">${video.sourceIcon} ${escapedTitle}</div>
                        <div class="result-artist">${escapedArtist}</div>
                        <div class="result-meta">
                            <div class="result-source">
                                <iconify-icon icon="${video.source === 'YouTube' ? 'tabler:brand-youtube' : 'tabler:video'}"></iconify-icon>
                                ${video.source}
                            </div>
                            ${video.year ? `<div class="result-year">${video.year}</div>` : ''}
                        </div>
                        <div class="result-actions">
                            <button class="btn-add-video" 
                                    data-source="${video.source}" 
                                    data-video-id="${video.id}" 
                                    data-title="${escapedTitle}" 
                                    data-artist="${escapedArtist}" 
                                    data-url="${video.url}">
                                <iconify-icon icon="tabler:plus"></iconify-icon>
                                Add to Library
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function attachAddVideoListeners() {
        const addButtons = document.querySelectorAll('.btn-add-video');
        addButtons.forEach(button => {
            button.addEventListener('click', function() {
                const source = this.dataset.source;
                const videoId = this.dataset.videoId;
                const title = this.dataset.title;
                const artist = this.dataset.artist;
                const url = this.dataset.url;
                
                // Use the shared Add Video modal functionality
                if (typeof addVideoToLibrary === 'function') {
                    addVideoToLibrary(source, videoId, title, artist, url);
                } else {
                    console.error('addVideoToLibrary function not available');
                    alert('Add to library functionality is not available');
                }
            });
        });
    }

    function showSearchStatus(show) {
        if (show) {
            searchStatus.style.display = 'block';
            searchButton.disabled = true;
            searchButton.innerHTML = `
                <img src="{{ url_for('static', filename='MVidarr.png') }}" alt="MVidarr" class="spinning mvidarr-logo-spinner" style="width: 20px; height: 20px;">
                Searching...
            `;
        } else {
            searchStatus.style.display = 'none';
            searchButton.disabled = false;
            searchButton.innerHTML = `
                <iconify-icon icon="tabler:search"></iconify-icon>
                Search
            `;
        }
    }

    function hideResults() {
        searchResults.style.display = 'none';
        youtubeResults.style.display = 'none';
        noResults.style.display = 'none';
    }

    function showNoResults() {
        searchResults.style.display = 'block';
        youtubeResults.style.display = 'none';
        noResults.style.display = 'block';
    }

    function showError(message) {
        if (typeof showToast === 'function') {
            showToast(message, 'error');
        } else {
            alert(message);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});

// Enhanced Discovery JavaScript Functions

function showEnhancedSearch() {
    document.getElementById('enhancedSearchModal').style.display = 'flex';
    document.getElementById('enhancedSearchInput').focus();
}

function showDuplicateDetection() {
    document.getElementById('duplicateModal').style.display = 'flex';
}

function showMetadataEnrichment() {
    document.getElementById('enrichmentModal').style.display = 'flex';
}

function showRecommendations() {
    document.getElementById('recommendationsModal').style.display = 'flex';
    loadArtistsForRecommendations();
}

function closeEnhancedModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    
    // Clear results when closing
    const resultsContainer = document.querySelector(`#${modalId} .enhanced-results`);
    if (resultsContainer) {
        resultsContainer.innerHTML = '';
    }
}

function performEnhancedSearch() {
    const searchInput = document.getElementById('enhancedSearchInput');
    const query = searchInput.value.trim();
    
    if (!query) {
        showToast('Please enter a search query', 'warning');
        return;
    }
    
    const resultsContainer = document.getElementById('enhancedSearchResults');
    showLoadingIndicator(resultsContainer, 'Searching across all sources...');
    
    fetch('/api/enhanced_discovery/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            max_results: 25
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayEnhancedSearchResults(resultsContainer, data.artists);
            showToast(`Found ${data.total_results} artists from multiple sources`, 'success');
        } else {
            showError(data.error || 'Enhanced search failed');
            resultsContainer.innerHTML = '<p>Search failed. Please try again.</p>';
        }
    })
    .catch(error => {
        console.error('Enhanced search error:', error);
        showError('Enhanced search failed');
        resultsContainer.innerHTML = '<p>Search failed. Please try again.</p>';
    });
}

function detectDuplicates() {
    const resultsContainer = document.getElementById('duplicateResults');
    showLoadingIndicator(resultsContainer, 'Scanning library for duplicates...');
    
    fetch('/api/enhanced_discovery/duplicates?limit=20')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayDuplicateResults(resultsContainer, data.duplicates);
            showToast(`Found ${data.total_duplicates} potential duplicates`, 'info');
        } else {
            showError(data.error || 'Duplicate detection failed');
            resultsContainer.innerHTML = '<p>Duplicate detection failed. Please try again.</p>';
        }
    })
    .catch(error => {
        console.error('Duplicate detection error:', error);
        showError('Duplicate detection failed');
        resultsContainer.innerHTML = '<p>Detection failed. Please try again.</p>';
    });
}

function loadArtistsForEnrichment() {
    fetch('/api/artists?limit=50')
    .then(response => response.json())
    .then(data => {
        if (data && data.artists) {
            // Show a selection interface for enrichment
            const enrichmentResults = document.getElementById('enrichmentResults');
            enrichmentResults.innerHTML = `
                <div class="artist-grid">
                    ${data.artists.slice(0, 10).map(artist => `
                        <div class="artist-item" data-artist-id="${artist.id}">
                            <input type="checkbox" id="artist_${artist.id}" value="${artist.id}">
                            <label for="artist_${artist.id}">${escapeHtml(artist.name)}</label>
                        </div>
                    `).join('')}
                </div>
                <button onclick="enrichSelectedArtists()" class="enrich-button">Enrich Selected Artists</button>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading artists:', error);
    });
}

function enrichSelectedArtists() {
    const checkboxes = document.querySelectorAll('#enrichmentResults input[type="checkbox"]:checked');
    const artistIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (artistIds.length === 0) {
        showToast('Please select at least one artist to enrich', 'warning');
        return;
    }
    
    const resultsContainer = document.getElementById('enrichmentResults');
    showLoadingIndicator(resultsContainer, `Enriching ${artistIds.length} artists...`);
    
    fetch('/api/enhanced_discovery/enrich', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            artist_ids: artistIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayEnrichmentResults(resultsContainer, data.results);
            showToast(`Enriched ${data.successful_enrichments} of ${data.total_artists} artists`, 'success');
        } else {
            showError(data.error || 'Enrichment failed');
            resultsContainer.innerHTML = '<p>Enrichment failed. Please try again.</p>';
        }
    })
    .catch(error => {
        console.error('Enrichment error:', error);
        showError('Enrichment failed');
        resultsContainer.innerHTML = '<p>Enrichment failed. Please try again.</p>';
    });
}

function loadArtistsForRecommendations() {
    const select = document.getElementById('recommendationArtist');
    
    fetch('/api/artists?limit=50')
    .then(response => response.json())
    .then(data => {
        if (data && data.artists) {
            select.innerHTML = '<option value="">Select an artist...</option>' +
                data.artists.map(artist => 
                    `<option value="${artist.id}">${escapeHtml(artist.name)}</option>`
                ).join('');
        }
    })
    .catch(error => {
        console.error('Error loading artists:', error);
    });
}

function getRecommendations() {
    const select = document.getElementById('recommendationArtist');
    const artistId = parseInt(select.value);
    
    if (!artistId) {
        showToast('Please select an artist', 'warning');
        return;
    }
    
    const resultsContainer = document.getElementById('recommendationResults');
    showLoadingIndicator(resultsContainer, 'Finding recommendations...');
    
    fetch('/api/enhanced_discovery/recommendations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            artist_id: artistId,
            limit: 15
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayRecommendationResults(resultsContainer, data.recommendations, data.base_artist);
            showToast(`Found ${data.total_recommendations} recommendations`, 'success');
        } else {
            showError(data.error || 'Recommendations failed');
            resultsContainer.innerHTML = '<p>Recommendations failed. Please try again.</p>';
        }
    })
    .catch(error => {
        console.error('Recommendations error:', error);
        showError('Recommendations failed');
        resultsContainer.innerHTML = '<p>Recommendations failed. Please try again.</p>';
    });
}

// Display functions for enhanced discovery results

function displayEnhancedSearchResults(container, artists) {
    if (!artists || artists.length === 0) {
        container.innerHTML = '<p>No artists found. Try different search terms.</p>';
        return;
    }
    
    container.innerHTML = artists.map(artist => `
        <div class="enhanced-result-item">
            <h4>${escapeHtml(artist.name)}</h4>
            <p><strong>Source:</strong> ${artist.source.toUpperCase()}</p>
            <p><strong>Confidence:</strong> ${Math.round(artist.confidence * 100)}%</p>
            ${artist.genres && artist.genres.length > 0 ? `<p><strong>Genres:</strong> ${artist.genres.slice(0, 3).join(', ')}</p>` : ''}
            ${artist.biography ? `<p><strong>Biography:</strong> ${escapeHtml(artist.biography)}</p>` : ''}
            <div class="result-meta">
                ${artist.formed_year ? `<span>Formed: ${artist.formed_year}</span>` : ''}
                ${artist.country ? `<span>${artist.country}</span>` : ''}
                <span>Quality: ${artist.quality_score}</span>
            </div>
        </div>
    `).join('');
}

function displayDuplicateResults(container, duplicates) {
    if (!duplicates || duplicates.length === 0) {
        container.innerHTML = '<p>No duplicate artists detected. Your library looks clean!</p>';
        return;
    }
    
    container.innerHTML = duplicates.map(duplicate => `
        <div class="enhanced-result-item">
            <h4>Potential Duplicate Match</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                <div>
                    <p><strong>Artist 1:</strong> ${escapeHtml(duplicate.artist_1.name)}</p>
                    <p><strong>Genres:</strong> ${duplicate.artist_1.genres || 'None'}</p>
                </div>
                <div>
                    <p><strong>Artist 2:</strong> ${escapeHtml(duplicate.artist_2.name)}</p>
                    <p><strong>Genres:</strong> ${duplicate.artist_2.genres || 'None'}</p>
                </div>
            </div>
            <div class="result-meta">
                <span>Similarity: ${Math.round(duplicate.similarity_score * 100)}%</span>
                <span>Action: ${duplicate.suggested_action}</span>
                <span>Factors: ${duplicate.matching_factors.join(', ')}</span>
            </div>
        </div>
    `).join('');
}

function displayEnrichmentResults(container, results) {
    container.innerHTML = results.map(result => `
        <div class="enhanced-result-item">
            <h4>${escapeHtml(result.name)}</h4>
            <p><strong>Status:</strong> ${result.success ? '✅ Enriched' : '❌ Failed'}</p>
            ${result.success && result.enriched_fields.length > 0 ? 
                `<p><strong>Added:</strong> ${result.enriched_fields.join(', ')}</p>` : ''}
            ${result.error ? `<p><strong>Error:</strong> ${escapeHtml(result.error)}</p>` : ''}
        </div>
    `).join('');
}

function displayRecommendationResults(container, recommendations, baseArtist) {
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<p>No recommendations found. Try selecting a different artist.</p>';
        return;
    }
    
    let html = `<div class="base-artist"><strong>Based on:</strong> ${escapeHtml(baseArtist.name)}</div>`;
    
    html += recommendations.map(rec => `
        <div class="enhanced-result-item">
            <h4>${escapeHtml(rec.name)}</h4>
            <p><strong>Source:</strong> ${rec.source.toUpperCase()}</p>
            <p><strong>Match:</strong> ${Math.round(rec.confidence * 100)}%</p>
            ${rec.genres && rec.genres.length > 0 ? `<p><strong>Genres:</strong> ${rec.genres.slice(0, 3).join(', ')}</p>` : ''}
            ${rec.biography ? `<p><strong>About:</strong> ${escapeHtml(rec.biography)}</p>` : ''}
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function showLoadingIndicator(container, message) {
    container.innerHTML = `
        <div class="loading-indicator">
            <img src="${document.querySelector('link[rel="icon"]').href}" alt="Loading" class="spinning mvidarr-logo-spinner" style="width: 30px; height: 30px;">
            <p>${message}</p>
        </div>
    `;
}

function showToast(message, type = 'info') {
    // Use existing toast functionality if available
    if (typeof showNotification === 'function') {
        showNotification(message, type);
    } else if (typeof showAlert === 'function') {
        showAlert(message, type);
    } else {
        // Fallback to alert
        alert(message);
    }
}

function showError(message) {
    showToast(message, 'error');
}

// Enhanced modal keyboard handling
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.enhanced-modal');
        modals.forEach(modal => {
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            }
        });
    }
});

// Enhanced search input Enter key handler
document.addEventListener('DOMContentLoaded', function() {
    const enhancedSearchInput = document.getElementById('enhancedSearchInput');
    if (enhancedSearchInput) {
        enhancedSearchInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                performEnhancedSearch();
            }
        });
    }
});
</script>
{% endblock %}