{% extends "base.html" %}

{% block title %}Settings - MVidarr{% endblock %}

{% block content %}
<div class="settings-container">
    
    <div class="settings-actions">
        <button onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
        <button onclick="restartApp()" class="btn btn-warning">Restart Application</button>
    </div>

    <!-- Settings Tabs -->
    <div class="settings-tabs">
        <button class="settings-tab-btn active" onclick="switchTab(event, 'general-tab')">
            <iconify-icon icon="tabler:settings" class="tab-icon"></iconify-icon> General
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'security-tab')">
            <iconify-icon icon="tabler:lock" class="tab-icon"></iconify-icon> Security
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'services-tab')">
            <iconify-icon icon="tabler:link" class="tab-icon"></iconify-icon> Services
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'downloads-tab')">
            <iconify-icon icon="tabler:download" class="tab-icon"></iconify-icon> Downloads
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'database-tab')">
            <iconify-icon icon="tabler:database" class="tab-icon"></iconify-icon> Database
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'system-tab')">
            <iconify-icon icon="tabler:tool" class="tab-icon"></iconify-icon> System
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'themes-tab')">
            <iconify-icon icon="tabler:palette" class="tab-icon"></iconify-icon> Themes
        </button>
    </div>

    <!-- Tab Content -->
    <div class="settings-tab-content">

        <!-- General Tab -->
        <div id="general-tab" class="settings-tab-panel active">
            <div class="settings-sections">
        <div class="settings-section">
            <h2>Application</h2>
            <div class="form-group">
                <label for="app_port">Port:</label>
                <input type="number" id="app_port" name="app_port" min="1" max="65535">
            </div>
            <div class="form-group">
                <label for="debug_mode">Debug Mode:</label>
                <select id="debug_mode" name="debug_mode">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="secret_key">Secret Key:</label>
                <input type="password" id="secret_key" name="secret_key" placeholder="Flask secret key for sessions">
            </div>
            <div class="form-group">
                <label for="require_authentication">Require User Authentication:</label>
                <select id="require_authentication" name="require_authentication">
                    <option value="false">Disabled - Open Access</option>
                    <option value="true">Enabled - Login Required</option>
                </select>
                <div class="form-help">
                    <small>When enabled, users must log in with username/password to access the system. Requires application restart to take effect.</small>
                </div>
            </div>
        </div>

        <div class="settings-section" id="userCredentialsSection" style="display: none;">
            <h2>üë§ User Credentials</h2>
            <div class="form-help">
                <small>Configure the username and password for accessing the system when authentication is enabled.</small>
            </div>
            <div class="form-group">
                <label for="auth_username">Username:</label>
                <input type="text" id="auth_username" name="auth_username" placeholder="Enter username" minlength="3">
                <div class="form-help">
                    <small>Username must be at least 3 characters long</small>
                </div>
            </div>
            <div class="form-group">
                <label for="auth_password">Password:</label>
                <input type="password" id="auth_password" name="auth_password" placeholder="Enter new password" minlength="6">
                <div class="form-help">
                    <small>Password must be at least 6 characters long</small>
                </div>
            </div>
            <div class="form-group">
                <label for="auth_password_confirm">Confirm Password:</label>
                <input type="password" id="auth_password_confirm" name="auth_password_confirm" placeholder="Confirm new password" minlength="6">
                <div class="form-help">
                    <small>Re-enter the password to confirm</small>
                </div>
            </div>
            <div class="form-group">
                <button onclick="updateCredentials()" class="btn btn-primary">üîë Update Credentials</button>
                <button onclick="resetCredentials()" class="btn btn-secondary">üîÑ Reset to Default</button>
            </div>
        </div>


        <div class="settings-section">
            <h2>Paths</h2>
            <div class="form-group">
                <label for="downloads_path">Downloads Directory:</label>
                <input type="text" id="downloads_path" name="downloads_path">
            </div>
            <div class="form-group">
                <label for="music_videos_path">Music Videos Directory:</label>
                <input type="text" id="music_videos_path" name="music_videos_path" placeholder="Organized music videos by artist">
            </div>
            <div class="form-group">
                <label for="thumbnails_path">Thumbnails Directory:</label>
                <input type="text" id="thumbnails_path" name="thumbnails_path">
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Security Tab -->
        <div id="security-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>üîí SSL/TLS Security</h2>
            <div class="form-group">
                <label for="ssl_required">Enforce HTTPS:</label>
                <select id="ssl_required" name="ssl_required">
                    <option value="false">Disabled - Allow HTTP</option>
                    <option value="true">Enabled - Redirect HTTP to HTTPS</option>
                </select>
                <div class="form-help">
                    <small>When enabled, all HTTP requests will be redirected to HTTPS. Requires SSL termination at reverse proxy or web server level.</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_port">HTTPS Port:</label>
                <input type="number" id="ssl_port" name="ssl_port" min="1" max="65535" value="443">
                <div class="form-help">
                    <small>Default port for HTTPS connections (typically 443).</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_hsts_enabled">HTTP Strict Transport Security (HSTS):</label>
                <select id="ssl_hsts_enabled" name="ssl_hsts_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
                <div class="form-help">
                    <small>HSTS tells browsers to only access the site over HTTPS. Only enable if SSL is properly configured.</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_hsts_max_age">HSTS Max Age (seconds):</label>
                <input type="number" id="ssl_hsts_max_age" name="ssl_hsts_max_age" min="300" max="31536000" value="31536000">
                <div class="form-help">
                    <small>How long browsers should enforce HTTPS-only access (31536000 = 1 year).</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_redirect_permanent">Use Permanent Redirects:</label>
                <select id="ssl_redirect_permanent" name="ssl_redirect_permanent">
                    <option value="false">Temporary (302)</option>
                    <option value="true">Permanent (301)</option>
                </select>
                <div class="form-help">
                    <small>Permanent redirects are cached by browsers and search engines.</small>
                </div>
            </div>
            <div class="ssl-warning">
                <strong>‚ö†Ô∏è Important:</strong> Only enable SSL enforcement if you have properly configured SSL termination at your reverse proxy (nginx, Apache, Cloudflare, etc.) or web server level. Enabling this without proper SSL setup will make the application inaccessible.
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Services Tab -->
        <div id="services-tab" class="settings-tab-panel">
            <div class="settings-sections">
        
        <div class="settings-section">
            <h2>Core Services</h2>
            <div class="form-group">
                <label for="imvdb_api_key">IMVDB API Key:</label>
                <input type="password" id="imvdb_api_key" name="imvdb_api_key">
            </div>
            <div class="form-group">
                <label for="youtube_api_key">YouTube API Key:</label>
                <input type="password" id="youtube_api_key" name="youtube_api_key">
            </div>
        </div>

        <div class="settings-section">
            <h2>YouTube Integration</h2>
            <div class="form-group">
                <label for="youtube_enabled">Enable YouTube Integration:</label>
                <select id="youtube_enabled" name="youtube_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="youtube_playlist_sync_interval">Playlist Sync Interval (minutes):</label>
                <input type="number" id="youtube_playlist_sync_interval" name="youtube_playlist_sync_interval" min="5" max="1440" value="60">
            </div>
            <div class="form-group">
                <label for="youtube_auto_download">Auto-download New Videos:</label>
                <select id="youtube_auto_download" name="youtube_auto_download">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="integration-actions">
                <button onclick="testYouTubeIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="syncYouTubePlaylists()" class="btn btn-secondary">Sync Playlists</button>
                <a href="/youtube-playlists" class="btn btn-primary">üì∫ YouTube Playlists Manager</a>
            </div>
        </div>

        <div class="settings-section">
            <h2>Spotify Integration</h2>
            <div class="form-group">
                <label for="spotify_enabled">Enable Spotify Integration:</label>
                <select id="spotify_enabled" name="spotify_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="spotify_client_id">Spotify Client ID:</label>
                <input type="text" id="spotify_client_id" name="spotify_client_id">
            </div>
            <div class="form-group">
                <label for="spotify_client_secret">Spotify Client Secret:</label>
                <input type="password" id="spotify_client_secret" name="spotify_client_secret">
            </div>
            <div class="form-group">
                <label for="spotify_redirect_uri">Redirect URI:</label>
                <input type="text" id="spotify_redirect_uri" name="spotify_redirect_uri" placeholder="http://localhost:5000/api/spotify/callback">
            </div>
            <div class="integration-actions">
                <button onclick="testSpotifyIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="authorizeSpotify()" class="btn btn-success">Authorize</button>
                <button onclick="importSpotifyPlaylists()" class="btn btn-secondary">Import Playlists</button>
                <a href="/spotify" class="btn btn-primary">üéµ Spotify Manager</a>
            </div>
        </div>



        <div class="settings-section">
            <h2>Lidarr Integration</h2>
            <div class="form-group">
                <label for="lidarr_enabled">Enable Lidarr Integration:</label>
                <select id="lidarr_enabled" name="lidarr_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lidarr_server_url">Lidarr Server URL:</label>
                <input type="text" id="lidarr_server_url" name="lidarr_server_url" placeholder="http://localhost:8686">
            </div>
            <div class="form-group">
                <label for="lidarr_api_key">Lidarr API Key:</label>
                <input type="password" id="lidarr_api_key" name="lidarr_api_key">
            </div>
            <div class="form-group">
                <label for="lidarr_sync_interval">Sync Interval (hours):</label>
                <input type="number" id="lidarr_sync_interval" name="lidarr_sync_interval" min="1" max="168" value="6">
            </div>
            <div class="form-group">
                <label for="lidarr_sync_monitored_only">Sync Monitored Artists Only:</label>
                <select id="lidarr_sync_monitored_only" name="lidarr_sync_monitored_only">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="integration-actions">
                <button onclick="testLidarrIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="syncLidarrLibrary()" class="btn btn-secondary">Sync Library</button>
                <button onclick="importLidarrArtists()" class="btn btn-secondary">Import Artists</button>
                <button onclick="syncLidarrAlbums()" class="btn btn-secondary">Sync Albums</button>
                <a href="/lidarr" class="btn btn-primary">üéµ Lidarr Manager</a>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Downloads Tab -->
        <div id="downloads-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>Download Settings</h2>
            <div class="form-group">
                <label for="auto_organize_downloads">Auto-organize Downloads:</label>
                <select id="auto_organize_downloads" name="auto_organize_downloads">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="auto_index_organized_videos">Auto-index Organized Videos:</label>
                <select id="auto_index_organized_videos" name="auto_index_organized_videos">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="video_quality_preference">Video Quality:</label>
                <select id="video_quality_preference" name="video_quality_preference">
                    <option value="best">Best Available</option>
                    <option value="1080p">1080p</option>
                    <option value="720p">720p</option>
                    <option value="480p">480p</option>
                </select>
            </div>
            <div class="form-group">
                <label for="download_subtitles">Download Closed Captions:</label>
                <select id="download_subtitles" name="download_subtitles">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
                <small class="help-text">Download and embed closed captions/subtitles when available</small>
            </div>
            
            <!-- YouTube Cookie Authentication -->
            <div class="form-group cookie-management-section">
                <label>üç™ YouTube Authentication:</label>
                <div class="cookie-upload-container">
                    <div id="cookieStatusSettings" class="cookie-status">
                        <span class="status-text">Checking cookie status...</span>
                    </div>
                    
                    <div class="cookie-actions">
                        <button type="button" id="uploadCookieBtnSettings" class="btn btn-success btn-sm" onclick="document.getElementById('cookieFileInputSettings').click()">
                            üì§ Upload Cookies
                        </button>
                        <button type="button" id="deleteCookieBtnSettings" class="btn btn-danger btn-sm" onclick="deleteCookiesSettings()" style="display: none;">
                            üóëÔ∏è Delete Cookies
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="showCookieInstructionsSettings()">
                            ‚ùì Help
                        </button>
                    </div>
                    
                    <input type="file" id="cookieFileInputSettings" accept=".txt,.cookies" style="display: none;" onchange="uploadCookiesSettings(this)">
                    
                    <small class="help-text">
                        Upload your YouTube cookies to enable downloads of age-restricted videos. 
                        The cookie file should be in Netscape format exported from your browser.
                    </small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="max_concurrent_downloads">Max Concurrent Downloads:</label>
                <input type="number" id="max_concurrent_downloads" name="max_concurrent_downloads" min="1" max="10">
            </div>
        </div>

        <div class="settings-section">
            <h2>Scheduled Downloads</h2>
            <div class="form-group">
                <label for="auto_download_schedule_enabled">Enable Scheduled Downloads:</label>
                <select id="auto_download_schedule_enabled" name="auto_download_schedule_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="auto_download_schedule_time">Schedule Time:</label>
                <input type="time" id="auto_download_schedule_time" name="auto_download_schedule_time" title="Time to run automatic downloads (24-hour format)">
            </div>
            <div class="form-group">
                <label for="auto_download_schedule_days">Schedule Frequency:</label>
                <select id="auto_download_schedule_days" name="auto_download_schedule_days">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly (Sunday)</option>
                    <option value="monday">Monday Only</option>
                    <option value="tuesday">Tuesday Only</option>
                    <option value="wednesday">Wednesday Only</option>
                    <option value="thursday">Thursday Only</option>
                    <option value="friday">Friday Only</option>
                    <option value="saturday">Saturday Only</option>
                    <option value="sunday">Sunday Only</option>
                    <option value="monday,wednesday,friday">Mon, Wed, Fri</option>
                    <option value="tuesday,thursday">Tue, Thu</option>
                    <option value="saturday,sunday">Weekends</option>
                </select>
            </div>
            <div class="form-group">
                <label for="auto_download_max_videos">Max Videos per Run:</label>
                <input type="number" id="auto_download_max_videos" name="auto_download_max_videos" min="1" max="500" title="Maximum number of videos to download per scheduled run">
            </div>
            <div class="form-group">
                <label>Scheduler Status:</label>
                <div id="scheduler-status">
                    <span id="scheduler-loading">Loading...</span>
                </div>
            </div>
            <div class="scheduler-actions">
                <button onclick="testScheduledDownload()" class="btn btn-info">Test Download Now</button>
                <button onclick="startScheduler()" class="btn btn-success">Start Scheduler</button>
                <button onclick="stopScheduler()" class="btn btn-warning">Stop Scheduler</button>
                <button onclick="reloadScheduler()" class="btn btn-secondary">Reload Schedule</button>
                <button onclick="refreshSchedulerStatus()" class="btn btn-light">Refresh Status</button>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Database Tab -->
        <div id="database-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>Database</h2>
            <div class="form-group">
                <label for="db_host">Database Host:</label>
                <input type="text" id="db_host" name="db_host">
            </div>
            <div class="form-group">
                <label for="db_port">Database Port:</label>
                <input type="number" id="db_port" name="db_port" min="1" max="65535">
            </div>
            <div class="form-group">
                <label for="db_name">Database Name:</label>
                <input type="text" id="db_name" name="db_name">
            </div>
            <div class="form-group">
                <label for="db_user">Database User:</label>
                <input type="text" id="db_user" name="db_user">
            </div>
            <div class="form-group">
                <label for="db_password">Database Password:</label>
                <input type="password" id="db_password" name="db_password">
            </div>
        </div>

        <div class="settings-section">
            <h2>Database Pool Settings</h2>
            <div class="form-group">
                <label for="db_pool_size">Pool Size:</label>
                <input type="number" id="db_pool_size" name="db_pool_size" min="1" max="100">
            </div>
            <div class="form-group">
                <label for="db_pool_overflow">Pool Overflow:</label>
                <input type="number" id="db_pool_overflow" name="db_pool_overflow" min="0" max="100">
            </div>
            <div class="form-group">
                <label for="db_pool_recycle">Pool Recycle (seconds):</label>
                <input type="number" id="db_pool_recycle" name="db_pool_recycle" min="300" max="86400">
            </div>
            <div class="form-group">
                <label for="db_pool_timeout">Pool Timeout (seconds):</label>
                <input type="number" id="db_pool_timeout" name="db_pool_timeout" min="5" max="300">
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- System Tab -->
        <div id="system-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>Video Indexing</h2>
            <div class="form-group">
                <label>Database Status:</label>
                <div id="indexing-stats">
                    <span id="stats-loading">Loading...</span>
                </div>
            </div>
            <div class="form-group">
                <label>IMVDB Connection:</label>
                <div id="imvdb-status">
                    <span id="imvdb-loading">Checking...</span>
                </div>
            </div>
            <div class="indexing-actions">
                <button onclick="testImvdbConnection()" class="btn btn-info">Test IMVDB Connection</button>
                <button onclick="indexAllVideos()" class="btn btn-primary">Index All Videos</button>
                <button onclick="indexAllVideosNoMeta()" class="btn btn-secondary">Index Without Metadata</button>
                <button onclick="scanVideoFiles()" class="btn btn-info">Scan Video Files</button>
                <button onclick="populateArtistThumbnails()" class="btn btn-warning">Populate Artist Thumbnails</button>
                <button onclick="fixMissingVideos()" class="btn btn-warning">Fix Missing Videos</button>
                <button onclick="cleanupZeroVideoArtists()" class="btn btn-danger">Remove Artists with 0 Videos</button>
                <button onclick="refreshStats()" class="btn btn-light">Refresh Stats</button>
            </div>
            <div id="indexing-progress" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <span id="progress-text">Processing...</span>
            </div>
            <div id="indexing-results" class="results-container" style="display: none;"></div>
        </div>

        <div class="settings-section">
            <h2>Logging</h2>
            <div class="form-group">
                <label for="log_level">Log Level:</label>
                <select id="log_level" name="log_level">
                    <option value="DEBUG">Debug</option>
                    <option value="INFO">Info</option>
                    <option value="WARNING">Warning</option>
                    <option value="ERROR">Error</option>
                    <option value="CRITICAL">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label for="log_max_size">Max Log File Size (bytes):</label>
                <input type="number" id="log_max_size" name="log_max_size" min="1048576" max="104857600">
            </div>
            <div class="form-group">
                <label for="log_backup_count">Log Backup Count:</label>
                <input type="number" id="log_backup_count" name="log_backup_count" min="1" max="20">
            </div>
        </div>
        
            </div>
        </div>

        <!-- Themes Tab -->
        <div id="themes-tab" class="settings-tab-panel">
            <div class="themes-container">
                
                <!-- Theme Actions -->
                <div class="theme-actions">
                    <button onclick="refreshThemes()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:refresh" style="margin-right: 5px;"></iconify-icon>
                        Refresh Themes
                    </button>
                </div>

                <!-- Theme Tabs -->
                <div class="theme-tabs">
                    <button class="theme-tab-btn active" onclick="switchThemeTab(event, 'browse-tab')">
                        <iconify-icon icon="tabler:grid-3x3" class="tab-icon"></iconify-icon> Browse Themes
                    </button>
                    <button class="theme-tab-btn" onclick="switchThemeTab(event, 'customize-tab')">
                        <iconify-icon icon="tabler:brush" class="tab-icon"></iconify-icon> Customize
                    </button>
                </div>

                <!-- Browse Themes Tab -->
                <div id="browse-tab" class="theme-tab-content active">
                    <div class="themes-grid-container">
                        <h3>Available Themes</h3>
                        <div id="themes-grid" class="themes-grid">
                            <!-- Themes will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Customize Tab -->
                <div id="customize-tab" class="theme-tab-content">
                    <div class="theme-customize-container">
                        <div class="customize-header">
                            <h3>Theme Customizer</h3>
                            <p class="customize-description">
                                Select a theme to customize its colors and properties. Changes are applied immediately as you make them.
                            </p>
                        </div>

                        <!-- Theme Selection for Customization -->
                        <div class="customize-theme-selection">
                            <h4>Select Theme to Customize</h4>
                            <div id="customize-theme-grid" class="customize-themes-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Color Customization Panel -->
                        <div id="color-customization-panel" class="color-panel" style="display: none;">
                            <div class="panel-header">
                                <h4 id="customizing-theme-name">Customizing: Theme Name</h4>
                                <div class="panel-actions">
                                    <button onclick="resetToDefault()" class="btn btn-secondary">
                                        <iconify-icon icon="tabler:refresh"></iconify-icon>
                                        Reset to Default
                                    </button>
                                    <button onclick="applyCurrentTheme()" class="btn btn-success">
                                        <iconify-icon icon="tabler:check"></iconify-icon>
                                        Apply Theme
                                    </button>
                                    <button onclick="saveCustomTheme()" class="btn btn-primary">
                                        <iconify-icon icon="tabler:device-floppy"></iconify-icon>
                                        Save as Custom
                                    </button>
                                    <button onclick="updateCurrentTheme()" class="btn btn-warning" id="update-theme-btn" style="display: none;">
                                        <iconify-icon icon="tabler:refresh"></iconify-icon>
                                        Update Theme
                                    </button>
                                </div>
                            </div>

                            <!-- Color Controls -->
                            <div class="color-controls">
                                <div class="color-groups">
                                    <!-- Background Colors -->
                                    <div class="color-group">
                                        <h5>Background Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="bg-primary">Primary Background:</label>
                                                <input type="color" id="bg-primary" data-css-var="--bg-primary">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-secondary">Secondary Background:</label>
                                                <input type="color" id="bg-secondary" data-css-var="--bg-secondary">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-tertiary">Tertiary Background:</label>
                                                <input type="color" id="bg-tertiary" data-css-var="--bg-tertiary">
                                                <span class="color-value">#3a3a3a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="sidebar-bg">Sidebar Background:</label>
                                                <input type="color" id="sidebar-bg" data-css-var="--sidebar-bg">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="sidebar-bg-secondary">Sidebar Secondary:</label>
                                                <input type="color" id="sidebar-bg-secondary" data-css-var="--sidebar-bg-secondary">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="search-bar-bg">Search Bar Background:</label>
                                                <input type="color" id="search-bar-bg" data-css-var="--search-bar-bg">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-modal">Modal Background:</label>
                                                <input type="color" id="bg-modal" data-css-var="--bg-modal">
                                                <span class="color-value">#333333</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-card">Card Background:</label>
                                                <input type="color" id="bg-card" data-css-var="--bg-card">
                                                <span class="color-value">#2a2a2a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-hover">Hover Background:</label>
                                                <input type="color" id="bg-hover" data-css-var="--bg-hover">
                                                <span class="color-value">#404040</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="top-bar-bg">Top Bar Background:</label>
                                                <input type="color" id="top-bar-bg" data-css-var="--top-bar-bg">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Text Colors -->
                                    <div class="color-group">
                                        <h5>Text Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="text-primary">Primary Text:</label>
                                                <input type="color" id="text-primary" data-css-var="--text-primary">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-secondary">Secondary Text:</label>
                                                <input type="color" id="text-secondary" data-css-var="--text-secondary">
                                                <span class="color-value">#cccccc</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-accent">Accent Text:</label>
                                                <input type="color" id="text-accent" data-css-var="--text-accent">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-muted">Muted Text:</label>
                                                <input type="color" id="text-muted" data-css-var="--text-muted">
                                                <span class="color-value">#888888</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-inverse">Inverse Text:</label>
                                                <input type="color" id="text-inverse" data-css-var="--text-inverse">
                                                <span class="color-value">#000000</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Button Colors -->
                                    <div class="color-group">
                                        <h5>Button Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="btn-primary-bg">Primary Button Background:</label>
                                                <input type="color" id="btn-primary-bg" data-css-var="--btn-primary-bg">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-primary-text">Primary Button Text:</label>
                                                <input type="color" id="btn-primary-text" data-css-var="--btn-primary-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-primary-hover">Primary Button Hover:</label>
                                                <input type="color" id="btn-primary-hover" data-css-var="--btn-primary-hover">
                                                <span class="color-value">#3a8eef</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-secondary-bg">Secondary Button Background:</label>
                                                <input type="color" id="btn-secondary-bg" data-css-var="--btn-secondary-bg">
                                                <span class="color-value">#666666</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-secondary-text">Secondary Button Text:</label>
                                                <input type="color" id="btn-secondary-text" data-css-var="--btn-secondary-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-secondary-hover">Secondary Button Hover:</label>
                                                <input type="color" id="btn-secondary-hover" data-css-var="--btn-secondary-hover">
                                                <span class="color-value">#777777</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-danger-bg">Danger Button Background:</label>
                                                <input type="color" id="btn-danger-bg" data-css-var="--btn-danger-bg">
                                                <span class="color-value">#dc3545</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-danger-text">Danger Button Text:</label>
                                                <input type="color" id="btn-danger-text" data-css-var="--btn-danger-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-danger-hover">Danger Button Hover:</label>
                                                <input type="color" id="btn-danger-hover" data-css-var="--btn-danger-hover">
                                                <span class="color-value">#c82333</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Border and Accent Colors -->
                                    <div class="color-group">
                                        <h5>Border & Accent Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="border-primary">Primary Border:</label>
                                                <input type="color" id="border-primary" data-css-var="--border-primary">
                                                <span class="color-value">#444444</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-secondary">Secondary Border:</label>
                                                <input type="color" id="border-secondary" data-css-var="--border-secondary">
                                                <span class="color-value">#555555</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-focus">Focus Border:</label>
                                                <input type="color" id="border-focus" data-css-var="--border-focus">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-hover">Hover Border:</label>
                                                <input type="color" id="border-hover" data-css-var="--border-hover">
                                                <span class="color-value">#666666</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Status Colors -->
                                    <div class="color-group">
                                        <h5>Status Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="success-color">Success Color:</label>
                                                <input type="color" id="success-color" data-css-var="--success">
                                                <span class="color-value">#28a745</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="success-dark">Success Dark:</label>
                                                <input type="color" id="success-dark" data-css-var="--success-dark">
                                                <span class="color-value">#1e7e34</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="warning-color">Warning Color:</label>
                                                <input type="color" id="warning-color" data-css-var="--warning">
                                                <span class="color-value">#ffc107</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="warning-dark">Warning Dark:</label>
                                                <input type="color" id="warning-dark" data-css-var="--warning-dark">
                                                <span class="color-value">#d39e00</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="error-color">Error Color:</label>
                                                <input type="color" id="error-color" data-css-var="--error">
                                                <span class="color-value">#dc3545</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="error-color-alt">Error Color Alt:</label>
                                                <input type="color" id="error-color-alt" data-css-var="--error-color">
                                                <span class="color-value">#ff6b6b</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="info-color">Info Color:</label>
                                                <input type="color" id="info-color" data-css-var="--info">
                                                <span class="color-value">#17a2b8</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="info-dark">Info Dark:</label>
                                                <input type="color" id="info-dark" data-css-var="--info-dark">
                                                <span class="color-value">#117a8b</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Form Colors -->
                                    <div class="color-group">
                                        <h5>Form & Input Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="input-bg">Input Background:</label>
                                                <input type="color" id="input-bg" data-css-var="--input-bg">
                                                <span class="color-value">#3a3a3a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-text">Input Text:</label>
                                                <input type="color" id="input-text" data-css-var="--input-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-border">Input Border:</label>
                                                <input type="color" id="input-border" data-css-var="--input-border">
                                                <span class="color-value">#555555</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-focus">Input Focus:</label>
                                                <input type="color" id="input-focus" data-css-var="--input-focus">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Navigation Colors -->
                                    <div class="color-group">
                                        <h5>Navigation Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="nav-bg">Navigation Background:</label>
                                                <input type="color" id="nav-bg" data-css-var="--nav-bg">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="nav-text">Navigation Text:</label>
                                                <input type="color" id="nav-text" data-css-var="--nav-text">
                                                <span class="color-value">#cccccc</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="nav-hover">Navigation Hover:</label>
                                                <input type="color" id="nav-hover" data-css-var="--nav-hover">
                                                <span class="color-value">#404040</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="nav-active">Navigation Active:</label>
                                                <input type="color" id="nav-active" data-css-var="--nav-active">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal & Accent Colors -->
                                    <div class="color-group">
                                        <h5>Modal & Accent Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="accent-secondary">Accent Secondary:</label>
                                                <input type="color" id="accent-secondary" data-css-var="--accent-secondary">
                                                <span class="color-value">#0099cc</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="accent-dark">Accent Dark:</label>
                                                <input type="color" id="accent-dark" data-css-var="--accent-dark">
                                                <span class="color-value">#007799</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Live Preview -->
                            <div class="theme-preview-section">
                                <h5>Live Preview</h5>
                                <div class="preview-container">
                                    <!-- Live Theme Preview Content -->
                                    <div class="preview-section">
                                        <h6>Cards & Panels</h6>
                                        <div class="preview-cards">
                                            <div class="preview-card">
                                                <div class="card-header">Album Title</div>
                                                <div class="card-content">This shows how cards look in the current theme</div>
                                            </div>
                                            <div class="preview-card">
                                                <div class="card-header">Artist Name</div>
                                                <div class="card-content">Secondary card example</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Buttons & Controls</h6>
                                        <div class="preview-buttons">
                                            <button class="preview-btn-primary">Primary Button</button>
                                            <button class="preview-btn-secondary">Secondary Button</button>
                                            <button class="preview-btn-danger">Danger Button</button>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Form Elements</h6>
                                        <div class="preview-form">
                                            <div class="form-group">
                                                <label>Input Field:</label>
                                                <input type="text" placeholder="Sample input text" class="preview-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Select Dropdown:</label>
                                                <select class="preview-select">
                                                    <option>Option 1</option>
                                                    <option>Option 2</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Navigation & Menu</h6>
                                        <div class="preview-nav">
                                            <div class="nav-item active">Active Item</div>
                                            <div class="nav-item">Regular Item</div>
                                            <div class="nav-item">Another Item</div>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Status Messages</h6>
                                        <div class="preview-alerts">
                                            <div class="alert-success">‚úì Success message</div>
                                            <div class="alert-warning">‚ö† Warning message</div>
                                            <div class="alert-error">‚úó Error message</div>
                                            <div class="alert-info">‚Ñπ Info message</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    </div>
    
    <!-- Duplicate Save Settings button at bottom -->
    <div class="settings-actions bottom-actions">
        <button onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
    </div>
</div>

<script>

// Tab switching functionality
function switchTab(event, tabId) {
    // Remove active class from all tabs and panels
    const tabButtons = document.querySelectorAll('.settings-tab-btn');
    const tabPanels = document.querySelectorAll('.settings-tab-panel');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabPanels.forEach(panel => panel.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding panel
    event.target.classList.add('active');
    const targetPanel = document.getElementById(tabId);
    if (targetPanel) {
        targetPanel.classList.add('active');
    }
    
    // Update URL hash for navigation
    window.location.hash = tabId;
}

// Initialize tab based on URL hash
function initializeTab() {
    const hash = window.location.hash.substring(1);
    if (hash && document.getElementById(hash)) {
        const tabButton = document.querySelector(`[onclick*="${hash}"]`);
        if (tabButton) {
            // Simulate click on the tab
            tabButton.click();
        }
    }
}

// Handle hash changes
window.addEventListener('hashchange', initializeTab);

function loadSettings() {
    // Load regular settings
    fetch('/api/settings/')
        .then(response => response.json())
        .then(data => {
            const settings = data.settings;
            
            // Populate form fields
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = settings[key].value;
                }
            });
            
            // After settings are loaded, update the user credentials section visibility
            updateUserCredentialsSection();
        })
        .catch(error => {
            console.error('Error loading settings:', error);
            if (typeof showError === 'function') {
                showError('Error loading settings');
            } else {
                alert('Error loading settings');
            }
        });
    
    // Load database configuration separately
    fetch('/api/settings/database-config')
        .then(response => response.json())
        .then(data => {
            const dbConfig = data.database_config;
            
            // Populate database configuration fields
            Object.keys(dbConfig).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = dbConfig[key];
                    // Make database fields read-only since they come from environment
                    element.readOnly = true;
                    element.classList.add('readonly-field');
                    element.title = 'This value is read from environment variables and cannot be edited here';
                }
            });
        })
        .catch(error => {
            console.error('Error loading database config:', error);
            // Don't show error for database config as it's supplementary
        });
}

// Update user credentials section visibility based on authentication setting
function updateUserCredentialsSection() {
    const authEnabled = document.getElementById('require_authentication').value === 'true';
    const credentialsSection = document.getElementById('userCredentialsSection');
    
    if (credentialsSection) {
        if (authEnabled) {
            credentialsSection.style.display = 'block';
        } else {
            credentialsSection.style.display = 'none';
        }
    }
}

// Set up authentication toggle event listener and load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load settings when page loads
    loadSettings();
    
    // Set up authentication toggle event listener
    const authToggle = document.getElementById('require_authentication');
    if (authToggle) {
        authToggle.addEventListener('change', updateUserCredentialsSection);
    }
    
    // Initialize tab from URL hash
    initializeTab();
});

function saveSettings() {
    const settingsData = {};
    
    // Collect all form values
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.name) {
            settingsData[input.name] = input.value;
        }
    });
    
    fetch('/api/settings/bulk', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ settings: settingsData })
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            if (typeof showError === 'function') {
                showError('Error: ' + result.error);
            } else {
                alert('Error: ' + result.error);
            }
        } else {
            if (typeof showSuccess === 'function') {
                showSuccess('Settings saved successfully!');
            } else {
                alert('Settings saved successfully!');
            }
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        if (typeof showError === 'function') {
            showError('Error saving settings');
        } else {
            alert('Error saving settings');
        }
    });
}

function restartApp() {
    const message = 'Are you sure you want to restart the application?';
    
    // Check if toastConfirm is available, otherwise use standard confirm
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedRestart();
        });
    } else {
        if (confirm(message)) {
            proceedRestart();
        }
    }
}

function proceedRestart() {
    fetch('/api/settings/restart', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (typeof showInfo === 'function') {
            showInfo('Application restart initiated. Please wait a moment and refresh the page.');
        } else {
            alert('Application restart initiated. Please wait a moment and refresh the page.');
        }
    })
    .catch(error => {
        console.error('Error restarting application:', error);
        if (typeof showError === 'function') {
            showError('Error restarting application');
        } else {
            alert('Error restarting application');
        }
    });
}

// Video Indexing Functions
function loadIndexingStats() {
    fetch('/api/video-indexing/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('indexing-stats').innerHTML = 
                    '<span class="error">Error loading stats: ' + data.error + '</span>';
            } else {
                const stats = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <strong>Artists:</strong> ${data.total_artists}
                        </div>
                        <div class="stat-item">
                            <strong>Videos:</strong> ${data.total_videos}
                        </div>
                        <div class="stat-item">
                            <strong>Downloaded:</strong> ${data.downloaded_videos}
                        </div>
                        <div class="stat-item">
                            <strong>With Files:</strong> ${data.videos_with_files}
                        </div>
                        <div class="stat-item">
                            <strong>IMVDb Data:</strong> ${data.videos_with_imvdb}
                        </div>
                        <div class="stat-item">
                            <strong>Coverage:</strong> ${data.imvdb_coverage}%
                        </div>
                    </div>
                `;
                document.getElementById('indexing-stats').innerHTML = stats;
                
                // Add thumbnail stats if available
                if (data.thumbnail_stats) {
                    const thumbStats = data.thumbnail_stats;
                    const thumbInfo = `
                        <div class="thumbnail-stats">
                            <strong>Thumbnails:</strong> ${thumbStats.total_files} files (${thumbStats.total_size_mb} MB)
                        </div>
                    `;
                    document.getElementById('indexing-stats').innerHTML += thumbInfo;
                }
            }
        })
        .catch(error => {
            console.error('Error loading indexing stats:', error);
            document.getElementById('indexing-stats').innerHTML = 
                '<span class="error">Failed to load stats</span>';
        });
}

function checkImvdbConnection() {
    fetch('/api/video-indexing/imvdb/test')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('imvdb-status');
            if (data.status === 'success') {
                statusElement.innerHTML = '<span class="success">‚úÖ Connected</span>';
            } else if (data.status === 'error' && data.message.includes('api key')) {
                statusElement.innerHTML = '<span class="warning">‚ö†Ô∏è API Key not configured</span>';
            } else {
                statusElement.innerHTML = '<span class="error">‚ùå Connection failed</span>';
            }
        })
        .catch(error => {
            console.error('Error checking IMVDb connection:', error);
            document.getElementById('imvdb-status').innerHTML = 
                '<span class="error">‚ùå Check failed</span>';
        });
}

function testImvdbConnection() {
    const statusElement = document.getElementById('imvdb-status');
    statusElement.innerHTML = '<span class="loading">üîÑ Testing...</span>';
    
    fetch('/api/video-indexing/imvdb/test')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusElement.innerHTML = '<span class="success">‚úÖ Connection successful!</span>';
                if (typeof showSuccess === 'function') {
                    showSuccess('IMVDb connection test passed! API is working correctly.');
                } else {
                    alert('IMVDb connection test passed! API is working correctly.');
                }
            } else {
                statusElement.innerHTML = '<span class="error">‚ùå Connection failed</span>';
                if (typeof showError === 'function') {
                    showError('IMVDb connection failed: ' + data.message);
                } else {
                    alert('IMVDb connection failed: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error testing IMVDb connection:', error);
            statusElement.innerHTML = '<span class="error">‚ùå Test failed</span>';
            if (typeof showError === 'function') {
                showError('IMVDb connection test failed: ' + error.message);
            } else {
                alert('IMVDb connection test failed: ' + error.message);
            }
        });
}

function scanVideoFiles() {
    showProgress('Scanning video files...');
    
    fetch('/api/video-indexing/scan-files')
        .then(response => response.json())
        .then(data => {
            hideProgress();
            if (data.error) {
                showResults('<span class="error">Scan failed: ' + data.error + '</span>');
            } else {
                const result = `
                    <div class="scan-results">
                        <h4>üìÅ Video Files Scan Results</h4>
                        <p><strong>Directory:</strong> ${data.directory}</p>
                        <p><strong>Total video files found:</strong> ${data.count}</p>
                        <p>Ready for indexing: ${data.count} files</p>
                    </div>
                `;
                showResults(result);
            }
        })
        .catch(error => {
            hideProgress();
            console.error('Error scanning video files:', error);
            showResults('<span class="error">Scan failed: ' + error.message + '</span>');
        });
}

function indexAllVideos() {
    const message = 'This will index all videos in your music videos directory with IMVDb metadata. This may take a while. Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedIndexAllVideos();
        });
    } else {
        if (confirm(message)) {
            proceedIndexAllVideos();
        }
    }
}

function proceedIndexAllVideos() {
    
    startIndexing(true);
}

function indexAllVideosNoMeta() {
    const message = 'This will index all videos without fetching metadata (faster). Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedIndexAllVideosNoMeta();
        });
    } else {
        if (confirm(message)) {
            proceedIndexAllVideosNoMeta();
        }
    }
}

function proceedIndexAllVideosNoMeta() {
    
    startIndexing(false);
}

function startIndexing(fetchMetadata) {
    showProgress('Starting video indexing...');
    
    const requestData = {
        fetch_metadata: fetchMetadata,
        max_files: null // Process all files
    };
    
    fetch('/api/video-indexing/index-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            const summary = data.summary;
            const result = `
                <div class="indexing-results">
                    <h4>üé¨ Video Indexing Complete</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Total files:</strong> ${summary.total_files}
                        </div>
                        <div class="result-item">
                            <strong>Successfully indexed:</strong> ${summary.successful}
                        </div>
                        <div class="result-item">
                            <strong>Already indexed:</strong> ${summary.already_indexed}
                        </div>
                        <div class="result-item">
                            <strong>Failed:</strong> ${summary.failed}
                        </div>
                        <div class="result-item">
                            <strong>Artists created:</strong> ${summary.artists_created}
                        </div>
                        <div class="result-item">
                            <strong>Videos created:</strong> ${summary.videos_created}
                        </div>
                        ${fetchMetadata ? `
                        <div class="result-item">
                            <strong>IMVDb metadata found:</strong> ${summary.imvdb_metadata_found}
                        </div>
                        <div class="result-item">
                            <strong>Thumbnails downloaded:</strong> ${summary.thumbnails_downloaded}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            showResults(result);
            
            // Refresh stats after indexing
            setTimeout(refreshStats, 1000);
        } else {
            showResults('<span class="error">Indexing failed: ' + data.error + '</span>');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error during indexing:', error);
        showResults('<span class="error">Indexing failed: ' + error.message + '</span>');
    });
}

function refreshStats() {
    loadIndexingStats();
    checkImvdbConnection();
}

function populateArtistThumbnails() {
    const message = 'This will scan all artists missing thumbnails and attempt to find images from IMVDb and Wikipedia. This may take a while. Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedPopulateArtistThumbnails();
        });
    } else {
        if (confirm(message)) {
            proceedPopulateArtistThumbnails();
        }
    }
}

function proceedPopulateArtistThumbnails() {
    
    showProgress('Scanning artists for missing thumbnails...');
    
    fetch('/api/artists/scan-missing-thumbnails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            const result = `
                <div class="scan-results">
                    <h4>üñºÔ∏è Artist Thumbnail Scan Complete</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Artists without thumbnails:</strong> ${data.missing_count}
                        </div>
                        <div class="result-item">
                            <strong>Thumbnails found:</strong> ${data.updated_count}
                        </div>
                        <div class="result-item">
                            <strong>Success rate:</strong> ${data.missing_count > 0 ? Math.round((data.updated_count / data.missing_count) * 100) : 0}%
                        </div>
                    </div>
                    <p>${data.message}</p>
                </div>
            `;
            showResults(result);
            
            // Refresh stats after thumbnail scan
            setTimeout(refreshStats, 1000);
        } else {
            showResults('<span class="error">Thumbnail scan failed: ' + data.error + '</span>');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error scanning thumbnails:', error);
        showResults('<span class="error">Thumbnail scan failed: ' + error.message + '</span>');
    });
}

function showProgress(text) {
    document.getElementById('progress-text').textContent = text;
    document.getElementById('indexing-progress').style.display = 'block';
    document.getElementById('indexing-results').style.display = 'none';
    
    // Disable buttons during processing
    const buttons = document.querySelectorAll('.indexing-actions button');
    buttons.forEach(btn => btn.disabled = true);
}

function hideProgress() {
    document.getElementById('indexing-progress').style.display = 'none';
    
    // Re-enable buttons
    const buttons = document.querySelectorAll('.indexing-actions button');
    buttons.forEach(btn => btn.disabled = false);
}

function showResults(html) {
    document.getElementById('indexing-results').innerHTML = html;
    document.getElementById('indexing-results').style.display = 'block';
}

function fixMissingVideos() {
    const message = 'This will scan all videos marked as downloaded and check if their files exist. Missing videos will be marked as wanted for re-download and artists will be monitored. Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedFixMissingVideos();
        });
    } else {
        if (confirm(message)) {
            proceedFixMissingVideos();
        }
    }
}

function proceedFixMissingVideos() {
    showProgress('Fixing missing videos...');
    
    fetch('/api/videos/recovery/fix-missing', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        if (data.error) {
            showResults('<span class="error">Fix missing videos failed: ' + data.error + '</span>');
        } else {
            const stats = data.statistics;
            const result = `
                <div class="fix-missing-results">
                    <h4>üîß Fix Missing Videos Complete</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Downloaded videos checked:</strong> ${stats.total_downloaded}
                        </div>
                        <div class="result-item">
                            <strong>Videos with missing files:</strong> ${stats.missing_files}
                        </div>
                        <div class="result-item">
                            <strong>Videos recovered:</strong> ${stats.recovered_videos}
                        </div>
                        <div class="result-item">
                            <strong>Videos marked as wanted:</strong> ${stats.marked_wanted}
                        </div>
                        <div class="result-item">
                            <strong>Artists set to monitored:</strong> ${stats.artists_monitored}
                        </div>
                    </div>
                    ${stats.missing_files > 0 ? 
                        `<p class="success-message">‚úÖ Successfully processed ${stats.missing_files} missing videos!</p>` :
                        `<p class="success-message">‚úÖ No missing videos found! All downloaded videos have valid file paths.</p>`
                    }
                </div>
            `;
            showResults(result);
            
            // Show success toast
            if (typeof showSuccess === 'function') {
                showSuccess(`Fixed ${stats.missing_files} missing videos: ${stats.recovered_videos} recovered, ${stats.marked_wanted} marked as wanted`);
            }
            
            // Refresh stats to show updated data
            loadIndexingStats();
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error fixing missing videos:', error);
        showResults('<span class="error">Fix missing videos failed: ' + error.message + '</span>');
        
        if (typeof showError === 'function') {
            showError('Failed to fix missing videos: ' + error.message);
        }
    });
}

function cleanupZeroVideoArtists() {
    const message = 'This will permanently delete ALL artists with 0 videos associated. This action cannot be undone. Are you sure you want to continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedCleanupZeroVideoArtists();
        });
    } else {
        if (confirm(message)) {
            proceedCleanupZeroVideoArtists();
        }
    }
}

function proceedCleanupZeroVideoArtists() {
    
    showProgress('Removing artists with 0 videos...');
    
    fetch('/api/artists/cleanup-zero-videos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            if (data.deleted_count > 0) {
                const result = `
                    <div class="cleanup-results">
                        <h4>üóëÔ∏è Artist Cleanup Complete</h4>
                        <div class="results-grid">
                            <div class="result-item">
                                <strong>Artists removed:</strong> ${data.deleted_count}
                            </div>
                        </div>
                        <div class="deleted-artists">
                            <strong>Deleted artists:</strong>
                            <ul>
                                ${data.deleted_artists.map(name => `<li>${name}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                showResults(result);
                
                // Refresh stats after cleanup
                setTimeout(refreshStats, 1000);
            } else {
                showResults('<div class="cleanup-results"><h4>‚ÑπÔ∏è No Artists Found</h4><p>No artists with 0 videos found to remove.</p></div>');
            }
        } else {
            showResults('<span class="error">Cleanup failed: ' + data.error + '</span>');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error cleaning up artists:', error);
        showResults('<span class="error">Cleanup failed: ' + error.message + '</span>');
    });
}

// Scheduler management functions
function refreshSchedulerStatus() {
    // Set loading status - check if element exists first
    const loadingElement = document.getElementById('scheduler-loading');
    if (loadingElement) {
        loadingElement.textContent = 'Loading...';
    } else {
        // Element doesn't exist (likely already replaced), show loading in status div
        const statusDiv = document.getElementById('scheduler-status');
        if (statusDiv) {
            statusDiv.innerHTML = '<span id="scheduler-loading">Loading...</span>';
        }
    }
    
    fetch('/api/settings/scheduler/status')
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('scheduler-status');
        const scheduler = data.scheduler;
        
        const scheduleInfo = scheduler.schedule_info;
        const nextRun = scheduleInfo.next_run_human ? scheduleInfo.next_run_human : 'Not scheduled';
        
        if (scheduler.running) {
            statusDiv.innerHTML = `
                <div class="status-info">
                    <div class="status-item running">
                        <strong>Service Status:</strong> Running
                    </div>
                    <div class="status-item">
                        <strong>Scheduling Enabled:</strong> ${scheduleInfo.enabled ? 'Yes' : 'No'}
                    </div>
                    ${scheduleInfo.enabled ? `
                    <div class="status-item">
                        <strong>Schedule:</strong> ${scheduleInfo.schedule_days} at ${scheduleInfo.schedule_time}
                    </div>
                    <div class="status-item">
                        <strong>Max Videos:</strong> ${scheduleInfo.max_videos}
                    </div>
                    <div class="status-item">
                        <strong>Next Run:</strong> ${nextRun}
                    </div>
                    <div class="status-item">
                        <strong>Active Jobs:</strong> ${scheduleInfo.job_count || 0}
                    </div>
                    ` : `
                    <div class="status-item warning">
                        <strong>Note:</strong> Scheduling is disabled. Enable it in settings to schedule downloads.
                    </div>
                    `}
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="status-info">
                    <div class="status-item ${scheduleInfo.enabled ? 'warning' : 'stopped'}">
                        <strong>Service Status:</strong> ${scheduleInfo.enabled ? 'Scheduled (Service Stopped)' : 'Not Scheduled'}
                    </div>
                    <div class="status-item">
                        <strong>Scheduling Enabled:</strong> ${scheduleInfo.enabled ? 'Yes' : 'No'}
                    </div>
                    ${scheduleInfo.enabled ? `
                    <div class="status-item">
                        <strong>Configured Schedule:</strong> ${scheduleInfo.schedule_days} at ${scheduleInfo.schedule_time}
                    </div>
                    <div class="status-item warning">
                        <strong>Note:</strong> Scheduler service needs to be started to run scheduled downloads
                    </div>
                    ` : `
                    <div class="status-item">
                        <strong>Note:</strong> Enable scheduling in settings to schedule automatic downloads
                    </div>
                    `}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error getting scheduler status:', error);
        const statusDiv = document.getElementById('scheduler-status');
        if (statusDiv) {
            statusDiv.innerHTML = '<span class="error">Error loading status</span>';
        }
    });
}

function startScheduler() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Starting scheduler...</span>';
    }
    
    fetch('/api/settings/scheduler/start', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showSuccess(data.message);
            refreshSchedulerStatus();
        } else {
            showError('Failed to start scheduler: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error starting scheduler:', error);
        showError('Error starting scheduler: ' + error.message);
        refreshSchedulerStatus();
    });
}

function stopScheduler() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Stopping scheduler...</span>';
    }
    
    fetch('/api/settings/scheduler/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showSuccess(data.message);
            refreshSchedulerStatus();
        } else {
            showError('Failed to stop scheduler: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error stopping scheduler:', error);
        showError('Error stopping scheduler: ' + error.message);
        refreshSchedulerStatus();
    });
}

function reloadScheduler() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Reloading scheduler configuration...</span>';
    }
    
    fetch('/api/settings/scheduler/reload', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showSuccess(data.message);
            refreshSchedulerStatus();
        } else {
            showError('Failed to reload scheduler: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error reloading scheduler:', error);
        showError('Error reloading scheduler: ' + error.message);
        refreshSchedulerStatus();
    });
}

function testScheduledDownload() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Running test download...</span>';
    }
    
    fetch('/api/settings/scheduler/trigger', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            const result = data.result;
            const message = `${data.message}<br>
                           Success: ${result.success_count} videos queued<br>
                           Failed: ${result.failed_count} videos<br>
                           Total Wanted: ${result.total_wanted} videos`;
            showSuccess(message);
            refreshSchedulerStatus();
        } else {
            showError('Test download failed: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error running test download:', error);
        showError('Error running test download: ' + error.message);
        refreshSchedulerStatus();
    });
}

// External Services Integration Functions
function testYouTubeIntegration() {
    showIntegrationLoading('YouTube');
    
    fetch('/api/youtube/playlists/test', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('YouTube integration test passed! API is working correctly.');
        } else {
            showErrorMessage('YouTube integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing YouTube integration:', error);
        showErrorMessage('YouTube integration test failed: ' + error.message);
    });
}

function syncYouTubePlaylists() {
    showIntegrationLoading('YouTube');
    
    fetch('/api/youtube/playlists/sync', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccessMessage(`YouTube playlists synced successfully! ${data.synced_count} playlists processed.`);
        } else {
            showErrorMessage('YouTube playlist sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing YouTube playlists:', error);
        showErrorMessage('YouTube playlist sync failed: ' + error.message);
    });
}

function testSpotifyIntegration() {
    showIntegrationLoading('Spotify');
    
    fetch('/api/spotify/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('Spotify integration test passed! API credentials are valid.');
        } else {
            showErrorMessage('Spotify integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing Spotify integration:', error);
        showErrorMessage('Spotify integration test failed: ' + error.message);
    });
}

function authorizeSpotify() {
    fetch('/api/spotify/authorize', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.authorization_url) {
            window.open(data.authorization_url, '_blank');
            showInfoMessage('Please complete authorization in the new window, then test the connection.');
        } else {
            showErrorMessage('Failed to get Spotify authorization URL: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error authorizing Spotify:', error);
        showErrorMessage('Spotify authorization failed: ' + error.message);
    });
}

function importSpotifyPlaylists() {
    showIntegrationLoading('Spotify');
    
    fetch('/api/spotify/import-playlists', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Spotify playlists imported successfully! ${data.imported_count} playlists processed.`);
        } else {
            showErrorMessage('Spotify playlist import failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error importing Spotify playlists:', error);
        showErrorMessage('Spotify playlist import failed: ' + error.message);
    });
}



function testLidarrIntegration() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('Lidarr integration test passed! ' + data.message);
        } else {
            showErrorMessage('Lidarr integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing Lidarr integration:', error);
        showErrorMessage('Lidarr integration test failed: ' + error.message);
    });
}

function syncLidarrLibrary() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/sync-library', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Lidarr library synced successfully! ${data.synced_count} artists processed.`);
        } else {
            showErrorMessage('Lidarr library sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing Lidarr library:', error);
        showErrorMessage('Lidarr library sync failed: ' + error.message);
    });
}

function importLidarrArtists() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/import-artists', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Lidarr artists imported successfully! ${data.imported_count} monitored artists processed.`);
        } else {
            showErrorMessage('Lidarr artist import failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error importing Lidarr artists:', error);
        showErrorMessage('Lidarr artist import failed: ' + error.message);
    });
}

function syncLidarrAlbums() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/sync-albums', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Lidarr albums synced successfully! ${data.processed_count} albums processed.`);
        } else {
            showErrorMessage('Lidarr album sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing Lidarr albums:', error);
        showErrorMessage('Lidarr album sync failed: ' + error.message);
    });
}

function showIntegrationLoading(service) {
    if (typeof showInfo === 'function') {
        showInfo(`Testing ${service} integration...`);
    } else {
        showInfoMessage(`Testing ${service} integration...`);
    }
}

// Helper functions for notifications
function showSuccessMessage(message) {
    if (typeof showSuccess === 'function') {
        showSuccess(message);
    } else {
        alert('‚úÖ ' + message);
    }
}

function showErrorMessage(message) {
    if (typeof showError === 'function') {
        showError(message);
    } else {
        alert('‚ùå ' + message);
    }
}

function showInfoMessage(message) {
    if (typeof showInfo === 'function') {
        showInfo(message);
    } else {
        alert('‚ÑπÔ∏è ' + message);
    }
}


// ================================
// USER MANAGEMENT FUNCTIONS
// ================================

function initializeUserManagement() {
    // Simplified authentication - no complex user management needed
    // User credentials can be updated in Settings > General tab
    console.log('User management simplified - using single user authentication');
}

function loadCurrentUserInfo() {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                const user = data.user;
                const permissions = data.permissions;
                
                // Update current user info
                document.getElementById('currentUsername').textContent = user.username;
                document.getElementById('currentUserEmail').textContent = user.email || 'Not provided';
                
                // Update role badge
                const roleElement = document.getElementById('currentUserRole');
                roleElement.textContent = user.role;
                roleElement.className = `role-badge role-${user.role.toLowerCase()}`;
                
                // Update last login
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
                document.getElementById('lastLoginTime').textContent = lastLogin;
                
                // Update 2FA status
                const twoFactorElement = document.getElementById('twoFactorStatus');
                if (user.two_factor_enabled) {
                    twoFactorElement.innerHTML = '<span class="status-enabled">‚úÖ Enabled</span>';
                } else {
                    twoFactorElement.innerHTML = '<span class="status-disabled">‚ùå Disabled</span>';
                }
                
                // Show admin section if user has admin privileges
                if (permissions.can_manage_users) {
                    document.getElementById('adminUserManagement').style.display = 'block';
                    loadUserList();
                }
                
            }
        })
        .catch(error => {
            console.error('Error loading user info:', error);
        });
}

function checkUserPermissions() {
    fetch('/auth/check')
        .then(response => response.json())
        .then(data => {
            if (!data.authenticated) {
                // User is not authenticated, hide user management
                document.getElementById('userManagementSection').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error checking authentication:', error);
        });
}

function loadUserList() {
    fetch('/api/users/')
        .then(response => response.json())
        .then(data => {
            if (data.users) {
                renderUserList(data.users);
                updateUserStats(data.users);
            }
        })
        .catch(error => {
            console.error('Error loading user list:', error);
            document.getElementById('userList').innerHTML = '<div class="error">Error loading users</div>';
        });
}

function renderUserList(users) {
    const userListElement = document.getElementById('userList');
    
    if (users.length === 0) {
        userListElement.innerHTML = '<div class="no-users">No users found</div>';
        return;
    }
    
    const userListHTML = users.map(user => {
        const statusClass = user.is_active ? 'active' : 'inactive';
        const lockedStatus = user.is_locked ? 'üîí Locked' : '';
        const twoFactorStatus = user.two_factor_enabled ? 'üîê' : '';
        
        return `
            <div class="user-item ${statusClass}">
                <div class="user-info">
                    <div class="user-primary">
                        <strong>${user.username}</strong>
                        <span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span>
                        ${twoFactorStatus}
                        ${lockedStatus}
                    </div>
                    <div class="user-secondary">
                        <span>${user.email}</span>
                        <span>Last login: ${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</span>
                    </div>
                </div>
                <div class="user-actions">
                    <button onclick="editUser(${user.id})" class="btn btn-sm btn-secondary">‚úèÔ∏è Edit</button>
                    <button onclick="viewUserSessions(${user.id})" class="btn btn-sm btn-info">üì± Sessions</button>
                    ${user.is_active 
                        ? `<button onclick="deactivateUser(${user.id})" class="btn btn-sm btn-warning">‚è∏Ô∏è Deactivate</button>`
                        : `<button onclick="activateUser(${user.id})" class="btn btn-sm btn-success">‚ñ∂Ô∏è Activate</button>`
                    }
                    ${user.is_locked 
                        ? `<button onclick="unlockUser(${user.id})" class="btn btn-sm btn-warning">üîì Unlock</button>`
                        : ''
                    }
                </div>
            </div>
        `;
    }).join('');
    
    userListElement.innerHTML = userListHTML;
}

function updateUserStats(users) {
    const totalUsers = users.length;
    const activeUsers = users.filter(u => u.is_active).length;
    const twoFactorUsers = users.filter(u => u.two_factor_enabled).length;
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('activeUsers').textContent = activeUsers;
    document.getElementById('twoFactorUsers').textContent = twoFactorUsers;
}


function refreshUserList() {
    loadUserList();
}

// Modal Functions
function showCreateUserModal() {
    const modalHTML = `
        <div class="modal-overlay" id="createUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New User</h3>
                    <button onclick="closeModal('createUserModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input type="text" id="newUsername" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Email:</label>
                            <input type="email" id="newEmail" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input type="password" id="newPassword" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="newRole">Role:</label>
                            <select id="newRole" name="role">
                                <option value="USER">User</option>
                                <option value="MANAGER">Manager</option>
                                <option value="ADMIN">Administrator</option>
                                <option value="READONLY">Read Only</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="createUser()" class="btn btn-primary">Create User</button>
                    <button onclick="closeModal('createUserModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function createUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        role: formData.get('role')
    };
    
    fetch('/api/users/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.user) {
            showSuccess('User created successfully');
            closeModal('createUserModal');
            loadUserList();
        } else {
            showError(data.error || 'Failed to create user');
        }
    })
    .catch(error => {
        console.error('Error creating user:', error);
        showError('Error creating user');
    });
}

function showChangePasswordModal() {
    const modalHTML = `
        <div class="modal-overlay" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Change Password</h3>
                    <button onclick="closeModal('changePasswordModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <input type="password" id="newPassword" name="new_password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" name="confirm_password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="changePassword()" class="btn btn-primary">Change Password</button>
                    <button onclick="closeModal('changePasswordModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function changePassword() {
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);
    
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        showError('New passwords do not match');
        return;
    }
    
    const passwordData = {
        current_password: formData.get('current_password'),
        new_password: newPassword
    };
    
    fetch('/auth/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(passwordData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Password changed successfully');
            closeModal('changePasswordModal');
        } else {
            showError(data.error || 'Failed to change password');
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showError('Error changing password');
    });
}

function showTwoFactorModal() {
    fetch('/2fa/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.status && data.status.enabled) {
                showTwoFactorManageModal();
            } else {
                showTwoFactorSetupModal();
            }
        })
        .catch(error => {
            console.error('Error getting 2FA status:', error);
            showError('Error loading 2FA status');
        });
}

function showTwoFactorSetupModal() {
    const modalHTML = `
        <div class="modal-overlay" id="twoFactorModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Setup Two-Factor Authentication</h3>
                    <button onclick="closeModal('twoFactorModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="twoFactorSetup">
                        <p>Two-factor authentication adds an extra layer of security to your account.</p>
                        <button onclick="initiateTwoFactorSetup()" class="btn btn-primary">Setup 2FA</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function showUserSessionsModal() {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                return fetch(`/api/users/${data.user.id}/sessions`);
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                renderSessionsModal(data.sessions);
            }
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            showError('Error loading sessions');
        });
}

function renderSessionsModal(sessions) {
    const sessionsHTML = sessions.map(session => {
        const isCurrentSession = session.is_current;
        const currentBadge = isCurrentSession ? '<span class="current-session">Current</span>' : '';
        
        return `
            <div class="session-item ${isCurrentSession ? 'current' : ''}">
                <div class="session-info">
                    <div><strong>IP Address:</strong> ${session.ip_address || 'Unknown'}</div>
                    <div><strong>User Agent:</strong> ${session.user_agent || 'Unknown'}</div>
                    <div><strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}</div>
                    <div><strong>Last Activity:</strong> ${new Date(session.last_activity).toLocaleString()}</div>
                    ${currentBadge}
                </div>
                <div class="session-actions">
                    ${!isCurrentSession ? `<button onclick="revokeSession(${session.id})" class="btn btn-sm btn-danger">Revoke</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    const modalHTML = `
        <div class="modal-overlay" id="sessionsModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Manage Sessions</h3>
                    <button onclick="closeModal('sessionsModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="sessions-list">
                        ${sessionsHTML}
                    </div>
                    <div class="session-actions-footer">
                        <button onclick="revokeAllSessions()" class="btn btn-danger">Revoke All Other Sessions</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function revokeSession(sessionId) {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                return fetch(`/api/users/${data.user.id}/sessions/${sessionId}`, { method: 'DELETE' });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Session revoked successfully');
                closeModal('sessionsModal');
                if (data.redirect_to_login) {
                    window.location.href = '/auth/login';
                }
            } else {
                showError(data.error || 'Failed to revoke session');
            }
        })
        .catch(error => {
            console.error('Error revoking session:', error);
            showError('Error revoking session');
        });
}

function revokeAllSessions() {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                return fetch(`/api/users/${data.user.id}/sessions`, { method: 'DELETE' });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('All sessions revoked successfully');
                closeModal('sessionsModal');
                if (data.redirect_to_login) {
                    window.location.href = '/auth/login';
                }
            } else {
                showError(data.error || 'Failed to revoke sessions');
            }
        })
        .catch(error => {
            console.error('Error revoking sessions:', error);
            showError('Error revoking sessions');
        });
}

function logoutUser() {
    if (confirm('Are you sure you want to logout?')) {
        fetch('/auth/logout', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/auth/login';
                } else {
                    showError('Logout failed');
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
                showError('Logout failed');
            });
    }
}

function deactivateUser(userId) {
    if (confirm('Are you sure you want to deactivate this user?')) {
        fetch(`/api/users/${userId}/deactivate`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('User deactivated successfully');
                    loadUserList();
                } else {
                    showError(data.error || 'Failed to deactivate user');
                }
            })
            .catch(error => {
                console.error('Error deactivating user:', error);
                showError('Error deactivating user');
            });
    }
}

function activateUser(userId) {
    fetch(`/api/users/${userId}/activate`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('User activated successfully');
                loadUserList();
            } else {
                showError(data.error || 'Failed to activate user');
            }
        })
        .catch(error => {
            console.error('Error activating user:', error);
            showError('Error activating user');
        });
}

function unlockUser(userId) {
    fetch(`/api/users/${userId}/unlock`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('User unlocked successfully');
                loadUserList();
            } else {
                showError(data.error || 'Failed to unlock user');
            }
        })
        .catch(error => {
            console.error('Error unlocking user:', error);
            showError('Error unlocking user');
        });
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

// Helper functions
function showSuccess(message) {
    if (typeof toastSuccess === 'function') {
        toastSuccess(message);
    } else {
        alert(message);
    }
}

function showError(message) {
    if (typeof toastError === 'function') {
        toastError(message);
    } else {
        alert('Error: ' + message);
    }
}

function showInfo(message) {
    if (typeof toastInfo === 'function') {
        toastInfo(message);
    } else {
        alert(message);
    }
}

// Missing function implementations
function showUserProfileModal() {
    const modalHTML = `
        <div class="modal-overlay" id="userProfileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>User Profile</h3>
                    <button onclick="closeModal('userProfileModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="userProfileForm">
                        <div class="form-group">
                            <label for="profileEmail">Email:</label>
                            <input type="email" id="profileEmail" name="email" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="updateUserProfile()" class="btn btn-primary">Update Profile</button>
                    <button onclick="closeModal('userProfileModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load current user data
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                document.getElementById('profileEmail').value = data.user.email || '';
            }
        })
        .catch(error => {
            console.error('Error loading profile:', error);
        });
}

function updateUserProfile() {
    const form = document.getElementById('userProfileForm');
    const formData = new FormData(form);
    const preferences = {};
    
    fetch('/api/users/me/preferences', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ preferences: preferences })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Profile updated successfully');
            closeModal('userProfileModal');
            loadCurrentUserInfo();
        } else {
            showError(data.error || 'Failed to update profile');
        }
    })
    .catch(error => {
        console.error('Error updating profile:', error);
        showError('Error updating profile');
    });
}

function editUser(userId) {
    // Fetch user data and show edit modal
    fetch(`/api/users/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                showEditUserModal(data.user);
            }
        })
        .catch(error => {
            console.error('Error loading user:', error);
            showError('Error loading user data');
        });
}

function showEditUserModal(user) {
    const modalHTML = `
        <div class="modal-overlay" id="editUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit User: ${user.username}</h3>
                    <button onclick="closeModal('editUserModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" value="${user.id}">
                        <div class="form-group">
                            <label for="editEmail">Email:</label>
                            <input type="email" id="editEmail" name="email" value="${user.email || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editRole">Role:</label>
                            <select id="editRole" name="role">
                                <option value="USER" ${user.role === 'USER' ? 'selected' : ''}>User</option>
                                <option value="MANAGER" ${user.role === 'MANAGER' ? 'selected' : ''}>Manager</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>Administrator</option>
                                <option value="READONLY" ${user.role === 'READONLY' ? 'selected' : ''}>Read Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editActive" ${user.is_active ? 'checked' : ''}> 
                                Active
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="updateUser()" class="btn btn-primary">Update User</button>
                    <button onclick="closeModal('editUserModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function updateUser() {
    const userId = document.getElementById('editUserId').value;
    const role = document.getElementById('editRole').value;
    
    fetch(`/api/users/${userId}/role`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: role })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('User updated successfully');
            closeModal('editUserModal');
            loadUserList();
        } else {
            showError(data.error || 'Failed to update user');
        }
    })
    .catch(error => {
        console.error('Error updating user:', error);
        showError('Error updating user');
    });
}

function viewUserSessions(userId) {
    fetch(`/api/users/${userId}/sessions`)
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                renderUserSessionsModal(userId, data.sessions);
            }
        })
        .catch(error => {
            console.error('Error loading user sessions:', error);
            showError('Error loading user sessions');
        });
}

function renderUserSessionsModal(userId, sessions) {
    const sessionsHTML = sessions.map(session => {
        return `
            <div class="session-item">
                <div class="session-info">
                    <div><strong>IP Address:</strong> ${session.ip_address || 'Unknown'}</div>
                    <div><strong>User Agent:</strong> ${session.user_agent || 'Unknown'}</div>
                    <div><strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}</div>
                    <div><strong>Last Activity:</strong> ${new Date(session.last_activity).toLocaleString()}</div>
                    <div><strong>Status:</strong> ${session.status}</div>
                </div>
                <div class="session-actions">
                    <button onclick="adminRevokeSession(${userId}, ${session.id})" class="btn btn-sm btn-danger">Revoke</button>
                </div>
            </div>
        `;
    }).join('');
    
    const modalHTML = `
        <div class="modal-overlay" id="userSessionsModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>User Sessions</h3>
                    <button onclick="closeModal('userSessionsModal')" class="btn-close">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="sessions-list">
                        ${sessionsHTML}
                    </div>
                    <div class="session-actions-footer">
                        <button onclick="adminRevokeAllSessions(${userId})" class="btn btn-danger">Revoke All Sessions</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function adminRevokeSession(userId, sessionId) {
    fetch(`/api/users/${userId}/sessions/${sessionId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Session revoked successfully');
                closeModal('userSessionsModal');
            } else {
                showError(data.error || 'Failed to revoke session');
            }
        })
        .catch(error => {
            console.error('Error revoking session:', error);
            showError('Error revoking session');
        });
}

function adminRevokeAllSessions(userId) {
    if (confirm('Are you sure you want to revoke all sessions for this user?')) {
        fetch(`/api/users/${userId}/sessions`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('All sessions revoked successfully');
                    closeModal('userSessionsModal');
                } else {
                    showError(data.error || 'Failed to revoke sessions');
                }
            })
            .catch(error => {
                console.error('Error revoking sessions:', error);
                showError('Error revoking sessions');
            });
    }
}

function initiateTwoFactorSetup() {
    fetch('/2fa/api/setup', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.setup_data) {
                showTwoFactorSetupData(data.setup_data);
            } else {
                showError(data.error || 'Failed to setup 2FA');
            }
        })
        .catch(error => {
            console.error('Error setting up 2FA:', error);
            showError('Error setting up 2FA');
        });
}

function showTwoFactorSetupData(setupData) {
    const setupHTML = `
        <div class="twofa-setup">
            <h4>Step 1: Scan QR Code</h4>
            <div class="qr-code-container">
                <img src="data:image/png;base64,${setupData.qr_code}" alt="2FA QR Code">
            </div>
            
            <h4>Step 2: Manual Entry Key</h4>
            <p>If you can't scan the QR code, enter this key manually:</p>
            <div class="manual-key">
                <code>${setupData.manual_entry_key}</code>
                <button onclick="copyToClipboard('${setupData.manual_entry_key}')" class="btn btn-sm btn-secondary">Copy</button>
            </div>
            
            <h4>Step 3: Verify Setup</h4>
            <div class="form-group">
                <label for="verifyToken">Enter verification code from your authenticator app:</label>
                <input type="text" id="verifyToken" placeholder="123456" maxlength="6">
            </div>
            <button onclick="verifyTwoFactorSetup()" class="btn btn-primary">Verify & Enable 2FA</button>
            
            <h4>Backup Codes</h4>
            <p>Save these backup codes in a safe place. You can use them if you lose access to your authenticator app:</p>
            <div class="backup-codes">
                ${setupData.backup_codes.map(code => `<code>${code}</code>`).join('')}
            </div>
        </div>
    `;
    
    document.getElementById('twoFactorSetup').innerHTML = setupHTML;
}

function verifyTwoFactorSetup() {
    const token = document.getElementById('verifyToken').value;
    
    fetch('/2fa/api/verify-setup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: token })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('2FA enabled successfully!');
            closeModal('twoFactorModal');
            loadCurrentUserInfo();
        } else {
            showError(data.error || 'Failed to verify 2FA');
        }
    })
    .catch(error => {
        console.error('Error verifying 2FA:', error);
        showError('Error verifying 2FA');
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('Copied to clipboard');
    }).catch(() => {
        showError('Failed to copy to clipboard');
    });
}

// Handle hash-based navigation from dropdown menu
function handleHashNavigation() {
    const hash = window.location.hash.substring(1);
    console.log('Hash navigation triggered for:', hash);
    
    if (hash === 'profile') {
        // Trigger user profile modal
        console.log('Triggering profile modal...');
        console.log('showUserProfileModal function exists:', typeof showUserProfileModal === 'function');
        
        // Check if authentication is enabled and user section is visible
        const userSection = document.getElementById('userManagementSection');
        const authEnabled = document.getElementById('require_authentication').value === 'true';
        
        if (!authEnabled) {
            console.log('Authentication not enabled, enabling first...');
            document.getElementById('require_authentication').value = 'true';
            document.getElementById('require_authentication').dispatchEvent(new Event('change'));
            
            // Wait for user section to be shown, then call modal
            setTimeout(() => {
                if (typeof showUserProfileModal === 'function') {
                    showUserProfileModal();
                    console.log('Profile modal function called after enabling auth');
                } else {
                    console.error('showUserProfileModal function not found after enabling auth');
                }
            }, 500);
        } else {
            // Authentication is enabled, call modal directly
            setTimeout(() => {
                if (typeof showUserProfileModal === 'function') {
                    console.log('Calling showUserProfileModal function...');
                    showUserProfileModal();
                    console.log('Profile modal function called');
                    
                    // Verify modal was created
                    setTimeout(() => {
                        const modal = document.getElementById('userProfileModal');
                        if (modal) {
                            console.log('Profile modal successfully created in DOM');
                        } else {
                            console.error('Profile modal not found in DOM after creation');
                        }
                    }, 100);
                } else {
                    console.error('showUserProfileModal function not found');
                }
            }, 200);
        }
    } else if (hash === 'password') {
        // Trigger change password modal  
        console.log('Triggering password modal...');
        console.log('showChangePasswordModal function exists:', typeof showChangePasswordModal === 'function');
        
        // Check if authentication is enabled
        const authEnabled = document.getElementById('require_authentication').value === 'true';
        
        if (!authEnabled) {
            console.log('Authentication not enabled, enabling first...');
            document.getElementById('require_authentication').value = 'true';
            document.getElementById('require_authentication').dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                if (typeof showChangePasswordModal === 'function') {
                    showChangePasswordModal();
                    console.log('Password modal function called after enabling auth');
                } else {
                    console.error('showChangePasswordModal function not found after enabling auth');
                }
            }, 500);
        } else {
            setTimeout(() => {
                if (typeof showChangePasswordModal === 'function') {
                    console.log('Calling showChangePasswordModal function...');
                    showChangePasswordModal();
                    console.log('Password modal function called');
                    
                    // Verify modal was created
                    setTimeout(() => {
                        const modal = document.getElementById('changePasswordModal');
                        if (modal) {
                            console.log('Password modal successfully created in DOM');
                        } else {
                            console.error('Password modal not found in DOM after creation');
                        }
                    }, 100);
                } else {
                    console.error('showChangePasswordModal function not found');
                }
            }, 200);
        }
    } else if (hash === 'userManagement') {
        // Scroll to user management section
        console.log('Scrolling to user management...');
        setTimeout(() => {
            const userMgmtSection = document.getElementById('userManagementSection');
            if (userMgmtSection) {
                userMgmtSection.scrollIntoView({ behavior: 'smooth' });
                console.log('Scrolled to user management section');
            } else {
                console.error('User management section not found');
            }
        }, 200);
    }
    
    // Clear the hash to prevent repeated triggers
    if (hash) {
        setTimeout(() => {
            history.replaceState(null, null, window.location.pathname);
        }, 2000);
    }
}

// Run hash navigation on page load

// Also run when hash changes (for single-page navigation)
window.addEventListener('hashchange', function() {
    handleHashNavigation();
});

// Cookie Management Functions for Settings Page
async function checkCookieStatusSettings() {
    try {
        const response = await fetch('/api/metube/cookies/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('cookieStatusSettings');
        const deleteBtn = document.getElementById('deleteCookieBtnSettings');
        
        if (data.cookies_available) {
            statusDiv.innerHTML = '<span class="status-text success">‚úÖ Cookies uploaded - Age-restricted videos supported</span>';
            deleteBtn.style.display = 'inline-block';
        } else {
            statusDiv.innerHTML = '<span class="status-text error">‚ùå No cookies uploaded - Age-restricted videos will fail</span>';
            deleteBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Failed to check cookie status:', error);
        document.getElementById('cookieStatusSettings').innerHTML = '<span class="status-text">‚ùì Status unknown</span>';
    }
}

async function uploadCookiesSettings(input) {
    const file = input.files[0];
    if (!file) return;
    
    const uploadBtn = document.getElementById('uploadCookieBtnSettings');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '‚è≥ Uploading...';
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/metube/cookies/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showSuccess === 'function') {
                showSuccess('‚úÖ Cookies uploaded successfully!');
            } else {
                alert('‚úÖ Cookies uploaded successfully!');
            }
            await checkCookieStatusSettings();
        } else {
            const errorMsg = `‚ùå Upload failed: ${data.error}`;
            if (typeof showError === 'function') {
                showError(errorMsg);
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('Upload error:', error);
        const errorMsg = '‚ùå Upload failed due to network error';
        if (typeof showError === 'function') {
            showError(errorMsg);
        } else {
            alert(errorMsg);
        }
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'üì§ Upload Cookies';
        input.value = '';
    }
}

async function deleteCookiesSettings() {
    if (!confirm('Are you sure you want to delete the uploaded cookies?')) return;
    
    try {
        const response = await fetch('/api/metube/cookies/delete', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showSuccess === 'function') {
                showSuccess('‚úÖ Cookies deleted successfully');
            } else {
                alert('‚úÖ Cookies deleted successfully');
            }
            await checkCookieStatusSettings();
        } else {
            const errorMsg = `‚ùå Delete failed: ${data.error}`;
            if (typeof showError === 'function') {
                showError(errorMsg);
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('Delete error:', error);
        const errorMsg = '‚ùå Delete failed due to network error';
        if (typeof showError === 'function') {
            showError(errorMsg);
        } else {
            alert(errorMsg);
        }
    }
}

function showCookieInstructionsSettings() {
    const instructions = `
How to export YouTube cookies:

1. Chrome/Edge:
   - Install "Get cookies.txt" extension
   - Go to YouTube.com and sign in
   - Click extension icon ‚Üí Download cookies
   - Save as .txt file

2. Firefox:
   - Install "cookies.txt" add-on
   - Go to YouTube.com and sign in  
   - Click add-on icon ‚Üí Export cookies
   - Save as .txt file

3. Manual method:
   - Use browser developer tools (F12)
   - Go to Application/Storage ‚Üí Cookies
   - Copy YouTube cookies to .txt file in Netscape format

‚ö†Ô∏è Security: Only upload cookies from your personal computer. Never share cookie files.

The cookie file should contain YouTube authentication data including session tokens.
    `;
    
    alert(instructions);
}

</script>

<style>
.settings-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Settings Tab Styles */
.settings-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-primary, #38383a);
    margin-bottom: 2rem;
    background: var(--bg-secondary, #2c2c2e);
    border-radius: 8px 8px 0 0;
    overflow-x: auto;
}

.settings-tab-btn {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-muted, #98989d);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.settings-tab-btn:hover {
    color: var(--text-primary, #ffffff);
    background: var(--bg-hover, #3c3c3e);
}

.settings-tab-btn.active {
    color: var(--text-accent, #a8b9be);
    border-bottom-color: var(--text-accent, #a8b9be);
    background: var(--bg-hover, #3c3c3e);
}

.tab-icon {
    font-size: 1.1rem;
}

.settings-tab-content {
    min-height: 500px;
}

.settings-tab-panel {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.settings-tab-panel.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive tabs */
@media (max-width: 768px) {
    .settings-tabs {
        flex-direction: column;
        border-radius: 8px;
    }
    
    .settings-tab-btn {
        text-align: left;
        border-bottom: 1px solid var(--border-primary, #38383a);
        border-right: none;
    }
    
    .settings-tab-btn.active {
        border-bottom: 1px solid var(--border-primary, #38383a);
        border-left: 3px solid var(--text-accent, #a8b9be);
    }
}

/* User Management Styles */
.user-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.user-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.role-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: bold;
    text-transform: uppercase;
}

.role-badge.role-admin {
    background-color: #dc3545;
    color: white;
}

.role-badge.role-manager {
    background-color: #fd7e14;
    color: white;
}

.role-badge.role-user {
    background-color: #28a745;
    color: white;
}

.role-badge.role-readonly {
    background-color: #6c757d;
    color: white;
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: bold;
}

.status-enabled {
    color: #28a745;
}

.status-disabled {
    color: #dc3545;
}

/* Cookie Management Styles */
.cookie-management-section {
    border: 1px solid var(--border-color, #38383a);
    border-radius: 8px;
    padding: 15px;
    background: var(--surface-color, #2c2c2e);
    margin-bottom: 15px;
    box-shadow: 0 2px 8px var(--shadow-color, rgba(108, 123, 127, 0.2));
}

.cookie-upload-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.cookie-status {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
}

.cookie-status .status-text.success {
    color: #28a745;
}

.cookie-status .status-text.error {
    color: #dc3545;
}

.cookie-status .status-text {
    color: #6c757d;
}

.cookie-upload-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.cookie-upload-actions button {
    font-size: 0.9rem;
    padding: 6px 12px;
}

.help-text {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 5px;
    line-height: 1.4;
}

/* SSL Warning Section */
.ssl-warning {
    background: var(--surface-color, #2c2c2e);
    border: 1px solid var(--warning-color, #ff9f0a);
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
    box-shadow: 0 2px 8px var(--shadow-color, rgba(108, 123, 127, 0.2));
}

.ssl-warning strong {
    color: var(--warning-color, #ff9f0a);
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.status-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.status-item label {
    font-weight: bold;
    color: #ccc;
}

.admin-only {
    color: #ffc107;
    font-size: 0.8em;
    font-weight: normal;
}

.user-management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.user-stats {
    display: flex;
    gap: 20px;
    font-size: 0.9em;
    color: #ccc;
}

.user-stats span {
    white-space: nowrap;
}

.user-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border: 1px solid #555;
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: #2a2a2a;
    transition: all 0.2s ease;
}

.user-item:hover {
    background-color: #333;
    border-color: #666;
}

.user-item.inactive {
    opacity: 0.6;
    background-color: #1a1a1a;
}

.user-item .user-info {
    flex: 1;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.user-primary {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1em;
}

.user-secondary {
    display: flex;
    gap: 15px;
    font-size: 0.9em;
    color: #ccc;
}

.user-item .user-actions {
    margin: 0;
    flex-shrink: 0;
}

.no-users, .loading, .error {
    text-align: center;
    color: #ccc;
    padding: 40px;
    font-style: italic;
}

.error {
    color: #dc3545;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.modal-content.modal-large {
    max-width: 700px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #555;
}

.modal-header h3 {
    margin: 0;
    color: #00d4ff;
}

.btn-close {
    background: none;
    border: none;
    color: #ccc;
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close:hover {
    color: #fff;
    background-color: #444;
    border-radius: 50%;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid #555;
}

.sessions-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.session-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px;
    border: 1px solid #555;
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: #333;
}

.session-item.current {
    border-color: #00d4ff;
    background-color: #1a3a4a;
}

.session-info {
    flex: 1;
    font-size: 0.9em;
    line-height: 1.4;
}

.session-info div {
    margin-bottom: 5px;
}

.current-session {
    background-color: #00d4ff;
    color: #000;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
    margin-top: 5px;
    display: inline-block;
}

.session-actions {
    flex-shrink: 0;
    margin-left: 15px;
}

.session-actions-footer {
    text-align: center;
    padding-top: 15px;
    border-top: 1px solid #555;
}


/* Button size variants */
.btn-sm {
    padding: 4px 8px;
    font-size: 0.875em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-management-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .user-stats {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .user-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .user-primary {
        flex-wrap: wrap;
    }
    
    .user-secondary {
        flex-direction: column;
        gap: 5px;
    }
    
    .modal-content {
        margin: 20px;
        width: calc(100% - 40px);
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .user-info {
        grid-template-columns: 1fr;
    }
}

.settings-container h1 {
    color: #00d4ff;
    margin-bottom: 10px;
    font-size: 2.5rem;
    text-align: center;
}

.page-description {
    text-align: center;
    color: #ccc;
    margin-bottom: 30px;
    font-size: 1.1rem;
}

.settings-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.settings-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
    margin-top: 30px;
}

.settings-section {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #444;
    border-radius: 12px;
    padding: 25px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.settings-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
}

.settings-section h2 {
    color: #00d4ff;
    margin-bottom: 15px;
    font-size: 1.4rem;
    border-bottom: 2px solid #00d4ff;
    padding-bottom: 8px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #00d4ff;
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group .help-text {
    display: block;
    color: #999;
    font-size: 12px;
    margin-top: 5px;
    font-style: italic;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    background: #333;
    border: 2px solid #444;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

.form-group input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
}

.form-group option {
    background: #333;
    color: #fff;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    color: #fff;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #0099cc 0%, #007799 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: #fff;
}

.btn-success:hover {
    background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
    color: #fff;
}

.btn-info:hover {
    background: linear-gradient(135deg, #117a8b 0%, #0c5460 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #ffc107 0%, #d39e00 100%);
    color: #000;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #d39e00 0%, #b08800 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: #fff;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #5a6268 0%, #484e53 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
    color: #fff;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #bd2130 0%, #a01e2a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.btn-light {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #333;
}

.btn-light:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(248, 249, 250, 0.3);
}

/* Action Button Groups */
.integration-actions,
.indexing-actions,
.scheduler-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.integration-actions button,
.indexing-actions button,
.scheduler-actions button {
    flex: 1;
    min-width: 120px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.stat-item {
    background: #333;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: transform 0.2s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
}

.stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #00d4ff;
    margin-bottom: 5px;
}

.stat-label {
    color: #ccc;
    font-size: 0.9rem;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin: 1rem 0;
}

.result-item {
    background-color: #3d3d3d;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.thumbnail-stats {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #3d3d3d;
    border-radius: 4px;
    font-size: 0.9rem;
}

.progress-container {
    margin: 1rem 0;
    padding: 1rem;
    background-color: #3d3d3d;
    border-radius: 4px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #555;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00d4ff, #0099cc);
    width: 0%;
    transition: width 0.3s ease;
    animation: progress-pulse 2s infinite;
}

@keyframes progress-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.results-container {
    margin: 1rem 0;
    padding: 1rem;
    background-color: #3d3d3d;
    border-radius: 4px;
}

.scan-results, .indexing-results, .cleanup-results {
    color: #fff;
}

.scan-results h4, .indexing-results h4, .cleanup-results h4 {
    color: #00d4ff;
    margin-bottom: 0.5rem;
}

.deleted-artists {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #444;
    border-radius: 4px;
}

.deleted-artists ul {
    list-style-type: disc;
    margin-left: 1rem;
    margin-top: 0.5rem;
}

.deleted-artists li {
    margin-bottom: 0.25rem;
}

.success {
    color: #4caf50;
    font-weight: bold;
}

.warning {
    color: #ff9800;
    font-weight: bold;
}

.error {
    color: #f44336;
    font-weight: bold;
}

.loading {
    color: #00bcd4;
    font-weight: bold;
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

button:disabled:hover {
    background-color: inherit !important;
}

/* Scheduler Status Styles */
.scheduler-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
}

.scheduler-actions button {
    flex: 1;
    min-width: 120px;
    padding: 0.5rem;
    font-size: 0.9rem;
}

.status-info {
    background-color: #333;
    border-radius: 4px;
    padding: 1rem;
    margin-top: 0.5rem;
}

.status-item {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.status-item:last-child {
    margin-bottom: 0;
}

.status-item.running {
    color: #4caf50;
}

.status-item.stopped {
    color: #f44336;
}

.status-item.warning {
    color: #ff9800;
    font-style: italic;
}

.status-loading {
    color: #00d4ff;
    font-style: italic;
}

/* External Services Subsections */
.subsection {
    margin-bottom: 2rem;
    padding: 1rem;
    border: 1px solid #555;
    border-radius: 6px;
    background-color: #353535;
}

.subsection h3 {
    color: #ffffff;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    border-bottom: 1px solid #555;
    padding-bottom: 0.5rem;
}

.subsection:last-child {
    margin-bottom: 0;
}

.integration-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.integration-actions button {
    flex: 1;
    min-width: 120px;
    padding: 0.5rem;
    font-size: 0.9rem;
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
    .settings-sections {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .settings-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .settings-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .settings-container {
        padding: 15px;
    }
    
    .settings-section {
        padding: 20px;
    }
    
    .integration-actions {
        flex-direction: column;
    }
    
    .integration-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .subsection {
        padding: 0.75rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .scheduler-actions {
        flex-direction: column;
    }
    
    .scheduler-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .indexing-actions {
        flex-direction: column;
    }
    
    .indexing-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

/* Form improvements for external services */
.external-services .form-group {
    margin-bottom: 1rem;
}

.external-services input[type="text"],
.external-services input[type="password"],
.external-services input[type="number"],
.external-services select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #555;
    border-radius: 4px;
    background-color: #444;
    color: #fff;
}

.external-services input[type="text"]:focus,
.external-services input[type="password"]:focus,
.external-services input[type="number"]:focus,
.external-services select:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
}

.external-services label {
    display: block;
    margin-bottom: 0.5rem;
    color: #ccc;
    font-weight: 500;
}

/* Integration status indicators */
.integration-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 0.5rem;
}

.integration-status.enabled {
    background-color: #4caf50;
    color: #fff;
}

.integration-status.disabled {
    background-color: #f44336;
    color: #fff;
}

.integration-status.testing {
    background-color: #ff9800;
    color: #fff;
}

/* Responsive design for external services */
@media (max-width: 768px) {
    .integration-actions {
        flex-direction: column;
    }
    
    .integration-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .subsection {
        padding: 0.75rem;
    }
}

/* Integration Notice */
.integration-notice {
    background-color: #f0f8ff;
    border: 1px solid #00d4ff;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 20px;
    color: #333;
}

.integration-notice p {
    margin-bottom: 12px;
    font-weight: 600;
}

.integration-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.integration-link {
    display: inline-block;
    padding: 8px 16px;
    background-color: #00d4ff;
    color: #000;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
}

.integration-link:hover {
    background-color: #0099cc;
    transform: translateY(-1px);
}

/* Dark theme adjustments */




/* Bauhaus theme adjustments */








/* Legacy bauhaus theme preview styles removed */

/* Light Theme Overrides for Settings */
body.light-theme .btn-light {
    background: white;
    border: 2px solid #e1e5e9;
    color: #333;
}

body.light-theme .btn-light:hover {
    background: #f0f0ff;
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

body.light-theme .settings-container {
    background: transparent;
}

body.light-theme .settings-section {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

body.light-theme .form-group input,
body.light-theme .form-group select,
body.light-theme .form-group textarea {
    background: white;
    border: 2px solid #e1e5e9;
    color: #333;
    border-radius: 8px;
}

body.light-theme .form-group input:focus,
body.light-theme .form-group select:focus,
body.light-theme .form-group textarea:focus {
    border-color: #667eea;
    box-shadow: none;
    outline: none;
}

body.light-theme .form-group label {
    color: #333;
}

/* Readonly field styles */
.readonly-field {
    background-color: #2a2a2a !important;
    color: #888 !important;
    cursor: not-allowed !important;
}

body.light-theme .readonly-field {
    background-color: #f5f5f5 !important;
    color: #666 !important;
    cursor: not-allowed !important;
}

/* Light theme tab styling */
body.light-theme .settings-tabs {
    background: var(--bg-secondary, white);
    border-bottom: 2px solid var(--border-primary, #e1e5e9);
    box-shadow: 0 2px 4px var(--shadow, rgba(0, 0, 0, 0.1));
}

body.light-theme .settings-tab-btn {
    color: var(--text-muted, #666);
}

body.light-theme .settings-tab-btn:hover {
    color: var(--text-accent, #667eea);
    background: var(--bg-hover, #f0f0ff);
}

body.light-theme .settings-tab-btn.active {
    color: var(--text-accent, #667eea);
    border-bottom-color: var(--text-accent, #667eea);
    background: var(--bg-hover, #f0f0ff);
}

/* Light theme SSL warning */
body.light-theme .ssl-warning {
    color: #cc7a00;
    background: rgba(255, 193, 7, 0.1);
    border-left: 4px solid #ffc107;
    padding: 1rem;
    border-radius: 4px;
    margin-top: 1rem;
}

/* Light theme YouTube Authentication section */
body.light-theme .cookie-management-section {
    background: rgba(255, 165, 0, 0.1);
    border: 1px solid #ffaa55;
}

/* Legacy theme preview styles removed - functionality moved to Themes tab */

/* ============== THEMES TAB STYLES ============== */

.themes-container {
    padding: 0;
}

.theme-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1.5rem;
    gap: 1rem;
}

.theme-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-primary, #444);
    margin-bottom: 2rem;
}

.theme-tab-btn {
    background: none;
    border: none;
    color: var(--text-secondary, #ccc);
    padding: 1rem 2rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.theme-tab-btn:hover {
    color: var(--text-primary, #fff);
    background: color-mix(in srgb, var(--text-accent, #4a9eff) 10%, transparent);
}

.theme-tab-btn.active {
    color: var(--text-accent, #4a9eff);
    border-bottom-color: var(--text-accent, #4a9eff);
}

.theme-tab-content {
    display: none;
}

.theme-tab-content.active {
    display: block;
}

/* Themes Grid */
.themes-grid-container h3 {
    color: var(--text-primary, #fff);
    margin-bottom: 1.5rem;
}

.themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
}

.theme-card {
    background: var(--bg-secondary, #2d2d2d);
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.theme-card:hover {
    border-color: var(--text-accent, #4a9eff);
    box-shadow: 0 4px 12px color-mix(in srgb, var(--text-accent, #4a9eff) 20%, transparent);
}

.theme-card.applied {
    border-color: var(--success, #00ff00);
    background: color-mix(in srgb, var(--success, #00ff00) 5%, var(--bg-secondary, #2d2d2d));
}

.theme-card.applied::before {
    content: "‚úì Applied";
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--success, #00ff00);
    color: var(--bg-primary, #000);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
}

.theme-preview-mini {
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
    border: 1px solid var(--border-primary, #444);
}

.preview-bg {
    height: 100%;
    display: flex;
    align-items: flex-end;
    padding: 0.5rem;
}

.preview-accent {
    width: 40px;
    height: 8px;
    border-radius: 2px;
}

.theme-info h4 {
    color: var(--text-primary, #fff);
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.theme-description {
    color: var(--text-secondary, #ccc);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    line-height: 1.4;
}

.theme-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.theme-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: bold;
}

.theme-badge.built-in {
    background: var(--info, #17a2b8);
    color: var(--text-primary, #fff);
}

.theme-badge.public {
    background: var(--success, #28a745);
    color: var(--text-primary, #fff);
}

.theme-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

/* Customize Theme Selection */
.customize-theme-selection h4 {
    color: var(--text-primary, #fff);
    margin-bottom: 1rem;
}

.customize-themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.customize-theme-card {
    background: var(--bg-secondary, #2d2d2d);
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.customize-theme-card:hover {
    border-color: var(--text-accent, #4a9eff);
}

.customize-theme-card.active {
    border-color: var(--text-accent, #4a9eff);
    background: color-mix(in srgb, var(--text-accent, #4a9eff) 10%, var(--bg-secondary, #2d2d2d));
}

.customize-theme-card .theme-preview-mini {
    height: 40px;
    margin-bottom: 0.5rem;
}

.theme-name {
    color: var(--text-primary, #fff);
    font-size: 0.875rem;
}

/* Color Customization Panel */
.color-panel {
    background: var(--bg-secondary, #2d2d2d);
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 1.5rem;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary, #444);
}

.panel-header h4 {
    color: var(--text-primary, #fff);
    margin: 0;
}

.panel-actions {
    display: flex;
    gap: 0.5rem;
}

.color-groups {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.color-group h5 {
    color: var(--text-accent, #4a9eff);
    margin-bottom: 1rem;
    font-size: 1rem;
}

.color-inputs {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.color-input-group {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.color-input-group label {
    color: var(--text-primary, #fff);
    min-width: 180px;
    font-size: 0.9rem;
}

.color-input-group input[type="color"] {
    width: 50px;
    height: 35px;
    border: 1px solid var(--border-primary, #444);
    border-radius: 4px;
    cursor: pointer;
}

.color-value {
    color: var(--text-secondary, #ccc);
    font-family: monospace;
    font-size: 0.875rem;
    min-width: 80px;
}

.theme-preview-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-primary, #444);
}

.theme-preview-section h5 {
    color: var(--text-accent, #4a9eff);
    margin-bottom: 1rem;
}

.preview-container {
    background: var(--bg-tertiary, #3a3a3a);
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 1.5rem;
    min-height: 200px;
}

.no-themes {
    text-align: center;
    color: var(--text-secondary, #ccc);
    font-style: italic;
    padding: 2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .themes-grid {
        grid-template-columns: 1fr;
    }
    
    .customize-themes-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
    
    .color-groups {
        grid-template-columns: 1fr;
    }
    
    .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .color-input-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .color-input-group label {
        min-width: auto;
    }
}

/* Live Preview Styles */
.preview-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary, #444);
}

.preview-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.preview-section h6 {
    color: var(--text-accent, #4a9eff);
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
    font-weight: 600;
}

/* Preview Cards */
.preview-cards {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.preview-card {
    background: var(--cardBackgroundColor, var(--bg-card, #2a2a2a));
    border: 1px solid var(--borderColor, var(--border-primary, #444));
    border-radius: 6px;
    padding: 1rem;
    min-width: 150px;
    flex: 1;
    box-shadow: 0 2px 4px var(--cardShadowColor, rgba(0,0,0,0.3));
}

.preview-card .card-header {
    color: var(--text-primary, #fff);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.preview-card .card-content {
    color: var(--text-secondary, #ccc);
    font-size: 0.9rem;
}

/* Preview Buttons */
.preview-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.preview-btn-primary {
    background: var(--btn-primary-bg, #4a9eff);
    color: var(--btn-primary-text, #fff);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.preview-btn-primary:hover {
    background: var(--btn-primary-hover, #3a8eef);
}

.preview-btn-secondary {
    background: var(--btn-secondary-bg, #666);
    color: var(--btn-secondary-text, #fff);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.preview-btn-secondary:hover {
    background: var(--btn-secondary-hover, #777);
}

.preview-btn-danger {
    background: var(--btn-danger-bg, #dc3545);
    color: var(--btn-danger-text, #fff);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.preview-btn-danger:hover {
    background: var(--btn-danger-hover, #c82333);
}

/* Preview Form Elements */
.preview-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.preview-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.preview-form label {
    color: var(--text-primary, #fff);
    font-size: 0.9rem;
    font-weight: 500;
}

.preview-input, .preview-select {
    background: var(--inputBackgroundColor, var(--input-bg, #3a3a3a));
    color: var(--textColor, var(--input-text, #fff));
    border: 1px solid var(--inputBorderColor, var(--input-border, #555));
    border-radius: 4px;
    padding: 0.5rem;
    font-size: 0.9rem;
    width: 200px;
}

.preview-input:focus, .preview-select:focus {
    outline: none;
    border-color: var(--inputFocusBorderColor, var(--input-focus, #4a9eff));
    box-shadow: 0 0 0 2px var(--inputFocusBoxShadowColor, rgba(74, 158, 255, 0.25));
}

/* Preview Navigation */
.preview-nav {
    display: flex;
    background: var(--nav-bg, #2d2d2d);
    border-radius: 4px;
    overflow: hidden;
}

.nav-item {
    padding: 0.75rem 1rem;
    color: var(--nav-text, #fff);
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.9rem;
}

.nav-item:hover {
    background: var(--nav-hover, #404040);
}

.nav-item.active {
    background: var(--nav-active, #4a9eff);
    color: var(--text-inverse, #000);
}

/* Preview Alerts */
.preview-alerts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.alert-success, .alert-warning, .alert-error, .alert-info {
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 0.9rem;
    border: 1px solid;
}

.alert-success {
    background: var(--alertSuccessBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--successColor, var(--success, #28a745));
    border-color: var(--successColor, var(--success, #28a745));
}

.alert-warning {
    background: var(--alertWarningBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--warningColor, var(--warning, #ffc107));
    border-color: var(--warningColor, var(--warning, #ffc107));
}

.alert-error {
    background: var(--alertDangerBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--dangerColor, var(--error, #dc3545));
    border-color: var(--dangerColor, var(--error, #dc3545));
}

.alert-info {
    background: var(--alertInfoBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--primaryColor, var(--info, #17a2b8));
    border-color: var(--primaryColor, var(--info, #17a2b8));
}

/* Preview Responsive */
@media (max-width: 768px) {
    .preview-cards, .preview-buttons {
        flex-direction: column;
    }
    
    .preview-input, .preview-select {
        width: 100%;
    }
    
    .preview-nav {
        flex-direction: column;
    }
}
</style>

<script>
// Theme management functionality
// Use existing global variables if available, otherwise create local ones
if (typeof window.currentTheme === 'undefined') {
    window.currentTheme = 'default';
}
if (typeof window.currentMode === 'undefined') {
    window.currentMode = 'dark';
}

// Initialize theme settings - now handled by Themes tab
document.addEventListener('DOMContentLoaded', function() {
    // Theme functionality moved to dedicated Themes tab
});

// Legacy theme functions removed - themes now handled in dedicated Themes tab

// Theme functionality moved to dedicated Themes tab - no legacy hooks needed

// ============== THEMES TAB FUNCTIONALITY ==============

let allThemes = [];
let currentTheme = null;

// Initialize themes when tab is activated
function initializeThemesTab() {
    if (document.getElementById('themes-tab').classList.contains('active')) {
        loadThemes();
    }
}

// Theme tab switching functionality
function switchThemeTab(event, tabId) {
    // Remove active class from all theme tabs and panels
    const tabButtons = document.querySelectorAll('.theme-tab-btn');
    const tabPanels = document.querySelectorAll('.theme-tab-content');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabPanels.forEach(panel => panel.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding panel
    event.target.classList.add('active');
    const targetPanel = document.getElementById(tabId);
    if (targetPanel) {
        targetPanel.classList.add('active');
        
        // Load customize grid if switching to customize tab
        if (tabId === 'customize-tab') {
            loadCustomizeThemeGrid();
        }
    }
}

// Load all themes from API
async function loadThemes() {
    try {
        console.log('Loading themes from /api/themes...');
        const response = await fetch('/api/themes');
        console.log('Themes API response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Themes API error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Themes API response data:', data);
        
        if (!data.themes) {
            throw new Error('No themes property in response');
        }
        
        allThemes = data.themes;
        console.log('Loaded themes:', allThemes.length);
        renderThemesGrid();
        loadCustomizeThemeGrid();
        
    } catch (error) {
        console.error('Failed to load themes:', error);
        console.error('Error stack:', error.stack);
        showError('Failed to load themes: ' + error.message);
    }
}

// Render themes grid
function renderThemesGrid() {
    const grid = document.getElementById('themes-grid');
    
    if (allThemes.length === 0) {
        grid.innerHTML = '<p class="no-themes">No themes available. Check your internet connection or refresh the page.</p>';
        return;
    }

    grid.innerHTML = allThemes.map(theme => `
        <div class="theme-card ${theme.is_applied ? 'applied' : ''}" data-theme-id="${theme.id || theme.name}">
            <div class="theme-preview-mini">
                <div class="preview-bg" style="background: ${theme.theme_data?.['--bg-primary'] || '#1a1a1a'};">
                    <div class="preview-accent" style="background: ${theme.theme_data?.['--text-accent'] || '#4a9eff'};"></div>
                </div>
            </div>
            <div class="theme-info">
                <h4 class="theme-title">${theme.display_name || theme.name}</h4>
                <p class="theme-description">${theme.description || 'No description available'}</p>
                <div class="theme-meta">
                    ${theme.is_built_in ? '<span class="theme-badge built-in">Built-in</span>' : ''}
                    ${theme.is_public ? '<span class="theme-badge public">Public</span>' : ''}
                </div>
            </div>
            <div class="theme-actions">
                <button onclick="quickApplyTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-success">
                    Apply
                </button>
                <button onclick="selectTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-primary">
                    Customize
                </button>
                ${!theme.is_built_in ? `
                    <button onclick="editTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-secondary" title="Edit Theme">
                        <iconify-icon icon="tabler:edit"></iconify-icon>
                    </button>
                    <button onclick="deleteTheme('${theme.id || theme.name}', '${theme.display_name}'); event.stopPropagation();" class="btn btn-sm btn-danger" title="Delete Theme">
                        <iconify-icon icon="tabler:trash"></iconify-icon>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// Load customize theme grid
function loadCustomizeThemeGrid() {
    const grid = document.getElementById('customize-theme-grid');
    if (!grid || allThemes.length === 0) return;
    
    grid.innerHTML = allThemes.map(theme => `
        <div class="customize-theme-card" data-theme-id="${theme.id || theme.name}" onclick="selectTheme('${theme.id || theme.name}')">
            <div class="theme-preview-mini">
                <div class="preview-bg" style="background: ${theme.theme_data?.['--bg-primary'] || '#1a1a1a'};">
                    <div class="preview-accent" style="background: ${theme.theme_data?.['--text-accent'] || '#4a9eff'};"></div>
                </div>
            </div>
            <span class="theme-name">${theme.display_name || theme.name}</span>
        </div>
    `).join('');
}

// Quick apply theme directly from theme card
async function quickApplyTheme(themeId) {
    const theme = allThemes.find(theme => (theme.id || theme.name) === themeId);
    
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    try {
        let themeToApply = theme;
        
        // If this is a built-in theme, get its CSS variables
        if (theme.is_built_in) {
            const extractResponse = await fetch(`/api/themes/built-in/${theme.name}/extract`, {
                method: 'POST'
            });
            if (extractResponse.ok) {
                const extractData = await extractResponse.json();
                themeToApply = {
                    ...theme,
                    theme_data: extractData.variables
                };
            }
        }
        
        // Apply theme variables to the document
        if (themeToApply.theme_data) {
            Object.entries(themeToApply.theme_data).forEach(([cssVar, value]) => {
                document.documentElement.style.setProperty(cssVar, value);
            });
        }
        
        // Save theme preference using themes API
        const response = await fetch('/api/themes/apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                theme_name: theme.id || theme.name
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to apply theme: ${response.status} - ${errorText}`);
        }
        
        // Update the global theme variable
        window.currentTheme = theme.id || theme.name;
        document.documentElement.setAttribute('data-theme', window.currentTheme);
        
        // Update visual feedback on theme cards
        document.querySelectorAll('.theme-card').forEach(card => {
            card.classList.remove('applied');
        });
        const appliedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
        if (appliedCard) {
            appliedCard.classList.add('applied');
        }
        
        showSuccess(`Applied theme "${theme.display_name}" successfully!`);
        
    } catch (error) {
        console.error('Failed to apply theme:', error);
        showError('Failed to apply theme: ' + error.message);
    }
}

// Select a theme for customization
function selectTheme(themeId) {
    // Remove active class from all cards
    document.querySelectorAll('.customize-theme-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Find the theme
    currentTheme = allThemes.find(theme => (theme.id || theme.name) === themeId);
    
    if (currentTheme) {
        loadThemeForCustomization(currentTheme);
        
        // Reset editing state unless this theme is being edited
        if (window.editingThemeId !== themeId) {
            window.editingThemeId = null;
            const updateBtn = document.getElementById('update-theme-btn');
            if (updateBtn) {
                updateBtn.style.display = 'none';
            }
        }
        
        // Switch to customize tab if not already active
        const customizeTab = document.querySelector('[onclick*="customize-tab"]');
        if (customizeTab && !customizeTab.classList.contains('active')) {
            switchThemeTab({target: customizeTab}, 'customize-tab');
        }
    }
}

// Load theme for customization
async function loadThemeForCustomization(theme) {
    let themeData = theme.theme_data;
    
    // If this is a built-in theme, extract its variables
    if (theme.is_built_in && !themeData) {
        try {
            const response = await fetch(`/api/themes/built-in/${theme.name}/extract`, {
                method: 'POST'
            });
            if (response.ok) {
                const extractData = await response.json();
                themeData = extractData.variables;
            }
        } catch (error) {
            console.error('Failed to extract theme variables:', error);
            themeData = {};
        }
    }
    
    // Update theme name
    document.getElementById('customizing-theme-name').textContent = `Customizing: ${theme.display_name || theme.name}`;
    
    // Load colors into inputs
    const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
    colorInputs.forEach(input => {
        const cssVar = input.dataset.cssVar;
        const value = themeData?.[cssVar] || input.nextElementSibling.textContent;
        input.value = value;
        input.nextElementSibling.textContent = value;
        
        // Apply the color to the document for live preview
        document.documentElement.style.setProperty(cssVar, value);
        
        // Add event listener for live updates
        input.addEventListener('input', function() {
            document.documentElement.style.setProperty(cssVar, this.value);
            this.nextElementSibling.textContent = this.value;
        });
    });
    
    // Show the customization panel
    document.getElementById('color-customization-panel').style.display = 'block';
}

// Apply current theme
async function applyCurrentTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    try {
        // Get current values from color inputs
        const themeData = {};
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            themeData[cssVar] = input.value;
        });
        
        // Apply theme variables to the document
        Object.entries(themeData).forEach(([cssVar, value]) => {
            document.documentElement.style.setProperty(cssVar, value);
        });
        
        // Save theme preference using themes API
        const response = await fetch('/api/themes/apply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                theme_name: currentTheme.id || currentTheme.name
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to apply theme: ${response.status} - ${errorText}`);
        }
        
        // Update the global theme variable
        window.currentTheme = currentTheme.id || currentTheme.name;
        document.documentElement.setAttribute('data-theme', window.currentTheme);
        
        showSuccess(`Applied theme "${currentTheme.display_name}" successfully!`);
        
    } catch (error) {
        console.error('Failed to apply theme:', error);
        showError('Failed to apply theme: ' + error.message);
    }
}

// Reset to default colors
async function resetToDefault() {
    if (!currentTheme) return;
    
    try {
        // Reload the original theme
        await loadThemeForCustomization(currentTheme);
        showSuccess('Reset to default colors');
    } catch (error) {
        console.error('Failed to reset theme:', error);
        showError('Failed to reset theme: ' + error.message);
    }
}

// Save custom theme
async function saveCustomTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    const customName = prompt('Enter a name for your custom theme:', `${currentTheme.display_name || currentTheme.name} Custom`);
    if (!customName) return;
    
    try {
        // Get current values from color inputs
        const themeData = {};
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            themeData[cssVar] = input.value;
        });
        
        // Save custom theme
        const response = await fetch('/api/themes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: customName.toLowerCase().replace(/\s+/g, '_'),
                display_name: customName,
                description: `Custom theme based on ${currentTheme.display_name || currentTheme.name}`,
                theme_data: themeData
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to save custom theme: ${response.status} - ${errorText}`);
        }
        
        showSuccess(`Custom theme "${customName}" saved successfully!`);
        loadThemes(); // Reload themes to show the new custom theme
        
    } catch (error) {
        console.error('Failed to save custom theme:', error);
        showError('Failed to save custom theme: ' + error.message);
    }
}

// Refresh themes
function refreshThemes() {
    loadThemes()
        .then(() => showSuccess('Themes refreshed successfully!'))
        .catch(error => showError('Failed to refresh themes: ' + error.message));
}

// Helper functions for notifications
function showSuccess(message) {
    console.log('Success:', message);
    // You can implement toast notifications here if available
}

function showError(message) {
    console.error('Error:', message);
    // You can implement toast notifications here if available
}

// Edit theme function
async function editTheme(themeId) {
    const theme = allThemes.find(t => (t.id || t.name) === themeId);
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    if (theme.is_built_in) {
        showError('Built-in themes cannot be edited');
        return;
    }
    
    // Switch to customize tab and select this theme for editing
    const customizeTab = document.querySelector('[onclick*="customize-themes-tab"]');
    if (customizeTab) {
        customizeTab.click();
        
        // Small delay to let tab switch complete
        setTimeout(() => {
            selectTheme(themeId);
            // Set the current theme as being edited
            window.editingThemeId = themeId;
            // Show the update button and hide save button while editing
            const updateBtn = document.getElementById('update-theme-btn');
            if (updateBtn) {
                updateBtn.style.display = 'inline-block';
            }
        }, 200);
    }
}

// Delete theme function with confirmation
async function deleteTheme(themeId, themeName) {
    const theme = allThemes.find(t => (t.id || t.name) === themeId);
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    if (theme.is_built_in) {
        showError('Built-in themes cannot be deleted');
        return;
    }
    
    // Show confirmation dialog
    const message = `Are you sure you want to delete the theme "${themeName}"? This action cannot be undone.`;
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedDeleteTheme(themeId);
        });
    } else {
        if (confirm(message)) {
            proceedDeleteTheme(themeId);
        }
    }
}

// Actually perform the theme deletion
async function proceedDeleteTheme(themeId) {
    try {
        const response = await fetch(`/api/themes/${themeId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showSuccess(`Theme "${data.theme_name}" deleted successfully`);
            
            // Remove from allThemes array
            const themeIndex = allThemes.findIndex(t => (t.id || t.name) === themeId);
            if (themeIndex !== -1) {
                allThemes.splice(themeIndex, 1);
            }
            
            // Re-render the themes grid
            renderThemesGrid();
            loadCustomizeThemeGrid();
            
            // If this was the currently applied theme, we might need to handle that
            // but the API should handle switching to a default theme
            
        } else {
            showError(data.error || 'Failed to delete theme');
        }
    } catch (error) {
        console.error('Error deleting theme:', error);
        showError('Failed to delete theme: ' + error.message);
    }
}

// Update current theme function (for editing existing themes)
async function updateCurrentTheme() {
    if (!currentTheme || !window.editingThemeId) {
        showError('No theme selected for editing');
        return;
    }
    
    const themeToUpdate = allThemes.find(t => (t.id || t.name) === window.editingThemeId);
    if (!themeToUpdate) {
        showError('Theme to update not found');
        return;
    }
    
    if (themeToUpdate.is_built_in) {
        showError('Built-in themes cannot be updated');
        return;
    }
    
    try {
        // Get current values from color inputs
        const themeData = {};
        const lightThemeData = {};
        
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            if (input.dataset.mode === 'light') {
                lightThemeData[cssVar] = input.value;
            } else {
                themeData[cssVar] = input.value;
            }
        });
        
        // Update existing theme
        const response = await fetch(`/api/themes/${window.editingThemeId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                theme_data: themeData,
                light_theme_data: Object.keys(lightThemeData).length > 0 ? lightThemeData : undefined
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to update theme: ${response.status}`);
        }
        
        const updatedTheme = await response.json();
        showSuccess(`Theme "${updatedTheme.display_name}" updated successfully!`);
        
        // Clear editing state
        window.editingThemeId = null;
        const updateBtn = document.getElementById('update-theme-btn');
        if (updateBtn) {
            updateBtn.style.display = 'none';
        }
        
        // Reload themes to show the updated theme
        loadThemes();
        
    } catch (error) {
        console.error('Failed to update theme:', error);
        showError('Failed to update theme: ' + error.message);
    }
}

// Override the main switchTab function to initialize themes when themes tab is activated
const originalSwitchTab = switchTab;
switchTab = function(event, tabId) {
    originalSwitchTab(event, tabId);
    
    if (tabId === 'themes-tab') {
        // Small delay to ensure tab is fully activated
        setTimeout(initializeThemesTab, 100);
    }
};

</script>

{% endblock %}