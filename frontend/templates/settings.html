{% extends "base.html" %}

{% block title %}Settings - MVidarr{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title-section">
            <h1 class="text-h1">Settings</h1>
        </div>
        <div class="action-group" role="group" aria-label="Settings actions">
            <button onclick="saveSettings()" class="btn btn-primary" aria-label="Save current settings">
                <iconify-icon icon="mdi:content-save" aria-hidden="true"></iconify-icon>
                Save Settings
            </button>
            <button onclick="restartApp()" class="btn btn-warning" aria-label="Restart application to apply changes">
                <iconify-icon icon="mdi:restart" aria-hidden="true"></iconify-icon>
                Restart Application
            </button>
        </div>
    </div>

    <div class="settings-container">

    <!-- Settings Tabs -->
    <div class="settings-tabs" role="tablist" aria-label="Settings categories">
        <button class="settings-tab-btn active" onclick="switchTab(event, 'general-tab')" 
                role="tab" aria-selected="true" aria-controls="general-tab" id="tab-general">
            <iconify-icon icon="mdi:cog" class="tab-icon" aria-hidden="true"></iconify-icon> General
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'security-tab')"
                role="tab" aria-selected="false" aria-controls="security-tab" id="tab-security">
            <iconify-icon icon="mdi:shield-lock" class="tab-icon" aria-hidden="true"></iconify-icon> Security
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'services-tab')"
                role="tab" aria-selected="false" aria-controls="services-tab" id="tab-services">
            <iconify-icon icon="mdi:link" class="tab-icon" aria-hidden="true"></iconify-icon> Services
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'downloads-tab')"
                role="tab" aria-selected="false" aria-controls="downloads-tab" id="tab-downloads">
            <iconify-icon icon="mdi:download" class="tab-icon" aria-hidden="true"></iconify-icon> Downloads
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'database-tab')"
                role="tab" aria-selected="false" aria-controls="database-tab" id="tab-database">
            <iconify-icon icon="mdi:database" class="tab-icon" aria-hidden="true"></iconify-icon> Database
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'system-tab')"
                role="tab" aria-selected="false" aria-controls="system-tab" id="tab-system">
            <iconify-icon icon="mdi:tools" class="tab-icon" aria-hidden="true"></iconify-icon> System
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'themes-tab')"
                role="tab" aria-selected="false" aria-controls="themes-tab" id="tab-themes">
            <iconify-icon icon="mdi:palette" class="tab-icon" aria-hidden="true"></iconify-icon> Themes
        </button>
        <button class="settings-tab-btn" onclick="switchTab(event, 'blacklist-tab')"
                role="tab" aria-selected="false" aria-controls="blacklist-tab" id="tab-blacklist">
            <iconify-icon icon="tabler:list-x" class="tab-icon" aria-hidden="true"></iconify-icon> Blacklist
        </button>
    </div>

    <!-- Tab Content -->
    <div class="settings-tab-content">

        <!-- General Tab -->
        <div id="general-tab" class="settings-tab-panel active" role="tabpanel" aria-labelledby="tab-general">
            <div class="settings-sections">
        <div class="settings-section">
            <h2>Application</h2>
            <div class="form-group">
                <label for="app_port">Port:</label>
                <input type="number" id="app_port" name="app_port" min="1" max="65535">
            </div>
            <div class="form-group">
                <label for="debug_mode">Debug Mode:</label>
                <select id="debug_mode" name="debug_mode">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="secret_key">Secret Key:</label>
                <input type="password" id="secret_key" name="secret_key" placeholder="Flask secret key for sessions">
            </div>
            <div class="form-group">
                <label for="require_authentication">Require User Authentication:</label>
                <select id="require_authentication" name="require_authentication">
                    <option value="false">Disabled - Open Access</option>
                    <option value="true">Enabled - Login Required</option>
                </select>
                <div class="form-help">
                    <small>When enabled, users must log in with username/password to access the system. Requires application restart to take effect.</small>
                </div>
            </div>
        </div>

        <div class="settings-section" id="userCredentialsSection" style="display: none;">
            <h2>👤 User Credentials</h2>
            <div class="form-help">
                <small>Configure the username and password for accessing the system when authentication is enabled.</small>
            </div>
            <div class="form-group">
                <label for="auth_username">Username:</label>
                <input type="text" id="auth_username" name="auth_username" placeholder="Enter username" minlength="3">
                <div class="form-help">
                    <small>Username must be at least 3 characters long</small>
                </div>
            </div>
            <div class="form-group">
                <label for="auth_password">Password:</label>
                <input type="password" id="auth_password" name="auth_password" placeholder="Enter new password" minlength="6">
                <div class="form-help">
                    <small>Password must be at least 6 characters long</small>
                </div>
            </div>
            <div class="form-group">
                <label for="auth_password_confirm">Confirm Password:</label>
                <input type="password" id="auth_password_confirm" name="auth_password_confirm" placeholder="Confirm new password" minlength="6">
                <div class="form-help">
                    <small>Re-enter the password to confirm</small>
                </div>
            </div>
            <div class="form-group">
                <button onclick="updateCredentials()" class="btn btn-primary">🔑 Update Credentials</button>
                <button onclick="resetCredentials()" class="btn btn-secondary">🔄 Reset to Default</button>
            </div>
        </div>


        <div class="settings-section">
            <h2>Paths</h2>
            <div class="form-group">
                <label for="downloads_path">Downloads Directory:</label>
                <input type="text" id="downloads_path" name="downloads_path">
            </div>
            <div class="form-group">
                <label for="music_videos_path">Music Videos Directory:</label>
                <input type="text" id="music_videos_path" name="music_videos_path" placeholder="Organized music videos by artist">
            </div>
            <div class="form-group">
                <label for="thumbnails_path">Thumbnails Directory:</label>
                <input type="text" id="thumbnails_path" name="thumbnails_path">
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Security Tab -->
        <div id="security-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>🔒 SSL/TLS Security</h2>
            <div class="form-group">
                <label for="ssl_required">Enforce HTTPS:</label>
                <select id="ssl_required" name="ssl_required">
                    <option value="false">Disabled - Allow HTTP</option>
                    <option value="true">Enabled - Redirect HTTP to HTTPS</option>
                </select>
                <div class="form-help">
                    <small>When enabled, all HTTP requests will be redirected to HTTPS. Requires SSL termination at reverse proxy or web server level.</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_port">HTTPS Port:</label>
                <input type="number" id="ssl_port" name="ssl_port" min="1" max="65535" value="443">
                <div class="form-help">
                    <small>Default port for HTTPS connections (typically 443).</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_hsts_enabled">HTTP Strict Transport Security (HSTS):</label>
                <select id="ssl_hsts_enabled" name="ssl_hsts_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
                <div class="form-help">
                    <small>HSTS tells browsers to only access the site over HTTPS. Only enable if SSL is properly configured.</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_hsts_max_age">HSTS Max Age (seconds):</label>
                <input type="number" id="ssl_hsts_max_age" name="ssl_hsts_max_age" min="300" max="31536000" value="31536000">
                <div class="form-help">
                    <small>How long browsers should enforce HTTPS-only access (31536000 = 1 year).</small>
                </div>
            </div>
            <div class="form-group">
                <label for="ssl_redirect_permanent">Use Permanent Redirects:</label>
                <select id="ssl_redirect_permanent" name="ssl_redirect_permanent">
                    <option value="false">Temporary (302)</option>
                    <option value="true">Permanent (301)</option>
                </select>
                <div class="form-help">
                    <small>Permanent redirects are cached by browsers and search engines.</small>
                </div>
            </div>
            <div class="ssl-warning">
                <strong>⚠️ Important:</strong> Only enable SSL enforcement if you have properly configured SSL termination at your reverse proxy (nginx, Apache, Cloudflare, etc.) or web server level. Enabling this without proper SSL setup will make the application inaccessible.
            </div>
        </div>

        <div class="settings-section">
            <h2>📄 Certificate Management</h2>
            <div class="form-help">
                <small>Manage SSL certificates for HTTPS connections. Upload certificate and private key files for custom SSL configuration.</small>
            </div>
            
            <!-- Current Certificate Status -->
            <div class="certificate-status">
                <h3>Current Certificate Status</h3>
                <div id="cert-status-info">
                    <div class="status-item">
                        <span class="status-label">Certificate:</span>
                        <span id="cert-status" class="status-value">Not configured</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Private Key:</span>
                        <span id="key-status" class="status-value">Not configured</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Expiry Date:</span>
                        <span id="cert-expiry" class="status-value">N/A</span>
                    </div>
                </div>
            </div>

            <!-- Certificate Upload -->
            <div class="certificate-upload">
                <h3>Upload New Certificate</h3>
                <div class="form-group">
                    <label for="ssl-certificate-file">SSL Certificate (.crt, .pem):</label>
                    <input type="file" id="ssl-certificate-file" name="ssl_certificate" accept=".crt,.pem,.cert" aria-describedby="cert-file-help">
                    <div class="form-help" id="cert-file-help">
                        <small>Upload your SSL certificate file (usually ends with .crt or .pem)</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ssl-private-key-file">Private Key (.key, .pem):</label>
                    <input type="file" id="ssl-private-key-file" name="ssl_private_key" accept=".key,.pem" aria-describedby="key-file-help">
                    <div class="form-help" id="key-file-help">
                        <small>Upload your private key file (usually ends with .key or .pem)</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ssl-certificate-chain">Certificate Chain (Optional):</label>
                    <input type="file" id="ssl-certificate-chain" name="ssl_certificate_chain" accept=".crt,.pem,.chain" aria-describedby="chain-file-help">
                    <div class="form-help" id="chain-file-help">
                        <small>Upload certificate chain file if required by your CA (intermediate certificates)</small>
                    </div>
                </div>
            </div>

            <!-- Certificate Actions -->
            <div class="certificate-actions">
                <button onclick="uploadCertificates()" class="btn btn-primary" id="upload-cert-btn">
                    <iconify-icon icon="mdi:upload" aria-hidden="true"></iconify-icon>
                    Upload Certificates
                </button>
                <button onclick="validateCertificate()" class="btn btn-info" id="validate-cert-btn">
                    <iconify-icon icon="mdi:certificate" aria-hidden="true"></iconify-icon>
                    Validate Certificate
                </button>
                <button onclick="downloadCertificate()" class="btn btn-secondary" id="download-cert-btn" style="display: none;">
                    <iconify-icon icon="mdi:download" aria-hidden="true"></iconify-icon>
                    Download Current Certificate
                </button>
                <button onclick="removeCertificates()" class="btn btn-danger" id="remove-cert-btn" style="display: none;">
                    <iconify-icon icon="mdi:delete" aria-hidden="true"></iconify-icon>
                    Remove Certificates
                </button>
            </div>

            <!-- Certificate Upload Progress -->
            <div id="cert-upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="cert-progress-fill"></div>
                </div>
                <div class="progress-text" id="cert-progress-text">Uploading certificates...</div>
            </div>

            <!-- Certificate Validation Results -->
            <div id="cert-validation-results" style="display: none;">
                <h4>Certificate Validation Results</h4>
                <div id="cert-validation-content"></div>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Services Tab -->
        <div id="services-tab" class="settings-tab-panel">
            <div class="settings-sections">
        
        <div class="settings-section">
            <h2>Core Services</h2>
            <div class="form-group">
                <label for="imvdb_api_key">IMVDB API Key:</label>
                <input type="password" id="imvdb_api_key" name="imvdb_api_key">
            </div>
            <div class="form-group">
                <label for="youtube_api_key">YouTube API Key:</label>
                <input type="password" id="youtube_api_key" name="youtube_api_key">
            </div>
        </div>

        <div class="settings-section">
            <h2>YouTube Integration</h2>
            <div class="form-group">
                <label for="youtube_enabled">Enable YouTube Integration:</label>
                <select id="youtube_enabled" name="youtube_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="youtube_playlist_sync_interval">Playlist Sync Interval (minutes):</label>
                <input type="number" id="youtube_playlist_sync_interval" name="youtube_playlist_sync_interval" min="5" max="1440" value="60">
            </div>
            <div class="form-group">
                <label for="youtube_auto_download">Auto-download New Videos:</label>
                <select id="youtube_auto_download" name="youtube_auto_download">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="integration-actions">
                <button onclick="testYouTubeIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="syncYouTubePlaylists()" class="btn btn-secondary">Sync Playlists</button>
                <a href="/youtube-playlists" class="btn btn-primary">📺 YouTube Playlists Manager</a>
            </div>
        </div>

        <div class="settings-section">
            <h2>Spotify Integration</h2>
            <div class="form-group">
                <label for="spotify_enabled">Enable Spotify Integration:</label>
                <select id="spotify_enabled" name="spotify_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="spotify_client_id">Spotify Client ID:</label>
                <input type="text" id="spotify_client_id" name="spotify_client_id">
            </div>
            <div class="form-group">
                <label for="spotify_client_secret">Spotify Client Secret:</label>
                <input type="password" id="spotify_client_secret" name="spotify_client_secret">
            </div>
            <div class="form-group">
                <label for="spotify_redirect_uri">Redirect URI:</label>
                <input type="text" id="spotify_redirect_uri" name="spotify_redirect_uri" placeholder="http://localhost:5000/api/spotify/callback">
            </div>
            <div class="integration-actions">
                <button onclick="testSpotifyIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="authorizeSpotify()" class="btn btn-success">Authorize</button>
                <button onclick="importSpotifyPlaylists()" class="btn btn-secondary">Import Playlists</button>
                <a href="/spotify" class="btn btn-primary">🎵 Spotify Manager</a>
            </div>
        </div>

        <div class="settings-section">
            <h2>Last.fm Integration</h2>
            <div class="form-group">
                <label for="lastfm_enabled">Enable Last.fm Integration:</label>
                <select id="lastfm_enabled" name="lastfm_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lastfm_api_key">Last.fm API Key:</label>
                <input type="password" id="lastfm_api_key" name="lastfm_api_key" placeholder="Get from https://www.last.fm/api/account/create">
            </div>
            <div class="form-group">
                <label for="lastfm_api_secret">Last.fm API Secret:</label>
                <input type="password" id="lastfm_api_secret" name="lastfm_api_secret">
            </div>
            <div class="form-group">
                <label for="lastfm_username">Connected Username:</label>
                <input type="text" id="lastfm_username" name="lastfm_username" placeholder="Connected Last.fm username" readonly>
            </div>
            <div class="integration-actions">
                <button onclick="testLastfmIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="authorizeLastfm()" class="btn btn-success">Authorize</button>
                <button onclick="syncLastfmHistory()" class="btn btn-secondary">Sync Listening History</button>
                <a href="/lastfm" class="btn btn-primary">🎵 Last.fm Manager</a>
            </div>
        </div>

        <div class="settings-section">
            <h2>Lidarr Integration</h2>
            <div class="form-group">
                <label for="lidarr_enabled">Enable Lidarr Integration:</label>
                <select id="lidarr_enabled" name="lidarr_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lidarr_server_url">Lidarr Server URL:</label>
                <input type="text" id="lidarr_server_url" name="lidarr_server_url" placeholder="http://localhost:8686">
            </div>
            <div class="form-group">
                <label for="lidarr_api_key">Lidarr API Key:</label>
                <input type="password" id="lidarr_api_key" name="lidarr_api_key">
            </div>
            <div class="form-group">
                <label for="lidarr_sync_interval">Sync Interval (hours):</label>
                <input type="number" id="lidarr_sync_interval" name="lidarr_sync_interval" min="1" max="168" value="6">
            </div>
            <div class="form-group">
                <label for="lidarr_sync_monitored_only">Sync Monitored Artists Only:</label>
                <select id="lidarr_sync_monitored_only" name="lidarr_sync_monitored_only">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="integration-actions">
                <button onclick="testLidarrIntegration()" class="btn btn-info">Test Connection</button>
                <button onclick="syncLidarrLibrary()" class="btn btn-secondary">Sync Library</button>
                <button onclick="importLidarrArtists()" class="btn btn-secondary">Import Artists</button>
                <button onclick="syncLidarrAlbums()" class="btn btn-secondary">Sync Albums</button>
                <a href="/lidarr" class="btn btn-primary">🎵 Lidarr Manager</a>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Downloads Tab -->
        <div id="downloads-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>Download Settings</h2>
            <div class="form-group">
                <label for="auto_organize_downloads">Auto-organize Downloads:</label>
                <select id="auto_organize_downloads" name="auto_organize_downloads">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="auto_index_organized_videos">Auto-index Organized Videos:</label>
                <select id="auto_index_organized_videos" name="auto_index_organized_videos">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div class="form-group">
                <label for="video_quality_preference">Video Quality:</label>
                <select id="video_quality_preference" name="video_quality_preference">
                    <option value="best">Best Available</option>
                    <option value="1080p">1080p</option>
                    <option value="720p">720p</option>
                    <option value="480p">480p</option>
                </select>
            </div>
            <div class="form-group">
                <label for="download_subtitles">Download Closed Captions:</label>
                <select id="download_subtitles" name="download_subtitles">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
                <small class="help-text">Download and embed closed captions/subtitles when available</small>
            </div>
            <div class="form-group">
                <label for="subtitle_languages">Subtitle Languages:</label>
                <input type="text" id="subtitle_languages" name="subtitle_languages" placeholder="en.*,es,fr" value="en.*">
                <small class="help-text">Comma-separated list of language codes (e.g., en.*, es, fr). Use 'en.*' to match any English variant.</small>
            </div>
            
            <!-- YouTube Cookie Authentication -->
            <div class="form-group cookie-management-section">
                <label>🍪 YouTube Authentication:</label>
                <div class="cookie-upload-container">
                    <div id="cookieStatusSettings" class="cookie-status">
                        <span class="status-text">Checking cookie status...</span>
                    </div>
                    
                    <div class="cookie-actions">
                        <button type="button" id="uploadCookieBtnSettings" class="btn btn-success btn-sm" onclick="document.getElementById('cookieFileInputSettings').click()">
                            📤 Upload Cookies
                        </button>
                        <button type="button" id="deleteCookieBtnSettings" class="btn btn-danger btn-sm" onclick="deleteCookiesSettings()" style="display: none;">
                            🗑️ Delete Cookies
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="showCookieInstructionsSettings()">
                            ❓ Help
                        </button>
                    </div>
                    
                    <input type="file" id="cookieFileInputSettings" accept=".txt,.cookies" style="display: none;" onchange="uploadCookiesSettings(this)">
                    
                    <small class="help-text">
                        Upload your YouTube cookies to enable downloads of age-restricted videos. 
                        The cookie file should be in Netscape format exported from your browser.
                    </small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="max_concurrent_downloads">Max Concurrent Downloads:</label>
                <input type="number" id="max_concurrent_downloads" name="max_concurrent_downloads" min="1" max="10">
            </div>
        </div>

        <div class="settings-section">
            <h2>Scheduled Downloads</h2>
            <p class="section-description">Automatically download videos marked as WANTED at regular intervals</p>
            
            <div class="form-group">
                <label for="auto_download_schedule_enabled">Enable Scheduled Downloads:</label>
                <select id="auto_download_schedule_enabled" name="auto_download_schedule_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="auto_download_schedule_days">Download Frequency:</label>
                <select id="auto_download_schedule_days" name="auto_download_schedule_days">
                    <option value="hourly">Every Hour</option>
                    <option value="every_2_hours">Every 2 Hours</option>
                    <option value="every_4_hours">Every 4 Hours</option>
                    <option value="every_6_hours">Every 6 Hours</option>
                    <option value="every_8_hours">Every 8 Hours</option>
                    <option value="every_12_hours">Every 12 Hours</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                </select>
            </div>
            
            <div class="form-group" id="download_time_group">
                <label for="auto_download_schedule_time">Schedule Time:</label>
                <input type="time" id="auto_download_schedule_time" name="auto_download_schedule_time" title="Time to run downloads (only applies to daily/weekly)">
                <small class="form-hint">Only used for daily and weekly schedules</small>
            </div>
            
            <div class="form-group">
                <label for="auto_download_max_videos">Max Videos per Run:</label>
                <input type="number" id="auto_download_max_videos" name="auto_download_max_videos" min="1" max="500" value="10" title="Maximum number of videos to download per scheduled run">
            </div>
        </div>

        <div class="settings-section">
            <h2>Video Discovery</h2>
            <p class="section-description">Automatically discover new videos for monitored artists</p>
            
            <div class="form-group">
                <label for="auto_discovery_schedule_enabled">Enable Video Discovery:</label>
                <select id="auto_discovery_schedule_enabled" name="auto_discovery_schedule_enabled">
                    <option value="false">Disabled</option>
                    <option value="true">Enabled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="auto_discovery_schedule_days">Discovery Frequency:</label>
                <select id="auto_discovery_schedule_days" name="auto_discovery_schedule_days">
                    <option value="daily">Daily</option>
                    <option value="twice_daily">Twice Daily (12 hours apart)</option>
                    <option value="weekly">Weekly</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="auto_discovery_schedule_time">Discovery Time:</label>
                <input type="time" id="auto_discovery_schedule_time" name="auto_discovery_schedule_time" value="06:00" title="Time to run video discovery">
            </div>
            
            <div class="form-group">
                <label for="auto_discovery_max_videos_per_artist">Max Videos per Artist:</label>
                <input type="number" id="auto_discovery_max_videos_per_artist" name="auto_discovery_max_videos_per_artist" min="1" max="50" value="5" title="Maximum new videos to discover per artist per run">
            </div>
            
            <div class="discovery-info">
                <p><strong>Note:</strong> Video discovery searches for new videos for artists marked as "monitored" and adds them with WANTED status for automatic download.</p>
            </div>
        </div>

        <div class="settings-section">
            <h2>Scheduler Status & Control</h2>
            <div class="form-group">
                <label>Current Status:</label>
                <div id="scheduler-status">
                    <span id="scheduler-loading">Loading...</span>
                </div>
            </div>
            <div class="scheduler-actions">
                <button onclick="testScheduledDownload()" class="btn btn-info">Test Download Now</button>
                <button onclick="startScheduler()" class="btn btn-success">Start Scheduler</button>
                <button onclick="stopScheduler()" class="btn btn-warning">Stop Scheduler</button>
                <button onclick="reloadScheduler()" class="btn btn-secondary">Reload Schedule</button>
                <button onclick="refreshSchedulerStatus()" class="btn btn-light">Refresh Status</button>
            </div>
            
            <!-- Enhanced Scheduler Actions (shown when enhanced scheduler is active) -->
            <div id="enhanced-scheduler-actions" class="scheduler-actions" style="display: none;">
                <button onclick="triggerEnhancedDownload()" class="btn btn-primary">🔽 Trigger Download</button>
                <button onclick="triggerEnhancedDiscovery()" class="btn btn-info">🔍 Trigger Discovery</button>
                <button onclick="viewEnhancedSchedulerHealth()" class="btn btn-success">🏥 Health Check</button>
                <button onclick="viewEnhancedSchedulerConfig()" class="btn btn-secondary">⚙️ View Config</button>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- Database Tab -->
        <div id="database-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>Database</h2>
            <div class="form-group">
                <label for="db_host">Database Host:</label>
                <input type="text" id="db_host" name="db_host">
            </div>
            <div class="form-group">
                <label for="db_port">Database Port:</label>
                <input type="number" id="db_port" name="db_port" min="1" max="65535">
            </div>
            <div class="form-group">
                <label for="db_name">Database Name:</label>
                <input type="text" id="db_name" name="db_name">
            </div>
            <div class="form-group">
                <label for="db_user">Database User:</label>
                <input type="text" id="db_user" name="db_user">
            </div>
            <div class="form-group">
                <label for="db_password">Database Password:</label>
                <input type="password" id="db_password" name="db_password">
            </div>
        </div>

        <div class="settings-section">
            <h2>Database Pool Settings</h2>
            <div class="form-group">
                <label for="db_pool_size">Pool Size:</label>
                <input type="number" id="db_pool_size" name="db_pool_size" min="1" max="100">
            </div>
            <div class="form-group">
                <label for="db_pool_overflow">Pool Overflow:</label>
                <input type="number" id="db_pool_overflow" name="db_pool_overflow" min="0" max="100">
            </div>
            <div class="form-group">
                <label for="db_pool_recycle">Pool Recycle (seconds):</label>
                <input type="number" id="db_pool_recycle" name="db_pool_recycle" min="300" max="86400">
            </div>
            <div class="form-group">
                <label for="db_pool_timeout">Pool Timeout (seconds):</label>
                <input type="number" id="db_pool_timeout" name="db_pool_timeout" min="5" max="300">
            </div>
            
            <div class="settings-info-box">
                <h4><iconify-icon icon="tabler:info-circle"></iconify-icon> Database Pool Settings Information</h4>
                <ul>
                    <li><strong>Pool Size:</strong> The number of persistent database connections to maintain. Higher values allow more concurrent operations but use more memory. Recommended: 5-20 for most setups.</li>
                    <li><strong>Pool Overflow:</strong> Additional temporary connections allowed beyond pool size during high load. These connections are closed when no longer needed. Recommended: 10-30.</li>
                    <li><strong>Pool Recycle (seconds):</strong> How long a connection stays open before being replaced. Prevents stale connections and database timeouts. Recommended: 3600 (1 hour).</li>
                    <li><strong>Pool Timeout (seconds):</strong> Maximum time to wait for an available connection before failing. Lower values fail faster, higher values wait longer. Recommended: 30-60 seconds.</li>
                </ul>
                <p><strong>Note:</strong> Changes require a service restart to take effect. Monitor system performance after adjusting these settings.</p>
            </div>
        </div>
        
            </div>
        </div>
        
        <!-- System Tab -->
        <div id="system-tab" class="settings-tab-panel">
            <div class="settings-sections">

        <div class="settings-section">
            <h2>Video Indexing</h2>
            <div class="form-group">
                <label>Database Status:</label>
                <div id="indexing-stats">
                    <span id="stats-loading">Loading...</span>
                </div>
            </div>
            <div class="form-group">
                <label>IMVDB Connection:</label>
                <div id="imvdb-status">
                    <span id="imvdb-loading">Checking...</span>
                </div>
            </div>
            <div class="indexing-actions">
                <button onclick="testImvdbConnection()" class="btn btn-info">Test IMVDB Connection</button>
                <button onclick="indexAllVideos()" class="btn btn-primary">Index All Videos</button>
                <button onclick="scanVideoFiles()" class="btn btn-info">Scan Video Files</button>
                <button onclick="populateArtistThumbnails()" class="btn btn-warning">Populate Artist Thumbnails</button>
                <button onclick="fixMissingVideos()" class="btn btn-warning">Fix Missing Videos</button>
                <button onclick="refreshStats()" class="btn btn-light">Refresh Stats</button>
            </div>
            <div id="indexing-progress" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <span id="progress-text">Processing...</span>
            </div>
            <div id="indexing-results" class="results-container" style="display: none;"></div>
        </div>

        <div class="settings-section">
            <h2>Logging</h2>
            <div class="form-group">
                <label for="log_level">Log Level:</label>
                <select id="log_level" name="log_level">
                    <option value="DEBUG">Debug</option>
                    <option value="INFO">Info</option>
                    <option value="WARNING">Warning</option>
                    <option value="ERROR">Error</option>
                    <option value="CRITICAL">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label for="log_max_size">Max Log File Size (bytes):</label>
                <input type="number" id="log_max_size" name="log_max_size" min="1048576" max="104857600">
            </div>
            <div class="form-group">
                <label for="log_backup_count">Log Backup Count:</label>
                <input type="number" id="log_backup_count" name="log_backup_count" min="1" max="20">
            </div>
        </div>
        
            </div>
        </div>

        <!-- Themes Tab -->
        <div id="themes-tab" class="settings-tab-panel">
            <div class="themes-container">
                
                <!-- Theme Actions -->
                <div class="theme-actions">
                    <button onclick="refreshThemes()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:refresh" style="margin-right: 5px;"></iconify-icon>
                        Refresh Themes
                    </button>
                    <button onclick="importThemes()" class="btn btn-info">
                        <iconify-icon icon="tabler:upload" style="margin-right: 5px;"></iconify-icon>
                        Import Themes
                    </button>
                    <button onclick="exportAllThemes()" class="btn btn-warning">
                        <iconify-icon icon="tabler:download" style="margin-right: 5px;"></iconify-icon>
                        Export All Themes
                    </button>
                </div>

                <!-- Theme Tabs -->
                <div class="theme-tabs">
                    <button class="theme-tab-btn active" onclick="switchThemeTab(event, 'browse-tab')">
                        <iconify-icon icon="tabler:grid-3x3" class="tab-icon"></iconify-icon> Browse Themes
                    </button>
                    <button class="theme-tab-btn" onclick="switchThemeTab(event, 'customize-tab')">
                        <iconify-icon icon="tabler:brush" class="tab-icon"></iconify-icon> Customize
                    </button>
                </div>

                <!-- Browse Themes Tab -->
                <div id="browse-tab" class="theme-tab-content active">
                    <div class="themes-grid-container">
                        <h3>Available Themes</h3>
                        <div id="themes-grid" class="themes-grid">
                            <!-- Themes will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Customize Tab -->
                <div id="customize-tab" class="theme-tab-content">
                    <div class="theme-customize-container">
                        <div class="customize-header">
                            <h3>Theme Customizer</h3>
                            <p class="customize-description">
                                Select a theme to customize its colors and properties. Changes are applied immediately as you make them.
                            </p>
                        </div>

                        <!-- Theme Selection for Customization -->
                        <div class="customize-theme-selection">
                            <h4>Select Theme to Customize</h4>
                            <div id="customize-theme-grid" class="customize-themes-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Color Customization Panel -->
                        <div id="color-customization-panel" class="color-panel" style="display: none;">
                            <div class="panel-header">
                                <h4 id="customizing-theme-name">Customizing: Theme Name</h4>
                                <div class="panel-actions">
                                    <button onclick="resetToDefault()" class="btn btn-secondary">
                                        <iconify-icon icon="tabler:refresh"></iconify-icon>
                                        Reset to Default
                                    </button>
                                    <button onclick="applyCurrentTheme()" class="btn btn-success">
                                        <iconify-icon icon="tabler:check"></iconify-icon>
                                        Apply Theme
                                    </button>
                                    <button onclick="saveCustomTheme()" class="btn btn-primary">
                                        <iconify-icon icon="tabler:device-floppy"></iconify-icon>
                                        Save as Custom
                                    </button>
                                    <button onclick="updateCurrentTheme()" class="btn btn-warning" id="update-theme-btn" style="display: none;">
                                        <iconify-icon icon="tabler:refresh"></iconify-icon>
                                        Update Theme
                                    </button>
                                    <button onclick="saveCurrentTheme()" class="btn btn-info" id="save-current-theme-btn">
                                        <iconify-icon icon="tabler:device-floppy"></iconify-icon>
                                        Save Current Theme
                                    </button>
                                    <button onclick="exportCurrentTheme()" class="btn btn-outline-secondary" id="export-current-theme-btn">
                                        <iconify-icon icon="tabler:download"></iconify-icon>
                                        Export Theme
                                    </button>
                                </div>
                            </div>

                            <!-- Theme Details -->  
                            <div class="theme-details" id="theme-details-section" style="display: none;"> 
                                <div class="form-group">
                                    <label for="theme-name-input">Theme Name:</label>
                                    <input type="text" id="theme-name-input" class="form-control" placeholder="Enter theme name">
                                </div>
                                <div class="form-group">
                                    <label for="theme-description-input">Description:</label>
                                    <textarea id="theme-description-input" class="form-control" rows="2" placeholder="Enter theme description"></textarea>
                                </div>
                            </div>

                            <!-- Color Controls with Dark/Light tabs -->
                            <div class="color-controls">
                                <div class="theme-mode-tabs">
                                    <button class="theme-mode-tab active" id="dark-theme-tab">
                                        <iconify-icon icon="tabler:moon"></iconify-icon>
                                        Dark Theme
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Dark Theme Colors -->
                            <div class="theme-mode-content active" id="dark-theme-content">
                                <div class="color-controls">
                                <div class="color-groups">
                                    <!-- Background Colors -->
                                    <div class="color-group">
                                        <h5>Background Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="bg-primary">Primary Background:</label>
                                                <input type="color" id="bg-primary" data-css-var="--bg-primary">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-secondary">Secondary Background:</label>
                                                <input type="color" id="bg-secondary" data-css-var="--bg-secondary">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-tertiary">Tertiary Background:</label>
                                                <input type="color" id="bg-tertiary" data-css-var="--bg-tertiary">
                                                <span class="color-value">#3a3a3a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="sidebar-bg">Sidebar Background:</label>
                                                <input type="color" id="sidebar-bg" data-css-var="--sidebar-bg">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="sidebar-bg-secondary">Sidebar Secondary:</label>
                                                <input type="color" id="sidebar-bg-secondary" data-css-var="--sidebar-bg-secondary">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="search-bar-bg">Search Bar Background:</label>
                                                <input type="color" id="search-bar-bg" data-css-var="--search-bar-bg">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-modal">Modal Background:</label>
                                                <input type="color" id="bg-modal" data-css-var="--bg-modal">
                                                <span class="color-value">#333333</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-card">Card Background:</label>
                                                <input type="color" id="bg-card" data-css-var="--bg-card">
                                                <span class="color-value">#2a2a2a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="bg-hover">Hover Background:</label>
                                                <input type="color" id="bg-hover" data-css-var="--bg-hover">
                                                <span class="color-value">#404040</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="top-bar-bg">Top Bar Background:</label>
                                                <input type="color" id="top-bar-bg" data-css-var="--top-bar-bg">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Text Colors -->
                                    <div class="color-group">
                                        <h5>Text Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="text-primary">Primary Text:</label>
                                                <input type="color" id="text-primary" data-css-var="--text-primary">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-secondary">Secondary Text:</label>
                                                <input type="color" id="text-secondary" data-css-var="--text-secondary">
                                                <span class="color-value">#cccccc</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-accent">Accent Text:</label>
                                                <input type="color" id="text-accent" data-css-var="--text-accent">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-muted">Muted Text:</label>
                                                <input type="color" id="text-muted" data-css-var="--text-muted">
                                                <span class="color-value">#888888</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="text-inverse">Inverse Text:</label>
                                                <input type="color" id="text-inverse" data-css-var="--text-inverse">
                                                <span class="color-value">#000000</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Button Colors -->
                                    <div class="color-group">
                                        <h5>Button Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="btn-primary-bg">Primary Button Background:</label>
                                                <input type="color" id="btn-primary-bg" data-css-var="--btn-primary-bg">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-primary-text">Primary Button Text:</label>
                                                <input type="color" id="btn-primary-text" data-css-var="--btn-primary-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-primary-hover">Primary Button Hover:</label>
                                                <input type="color" id="btn-primary-hover" data-css-var="--btn-primary-hover">
                                                <span class="color-value">#3a8eef</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-secondary-bg">Secondary Button Background:</label>
                                                <input type="color" id="btn-secondary-bg" data-css-var="--btn-secondary-bg">
                                                <span class="color-value">#666666</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-secondary-text">Secondary Button Text:</label>
                                                <input type="color" id="btn-secondary-text" data-css-var="--btn-secondary-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-secondary-hover">Secondary Button Hover:</label>
                                                <input type="color" id="btn-secondary-hover" data-css-var="--btn-secondary-hover">
                                                <span class="color-value">#777777</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-danger-bg">Danger Button Background:</label>
                                                <input type="color" id="btn-danger-bg" data-css-var="--btn-danger-bg">
                                                <span class="color-value">#dc3545</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-danger-text">Danger Button Text:</label>
                                                <input type="color" id="btn-danger-text" data-css-var="--btn-danger-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="btn-danger-hover">Danger Button Hover:</label>
                                                <input type="color" id="btn-danger-hover" data-css-var="--btn-danger-hover">
                                                <span class="color-value">#c82333</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Border and Accent Colors -->
                                    <div class="color-group">
                                        <h5>Border & Accent Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="border-primary">Primary Border:</label>
                                                <input type="color" id="border-primary" data-css-var="--border-primary">
                                                <span class="color-value">#444444</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-secondary">Secondary Border:</label>
                                                <input type="color" id="border-secondary" data-css-var="--border-secondary">
                                                <span class="color-value">#555555</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-focus">Focus Border:</label>
                                                <input type="color" id="border-focus" data-css-var="--border-focus">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-hover">Hover Border:</label>
                                                <input type="color" id="border-hover" data-css-var="--border-hover">
                                                <span class="color-value">#666666</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Status Colors -->
                                    <div class="color-group">
                                        <h5>Status Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="success-color">Success Color:</label>
                                                <input type="color" id="success-color" data-css-var="--success">
                                                <span class="color-value">#28a745</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="success-dark">Success Dark:</label>
                                                <input type="color" id="success-dark" data-css-var="--success-dark">
                                                <span class="color-value">#1e7e34</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="warning-color">Warning Color:</label>
                                                <input type="color" id="warning-color" data-css-var="--warning">
                                                <span class="color-value">#ffc107</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="warning-dark">Warning Dark:</label>
                                                <input type="color" id="warning-dark" data-css-var="--warning-dark">
                                                <span class="color-value">#d39e00</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="error-color">Error Color:</label>
                                                <input type="color" id="error-color" data-css-var="--error">
                                                <span class="color-value">#dc3545</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="error-color-alt">Error Color Alt:</label>
                                                <input type="color" id="error-color-alt" data-css-var="--error-color">
                                                <span class="color-value">#ff6b6b</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="info-color">Info Color:</label>
                                                <input type="color" id="info-color" data-css-var="--info">
                                                <span class="color-value">#17a2b8</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="info-dark">Info Dark:</label>
                                                <input type="color" id="info-dark" data-css-var="--info-dark">
                                                <span class="color-value">#117a8b</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Form Colors -->
                                    <div class="color-group">
                                        <h5>Form & Input Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="input-bg">Input Background:</label>
                                                <input type="color" id="input-bg" data-css-var="--input-bg">
                                                <span class="color-value">#3a3a3a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-text">Input Text:</label>
                                                <input type="color" id="input-text" data-css-var="--input-text">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-border">Input Border:</label>
                                                <input type="color" id="input-border" data-css-var="--input-border">
                                                <span class="color-value">#555555</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-focus">Input Focus:</label>
                                                <input type="color" id="input-focus" data-css-var="--input-focus">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Navigation Colors -->
                                    <div class="color-group">
                                        <h5>Navigation Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="nav-bg">Navigation Background:</label>
                                                <input type="color" id="nav-bg" data-css-var="--nav-bg">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="nav-text">Navigation Text:</label>
                                                <input type="color" id="nav-text" data-css-var="--nav-text">
                                                <span class="color-value">#cccccc</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="nav-hover">Navigation Hover:</label>
                                                <input type="color" id="nav-hover" data-css-var="--nav-hover">
                                                <span class="color-value">#404040</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="nav-active">Navigation Active:</label>
                                                <input type="color" id="nav-active" data-css-var="--nav-active">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal & Accent Colors -->
                                    <div class="color-group">
                                        <h5>Modal & Accent Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="accent-secondary">Accent Secondary:</label>
                                                <input type="color" id="accent-secondary" data-css-var="--accent-secondary">
                                                <span class="color-value">#0099cc</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="accent-dark">Accent Dark:</label>
                                                <input type="color" id="accent-dark" data-css-var="--accent-dark">
                                                <span class="color-value">#007799</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Shadows & Effects -->
                                    <div class="color-group">
                                        <h5>Shadows & Effects</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="shadow">Shadow Color:</label>
                                                <input type="color" id="shadow" data-css-var="--shadow">
                                                <span class="color-value">#000000</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="shadow-hover">Shadow Hover:</label>
                                                <input type="color" id="shadow-hover" data-css-var="--shadow-hover">
                                                <span class="color-value">#000000</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="border-focus-shadow">Focus Shadow:</label>
                                                <input type="color" id="border-focus-shadow" data-css-var="--border-focus-shadow">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal & Overlay -->
                                    <div class="color-group">
                                        <h5>Modal & Overlay</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="modal-background">Modal Background:</label>
                                                <input type="color" id="modal-background" data-css-var="--modalBackgroundColor">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="modal-backdrop">Modal Backdrop:</label>
                                                <input type="color" id="modal-backdrop" data-css-var="--modalBackdropBackgroundColor">
                                                <span class="color-value">#000000</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="modal-overlay">Modal Overlay:</label>
                                                <input type="color" id="modal-overlay" data-css-var="--modal-overlay">
                                                <span class="color-value">#00000080</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="modal-close-hover">Modal Close Hover:</label>
                                                <input type="color" id="modal-close-hover" data-css-var="--modalCloseButtonHoverColor">
                                                <span class="color-value">#ff0000</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Extended Form Elements -->
                                    <div class="color-group">
                                        <h5>Extended Form Elements</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="input-hover-bg">Input Hover Background:</label>
                                                <input type="color" id="input-hover-bg" data-css-var="--inputHoverBackgroundColor">
                                                <span class="color-value">#3a3a3a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-selected-bg">Input Selected Background:</label>
                                                <input type="color" id="input-selected-bg" data-css-var="--inputSelectedBackgroundColor">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-readonly-bg">Input Read-Only Background:</label>
                                                <input type="color" id="input-readonly-bg" data-css-var="--inputReadOnlyBackgroundColor">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-error-border">Input Error Border:</label>
                                                <input type="color" id="input-error-border" data-css-var="--inputErrorBorderColor">
                                                <span class="color-value">#dc3545</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="input-warning-border">Input Warning Border:</label>
                                                <input type="color" id="input-warning-border" data-css-var="--inputWarningBorderColor">
                                                <span class="color-value">#ffc107</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Menu & Tooltip -->
                                    <div class="color-group">
                                        <h5>Menu & Tooltip</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="menu-item-color">Menu Item Color:</label>
                                                <input type="color" id="menu-item-color" data-css-var="--menuItemColor">
                                                <span class="color-value">#ffffff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="menu-item-hover">Menu Item Hover:</label>
                                                <input type="color" id="menu-item-hover" data-css-var="--menuItemHoverBackgroundColor">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="popover-body-bg">Popover Body Background:</label>
                                                <input type="color" id="popover-body-bg" data-css-var="--popoverBodyBackgroundColor">
                                                <span class="color-value">#2d2d2d</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="popover-title-bg">Popover Title Background:</label>
                                                <input type="color" id="popover-title-bg" data-css-var="--popoverTitleBackgroundColor">
                                                <span class="color-value">#1a1a1a</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Utility Colors -->
                                    <div class="color-group">
                                        <h5>Utility Colors</h5>
                                        <div class="color-inputs">
                                            <div class="color-input-group">
                                                <label for="disabled-color">Disabled Color:</label>
                                                <input type="color" id="disabled-color" data-css-var="--disabledColor">
                                                <span class="color-value">#666666</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="help-text-color">Help Text Color:</label>
                                                <input type="color" id="help-text-color" data-css-var="--helpTextColor">
                                                <span class="color-value">#888888</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="link-hover-color">Link Hover Color:</label>
                                                <input type="color" id="link-hover-color" data-css-var="--linkHoverColor">
                                                <span class="color-value">#6bb6ff</span>
                                            </div>
                                            <div class="color-input-group">
                                                <label for="icon-button-hover">Icon Button Hover:</label>
                                                <input type="color" id="icon-button-hover" data-css-var="--iconButtonHoverColor">
                                                <span class="color-value">#4a9eff</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>
                            

                            <!-- Live Preview -->
                            <div class="theme-preview-section">
                                <h5>Live Preview</h5>
                                <div class="preview-container">
                                    <!-- Live Theme Preview Content -->
                                    <div class="preview-section">
                                        <h6>Cards & Panels</h6>
                                        <div class="preview-cards">
                                            <div class="preview-card">
                                                <div class="card-header">Album Title</div>
                                                <div class="card-content">This shows how cards look in the current theme</div>
                                            </div>
                                            <div class="preview-card">
                                                <div class="card-header">Artist Name</div>
                                                <div class="card-content">Secondary card example</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Buttons & Controls</h6>
                                        <div class="preview-buttons">
                                            <button class="preview-btn-primary">Primary Button</button>
                                            <button class="preview-btn-secondary">Secondary Button</button>
                                            <button class="preview-btn-danger">Danger Button</button>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Form Elements</h6>
                                        <div class="preview-form">
                                            <div class="form-group">
                                                <label>Input Field:</label>
                                                <input type="text" placeholder="Sample input text" class="preview-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Select Dropdown:</label>
                                                <select class="preview-select">
                                                    <option>Option 1</option>
                                                    <option>Option 2</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Navigation & Menu</h6>
                                        <div class="preview-nav">
                                            <div class="nav-item active">Active Item</div>
                                            <div class="nav-item">Regular Item</div>
                                            <div class="nav-item">Another Item</div>
                                        </div>
                                    </div>

                                    <div class="preview-section">
                                        <h6>Status Messages</h6>
                                        <div class="preview-alerts">
                                            <div class="alert-success">✓ Success message</div>
                                            <div class="alert-warning">⚠ Warning message</div>
                                            <div class="alert-error">✗ Error message</div>
                                            <div class="alert-info">ℹ Info message</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Blacklist Tab -->
        <div id="blacklist-tab" class="settings-tab-panel" role="tabpanel" aria-labelledby="tab-blacklist">
            <div class="settings-sections">
                <div class="settings-section">
                    <h2>🚫 Video Blacklist Management</h2>
                    <p class="section-description">
                        Manage blacklisted YouTube URLs to prevent re-download of unwanted videos. Blacklisted videos will not be downloaded in future scans, even if they appear in monitored artists or playlists.
                    </p>
                    
                    <!-- Blacklist Actions -->
                    <div class="blacklist-actions">
                        <button onclick="showAddToBlacklistModal()" class="btn btn-primary">
                            <iconify-icon icon="tabler:plus"></iconify-icon>
                            Add URL to Blacklist
                        </button>
                        <button onclick="refreshBlacklist()" class="btn btn-secondary">
                            <iconify-icon icon="tabler:refresh"></iconify-icon>
                            Refresh
                        </button>
                        <button onclick="exportBlacklist()" class="btn btn-info">
                            <iconify-icon icon="tabler:download"></iconify-icon>
                            Export Blacklist
                        </button>
                    </div>
                    
                    <!-- Blacklist Stats -->
                    <div class="blacklist-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalBlacklistCount">0</div>
                            <div class="stat-label">Total Blacklisted URLs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="recentBlacklistCount">0</div>
                            <div class="stat-label">Added This Week</div>
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div class="search-panel">
                        <div class="search-input-container">
                            <input type="text" id="blacklistSearchInput" placeholder="Search blacklisted URLs, titles, or artists..." onkeyup="handleBlacklistSearch(event)">
                            <iconify-icon icon="tabler:search" class="search-icon"></iconify-icon>
                        </div>
                    </div>
                    
                    <!-- Blacklist Table -->
                    <div id="blacklistTableContainer" class="blacklist-table-container">
                        <div id="blacklistLoading" class="loading-container" style="display: none;">
                            <div class="loading-spinner">
                                <img src="{{ url_for('static', filename='MVidarr.png') }}" alt="MVidarr" class="spinning mvidarr-logo-spinner" style="width: 24px; height: 24px;">
                            </div>
                            <p>Loading blacklisted URLs...</p>
                        </div>
                        
                        <div id="blacklistError" class="error-container" style="display: none;">
                            <iconify-icon icon="tabler:alert-circle" class="error-icon"></iconify-icon>
                            <h3>Error Loading Blacklist</h3>
                            <p id="blacklistErrorMessage">Failed to load blacklisted URLs. Please try again.</p>
                            <button onclick="loadBlacklist()" class="btn btn-primary">Retry</button>
                        </div>
                        
                        <div id="blacklistEmpty" class="empty-state" style="display: none;">
                            <iconify-icon icon="tabler:list-x" class="empty-icon"></iconify-icon>
                            <h3>No Blacklisted URLs</h3>
                            <p>You haven't blacklisted any YouTube URLs yet. Add URLs to prevent unwanted videos from being downloaded.</p>
                            <button onclick="showAddToBlacklistModal()" class="btn btn-primary">Add First URL</button>
                        </div>
                        
                        <div id="blacklistTable" style="display: none;">
                            <table class="blacklist-table">
                                <thead>
                                    <tr>
                                        <th>YouTube URL</th>
                                        <th>Title</th>
                                        <th>Artist</th>
                                        <th>Blacklisted Date</th>
                                        <th>Blacklisted By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="blacklistTableBody">
                                    <!-- Blacklist entries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="blacklistPagination" class="pagination-container" style="display: none;">
                            <div class="pagination-info">
                                <span id="blacklistPaginationInfo">Showing 0-0 of 0 entries</span>
                            </div>
                            <div class="pagination-controls">
                                <button id="blacklistPrevPage" onclick="loadBlacklistPage(currentBlacklistPage - 1)" class="btn btn-secondary btn-sm" disabled>
                                    <iconify-icon icon="tabler:chevron-left"></iconify-icon>
                                    Previous
                                </button>
                                <span id="blacklistPageNumbers" class="page-numbers"></span>
                                <button id="blacklistNextPage" onclick="loadBlacklistPage(currentBlacklistPage + 1)" class="btn btn-secondary btn-sm" disabled>
                                    Next
                                    <iconify-icon icon="tabler:chevron-right"></iconify-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    </div>
    
    <!-- Duplicate Save Settings button at bottom -->
    <div class="settings-actions bottom-actions">
        <button onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
    </div>
</div> <!-- Close settings-container -->

</div> <!-- Close container -->

<!-- Add to Blacklist Modal -->
<div id="addToBlacklistModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add URL to Blacklist</h2>
            <button onclick="closeAddToBlacklistModal()" class="btn btn-ghost btn-sm" aria-label="Close modal">
                <iconify-icon icon="tabler:x"></iconify-icon>
            </button>
        </div>
        <div class="modal-body">
            <form id="addToBlacklistForm" onsubmit="submitAddToBlacklist(event)">
                <div class="form-group">
                    <label for="blacklistUrl">YouTube URL *</label>
                    <input type="url" id="blacklistUrl" name="youtube_url" required placeholder="https://www.youtube.com/watch?v=..." aria-describedby="blacklistUrlHelp">
                    <small id="blacklistUrlHelp" class="form-text">Enter the full YouTube URL to blacklist</small>
                </div>
                <div class="form-group">
                    <label for="blacklistTitle">Video Title (Optional)</label>
                    <input type="text" id="blacklistTitle" name="title" placeholder="Optional: Video title for reference">
                </div>
                <div class="form-group">
                    <label for="blacklistArtist">Artist Name (Optional)</label>
                    <input type="text" id="blacklistArtist" name="artist_name" placeholder="Optional: Artist name for reference">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeAddToBlacklistModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="submitAddToBlacklist()" class="btn btn-primary">Add to Blacklist</button>
        </div>
    </div>
</div>

<!-- Confirm Remove Modal -->
<div id="confirmRemoveModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Remove from Blacklist</h2>
            <button onclick="closeConfirmRemoveModal()" class="btn btn-ghost btn-sm" aria-label="Close modal">
                <iconify-icon icon="tabler:x"></iconify-icon>
            </button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to remove this URL from the blacklist?</p>
            <div class="blacklist-preview">
                <strong>URL:</strong> <span id="removePreviewUrl"></span><br>
                <strong>Title:</strong> <span id="removePreviewTitle"></span><br>
                <strong>Artist:</strong> <span id="removePreviewArtist"></span>
            </div>
            <p class="text-warning"><strong>Warning:</strong> This URL may be downloaded again in future scans.</p>
        </div>
        <div class="modal-footer">
            <button onclick="closeConfirmRemoveModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmRemoveFromBlacklist()" class="btn btn-danger">Remove from Blacklist</button>
        </div>
    </div>
</div>

<script>

// Tab switching functionality
function switchTab(event, tabId) {
    // Remove active class from all tabs and panels
    const tabButtons = document.querySelectorAll('.settings-tab-btn');
    const tabPanels = document.querySelectorAll('.settings-tab-panel');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabPanels.forEach(panel => panel.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding panel
    event.target.classList.add('active');
    const targetPanel = document.getElementById(tabId);
    if (targetPanel) {
        targetPanel.classList.add('active');
    }
    
    // Update URL hash for navigation
    window.location.hash = tabId;
}

// Initialize tab based on URL hash
function initializeTab() {
    const hash = window.location.hash.substring(1);
    if (hash && document.getElementById(hash)) {
        const tabButton = document.querySelector(`[onclick*="${hash}"]`);
        if (tabButton) {
            // Simulate click on the tab
            tabButton.click();
        }
    }
}

// Handle hash changes
window.addEventListener('hashchange', initializeTab);

function loadSettings() {
    // Load regular settings
    fetch('/api/settings/')
        .then(response => response.json())
        .then(data => {
            const settings = data.settings;
            
            // Populate form fields
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = settings[key].value;
                }
            });
            
            // After settings are loaded, update the user credentials section visibility
            updateUserCredentialsSection();
        })
        .catch(error => {
            console.error('Error loading settings:', error);
            if (typeof showError === 'function') {
                showError('Error loading settings');
            } else {
                alert('Error loading settings');
            }
        });
    
    // Load database configuration separately
    fetch('/api/settings/database-config')
        .then(response => response.json())
        .then(data => {
            const dbConfig = data.database_config;
            
            // Populate database configuration fields
            Object.keys(dbConfig).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = dbConfig[key];
                    // Make database fields read-only since they come from environment
                    element.readOnly = true;
                    element.classList.add('readonly-field');
                    element.title = 'This value is read from environment variables and cannot be edited here';
                }
            });
        })
        .catch(error => {
            console.error('Error loading database config:', error);
            // Don't show error for database config as it's supplementary
        });
}

// Update user credentials section visibility based on authentication setting
function updateUserCredentialsSection() {
    const authEnabled = document.getElementById('require_authentication').value === 'true';
    const credentialsSection = document.getElementById('userCredentialsSection');
    
    if (credentialsSection) {
        if (authEnabled) {
            credentialsSection.style.display = 'block';
        } else {
            credentialsSection.style.display = 'none';
        }
    }
}

// Set up authentication toggle event listener and load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load settings when page loads
    loadSettings();
    
    // Load certificate status
    loadCertificateStatus();
    
    // Set up authentication toggle event listener
    const authToggle = document.getElementById('require_authentication');
    if (authToggle) {
        authToggle.addEventListener('change', updateUserCredentialsSection);
    }
    
    // Set up scheduled downloads frequency change listener
    const downloadFrequency = document.getElementById('auto_download_schedule_days');
    if (downloadFrequency) {
        downloadFrequency.addEventListener('change', updateDownloadTimeVisibility);
        // Initialize visibility on page load
        updateDownloadTimeVisibility();
    }
    
    // Initialize tab from URL hash
    initializeTab();
});

function updateDownloadTimeVisibility() {
    const downloadFrequency = document.getElementById('auto_download_schedule_days');
    const timeGroup = document.getElementById('download_time_group');
    
    if (downloadFrequency && timeGroup) {
        const frequency = downloadFrequency.value;
        // Show time field only for daily and weekly schedules
        if (frequency === 'daily' || frequency === 'weekly') {
            timeGroup.style.display = 'block';
        } else {
            timeGroup.style.display = 'none';
        }
    }
}

function saveSettings() {
    const settingsData = {};
    
    // Collect all form values
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.name) {
            settingsData[input.name] = input.value;
        }
    });
    
    fetch('/api/settings/bulk', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ settings: settingsData })
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            if (typeof showError === 'function') {
                showError('Error: ' + result.error);
            } else {
                alert('Error: ' + result.error);
            }
        } else {
            if (typeof showSuccess === 'function') {
                showSuccess('Settings saved successfully!');
            } else {
                alert('Settings saved successfully!');
            }
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        if (typeof showError === 'function') {
            showError('Error saving settings');
        } else {
            alert('Error saving settings');
        }
    });
}

function restartApp() {
    const message = 'Are you sure you want to restart the application?';
    
    // Check if toastConfirm is available, otherwise use standard confirm
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedRestart();
        });
    } else {
        if (confirm(message)) {
            proceedRestart();
        }
    }
}

function proceedRestart() {
    fetch('/api/settings/restart', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (typeof showInfo === 'function') {
            showInfo('Application restart initiated. Please wait a moment and refresh the page.');
        } else {
            alert('Application restart initiated. Please wait a moment and refresh the page.');
        }
    })
    .catch(error => {
        console.error('Error restarting application:', error);
        if (typeof showError === 'function') {
            showError('Error restarting application');
        } else {
            alert('Error restarting application');
        }
    });
}

// Video Indexing Functions
function loadIndexingStats() {
    fetch('/api/video-indexing/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('indexing-stats').innerHTML = 
                    '<span class="error">Error loading stats: ' + data.error + '</span>';
            } else {
                const stats = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <strong>Artists:</strong> ${data.total_artists}
                        </div>
                        <div class="stat-item">
                            <strong>Videos:</strong> ${data.total_videos}
                        </div>
                        <div class="stat-item">
                            <strong>Downloaded:</strong> ${data.downloaded_videos}
                        </div>
                        <div class="stat-item">
                            <strong>With Files:</strong> ${data.videos_with_files}
                        </div>
                        <div class="stat-item">
                            <strong>IMVDb Data:</strong> ${data.videos_with_imvdb}
                        </div>
                        <div class="stat-item">
                            <strong>Coverage:</strong> ${data.imvdb_coverage}%
                        </div>
                    </div>
                `;
                document.getElementById('indexing-stats').innerHTML = stats;
                
                // Add thumbnail stats if available
                if (data.thumbnail_stats) {
                    const thumbStats = data.thumbnail_stats;
                    const thumbInfo = `
                        <div class="thumbnail-stats">
                            <strong>Thumbnails:</strong> ${thumbStats.total_files} files (${thumbStats.total_size_mb} MB)
                        </div>
                    `;
                    document.getElementById('indexing-stats').innerHTML += thumbInfo;
                }
            }
        })
        .catch(error => {
            console.error('Error loading indexing stats:', error);
            document.getElementById('indexing-stats').innerHTML = 
                '<span class="error">Failed to load stats</span>';
        });
}

function checkImvdbConnection() {
    fetch('/api/video-indexing/imvdb/test')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('imvdb-status');
            if (data.status === 'success') {
                statusElement.innerHTML = '<span class="success">✅ Connected</span>';
            } else if (data.status === 'error' && data.message.includes('api key')) {
                statusElement.innerHTML = '<span class="warning">⚠️ API Key not configured</span>';
            } else {
                statusElement.innerHTML = '<span class="error">❌ Connection failed</span>';
            }
        })
        .catch(error => {
            console.error('Error checking IMVDb connection:', error);
            document.getElementById('imvdb-status').innerHTML = 
                '<span class="error">❌ Check failed</span>';
        });
}

function testImvdbConnection() {
    const statusElement = document.getElementById('imvdb-status');
    statusElement.innerHTML = '<span class="loading">🔄 Testing...</span>';
    
    fetch('/api/video-indexing/imvdb/test')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusElement.innerHTML = '<span class="success">✅ Connection successful!</span>';
                if (typeof showSuccess === 'function') {
                    showSuccess('IMVDb connection test passed! API is working correctly.');
                } else {
                    alert('IMVDb connection test passed! API is working correctly.');
                }
            } else {
                statusElement.innerHTML = '<span class="error">❌ Connection failed</span>';
                if (typeof showError === 'function') {
                    showError('IMVDb connection failed: ' + data.message);
                } else {
                    alert('IMVDb connection failed: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error testing IMVDb connection:', error);
            statusElement.innerHTML = '<span class="error">❌ Test failed</span>';
            if (typeof showError === 'function') {
                showError('IMVDb connection test failed: ' + error.message);
            } else {
                alert('IMVDb connection test failed: ' + error.message);
            }
        });
}

function scanVideoFiles() {
    showProgress('Scanning video files...');
    
    fetch('/api/video-indexing/scan-files')
        .then(response => response.json())
        .then(data => {
            hideProgress();
            if (data.error) {
                showResults('<span class="error">Scan failed: ' + data.error + '</span>');
            } else {
                const result = `
                    <div class="scan-results">
                        <h4>📁 Video Files Scan Results</h4>
                        <p><strong>Directory:</strong> ${data.directory}</p>
                        <p><strong>Total video files found:</strong> ${data.count}</p>
                        <p>Ready for indexing: ${data.count} files</p>
                    </div>
                `;
                showResults(result);
            }
        })
        .catch(error => {
            hideProgress();
            console.error('Error scanning video files:', error);
            showResults('<span class="error">Scan failed: ' + error.message + '</span>');
        });
}

function indexAllVideos() {
    const message = 'This will index all videos in your music videos directory with IMVDb metadata. This may take a while. Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedIndexAllVideos();
        });
    } else {
        if (confirm(message)) {
            proceedIndexAllVideos();
        }
    }
}

function proceedIndexAllVideos() {
    
    startIndexing(true);
}

function indexAllVideosNoMeta() {
    const message = 'This will index all videos without fetching metadata (faster). Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedIndexAllVideosNoMeta();
        });
    } else {
        if (confirm(message)) {
            proceedIndexAllVideosNoMeta();
        }
    }
}

function proceedIndexAllVideosNoMeta() {
    
    startIndexing(false);
}

function startIndexing(fetchMetadata) {
    showProgress('Starting video indexing...');
    
    const requestData = {
        fetch_metadata: fetchMetadata,
        max_files: null // Process all files
    };
    
    fetch('/api/video-indexing/index-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            const summary = data.summary;
            const result = `
                <div class="indexing-results">
                    <h4>🎬 Video Indexing Complete</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Total files:</strong> ${summary.total_files}
                        </div>
                        <div class="result-item">
                            <strong>Successfully indexed:</strong> ${summary.successful}
                        </div>
                        <div class="result-item">
                            <strong>Already indexed:</strong> ${summary.already_indexed}
                        </div>
                        <div class="result-item">
                            <strong>Failed:</strong> ${summary.failed}
                        </div>
                        <div class="result-item">
                            <strong>Artists created:</strong> ${summary.artists_created}
                        </div>
                        <div class="result-item">
                            <strong>Videos created:</strong> ${summary.videos_created}
                        </div>
                        ${fetchMetadata ? `
                        <div class="result-item">
                            <strong>IMVDb metadata found:</strong> ${summary.imvdb_metadata_found}
                        </div>
                        <div class="result-item">
                            <strong>Thumbnails downloaded:</strong> ${summary.thumbnails_downloaded}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            showResults(result);
            
            // Refresh stats after indexing
            setTimeout(refreshStats, 1000);
        } else {
            showResults('<span class="error">Indexing failed: ' + data.error + '</span>');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error during indexing:', error);
        showResults('<span class="error">Indexing failed: ' + error.message + '</span>');
    });
}

function refreshStats() {
    loadIndexingStats();
    checkImvdbConnection();
}

function populateArtistThumbnails() {
    const message = 'This will scan all artists missing thumbnails and attempt to find images from IMVDb and Wikipedia. This may take a while. Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedPopulateArtistThumbnails();
        });
    } else {
        if (confirm(message)) {
            proceedPopulateArtistThumbnails();
        }
    }
}

function proceedPopulateArtistThumbnails() {
    
    showProgress('Scanning artists for missing thumbnails...');
    
    fetch('/api/artists/scan-missing-thumbnails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            const result = `
                <div class="scan-results">
                    <h4>🖼️ Artist Thumbnail Scan Complete</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Artists without thumbnails:</strong> ${data.missing_count}
                        </div>
                        <div class="result-item">
                            <strong>Thumbnails found:</strong> ${data.updated_count}
                        </div>
                        <div class="result-item">
                            <strong>Success rate:</strong> ${data.missing_count > 0 ? Math.round((data.updated_count / data.missing_count) * 100) : 0}%
                        </div>
                    </div>
                    <p>${data.message}</p>
                </div>
            `;
            showResults(result);
            
            // Refresh stats after thumbnail scan
            setTimeout(refreshStats, 1000);
        } else {
            showResults('<span class="error">Thumbnail scan failed: ' + data.error + '</span>');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error scanning thumbnails:', error);
        showResults('<span class="error">Thumbnail scan failed: ' + error.message + '</span>');
    });
}

function showProgress(text) {
    document.getElementById('progress-text').textContent = text;
    document.getElementById('indexing-progress').style.display = 'block';
    document.getElementById('indexing-results').style.display = 'none';
    
    // Disable buttons during processing
    const buttons = document.querySelectorAll('.indexing-actions button');
    buttons.forEach(btn => btn.disabled = true);
}

function hideProgress() {
    document.getElementById('indexing-progress').style.display = 'none';
    
    // Re-enable buttons
    const buttons = document.querySelectorAll('.indexing-actions button');
    buttons.forEach(btn => btn.disabled = false);
}

function showResults(html) {
    document.getElementById('indexing-results').innerHTML = html;
    document.getElementById('indexing-results').style.display = 'block';
}

function fixMissingVideos() {
    const message = 'This will scan all videos marked as downloaded and check if their files exist. Missing videos will be marked as wanted for re-download and artists will be monitored. Continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedFixMissingVideos();
        });
    } else {
        if (confirm(message)) {
            proceedFixMissingVideos();
        }
    }
}

function proceedFixMissingVideos() {
    showProgress('Fixing missing videos...');
    
    fetch('/api/videos/recovery/fix-missing', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        if (data.error) {
            showResults('<span class="error">Fix missing videos failed: ' + data.error + '</span>');
        } else {
            const stats = data.statistics;
            const result = `
                <div class="fix-missing-results">
                    <h4>🔧 Fix Missing Videos Complete</h4>
                    <div class="results-grid">
                        <div class="result-item">
                            <strong>Downloaded videos checked:</strong> ${stats.total_downloaded}
                        </div>
                        <div class="result-item">
                            <strong>Videos with missing files:</strong> ${stats.missing_files}
                        </div>
                        <div class="result-item">
                            <strong>Videos recovered:</strong> ${stats.recovered_videos}
                        </div>
                        <div class="result-item">
                            <strong>Videos marked as wanted:</strong> ${stats.marked_wanted}
                        </div>
                        <div class="result-item">
                            <strong>Artists set to monitored:</strong> ${stats.artists_monitored}
                        </div>
                    </div>
                    ${stats.missing_files > 0 ? 
                        `<p class="success-message">✅ Successfully processed ${stats.missing_files} missing videos!</p>` :
                        `<p class="success-message">✅ No missing videos found! All downloaded videos have valid file paths.</p>`
                    }
                </div>
            `;
            showResults(result);
            
            // Show success toast
            if (typeof showSuccess === 'function') {
                showSuccess(`Fixed ${stats.missing_files} missing videos: ${stats.recovered_videos} recovered, ${stats.marked_wanted} marked as wanted`);
            }
            
            // Refresh stats to show updated data
            loadIndexingStats();
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error fixing missing videos:', error);
        showResults('<span class="error">Fix missing videos failed: ' + error.message + '</span>');
        
        if (typeof showError === 'function') {
            showError('Failed to fix missing videos: ' + error.message);
        }
    });
}

function cleanupZeroVideoArtists() {
    const message = 'This will permanently delete ALL artists with 0 videos associated. This action cannot be undone. Are you sure you want to continue?';
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedCleanupZeroVideoArtists();
        });
    } else {
        if (confirm(message)) {
            proceedCleanupZeroVideoArtists();
        }
    }
}

function proceedCleanupZeroVideoArtists() {
    
    showProgress('Removing artists with 0 videos...');
    
    fetch('/api/artists/cleanup-zero-videos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        hideProgress();
        
        if (data.success) {
            if (data.deleted_count > 0) {
                const result = `
                    <div class="cleanup-results">
                        <h4>🗑️ Artist Cleanup Complete</h4>
                        <div class="results-grid">
                            <div class="result-item">
                                <strong>Artists removed:</strong> ${data.deleted_count}
                            </div>
                        </div>
                        <div class="deleted-artists">
                            <strong>Deleted artists:</strong>
                            <ul>
                                ${data.deleted_artists.map(name => `<li>${name}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                showResults(result);
                
                // Refresh stats after cleanup
                setTimeout(refreshStats, 1000);
            } else {
                showResults('<div class="cleanup-results"><h4>ℹ️ No Artists Found</h4><p>No artists with 0 videos found to remove.</p></div>');
            }
        } else {
            showResults('<span class="error">Cleanup failed: ' + data.error + '</span>');
        }
    })
    .catch(error => {
        hideProgress();
        console.error('Error cleaning up artists:', error);
        showResults('<span class="error">Cleanup failed: ' + error.message + '</span>');
    });
}

// Scheduler management functions
function refreshSchedulerStatus() {
    // Set loading status - check if element exists first
    const loadingElement = document.getElementById('scheduler-loading');
    if (loadingElement) {
        loadingElement.textContent = 'Loading...';
    } else {
        // Element doesn't exist (likely already replaced), show loading in status div
        const statusDiv = document.getElementById('scheduler-status');
        if (statusDiv) {
            statusDiv.innerHTML = '<span id="scheduler-loading">Loading...</span>';
        }
    }
    
    // First try to check if enhanced scheduler is available
    fetch('/api/enhanced-scheduler/status')
    .then(response => {
        if (response.ok) {
            return response.json().then(data => ({ enhanced: true, data: data }));
        } else {
            // Enhanced scheduler not available, try standard scheduler
            return fetch('/api/settings/scheduler/status')
                .then(response => response.json())
                .then(data => ({ enhanced: false, data: data }));
        }
    })
    .then(result => {
        const statusDiv = document.getElementById('scheduler-status');
        
        if (result.enhanced) {
            // Display enhanced scheduler status
            displayEnhancedSchedulerStatus(statusDiv, result.data);
        } else {
            // Display standard scheduler status
            displayStandardSchedulerStatus(statusDiv, result.data);
        }
    })
    .catch(error => {
        console.error('Error getting scheduler status:', error);
        const statusDiv = document.getElementById('scheduler-status');
        if (statusDiv) {
            statusDiv.innerHTML = '<span class="error">Error loading scheduler status</span>';
        }
    });
}

function displayEnhancedSchedulerStatus(statusDiv, data) {
    const envConfig = data.environment_config || {};
    const scheduledJobs = data.scheduled_jobs || [];
    const lastRunTimes = data.last_run_times || {};
    
    // Show enhanced scheduler actions
    const standardActions = document.getElementById('scheduler-actions') || document.querySelector('.scheduler-actions');
    const enhancedActions = document.getElementById('enhanced-scheduler-actions');
    if (standardActions) standardActions.style.display = 'none';
    if (enhancedActions) enhancedActions.style.display = 'flex';
    
    // Enhanced scheduler specific display
    statusDiv.innerHTML = `
        <div class="status-info">
            <div class="status-item enhanced">
                <strong>Scheduler Type:</strong> 🐳 Enhanced Docker-Native Scheduler
            </div>
            <div class="status-item ${data.running ? 'running' : 'stopped'}">
                <strong>Service Status:</strong> ${data.running ? 'Running' : 'Stopped'} ${data.thread_alive ? '(Thread Active)' : '(Thread Inactive)'}
            </div>
            <div class="status-item">
                <strong>Active Jobs:</strong> ${data.jobs_count || 0}
            </div>
            ${data.running ? `
                <div class="status-item">
                    <strong>Environment Config:</strong> 
                    <div class="env-config">
                        <div>Download Enabled: ${envConfig.auto_download_enabled ? 'Yes' : 'No'}</div>
                        <div>Schedule: ${envConfig.auto_download_schedule} at ${envConfig.auto_download_time}</div>
                        <div>Max Downloads/Run: ${envConfig.max_downloads_per_run}</div>
                        <div>Discovery Enabled: ${envConfig.auto_discovery_enabled ? 'Yes' : 'No'}</div>
                        <div>Health Checks: ${envConfig.scheduler_health_check ? 'Enabled' : 'Disabled'}</div>
                    </div>
                </div>
                ${scheduledJobs.length > 0 ? `
                <div class="status-item">
                    <strong>Scheduled Jobs:</strong>
                    <div class="job-list">
                        ${scheduledJobs.map(job => `
                            <div class="job-item">
                                ${job.job_func} - Next: ${job.next_run ? new Date(job.next_run).toLocaleString() : 'Not scheduled'}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                ${Object.keys(lastRunTimes).length > 0 ? `
                <div class="status-item">
                    <strong>Last Run Times:</strong>
                    <div class="last-runs">
                        ${Object.entries(lastRunTimes).map(([task, time]) => `
                            <div>${task}: ${new Date(time).toLocaleString()}</div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            ` : `
                <div class="status-item warning">
                    <strong>Note:</strong> Enhanced scheduler is not running. Use environment variables or database settings to configure.
                </div>
            `}
        </div>
    `;
}

function displayStandardSchedulerStatus(statusDiv, data) {
    const scheduler = data.scheduler;
    const scheduleInfo = scheduler.schedule_info;
    const nextRun = scheduleInfo.next_run_human ? scheduleInfo.next_run_human : 'Not scheduled';
    
    // Show standard scheduler actions
    const standardActions = document.getElementById('scheduler-actions') || document.querySelector('.scheduler-actions');
    const enhancedActions = document.getElementById('enhanced-scheduler-actions');
    if (standardActions) standardActions.style.display = 'flex';
    if (enhancedActions) enhancedActions.style.display = 'none';
    
    if (scheduler.running) {
        statusDiv.innerHTML = `
            <div class="status-info">
                <div class="status-item standard">
                    <strong>Scheduler Type:</strong> 📊 Standard Scheduler
                </div>
                <div class="status-item running">
                    <strong>Service Status:</strong> Running
                </div>
                <div class="status-item">
                    <strong>Scheduling Enabled:</strong> ${scheduleInfo.enabled ? 'Yes' : 'No'}
                </div>
                ${scheduleInfo.enabled ? `
                <div class="status-item">
                    <strong>Schedule:</strong> ${scheduleInfo.downloads?.schedule_days || 'Not configured'} at ${scheduleInfo.downloads?.schedule_time || 'Not configured'}
                </div>
                <div class="status-item">
                    <strong>Max Videos:</strong> ${scheduleInfo.downloads?.max_videos || 'Not configured'}
                </div>
                <div class="status-item">
                    <strong>Next Run:</strong> ${nextRun}
                </div>
                <div class="status-item">
                    <strong>Active Jobs:</strong> ${scheduleInfo.job_count || 0}
                </div>
                ${scheduler.diagnostics ? `
                <div class="status-item">
                    <strong>Wanted Videos:</strong> ${scheduler.diagnostics.wanted_videos_count}
                </div>
                ${scheduler.diagnostics.issues_detected && scheduler.diagnostics.issues_detected.length > 0 ? `
                <div class="status-item warning">
                    <strong>Issues Detected:</strong>
                    <ul>
                        ${scheduler.diagnostics.issues_detected.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                ` : ''}
                ` : `
                <div class="status-item warning">
                    <strong>Note:</strong> Scheduling is disabled. Enable it in settings to schedule downloads.
                </div>
                `}
            </div>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="status-info">
                <div class="status-item standard">
                    <strong>Scheduler Type:</strong> 📊 Standard Scheduler
                </div>
                <div class="status-item ${scheduleInfo.enabled ? 'warning' : 'stopped'}">
                    <strong>Service Status:</strong> ${scheduleInfo.enabled ? 'Scheduled (Service Stopped)' : 'Not Scheduled'}
                </div>
                <div class="status-item">
                    <strong>Scheduling Enabled:</strong> ${scheduleInfo.enabled ? 'Yes' : 'No'}
                </div>
                ${scheduleInfo.enabled ? `
                <div class="status-item">
                    <strong>Configured Schedule:</strong> ${scheduleInfo.downloads?.schedule_days || 'Not configured'} at ${scheduleInfo.downloads?.schedule_time || 'Not configured'}
                </div>
                <div class="status-item warning">
                    <strong>Note:</strong> Scheduler service needs to be started to run scheduled downloads
                </div>
                ` : `
                <div class="status-item">
                    <strong>Note:</strong> Enable scheduling in settings to schedule automatic downloads
                </div>
                `}
            </div>
        `;
    }
}

function startScheduler() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Starting scheduler...</span>';
    }
    
    fetch('/api/settings/scheduler/start', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showSuccess(data.message);
            refreshSchedulerStatus();
        } else {
            showError('Failed to start scheduler: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error starting scheduler:', error);
        showError('Error starting scheduler: ' + error.message);
        refreshSchedulerStatus();
    });
}

function stopScheduler() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Stopping scheduler...</span>';
    }
    
    fetch('/api/settings/scheduler/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showSuccess(data.message);
            refreshSchedulerStatus();
        } else {
            showError('Failed to stop scheduler: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error stopping scheduler:', error);
        showError('Error stopping scheduler: ' + error.message);
        refreshSchedulerStatus();
    });
}

function reloadScheduler() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Reloading scheduler configuration...</span>';
    }
    
    fetch('/api/settings/scheduler/reload', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showSuccess(data.message);
            refreshSchedulerStatus();
        } else {
            showError('Failed to reload scheduler: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error reloading scheduler:', error);
        showError('Error reloading scheduler: ' + error.message);
        refreshSchedulerStatus();
    });
}

function testScheduledDownload() {
    // Update status display to show loading
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">Running test download...</span>';
    }
    
    fetch('/api/settings/scheduler/trigger', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            const result = data.result;
            const message = `${data.message}<br>
                           Success: ${result.success_count} videos queued<br>
                           Failed: ${result.failed_count} videos<br>
                           Total Wanted: ${result.total_wanted} videos`;
            showSuccess(message);
            refreshSchedulerStatus();
        } else {
            showError('Test download failed: ' + (data.error || 'Unknown error'));
            refreshSchedulerStatus();
        }
    })
    .catch(error => {
        console.error('Error running test download:', error);
        showError('Error running test download: ' + error.message);
        refreshSchedulerStatus();
    });
}

// Enhanced Scheduler Functions
function triggerEnhancedDownload() {
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">🔽 Triggering enhanced download...</span>';
    }
    
    fetch('/api/enhanced-scheduler/trigger/download', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.result;
            const message = `Download triggered successfully!<br>
                           Downloaded: ${result.downloaded || 0} videos<br>
                           Total Found: ${result.total_found || 0} videos<br>
                           Duration: ${result.duration_seconds ? result.duration_seconds.toFixed(1) + 's' : 'Unknown'}`;
            showSuccess(message);
        } else {
            showError('Enhanced download trigger failed: ' + data.message);
        }
        refreshSchedulerStatus();
    })
    .catch(error => {
        console.error('Error triggering enhanced download:', error);
        showError('Error triggering enhanced download: ' + error.message);
        refreshSchedulerStatus();
    });
}

function triggerEnhancedDiscovery() {
    const statusDiv = document.getElementById('scheduler-status');
    if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-loading">🔍 Triggering enhanced discovery...</span>';
    }
    
    fetch('/api/enhanced-scheduler/trigger/discovery', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.result;
            const message = `Discovery triggered successfully!<br>
                           Result: ${JSON.stringify(result, null, 2)}`;
            showSuccess(message);
        } else {
            showError('Enhanced discovery trigger failed: ' + data.message);
        }
        refreshSchedulerStatus();
    })
    .catch(error => {
        console.error('Error triggering enhanced discovery:', error);
        showError('Error triggering enhanced discovery: ' + error.message);
        refreshSchedulerStatus();
    });
}

function viewEnhancedSchedulerHealth() {
    fetch('/api/enhanced-scheduler/health')
    .then(response => response.json())
    .then(data => {
        const healthStatus = data.status === 'healthy' ? '✅ Healthy' : '❌ Unhealthy';
        const details = data.details || {};
        const message = `
            <div><strong>Health Status:</strong> ${healthStatus}</div>
            <div><strong>Timestamp:</strong> ${data.timestamp ? new Date(data.timestamp).toLocaleString() : 'Unknown'}</div>
            <div><strong>Scheduler Running:</strong> ${details.scheduler_running ? 'Yes' : 'No'}</div>
            <div><strong>Thread Alive:</strong> ${details.thread_alive ? 'Yes' : 'No'}</div>
            <div><strong>Jobs Count:</strong> ${details.jobs_count || 0}</div>
            ${details.last_download ? `<div><strong>Last Download:</strong> ${new Date(details.last_download).toLocaleString()}</div>` : ''}
            ${details.last_discovery ? `<div><strong>Last Discovery:</strong> ${new Date(details.last_discovery).toLocaleString()}</div>` : ''}
        `;
        
        if (data.status === 'healthy') {
            showSuccess('Enhanced Scheduler Health Check:<br>' + message);
        } else {
            showError('Enhanced Scheduler Health Check:<br>' + message);
        }
    })
    .catch(error => {
        console.error('Error checking enhanced scheduler health:', error);
        showError('Error checking enhanced scheduler health: ' + error.message);
    });
}

function viewEnhancedSchedulerConfig() {
    fetch('/api/enhanced-scheduler/config')
    .then(response => response.json())
    .then(data => {
        const envConfig = data.environment_config || {};
        const schedulerInfo = data.scheduler_info || {};
        const message = `
            <div><strong>Environment Configuration:</strong></div>
            <div style="margin-left: 20px;">
                <div>Auto Download Enabled: ${envConfig.auto_download_enabled ? 'Yes' : 'No'}</div>
                <div>Download Schedule: ${envConfig.auto_download_schedule} at ${envConfig.auto_download_time}</div>
                <div>Max Downloads/Run: ${envConfig.max_downloads_per_run}</div>
                <div>Auto Discovery Enabled: ${envConfig.auto_discovery_enabled ? 'Yes' : 'No'}</div>
                <div>Discovery Schedule: ${envConfig.auto_discovery_schedule} at ${envConfig.auto_discovery_time}</div>
                <div>Health Checks: ${envConfig.scheduler_health_check ? 'Enabled' : 'Disabled'}</div>
                <div>Log Level: ${envConfig.scheduler_log_level}</div>
            </div>
            <div><strong>Scheduler Info:</strong></div>
            <div style="margin-left: 20px;">
                <div>Jobs Count: ${schedulerInfo.jobs_count || 0}</div>
            </div>
        `;
        showInfo('Enhanced Scheduler Configuration:<br>' + message);
    })
    .catch(error => {
        console.error('Error getting enhanced scheduler config:', error);
        showError('Error getting enhanced scheduler config: ' + error.message);
    });
}

// External Services Integration Functions
function testYouTubeIntegration() {
    showIntegrationLoading('YouTube');
    
    fetch('/api/youtube/playlists/test', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('YouTube integration test passed! API is working correctly.');
        } else {
            showErrorMessage('YouTube integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing YouTube integration:', error);
        showErrorMessage('YouTube integration test failed: ' + error.message);
    });
}

function syncYouTubePlaylists() {
    showIntegrationLoading('YouTube');
    
    fetch('/api/youtube/playlists/sync', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showSuccessMessage(`YouTube playlists synced successfully! ${data.synced_count} playlists processed.`);
        } else {
            showErrorMessage('YouTube playlist sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing YouTube playlists:', error);
        showErrorMessage('YouTube playlist sync failed: ' + error.message);
    });
}

function testSpotifyIntegration() {
    showIntegrationLoading('Spotify');
    
    fetch('/api/spotify/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('Spotify integration test passed! API credentials are valid.');
        } else {
            showErrorMessage('Spotify integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing Spotify integration:', error);
        showErrorMessage('Spotify integration test failed: ' + error.message);
    });
}

function authorizeSpotify() {
    fetch('/api/spotify/authorize', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.authorization_url) {
            window.open(data.authorization_url, '_blank');
            showInfoMessage('Please complete authorization in the new window, then test the connection.');
        } else {
            showErrorMessage('Failed to get Spotify authorization URL: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error authorizing Spotify:', error);
        showErrorMessage('Spotify authorization failed: ' + error.message);
    });
}

function importSpotifyPlaylists() {
    showIntegrationLoading('Spotify');
    
    fetch('/api/spotify/import-playlists', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Spotify playlists imported successfully! ${data.imported_count} playlists processed.`);
        } else {
            showErrorMessage('Spotify playlist import failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error importing Spotify playlists:', error);
        showErrorMessage('Spotify playlist import failed: ' + error.message);
    });
}

// Last.fm Integration Functions
function testLastfmIntegration() {
    showIntegrationLoading('Last.fm');
    
    fetch('/api/lastfm/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('Last.fm integration test passed! API credentials are valid.');
        } else {
            showErrorMessage('Last.fm integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing Last.fm integration:', error);
        showErrorMessage('Last.fm integration test failed: ' + error.message);
    });
}

function authorizeLastfm() {
    fetch('/api/lastfm/auth/url', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.auth_url) {
            window.open(data.auth_url, '_blank');
            showInfoMessage('Please complete authorization in the new window, then test the connection.');
        } else {
            showErrorMessage('Failed to get Last.fm authorization URL: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error authorizing Last.fm:', error);
        showErrorMessage('Last.fm authorization failed: ' + error.message);
    });
}

function syncLastfmHistory() {
    showIntegrationLoading('Last.fm');
    
    fetch('/api/lastfm/sync-history', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Last.fm listening history synced successfully! ${data.tracks_processed || 0} tracks processed.`);
        } else {
            showErrorMessage('Last.fm history sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing Last.fm history:', error);
        showErrorMessage('Last.fm history sync failed: ' + error.message);
    });
}

function testLidarrIntegration() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccessMessage('Lidarr integration test passed! ' + data.message);
        } else {
            showErrorMessage('Lidarr integration test failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error testing Lidarr integration:', error);
        showErrorMessage('Lidarr integration test failed: ' + error.message);
    });
}

function syncLidarrLibrary() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/sync-library', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Lidarr library synced successfully! ${data.synced_count} artists processed.`);
        } else {
            showErrorMessage('Lidarr library sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing Lidarr library:', error);
        showErrorMessage('Lidarr library sync failed: ' + error.message);
    });
}

function importLidarrArtists() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/import-artists', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Lidarr artists imported successfully! ${data.imported_count} monitored artists processed.`);
        } else {
            showErrorMessage('Lidarr artist import failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error importing Lidarr artists:', error);
        showErrorMessage('Lidarr artist import failed: ' + error.message);
    });
}

function syncLidarrAlbums() {
    showIntegrationLoading('Lidarr');
    
    fetch('/api/lidarr/sync-albums', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(`Lidarr albums synced successfully! ${data.processed_count} albums processed.`);
        } else {
            showErrorMessage('Lidarr album sync failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error syncing Lidarr albums:', error);
        showErrorMessage('Lidarr album sync failed: ' + error.message);
    });
}

function showIntegrationLoading(service) {
    if (typeof showInfo === 'function') {
        showInfo(`Testing ${service} integration...`);
    } else {
        showInfoMessage(`Testing ${service} integration...`);
    }
}

// Helper functions for notifications
function showSuccessMessage(message) {
    if (typeof showSuccess === 'function') {
        showSuccess(message);
    } else {
        alert('✅ ' + message);
    }
}

function showErrorMessage(message) {
    if (typeof showError === 'function') {
        showError(message);
    } else {
        alert('❌ ' + message);
    }
}

function showInfoMessage(message) {
    if (typeof showInfo === 'function') {
        showInfo(message);
    } else {
        alert('ℹ️ ' + message);
    }
}


// ================================
// USER MANAGEMENT FUNCTIONS
// ================================

function initializeUserManagement() {
    // Simplified authentication - no complex user management needed
    // User credentials can be updated in Settings > General tab
    console.log('User management simplified - using single user authentication');
}

function loadCurrentUserInfo() {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                const user = data.user;
                const permissions = data.permissions;
                
                // Update current user info
                document.getElementById('currentUsername').textContent = user.username;
                document.getElementById('currentUserEmail').textContent = user.email || 'Not provided';
                
                // Update role badge
                const roleElement = document.getElementById('currentUserRole');
                roleElement.textContent = user.role;
                roleElement.className = `role-badge role-${user.role.toLowerCase()}`;
                
                // Update last login
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
                document.getElementById('lastLoginTime').textContent = lastLogin;
                
                // Update 2FA status
                const twoFactorElement = document.getElementById('twoFactorStatus');
                if (user.two_factor_enabled) {
                    twoFactorElement.innerHTML = '<span class="status-enabled">✅ Enabled</span>';
                } else {
                    twoFactorElement.innerHTML = '<span class="status-disabled">❌ Disabled</span>';
                }
                
                // Show admin section if user has admin privileges
                if (permissions.can_manage_users) {
                    document.getElementById('adminUserManagement').style.display = 'block';
                    loadUserList();
                }
                
            }
        })
        .catch(error => {
            console.error('Error loading user info:', error);
        });
}

function checkUserPermissions() {
    fetch('/auth/check')
        .then(response => response.json())
        .then(data => {
            if (!data.authenticated) {
                // User is not authenticated, hide user management
                document.getElementById('userManagementSection').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error checking authentication:', error);
        });
}

function loadUserList() {
    fetch('/api/users/')
        .then(response => response.json())
        .then(data => {
            if (data.users) {
                renderUserList(data.users);
                updateUserStats(data.users);
            }
        })
        .catch(error => {
            console.error('Error loading user list:', error);
            document.getElementById('userList').innerHTML = '<div class="error">Error loading users</div>';
        });
}

function renderUserList(users) {
    const userListElement = document.getElementById('userList');
    
    if (users.length === 0) {
        userListElement.innerHTML = '<div class="no-users">No users found</div>';
        return;
    }
    
    const userListHTML = users.map(user => {
        const statusClass = user.is_active ? 'active' : 'inactive';
        const lockedStatus = user.is_locked ? '🔒 Locked' : '';
        const twoFactorStatus = user.two_factor_enabled ? '🔐' : '';
        
        return `
            <div class="user-item ${statusClass}">
                <div class="user-info">
                    <div class="user-primary">
                        <strong>${user.username}</strong>
                        <span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span>
                        ${twoFactorStatus}
                        ${lockedStatus}
                    </div>
                    <div class="user-secondary">
                        <span>${user.email}</span>
                        <span>Last login: ${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</span>
                    </div>
                </div>
                <div class="user-actions">
                    <button onclick="editUser(${user.id})" class="btn btn-sm btn-secondary">✏️ Edit</button>
                    <button onclick="viewUserSessions(${user.id})" class="btn btn-sm btn-info">📱 Sessions</button>
                    ${user.is_active 
                        ? `<button onclick="deactivateUser(${user.id})" class="btn btn-sm btn-warning">⏸️ Deactivate</button>`
                        : `<button onclick="activateUser(${user.id})" class="btn btn-sm btn-success">▶️ Activate</button>`
                    }
                    ${user.is_locked 
                        ? `<button onclick="unlockUser(${user.id})" class="btn btn-sm btn-warning">🔓 Unlock</button>`
                        : ''
                    }
                </div>
            </div>
        `;
    }).join('');
    
    userListElement.innerHTML = userListHTML;
}

function updateUserStats(users) {
    const totalUsers = users.length;
    const activeUsers = users.filter(u => u.is_active).length;
    const twoFactorUsers = users.filter(u => u.two_factor_enabled).length;
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('activeUsers').textContent = activeUsers;
    document.getElementById('twoFactorUsers').textContent = twoFactorUsers;
}


function refreshUserList() {
    loadUserList();
}

// Modal Functions
function showCreateUserModal() {
    const modalHTML = `
        <div class="modal-overlay" id="createUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New User</h3>
                    <button onclick="closeModal('createUserModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input type="text" id="newUsername" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Email:</label>
                            <input type="email" id="newEmail" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input type="password" id="newPassword" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="newRole">Role:</label>
                            <select id="newRole" name="role">
                                <option value="USER">User</option>
                                <option value="MANAGER">Manager</option>
                                <option value="ADMIN">Administrator</option>
                                <option value="READONLY">Read Only</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="createUser()" class="btn btn-primary">Create User</button>
                    <button onclick="closeModal('createUserModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function createUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        role: formData.get('role')
    };
    
    fetch('/api/users/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.user) {
            showSuccess('User created successfully');
            closeModal('createUserModal');
            loadUserList();
        } else {
            showError(data.error || 'Failed to create user');
        }
    })
    .catch(error => {
        console.error('Error creating user:', error);
        showError('Error creating user');
    });
}

function showChangePasswordModal() {
    const modalHTML = `
        <div class="modal-overlay" id="changePasswordModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Change Password</h3>
                    <button onclick="closeModal('changePasswordModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <input type="password" id="newPassword" name="new_password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" name="confirm_password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="changePassword()" class="btn btn-primary">Change Password</button>
                    <button onclick="closeModal('changePasswordModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function changePassword() {
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);
    
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        showError('New passwords do not match');
        return;
    }
    
    const passwordData = {
        current_password: formData.get('current_password'),
        new_password: newPassword
    };
    
    fetch('/auth/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(passwordData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Password changed successfully');
            closeModal('changePasswordModal');
        } else {
            showError(data.error || 'Failed to change password');
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showError('Error changing password');
    });
}

function showTwoFactorModal() {
    fetch('/2fa/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.status && data.status.enabled) {
                showTwoFactorManageModal();
            } else {
                showTwoFactorSetupModal();
            }
        })
        .catch(error => {
            console.error('Error getting 2FA status:', error);
            showError('Error loading 2FA status');
        });
}

function showTwoFactorSetupModal() {
    const modalHTML = `
        <div class="modal-overlay" id="twoFactorModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Setup Two-Factor Authentication</h3>
                    <button onclick="closeModal('twoFactorModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <div id="twoFactorSetup">
                        <p>Two-factor authentication adds an extra layer of security to your account.</p>
                        <button onclick="initiateTwoFactorSetup()" class="btn btn-primary">Setup 2FA</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function showUserSessionsModal() {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                return fetch(`/api/users/${data.user.id}/sessions`);
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                renderSessionsModal(data.sessions);
            }
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            showError('Error loading sessions');
        });
}

function renderSessionsModal(sessions) {
    const sessionsHTML = sessions.map(session => {
        const isCurrentSession = session.is_current;
        const currentBadge = isCurrentSession ? '<span class="current-session">Current</span>' : '';
        
        return `
            <div class="session-item ${isCurrentSession ? 'current' : ''}">
                <div class="session-info">
                    <div><strong>IP Address:</strong> ${session.ip_address || 'Unknown'}</div>
                    <div><strong>User Agent:</strong> ${session.user_agent || 'Unknown'}</div>
                    <div><strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}</div>
                    <div><strong>Last Activity:</strong> ${new Date(session.last_activity).toLocaleString()}</div>
                    ${currentBadge}
                </div>
                <div class="session-actions">
                    ${!isCurrentSession ? `<button onclick="revokeSession(${session.id})" class="btn btn-sm btn-danger">Revoke</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    const modalHTML = `
        <div class="modal-overlay" id="sessionsModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Manage Sessions</h3>
                    <button onclick="closeModal('sessionsModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <div class="sessions-list">
                        ${sessionsHTML}
                    </div>
                    <div class="session-actions-footer">
                        <button onclick="revokeAllSessions()" class="btn btn-danger">Revoke All Other Sessions</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function revokeSession(sessionId) {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                return fetch(`/api/users/${data.user.id}/sessions/${sessionId}`, { method: 'DELETE' });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Session revoked successfully');
                closeModal('sessionsModal');
                if (data.redirect_to_login) {
                    window.location.href = '/auth/login';
                }
            } else {
                showError(data.error || 'Failed to revoke session');
            }
        })
        .catch(error => {
            console.error('Error revoking session:', error);
            showError('Error revoking session');
        });
}

function revokeAllSessions() {
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                return fetch(`/api/users/${data.user.id}/sessions`, { method: 'DELETE' });
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('All sessions revoked successfully');
                closeModal('sessionsModal');
                if (data.redirect_to_login) {
                    window.location.href = '/auth/login';
                }
            } else {
                showError(data.error || 'Failed to revoke sessions');
            }
        })
        .catch(error => {
            console.error('Error revoking sessions:', error);
            showError('Error revoking sessions');
        });
}

function logoutUser() {
    if (confirm('Are you sure you want to logout?')) {
        // Try to detect which auth system is active by checking available endpoints
        let logoutEndpoint = '/auth/logout';
        
        fetch('/auth/logout', { method: 'POST' })
            .then(response => {
                // If full auth returns 404, try dynamic/simple auth system
                if (response.status === 404) {
                    console.log('Full auth logout not found, trying dynamic logout');
                    logoutEndpoint = '/auth/dynamic-logout';
                    return fetch('/auth/dynamic-logout', { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                }
                return response;
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect based on auth system
                    if (logoutEndpoint === '/auth/dynamic-logout') {
                        window.location.href = '/simple-login';
                    } else {
                        window.location.href = '/auth/login';
                    }
                } else {
                    showError('Logout failed');
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
                showError('Logout failed');
            });
    }
}

function deactivateUser(userId) {
    if (confirm('Are you sure you want to deactivate this user?')) {
        fetch(`/api/users/${userId}/deactivate`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('User deactivated successfully');
                    loadUserList();
                } else {
                    showError(data.error || 'Failed to deactivate user');
                }
            })
            .catch(error => {
                console.error('Error deactivating user:', error);
                showError('Error deactivating user');
            });
    }
}

function activateUser(userId) {
    fetch(`/api/users/${userId}/activate`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('User activated successfully');
                loadUserList();
            } else {
                showError(data.error || 'Failed to activate user');
            }
        })
        .catch(error => {
            console.error('Error activating user:', error);
            showError('Error activating user');
        });
}

function unlockUser(userId) {
    fetch(`/api/users/${userId}/unlock`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('User unlocked successfully');
                loadUserList();
            } else {
                showError(data.error || 'Failed to unlock user');
            }
        })
        .catch(error => {
            console.error('Error unlocking user:', error);
            showError('Error unlocking user');
        });
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

// Helper functions
function showSuccess(message) {
    if (typeof toastSuccess === 'function') {
        toastSuccess(message);
    } else {
        alert(message);
    }
}

function showError(message) {
    if (typeof toastError === 'function') {
        toastError(message);
    } else {
        alert('Error: ' + message);
    }
}

function showInfo(message) {
    if (typeof toastInfo === 'function') {
        toastInfo(message);
    } else {
        alert(message);
    }
}

// Missing function implementations
function showUserProfileModal() {
    const modalHTML = `
        <div class="modal-overlay" id="userProfileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>User Profile</h3>
                    <button onclick="closeModal('userProfileModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <form id="userProfileForm">
                        <div class="form-group">
                            <label for="profileEmail">Email:</label>
                            <input type="email" id="profileEmail" name="email" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="updateUserProfile()" class="btn btn-primary">Update Profile</button>
                    <button onclick="closeModal('userProfileModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load current user data
    fetch('/api/users/me')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                document.getElementById('profileEmail').value = data.user.email || '';
            }
        })
        .catch(error => {
            console.error('Error loading profile:', error);
        });
}

function updateUserProfile() {
    const form = document.getElementById('userProfileForm');
    const formData = new FormData(form);
    const preferences = {};
    
    fetch('/api/users/me/preferences', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ preferences: preferences })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Profile updated successfully');
            closeModal('userProfileModal');
            loadCurrentUserInfo();
        } else {
            showError(data.error || 'Failed to update profile');
        }
    })
    .catch(error => {
        console.error('Error updating profile:', error);
        showError('Error updating profile');
    });
}

function editUser(userId) {
    // Fetch user data and show edit modal
    fetch(`/api/users/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                showEditUserModal(data.user);
            }
        })
        .catch(error => {
            console.error('Error loading user:', error);
            showError('Error loading user data');
        });
}

function showEditUserModal(user) {
    const modalHTML = `
        <div class="modal-overlay" id="editUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit User: ${user.username}</h3>
                    <button onclick="closeModal('editUserModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" value="${user.id}">
                        <div class="form-group">
                            <label for="editEmail">Email:</label>
                            <input type="email" id="editEmail" name="email" value="${user.email || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="editRole">Role:</label>
                            <select id="editRole" name="role">
                                <option value="USER" ${user.role === 'USER' ? 'selected' : ''}>User</option>
                                <option value="MANAGER" ${user.role === 'MANAGER' ? 'selected' : ''}>Manager</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>Administrator</option>
                                <option value="READONLY" ${user.role === 'READONLY' ? 'selected' : ''}>Read Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editActive" ${user.is_active ? 'checked' : ''}> 
                                Active
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button onclick="updateUser()" class="btn btn-primary">Update User</button>
                    <button onclick="closeModal('editUserModal')" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function updateUser() {
    const userId = document.getElementById('editUserId').value;
    const role = document.getElementById('editRole').value;
    
    fetch(`/api/users/${userId}/role`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: role })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('User updated successfully');
            closeModal('editUserModal');
            loadUserList();
        } else {
            showError(data.error || 'Failed to update user');
        }
    })
    .catch(error => {
        console.error('Error updating user:', error);
        showError('Error updating user');
    });
}

function viewUserSessions(userId) {
    fetch(`/api/users/${userId}/sessions`)
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                renderUserSessionsModal(userId, data.sessions);
            }
        })
        .catch(error => {
            console.error('Error loading user sessions:', error);
            showError('Error loading user sessions');
        });
}

function renderUserSessionsModal(userId, sessions) {
    const sessionsHTML = sessions.map(session => {
        return `
            <div class="session-item">
                <div class="session-info">
                    <div><strong>IP Address:</strong> ${session.ip_address || 'Unknown'}</div>
                    <div><strong>User Agent:</strong> ${session.user_agent || 'Unknown'}</div>
                    <div><strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}</div>
                    <div><strong>Last Activity:</strong> ${new Date(session.last_activity).toLocaleString()}</div>
                    <div><strong>Status:</strong> ${session.status}</div>
                </div>
                <div class="session-actions">
                    <button onclick="adminRevokeSession(${userId}, ${session.id})" class="btn btn-sm btn-danger">Revoke</button>
                </div>
            </div>
        `;
    }).join('');
    
    const modalHTML = `
        <div class="modal-overlay" id="userSessionsModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>User Sessions</h3>
                    <button onclick="closeModal('userSessionsModal')" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <div class="sessions-list">
                        ${sessionsHTML}
                    </div>
                    <div class="session-actions-footer">
                        <button onclick="adminRevokeAllSessions(${userId})" class="btn btn-danger">Revoke All Sessions</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function adminRevokeSession(userId, sessionId) {
    fetch(`/api/users/${userId}/sessions/${sessionId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Session revoked successfully');
                closeModal('userSessionsModal');
            } else {
                showError(data.error || 'Failed to revoke session');
            }
        })
        .catch(error => {
            console.error('Error revoking session:', error);
            showError('Error revoking session');
        });
}

function adminRevokeAllSessions(userId) {
    if (confirm('Are you sure you want to revoke all sessions for this user?')) {
        fetch(`/api/users/${userId}/sessions`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('All sessions revoked successfully');
                    closeModal('userSessionsModal');
                } else {
                    showError(data.error || 'Failed to revoke sessions');
                }
            })
            .catch(error => {
                console.error('Error revoking sessions:', error);
                showError('Error revoking sessions');
            });
    }
}

function initiateTwoFactorSetup() {
    fetch('/2fa/api/setup', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.setup_data) {
                showTwoFactorSetupData(data.setup_data);
            } else {
                showError(data.error || 'Failed to setup 2FA');
            }
        })
        .catch(error => {
            console.error('Error setting up 2FA:', error);
            showError('Error setting up 2FA');
        });
}

function showTwoFactorSetupData(setupData) {
    const setupHTML = `
        <div class="twofa-setup">
            <h4>Step 1: Scan QR Code</h4>
            <div class="qr-code-container">
                <img src="data:image/png;base64,${setupData.qr_code}" alt="2FA QR Code">
            </div>
            
            <h4>Step 2: Manual Entry Key</h4>
            <p>If you can't scan the QR code, enter this key manually:</p>
            <div class="manual-key">
                <code>${setupData.manual_entry_key}</code>
                <button onclick="copyToClipboard('${setupData.manual_entry_key}')" class="btn btn-sm btn-secondary">Copy</button>
            </div>
            
            <h4>Step 3: Verify Setup</h4>
            <div class="form-group">
                <label for="verifyToken">Enter verification code from your authenticator app:</label>
                <input type="text" id="verifyToken" placeholder="123456" maxlength="6">
            </div>
            <button onclick="verifyTwoFactorSetup()" class="btn btn-primary">Verify & Enable 2FA</button>
            
            <h4>Backup Codes</h4>
            <p>Save these backup codes in a safe place. You can use them if you lose access to your authenticator app:</p>
            <div class="backup-codes">
                ${setupData.backup_codes.map(code => `<code>${code}</code>`).join('')}
            </div>
        </div>
    `;
    
    document.getElementById('twoFactorSetup').innerHTML = setupHTML;
}

function verifyTwoFactorSetup() {
    const token = document.getElementById('verifyToken').value;
    
    fetch('/2fa/api/verify-setup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: token })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('2FA enabled successfully!');
            closeModal('twoFactorModal');
            loadCurrentUserInfo();
        } else {
            showError(data.error || 'Failed to verify 2FA');
        }
    })
    .catch(error => {
        console.error('Error verifying 2FA:', error);
        showError('Error verifying 2FA');
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('Copied to clipboard');
    }).catch(() => {
        showError('Failed to copy to clipboard');
    });
}

// Handle hash-based navigation from dropdown menu
function handleHashNavigation() {
    const hash = window.location.hash.substring(1);
    console.log('Hash navigation triggered for:', hash);
    
    if (hash === 'profile') {
        // Trigger user profile modal
        console.log('Triggering profile modal...');
        console.log('showUserProfileModal function exists:', typeof showUserProfileModal === 'function');
        
        // Check if authentication is enabled and user section is visible
        const userSection = document.getElementById('userManagementSection');
        const authEnabled = document.getElementById('require_authentication').value === 'true';
        
        if (!authEnabled) {
            console.log('Authentication not enabled, enabling first...');
            document.getElementById('require_authentication').value = 'true';
            document.getElementById('require_authentication').dispatchEvent(new Event('change'));
            
            // Wait for user section to be shown, then call modal
            setTimeout(() => {
                if (typeof showUserProfileModal === 'function') {
                    showUserProfileModal();
                    console.log('Profile modal function called after enabling auth');
                } else {
                    console.error('showUserProfileModal function not found after enabling auth');
                }
            }, 500);
        } else {
            // Authentication is enabled, call modal directly
            setTimeout(() => {
                if (typeof showUserProfileModal === 'function') {
                    console.log('Calling showUserProfileModal function...');
                    showUserProfileModal();
                    console.log('Profile modal function called');
                    
                    // Verify modal was created
                    setTimeout(() => {
                        const modal = document.getElementById('userProfileModal');
                        if (modal) {
                            console.log('Profile modal successfully created in DOM');
                        } else {
                            console.error('Profile modal not found in DOM after creation');
                        }
                    }, 100);
                } else {
                    console.error('showUserProfileModal function not found');
                }
            }, 200);
        }
    } else if (hash === 'password') {
        // Trigger change password modal  
        console.log('Triggering password modal...');
        console.log('showChangePasswordModal function exists:', typeof showChangePasswordModal === 'function');
        
        // Check if authentication is enabled
        const authEnabled = document.getElementById('require_authentication').value === 'true';
        
        if (!authEnabled) {
            console.log('Authentication not enabled, enabling first...');
            document.getElementById('require_authentication').value = 'true';
            document.getElementById('require_authentication').dispatchEvent(new Event('change'));
            
            setTimeout(() => {
                if (typeof showChangePasswordModal === 'function') {
                    showChangePasswordModal();
                    console.log('Password modal function called after enabling auth');
                } else {
                    console.error('showChangePasswordModal function not found after enabling auth');
                }
            }, 500);
        } else {
            setTimeout(() => {
                if (typeof showChangePasswordModal === 'function') {
                    console.log('Calling showChangePasswordModal function...');
                    showChangePasswordModal();
                    console.log('Password modal function called');
                    
                    // Verify modal was created
                    setTimeout(() => {
                        const modal = document.getElementById('changePasswordModal');
                        if (modal) {
                            console.log('Password modal successfully created in DOM');
                        } else {
                            console.error('Password modal not found in DOM after creation');
                        }
                    }, 100);
                } else {
                    console.error('showChangePasswordModal function not found');
                }
            }, 200);
        }
    } else if (hash === 'userManagement') {
        // Scroll to user management section
        console.log('Scrolling to user management...');
        setTimeout(() => {
            const userMgmtSection = document.getElementById('userManagementSection');
            if (userMgmtSection) {
                userMgmtSection.scrollIntoView({ behavior: 'smooth' });
                console.log('Scrolled to user management section');
            } else {
                console.error('User management section not found');
            }
        }, 200);
    }
    
    // Clear the hash to prevent repeated triggers
    if (hash) {
        setTimeout(() => {
            history.replaceState(null, null, window.location.pathname);
        }, 2000);
    }
}

// Run hash navigation on page load

// Also run when hash changes (for single-page navigation)
window.addEventListener('hashchange', function() {
    handleHashNavigation();
});

// Cookie Management Functions for Settings Page
async function checkCookieStatusSettings() {
    try {
        const response = await fetch('/api/metube/cookies/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('cookieStatusSettings');
        const deleteBtn = document.getElementById('deleteCookieBtnSettings');
        
        if (data.cookies_available) {
            statusDiv.innerHTML = '<span class="status-text success">✅ Cookies uploaded - Age-restricted videos supported</span>';
            deleteBtn.style.display = 'inline-block';
        } else {
            statusDiv.innerHTML = '<span class="status-text error">❌ No cookies uploaded - Age-restricted videos will fail</span>';
            deleteBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Failed to check cookie status:', error);
        document.getElementById('cookieStatusSettings').innerHTML = '<span class="status-text">❓ Status unknown</span>';
    }
}

async function uploadCookiesSettings(input) {
    const file = input.files[0];
    if (!file) return;
    
    const uploadBtn = document.getElementById('uploadCookieBtnSettings');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '⏳ Uploading...';
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/metube/cookies/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showSuccess === 'function') {
                showSuccess('✅ Cookies uploaded successfully!');
            } else {
                alert('✅ Cookies uploaded successfully!');
            }
            await checkCookieStatusSettings();
        } else {
            const errorMsg = `❌ Upload failed: ${data.error}`;
            if (typeof showError === 'function') {
                showError(errorMsg);
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('Upload error:', error);
        const errorMsg = '❌ Upload failed due to network error';
        if (typeof showError === 'function') {
            showError(errorMsg);
        } else {
            alert(errorMsg);
        }
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '📤 Upload Cookies';
        input.value = '';
    }
}

async function deleteCookiesSettings() {
    if (!confirm('Are you sure you want to delete the uploaded cookies?')) return;
    
    try {
        const response = await fetch('/api/metube/cookies/delete', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (typeof showSuccess === 'function') {
                showSuccess('✅ Cookies deleted successfully');
            } else {
                alert('✅ Cookies deleted successfully');
            }
            await checkCookieStatusSettings();
        } else {
            const errorMsg = `❌ Delete failed: ${data.error}`;
            if (typeof showError === 'function') {
                showError(errorMsg);
            } else {
                alert(errorMsg);
            }
        }
    } catch (error) {
        console.error('Delete error:', error);
        const errorMsg = '❌ Delete failed due to network error';
        if (typeof showError === 'function') {
            showError(errorMsg);
        } else {
            alert(errorMsg);
        }
    }
}

function showCookieInstructionsSettings() {
    const instructions = `
How to export YouTube cookies:

1. Chrome/Edge:
   - Install "Get cookies.txt" extension
   - Go to YouTube.com and sign in
   - Click extension icon → Download cookies
   - Save as .txt file

2. Firefox:
   - Install "cookies.txt" add-on
   - Go to YouTube.com and sign in  
   - Click add-on icon → Export cookies
   - Save as .txt file

3. Manual method:
   - Use browser developer tools (F12)
   - Go to Application/Storage → Cookies
   - Copy YouTube cookies to .txt file in Netscape format

⚠️ Security: Only upload cookies from your personal computer. Never share cookie files.

The cookie file should contain YouTube authentication data including session tokens.
    `;
    
    alert(instructions);
}

// Certificate Management Functions
async function uploadCertificates() {
    const certFile = document.getElementById('ssl-certificate-file').files[0];
    const keyFile = document.getElementById('ssl-private-key-file').files[0];
    const chainFile = document.getElementById('ssl-certificate-chain').files[0];
    
    if (!certFile || !keyFile) {
        showToast('Please select both certificate and private key files', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('certificate', certFile);
    formData.append('private_key', keyFile);
    if (chainFile) {
        formData.append('certificate_chain', chainFile);
    }
    
    // Show progress
    const progressDiv = document.getElementById('cert-upload-progress');
    const progressFill = document.getElementById('cert-progress-fill');
    const progressText = document.getElementById('cert-progress-text');
    const uploadBtn = document.getElementById('upload-cert-btn');
    
    progressDiv.style.display = 'block';
    uploadBtn.disabled = true;
    progressText.textContent = 'Uploading certificates...';
    
    try {
        const response = await fetch('/api/security/certificates/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            progressFill.style.width = '100%';
            progressText.textContent = 'Upload complete!';
            showToast('Certificates uploaded successfully', 'success');
            
            // Refresh certificate status
            await loadCertificateStatus();
            
            // Clear file inputs
            document.getElementById('ssl-certificate-file').value = '';
            document.getElementById('ssl-private-key-file').value = '';
            document.getElementById('ssl-certificate-chain').value = '';
            
        } else {
            throw new Error(result.error || 'Upload failed');
        }
        
    } catch (error) {
        console.error('Certificate upload error:', error);
        showToast(`Upload failed: ${error.message}`, 'error');
        progressText.textContent = 'Upload failed';
    } finally {
        uploadBtn.disabled = false;
        setTimeout(() => {
            progressDiv.style.display = 'none';
            progressFill.style.width = '0%';
        }, 2000);
    }
}

async function validateCertificate() {
    const validateBtn = document.getElementById('validate-cert-btn');
    const resultsDiv = document.getElementById('cert-validation-results');
    const resultsContent = document.getElementById('cert-validation-content');
    
    validateBtn.disabled = true;
    validateBtn.textContent = 'Validating...';
    
    try {
        const response = await fetch('/api/security/certificates/validate', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            const validation = result.validation;
            let statusClass = validation.valid ? 'text-success' : 'text-danger';
            
            resultsContent.innerHTML = `
                <div class="validation-result ${statusClass}">
                    <strong>Status:</strong> ${validation.valid ? '✅ Valid' : '❌ Invalid'}
                </div>
                <div class="validation-details">
                    <p><strong>Subject:</strong> ${validation.subject || 'N/A'}</p>
                    <p><strong>Issuer:</strong> ${validation.issuer || 'N/A'}</p>
                    <p><strong>Valid From:</strong> ${validation.not_before || 'N/A'}</p>
                    <p><strong>Valid Until:</strong> ${validation.not_after || 'N/A'}</p>
                    <p><strong>Days Until Expiry:</strong> ${validation.days_until_expiry || 'N/A'}</p>
                    ${validation.alt_names ? `<p><strong>Alternative Names:</strong> ${validation.alt_names.join(', ')}</p>` : ''}
                    ${validation.errors.length > 0 ? `<div class="validation-errors"><strong>Errors:</strong><ul>${validation.errors.map(err => `<li>${err}</li>`).join('')}</ul></div>` : ''}
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            
        } else {
            throw new Error(result.error || 'Validation failed');
        }
        
    } catch (error) {
        console.error('Certificate validation error:', error);
        resultsContent.innerHTML = `<div class="text-danger">Validation failed: ${error.message}</div>`;
        resultsDiv.style.display = 'block';
    } finally {
        validateBtn.disabled = false;
        validateBtn.textContent = 'Validate Certificate';
    }
}

async function downloadCertificate() {
    try {
        const response = await fetch('/api/security/certificates/download');
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'mvidarr-certificate.crt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Certificate downloaded successfully', 'success');
        } else {
            const result = await response.json();
            throw new Error(result.error || 'Download failed');
        }
        
    } catch (error) {
        console.error('Certificate download error:', error);
        showToast(`Download failed: ${error.message}`, 'error');
    }
}

async function removeCertificates() {
    if (!confirm('Are you sure you want to remove the SSL certificates? This will disable HTTPS functionality.')) {
        return;
    }
    
    const removeBtn = document.getElementById('remove-cert-btn');
    removeBtn.disabled = true;
    
    try {
        const response = await fetch('/api/security/certificates/remove', {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Certificates removed successfully', 'success');
            await loadCertificateStatus();
        } else {
            throw new Error(result.error || 'Removal failed');
        }
        
    } catch (error) {
        console.error('Certificate removal error:', error);
        showToast(`Removal failed: ${error.message}`, 'error');
    } finally {
        removeBtn.disabled = false;
    }
}

async function loadCertificateStatus() {
    try {
        const response = await fetch('/api/security/certificates/status');
        const result = await response.json();
        
        if (result.success) {
            const status = result.status;
            
            // Update status display
            document.getElementById('cert-status').textContent = status.certificate_exists ? '✅ Configured' : '❌ Not configured';
            document.getElementById('key-status').textContent = status.private_key_exists ? '✅ Configured' : '❌ Not configured';
            document.getElementById('cert-expiry').textContent = status.expiry_date || 'N/A';
            
            // Show/hide action buttons based on certificate existence
            const downloadBtn = document.getElementById('download-cert-btn');
            const removeBtn = document.getElementById('remove-cert-btn');
            
            if (status.certificate_exists) {
                downloadBtn.style.display = 'inline-block';
                removeBtn.style.display = 'inline-block';
            } else {
                downloadBtn.style.display = 'none';
                removeBtn.style.display = 'none';
            }
            
            // Update status styling
            const certStatusEl = document.getElementById('cert-status');
            const keyStatusEl = document.getElementById('key-status');
            
            certStatusEl.className = `status-value ${status.certificate_exists ? 'text-success' : 'text-warning'}`;
            keyStatusEl.className = `status-value ${status.private_key_exists ? 'text-success' : 'text-warning'}`;
            
        } else {
            console.error('Failed to load certificate status:', result.error);
        }
        
    } catch (error) {
        console.error('Error loading certificate status:', error);
    }
}

</script>

<style>
.settings-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Settings Tab Styles */
.settings-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-primary, #38383a);
    margin-bottom: 2rem;
    background: var(--bg-secondary, #2c2c2e);
    border-radius: 8px 8px 0 0;
    overflow-x: auto;
}

.settings-tab-btn {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-muted, #98989d);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.settings-tab-btn:hover {
    color: var(--text-primary, #ffffff);
    background: var(--bg-hover, #3c3c3e);
}

.settings-tab-btn.active {
    color: var(--text-accent, #a8b9be);
    border-bottom-color: var(--text-accent, #a8b9be);
    background: var(--bg-tertiary, #3a3a3a);
}

.tab-icon {
    font-size: 1.1rem;
}

.settings-tab-content {
    min-height: 500px;
}

.settings-tab-panel {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.settings-tab-panel.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive tabs */
@media (max-width: 768px) {
    .settings-tabs {
        flex-direction: column;
        border-radius: 8px;
    }
    
    .settings-tab-btn {
        text-align: left;
        border-bottom: 1px solid var(--border-primary, #38383a);
        border-right: none;
    }
    
    .settings-tab-btn.active {
        border-bottom: 1px solid var(--border-primary, #38383a);
        border-left: 3px solid var(--text-accent, #a8b9be);
    }
}

/* User Management Styles */
.user-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.user-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.role-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: bold;
    text-transform: uppercase;
}

.role-badge.role-admin {
    background-color: var(--danger, #dc3545);
    color: var(--text-inverse, white);
}

.role-badge.role-manager {
    background-color: var(--warning, #fd7e14);
    color: var(--text-inverse, white);
}

.role-badge.role-user {
    background-color: var(--success, #28a745);
    color: var(--text-inverse, white);
}

.role-badge.role-readonly {
    background-color: var(--secondary, #6c757d);
    color: var(--text-inverse, white);
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: bold;
}

.status-enabled {
    color: var(--success, #28a745);
}

.status-disabled {
    color: var(--danger, #dc3545);
}

/* Cookie Management Styles */
.cookie-management-section {
    border: 1px solid var(--border-color, #38383a);
    border-radius: 8px;
    padding: 15px;
    background: var(--surface-color, #2c2c2e);
    margin-bottom: 15px;
    box-shadow: 0 2px 8px var(--shadow-color, rgba(108, 123, 127, 0.2));
}

.cookie-upload-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.cookie-status {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 500;
}

.cookie-status .status-text.success {
    color: var(--success, #28a745);
}

.cookie-status .status-text.error {
    color: var(--danger, #dc3545);
}

.cookie-status .status-text {
    color: var(--text-muted, #6c757d);
}

.cookie-upload-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.cookie-upload-actions button {
    font-size: 0.9rem;
    padding: 6px 12px;
}

.help-text {
    font-size: 0.85rem;
    color: var(--text-muted, #6c757d);
    margin-top: 5px;
    line-height: 1.4;
}

/* New section styles */
.section-description {
    font-size: 0.9rem;
    color: var(--text-muted, #999);
    margin-bottom: 20px;
    font-style: italic;
    line-height: 1.4;
}

.form-hint {
    font-size: 0.8rem;
    color: var(--text-muted, #999);
    margin-top: 4px;
    font-style: italic;
}

.discovery-info {
    background: var(--card-bg, #2a2a2a);
    border: 1px solid var(--border-color, #444);
    border-radius: 6px;
    padding: 12px;
    margin-top: 15px;
}

.discovery-info p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-muted, #ccc);
}

/* SSL Warning Section */
.ssl-warning {
    background: var(--surface-color, #2c2c2e);
    border: 1px solid var(--warning-color, #ff9f0a);
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
    box-shadow: 0 2px 8px var(--shadow-color, rgba(108, 123, 127, 0.2));
}

.ssl-warning strong {
    color: var(--warning-color, #ff9f0a);
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.status-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.status-item label {
    font-weight: bold;
    color: var(--text-secondary, #ccc);
}

.admin-only {
    color: var(--warning, #ffc107);
    font-size: 0.8em;
    font-weight: normal;
}

.user-management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.user-stats {
    display: flex;
    gap: 20px;
    font-size: 0.9em;
    color: var(--text-secondary, #ccc);
}

.user-stats span {
    white-space: nowrap;
}

.user-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 10px;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border: 1px solid var(--border-secondary, #555);
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: var(--bg-card, #2a2a2a);
    transition: all 0.2s ease;
}

.user-item:hover {
    background-color: var(--bg-hover, #333);
    border-color: var(--border-tertiary, #666);
}

.user-item.inactive {
    opacity: 0.6;
    background-color: var(--bg-primary, #1a1a1a);
}

.user-item .user-info {
    flex: 1;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.user-primary {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1em;
}

.user-secondary {
    display: flex;
    gap: 15px;
    font-size: 0.9em;
    color: var(--text-secondary, #ccc);
}

.user-item .user-actions {
    margin: 0;
    flex-shrink: 0;
}

.no-users, .loading, .error {
    text-align: center;
    color: var(--text-secondary, #ccc);
    padding: 40px;
    font-style: italic;
}

.error {
    color: var(--danger, #dc3545);
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background-color: var(--bg-card, #2a2a2a);
    border: 1px solid var(--border-secondary, #555);
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.modal-content.modal-large {
    max-width: 700px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-secondary, #555);
}

.modal-header h3 {
    margin: 0;
    color: var(--text-accent, #00d4ff);
}

.btn-close {
    background: none;
    border: none;
    color: var(--text-secondary, #ccc);
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close:hover {
    color: var(--text-primary, #fff);
    background-color: var(--bg-hover, #444);
    border-radius: 50%;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid var(--border-secondary, #555);
}

.sessions-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.session-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px;
    border: 1px solid var(--border-secondary, #555);
    border-radius: 8px;
    margin-bottom: 10px;
    background-color: var(--bg-tertiary, #333);
}

.session-item.current {
    border-color: var(--text-accent, #00d4ff);
    background-color: var(--bg-accent-muted, #1a3a4a);
}

.session-info {
    flex: 1;
    font-size: 0.9em;
    line-height: 1.4;
}

.session-info div {
    margin-bottom: 5px;
}

.current-session {
    background-color: var(--text-accent, #00d4ff);
    color: var(--accent-text, #000);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
    margin-top: 5px;
    display: inline-block;
}

.session-actions {
    flex-shrink: 0;
    margin-left: 15px;
}

.session-actions-footer {
    text-align: center;
    padding-top: 15px;
    border-top: 1px solid var(--border-secondary, #555);
}


/* Button size variants */
.btn-sm {
    padding: 4px 8px;
    font-size: 0.875em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-management-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .user-stats {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .user-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .user-primary {
        flex-wrap: wrap;
    }
    
    .user-secondary {
        flex-direction: column;
        gap: 5px;
    }
    
    .modal-content {
        margin: 20px;
        width: calc(100% - 40px);
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .user-info {
        grid-template-columns: 1fr;
    }
}

.settings-container h1 {
    color: var(--text-accent, #00d4ff);
    margin-bottom: 10px;
    font-size: 2.5rem;
    text-align: center;
}

.page-description {
    text-align: center;
    color: var(--text-secondary, #ccc);
    margin-bottom: 30px;
    font-size: 1.1rem;
}

.settings-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.settings-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
    margin-top: 30px;
}

.settings-section {
    background: var(--bg-tertiary, #3a3a3a);
    border: 1px solid #444;
    border-radius: 12px;
    padding: 25px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.settings-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
}

.settings-section h2 {
    color: var(--text-accent, #00d4ff);
    margin-bottom: 15px;
    font-size: 1.4rem;
    border-bottom: 2px solid var(--text-accent, #00d4ff);
    padding-bottom: 8px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: var(--text-accent, #00d4ff);
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group .help-text {
    display: block;
    color: var(--text-muted, #999);
    font-size: 12px;
    margin-top: 5px;
    font-style: italic;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    background: var(--input-bg, #333);
    border: 2px solid var(--input-border, #444);
    border-radius: 8px;
    color: var(--input-text, #fff);
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--input-focus, #00d4ff);
    box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
}

.form-group input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
}

.form-group option {
    background: var(--input-bg, #333);
    color: var(--input-text, #fff);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    color: #fff;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #0099cc 0%, #007799 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: #fff;
}

.btn-success:hover {
    background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
    color: #fff;
}

.btn-info:hover {
    background: linear-gradient(135deg, #117a8b 0%, #0c5460 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #ffc107 0%, #d39e00 100%);
    color: #000;
}

.btn-warning:hover {
    background: linear-gradient(135deg, #d39e00 0%, #b08800 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: #fff;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #5a6268 0%, #484e53 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
    color: #fff;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #bd2130 0%, #a01e2a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.btn-light {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #333;
}

.btn-light:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(248, 249, 250, 0.3);
}

/* Action Button Groups */
.integration-actions,
.indexing-actions,
.scheduler-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.integration-actions button,
.indexing-actions button,
.scheduler-actions button {
    flex: 1;
    min-width: 120px;
    max-width: 200px;
    white-space: normal;
    word-wrap: break-word;
    padding: 12px 8px;
    line-height: 1.3;
    height: auto;
    min-height: 44px;
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.stat-item {
    background: var(--bg-tertiary, #333);
    border: 1px solid var(--border-secondary, #555);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: transform 0.2s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
}

.stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--text-accent, #00d4ff);
    margin-bottom: 5px;
}

.stat-label {
    color: var(--text-secondary, #ccc);
    font-size: 0.9rem;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin: 1rem 0;
}

.result-item {
    background-color: var(--bg-quaternary, #3d3d3d);
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.thumbnail-stats {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: var(--bg-quaternary, #3d3d3d);
    border-radius: 4px;
    font-size: 0.9rem;
}

.progress-container {
    margin: 1rem 0;
    padding: 1rem;
    background-color: #3d3d3d;
    border-radius: 4px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #555;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00d4ff, #0099cc);
    width: 0%;
    transition: width 0.3s ease;
    animation: progress-pulse 2s infinite;
}

@keyframes progress-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.results-container {
    margin: 1rem 0;
    padding: 1rem;
    background-color: #3d3d3d;
    border-radius: 4px;
}

.scan-results, .indexing-results, .cleanup-results {
    color: #fff;
}

.scan-results h4, .indexing-results h4, .cleanup-results h4 {
    color: #00d4ff;
    margin-bottom: 0.5rem;
}

.deleted-artists {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #444;
    border-radius: 4px;
}

.deleted-artists ul {
    list-style-type: disc;
    margin-left: 1rem;
    margin-top: 0.5rem;
}

.deleted-artists li {
    margin-bottom: 0.25rem;
}

.success {
    color: #4caf50;
    font-weight: bold;
}

.warning {
    color: #ff9800;
    font-weight: bold;
}

.error {
    color: #f44336;
    font-weight: bold;
}

.loading {
    color: #00bcd4;
    font-weight: bold;
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

button:disabled:hover {
    background-color: inherit !important;
}

/* Scheduler Status Styles */
.scheduler-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
}

.scheduler-actions button {
    flex: 1;
    min-width: 120px;
    padding: 0.5rem;
    font-size: 0.9rem;
}

.status-info {
    background-color: #333;
    border-radius: 4px;
    padding: 1rem;
    margin-top: 0.5rem;
}

.status-item {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.status-item:last-child {
    margin-bottom: 0;
}

.status-item.running {
    color: #4caf50;
}

.status-item.stopped {
    color: #f44336;
}

.status-item.warning {
    color: #ff9800;
    font-style: italic;
}

.status-loading {
    color: #00d4ff;
    font-style: italic;
}

/* External Services Subsections */
.subsection {
    margin-bottom: 2rem;
    padding: 1rem;
    border: 1px solid #555;
    border-radius: 6px;
    background-color: #353535;
}

.subsection h3 {
    color: #ffffff;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    border-bottom: 1px solid #555;
    padding-bottom: 0.5rem;
}

.subsection:last-child {
    margin-bottom: 0;
}

.integration-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.integration-actions button {
    flex: 1;
    min-width: 120px;
    padding: 0.5rem;
    font-size: 0.9rem;
}

/* Mobile Responsive Design */
@media (max-width: 768px) {
    .settings-sections {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .settings-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .settings-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .settings-container {
        padding: 15px;
    }
    
    .settings-section {
        padding: 20px;
    }
    
    .integration-actions {
        flex-direction: column;
    }
    
    .integration-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .subsection {
        padding: 0.75rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .scheduler-actions {
        flex-direction: column;
    }
    
    .scheduler-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .indexing-actions {
        flex-direction: column;
    }
    
    .indexing-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

/* Form improvements for external services */
.external-services .form-group {
    margin-bottom: 1rem;
}

.external-services input[type="text"],
.external-services input[type="password"],
.external-services input[type="number"],
.external-services select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #555;
    border-radius: 4px;
    background-color: #444;
    color: #fff;
}

.external-services input[type="text"]:focus,
.external-services input[type="password"]:focus,
.external-services input[type="number"]:focus,
.external-services select:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
}

.external-services label {
    display: block;
    margin-bottom: 0.5rem;
    color: #ccc;
    font-weight: 500;
}

/* Integration status indicators */
.integration-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-left: 0.5rem;
}

.integration-status.enabled {
    background-color: #4caf50;
    color: #fff;
}

.integration-status.disabled {
    background-color: #f44336;
    color: #fff;
}

.integration-status.testing {
    background-color: #ff9800;
    color: #fff;
}

/* Responsive design for external services */
@media (max-width: 768px) {
    .integration-actions {
        flex-direction: column;
    }
    
    .integration-actions button {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .subsection {
        padding: 0.75rem;
    }
}

/* Integration Notice */
.integration-notice {
    background-color: #f0f8ff;
    border: 1px solid #00d4ff;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 20px;
    color: #333;
}

.integration-notice p {
    margin-bottom: 12px;
    font-weight: 600;
}

.integration-links {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.integration-link {
    display: inline-block;
    padding: 8px 16px;
    background-color: #00d4ff;
    color: #000;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
}

.integration-link:hover {
    background-color: #0099cc;
    transform: translateY(-1px);
}

/* Dark theme adjustments */




/* Bauhaus theme adjustments */








/* Legacy bauhaus theme preview styles removed */


/* Readonly field styles */
.readonly-field {
    background-color: #2a2a2a !important;
    color: #888 !important;
    cursor: not-allowed !important;
}


/* Legacy theme preview styles removed - functionality moved to Themes tab */

/* ============== THEMES TAB STYLES ============== */

.themes-container {
    padding: 0;
}

.theme-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1.5rem;
    gap: 1rem;
}

.theme-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-primary, #444);
    margin-bottom: 2rem;
}

.theme-tab-btn {
    background: var(--bg-card, #2a2a2a);
    border: none;
    color: var(--text-secondary, #ccc);
    padding: 1rem 2rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.theme-tab-btn:hover {
    color: var(--text-primary, #fff);
    background: color-mix(in srgb, var(--text-accent, #4a9eff) 10%, transparent);
}

.theme-tab-btn.active {
    color: var(--text-accent, #4a9eff);
    border-bottom-color: var(--text-accent, #4a9eff);
    background: var(--bg-modal, #333333);
}

.theme-tab-content {
    display: none;
}

.theme-tab-content.active {
    display: block;
    background: var(--bg-hover, #404040);
}

/* Themes Grid */
.themes-grid-container h3 {
    color: var(--text-primary, #fff);
    margin-bottom: 1.5rem;
}

.themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
}

.theme-card {
    background: var(--bg-secondary, #2d2d2d);
    border: 1px solid var(--border-primary, #444);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.theme-card:hover {
    border-color: var(--text-accent, #4a9eff);
    box-shadow: 0 4px 12px color-mix(in srgb, var(--text-accent, #4a9eff) 20%, transparent);
}

.theme-card.applied {
    border-color: var(--success, #00ff00);
    background: color-mix(in srgb, var(--success, #00ff00) 5%, var(--bg-secondary, #2d2d2d));
}

.theme-card.applied::before {
    content: "✓ Applied";
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--success, #00ff00);
    color: var(--bg-primary, #000);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
}

.theme-preview-mini {
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
    border: 1px solid var(--border-primary, #444);
}

.preview-bg {
    height: 100%;
    display: flex;
    align-items: flex-end;
    padding: 0.5rem;
}

.preview-accent {
    width: 40px;
    height: 8px;
    border-radius: 2px;
}

.theme-info h4 {
    color: var(--text-primary, #fff);
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.theme-description {
    color: var(--text-secondary, #ccc);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    line-height: 1.4;
}

.theme-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.theme-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: bold;
}

.theme-badge.built-in {
    background: var(--info, #17a2b8);
    color: var(--text-primary, #fff);
}

.theme-badge.public {
    background: var(--success, #28a745);
    color: var(--text-primary, #fff);
}

.theme-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

/* Customize Theme Selection */
.customize-theme-selection h4 {
    color: var(--text-primary, #fff);
    margin-bottom: 1rem;
}

.customize-themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.customize-theme-card {
    background: var(--bg-secondary, #2d2d2d);
    border: 1px solid var(--border-primary, #444);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.customize-theme-card:hover {
    border-color: var(--text-accent, #4a9eff);
}

.customize-theme-card.active {
    border-color: var(--text-accent, #4a9eff);
    background: color-mix(in srgb, var(--text-accent, #4a9eff) 10%, var(--bg-secondary, #2d2d2d));
}

.customize-theme-card .theme-preview-mini {
    height: 40px;
    margin-bottom: 0.5rem;
}

.theme-name {
    color: var(--text-primary, #fff);
    font-size: 0.875rem;
}

/* Color Customization Panel */
.color-panel {
    background: var(--bg-secondary, #2d2d2d);
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 1.5rem;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary, #444);
}

.panel-header h4 {
    color: var(--text-primary, #fff);
    margin: 0;
}

.panel-actions {
    display: flex;
    gap: 0.5rem;
}

/* Theme Details Section */
.theme-details {
    background: var(--bg-tertiary, #3a3a3a);
    border: 1px solid var(--border-secondary, #555);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.theme-details .form-group {
    margin-bottom: 1rem;
}

.theme-details .form-group:last-child {
    margin-bottom: 0;
}

.theme-details label {
    display: block;
    color: var(--text-primary, #fff);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.theme-details .form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: var(--input-bg, #3a3a3a);
    border: 1px solid var(--input-border, #555);
    border-radius: 4px;
    color: var(--input-text, #fff);
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
}

.theme-details .form-control:focus {
    outline: none;
    border-color: var(--input-focus, #4a9eff);
    box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
}

.theme-details textarea.form-control {
    resize: vertical;
    min-height: 3rem;
}

/* Theme Mode Tabs */
.theme-mode-tabs {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-primary, #444);
}

.theme-mode-tab {
    background: none;
    border: none;
    padding: 0.75rem 1.5rem;
    color: var(--text-secondary, #ccc);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    border-bottom: 2px solid transparent;
}

.theme-mode-tab:hover {
    color: var(--text-primary, #fff);
    background: var(--bg-hover, #404040);
}

.theme-mode-tab.active {
    color: var(--text-accent, #4a9eff);
    border-bottom-color: var(--text-accent, #4a9eff);
}

.theme-mode-tab iconify-icon {
    font-size: 1rem;
}

.theme-mode-content {
    display: none;
}

.theme-mode-content.active {
    display: block;
}

.color-groups {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.color-group h5 {
    color: var(--text-accent, #4a9eff);
    margin-bottom: 1rem;
    font-size: 1rem;
}

.color-inputs {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.color-input-group {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.color-input-group label {
    color: var(--text-primary, #fff);
    min-width: 180px;
    font-size: 0.9rem;
}

.color-input-group input[type="color"] {
    width: 50px;
    height: 35px;
    border: 1px solid var(--border-primary, #444);
    border-radius: 4px;
    cursor: pointer;
}

.color-value {
    color: var(--text-secondary, #ccc);
    font-family: monospace;
    font-size: 0.875rem;
    min-width: 80px;
}

.theme-preview-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-primary, #444);
}

.theme-preview-section h5 {
    color: var(--text-accent, #4a9eff);
    margin-bottom: 1rem;
}

.preview-container {
    background: var(--bg-tertiary, #3a3a3a);
    border: 1px solid var(--border-primary, #444);
    border-radius: 8px;
    padding: 1.5rem;
    min-height: 200px;
}

.no-themes {
    text-align: center;
    color: var(--text-secondary, #ccc);
    font-style: italic;
    padding: 2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .themes-grid {
        grid-template-columns: 1fr;
    }
    
    .customize-themes-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
    
    .color-groups {
        grid-template-columns: 1fr;
    }
    
    .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .color-input-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .color-input-group label {
        min-width: auto;
    }
}

/* Live Preview Styles */
.preview-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-primary, #444);
}

.preview-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.preview-section h6 {
    color: var(--text-accent, #4a9eff);
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
    font-weight: 600;
}

/* Preview Cards */
.preview-cards {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.preview-card {
    background: var(--cardBackgroundColor, var(--bg-card, #2a2a2a));
    border: 1px solid var(--borderColor, var(--border-primary, #444));
    border-radius: 6px;
    padding: 1rem;
    min-width: 150px;
    flex: 1;
    box-shadow: 0 2px 4px var(--cardShadowColor, rgba(0,0,0,0.3));
}

.preview-card .card-header {
    color: var(--text-primary, #fff);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.preview-card .card-content {
    color: var(--text-secondary, #ccc);
    font-size: 0.9rem;
}

/* Preview Buttons */
.preview-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.preview-btn-primary {
    background: var(--btn-primary-bg, #4a9eff);
    color: var(--btn-primary-text, #fff);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.preview-btn-primary:hover {
    background: var(--btn-primary-hover, #3a8eef);
}

.preview-btn-secondary {
    background: var(--btn-secondary-bg, #666);
    color: var(--btn-secondary-text, #fff);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.preview-btn-secondary:hover {
    background: var(--btn-secondary-hover, #777);
}

.preview-btn-danger {
    background: var(--btn-danger-bg, #dc3545);
    color: var(--btn-danger-text, #fff);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.preview-btn-danger:hover {
    background: var(--btn-danger-hover, #c82333);
}

/* Preview Form Elements */
.preview-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.preview-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.preview-form label {
    color: var(--text-primary, #fff);
    font-size: 0.9rem;
    font-weight: 500;
}

.preview-input, .preview-select {
    background: var(--inputBackgroundColor, var(--input-bg, #3a3a3a));
    color: var(--textColor, var(--input-text, #fff));
    border: 1px solid var(--inputBorderColor, var(--input-border, #555));
    border-radius: 4px;
    padding: 0.5rem;
    font-size: 0.9rem;
    width: 200px;
}

.preview-input:focus, .preview-select:focus {
    outline: none;
    border-color: var(--inputFocusBorderColor, var(--input-focus, #4a9eff));
    box-shadow: 0 0 0 2px var(--inputFocusBoxShadowColor, rgba(74, 158, 255, 0.25));
}

/* Preview Navigation */
.preview-nav {
    display: flex;
    background: var(--nav-bg, #2d2d2d);
    border-radius: 4px;
    overflow: hidden;
}

.nav-item {
    padding: 0.75rem 1rem;
    color: var(--nav-text, #fff);
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.9rem;
}

.nav-item:hover {
    background: var(--nav-hover, #404040);
}

.nav-item.active {
    background: var(--nav-active, #4a9eff);
    color: var(--text-inverse, #000);
}

/* Preview Alerts */
.preview-alerts {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.alert-success, .alert-warning, .alert-error, .alert-info {
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 0.9rem;
    border: 1px solid;
}

.alert-success {
    background: var(--alertSuccessBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--successColor, var(--success, #28a745));
    border-color: var(--successColor, var(--success, #28a745));
}

.alert-warning {
    background: var(--alertWarningBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--warningColor, var(--warning, #ffc107));
    border-color: var(--warningColor, var(--warning, #ffc107));
}

.alert-error {
    background: var(--alertDangerBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--dangerColor, var(--error, #dc3545));
    border-color: var(--dangerColor, var(--error, #dc3545));
}

.alert-info {
    background: var(--alertInfoBackgroundColor, var(--bg-secondary, #2d2d2d));
    color: var(--primaryColor, var(--info, #17a2b8));
    border-color: var(--primaryColor, var(--info, #17a2b8));
}

/* Preview Responsive */
@media (max-width: 768px) {
    .preview-cards, .preview-buttons {
        flex-direction: column;
    }
    
    .preview-input, .preview-select {
        width: 100%;
    }
    
    .preview-nav {
        flex-direction: column;
    }
}

/* Enhanced Scheduler Status Styles */
.status-item.enhanced {
    color: #00d4ff;
    font-weight: bold;
}
.status-item.standard {
    color: #4a9eff;
    font-weight: bold;
}
.env-config, .job-list, .last-runs {
    margin-left: 10px;
    margin-top: 5px;
    font-size: 0.9em;
}
.env-config > div, .job-list > div, .last-runs > div {
    margin-bottom: 2px;
    color: var(--text-secondary, #ccc);
}
.job-item {
    padding: 2px 0;
    border-bottom: 1px solid var(--border-primary, #444);
}
.job-item:last-child {
    border-bottom: none;
}
</style>

<script>
// Theme management functionality
// Use existing global variables if available, otherwise create local ones
if (typeof window.currentTheme === 'undefined') {
    window.currentTheme = 'default';
}
if (typeof window.currentMode === 'undefined') {
    window.currentMode = 'dark';
}

// Initialize theme settings - now handled by Themes tab
document.addEventListener('DOMContentLoaded', function() {
    // Theme functionality moved to dedicated Themes tab
});

// Legacy theme functions removed - themes now handled in dedicated Themes tab

// Theme functionality moved to dedicated Themes tab - no legacy hooks needed

// ============== THEMES TAB FUNCTIONALITY ==============

let allThemes = [];
let currentTheme = null;

// Initialize themes when tab is activated
function initializeThemesTab() {
    if (document.getElementById('themes-tab').classList.contains('active')) {
        loadThemes();
    }
}

// Theme tab switching functionality
function switchThemeTab(event, tabId) {
    // Remove active class from all theme tabs and panels
    const tabButtons = document.querySelectorAll('.theme-tab-btn');
    const tabPanels = document.querySelectorAll('.theme-tab-content');
    
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabPanels.forEach(panel => panel.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding panel
    event.target.classList.add('active');
    const targetPanel = document.getElementById(tabId);
    if (targetPanel) {
        targetPanel.classList.add('active');
        
        // Load customize grid if switching to customize tab
        if (tabId === 'customize-tab') {
            loadCustomizeThemeGrid();
        }
    }
}

// Load all themes from API
async function loadThemes() {
    try {
        console.log('Loading themes from /api/themes...');
        const response = await fetch('/api/themes', {
            credentials: 'same-origin'
        });
        console.log('Themes API response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Themes API error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Themes API response data:', data);
        
        if (!data.themes) {
            throw new Error('No themes property in response');
        }
        
        allThemes = data.themes;
        console.log('Loaded themes:', allThemes.length);
        renderThemesGrid();
        loadCustomizeThemeGrid();
        
    } catch (error) {
        console.error('Failed to load themes:', error);
        console.error('Error stack:', error.stack);
        showError('Failed to load themes: ' + error.message);
    }
}

// Render themes grid
function renderThemesGrid() {
    const grid = document.getElementById('themes-grid');
    
    if (allThemes.length === 0) {
        grid.innerHTML = '<p class="no-themes">No themes available. Check your internet connection or refresh the page.</p>';
        return;
    }

    grid.innerHTML = allThemes.map(theme => `
        <div class="theme-card ${theme.is_applied ? 'applied' : ''}" data-theme-id="${theme.id || theme.name}">
            <div class="theme-preview-mini">
                <div class="preview-bg" style="background: ${theme.theme_data?.['--bg-primary'] || '#1a1a1a'};">
                    <div class="preview-accent" style="background: ${theme.theme_data?.['--text-accent'] || '#4a9eff'};"></div>
                </div>
            </div>
            <div class="theme-info">
                <h4 class="theme-title">${theme.display_name || theme.name}</h4>
                <p class="theme-description">${theme.description || 'No description available'}</p>
                <div class="theme-meta">
                    ${theme.is_built_in ? '<span class="theme-badge built-in">Built-in</span>' : ''}
                    ${theme.is_public ? '<span class="theme-badge public">Public</span>' : ''}
                </div>
            </div>
            <div class="theme-actions">
                <button onclick="quickApplyTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-success">
                    Apply
                </button>
                <button onclick="selectTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-primary">
                    Customize
                </button>
                ${!theme.is_built_in ? `
                    <button onclick="editTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-secondary" title="Edit Theme">
                        <iconify-icon icon="tabler:edit"></iconify-icon>
                    </button>
                    <button onclick="deleteTheme('${theme.id || theme.name}', '${theme.display_name}'); event.stopPropagation();" class="btn btn-sm btn-danger" title="Delete Theme">
                        <iconify-icon icon="tabler:trash"></iconify-icon>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// Load customize theme grid
function loadCustomizeThemeGrid() {
    const grid = document.getElementById('customize-theme-grid');
    if (!grid || allThemes.length === 0) return;
    
    grid.innerHTML = allThemes.map(theme => `
        <div class="customize-theme-card" data-theme-id="${theme.id || theme.name}" onclick="selectTheme('${theme.id || theme.name}')">
            <div class="theme-preview-mini">
                <div class="preview-bg" style="background: ${theme.theme_data?.['--bg-primary'] || '#1a1a1a'};">
                    <div class="preview-accent" style="background: ${theme.theme_data?.['--text-accent'] || '#4a9eff'};"></div>
                </div>
            </div>
            <span class="theme-name">${theme.display_name || theme.name}</span>
        </div>
    `).join('');
}

// Quick apply theme directly from theme card
async function quickApplyTheme(themeId) {
    const theme = allThemes.find(theme => {
        const themeIdentifier = theme.id || theme.name;
        return String(themeIdentifier) === String(themeId);
    });
    
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    try {
        let themeToApply = theme;
        
        // If this is a built-in theme, get its CSS variables
        if (theme.is_built_in) {
            const extractResponse = await fetch(`/api/themes/built-in/${theme.name}/extract`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            if (extractResponse.ok) {
                const extractData = await extractResponse.json();
                themeToApply = {
                    ...theme,
                    theme_data: extractData.variables
                };
            }
        }
        
        // Apply theme variables to the document
        if (themeToApply.theme_data) {
            Object.entries(themeToApply.theme_data).forEach(([cssVar, value]) => {
                document.documentElement.style.setProperty(cssVar, value);
            });
        }
        
        // Save theme preference using themes API
        const response = await fetch('/api/themes/apply', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                theme_name: theme.id || theme.name
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to apply theme: ${response.status} - ${errorText}`);
        }
        
        // Update the global theme variable
        window.currentTheme = theme.id || theme.name;
        document.documentElement.setAttribute('data-theme', window.currentTheme);
        
        // Update visual feedback on theme cards
        document.querySelectorAll('.theme-card').forEach(card => {
            card.classList.remove('applied');
        });
        const appliedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
        if (appliedCard) {
            appliedCard.classList.add('applied');
        }
        
        showSuccess(`Applied theme "${theme.display_name}" successfully!`);
        
    } catch (error) {
        console.error('Failed to apply theme:', error);
        showError('Failed to apply theme: ' + error.message);
    }
}

// Select a theme for customization
function selectTheme(themeId) {
    // Remove active class from all cards
    document.querySelectorAll('.customize-theme-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Find the theme - handle both numeric and string IDs
    currentTheme = allThemes.find(theme => {
        const themeIdentifier = theme.id || theme.name;
        return String(themeIdentifier) === String(themeId);
    });
    
    if (currentTheme) {
        loadThemeForCustomization(currentTheme);
        
        // Manage button visibility based on theme type and editing state
        const updateBtn = document.getElementById('update-theme-btn');
        const saveBtn = document.querySelector('[onclick*="saveCustomTheme"]');
        const saveCurrentBtn = document.getElementById('save-current-theme-btn');
        
        if (window.editingThemeId === themeId) {
            // This theme is being edited
            if (updateBtn) {
                updateBtn.style.display = 'inline-block';
            }
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
            if (saveCurrentBtn) {
                saveCurrentBtn.style.display = 'none';
            }
        } else {
            // Reset editing state
            window.editingThemeId = null;
            if (updateBtn) {
                updateBtn.style.display = 'none';
            }
            if (saveBtn) {
                // Show Save as Custom button for all themes
                saveBtn.style.display = 'inline-block';
            }
            if (saveCurrentBtn) {
                // Show Save Current Theme button for editable themes (not Default)
                if (currentTheme.is_built_in && currentTheme.name.toLowerCase() === 'default') {
                    saveCurrentBtn.style.display = 'none';
                } else {
                    saveCurrentBtn.style.display = 'inline-block';
                }
            }
        }
        
        // Switch to customize tab if not already active
        const customizeTab = document.querySelector('[onclick*="customize-tab"]');
        if (customizeTab && !customizeTab.classList.contains('active')) {
            switchThemeTab({target: customizeTab}, 'customize-tab');
        }
    }
}

// Load theme for customization
async function loadThemeForCustomization(theme) {
    let themeData = theme.theme_data;
    
    // If this is a built-in theme, extract its variables
    if (theme.is_built_in && !themeData) {
        try {
            const response = await fetch(`/api/themes/built-in/${theme.name}/extract`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            if (response.ok) {
                const extractData = await response.json();
                themeData = extractData.variables;
            }
        } catch (error) {
            console.error('Failed to extract theme variables:', error);
            themeData = {};
        }
    }
    
    // Update theme name
    document.getElementById('customizing-theme-name').textContent = `Customizing: ${theme.display_name || theme.name}`;
    
    // Show/hide theme details section and populate fields
    const themeDetailsSection = document.getElementById('theme-details-section');
    const themeNameInput = document.getElementById('theme-name-input');
    const themeDescriptionInput = document.getElementById('theme-description-input');
    
    // Show theme details for custom themes or built-in themes (except Default)
    if (!theme.is_built_in || (theme.is_built_in && theme.name.toLowerCase() !== 'default')) {
        themeDetailsSection.style.display = 'block';
        themeNameInput.value = theme.display_name || theme.name;
        themeDescriptionInput.value = theme.description || '';
    } else {
        themeDetailsSection.style.display = 'none';
        themeNameInput.value = '';
        themeDescriptionInput.value = '';
    }
    
    // Load colors into inputs
    const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
    colorInputs.forEach(input => {
        const cssVar = input.dataset.cssVar;
        
        // Use regular theme data
        const value = themeData?.[cssVar] || input.nextElementSibling.textContent;
        
        input.value = value;
        input.nextElementSibling.textContent = value;
        
        // Apply the color to the document for live preview
        document.documentElement.style.setProperty(cssVar, value);
        
        // Add event listener for live updates
        input.addEventListener('input', function() {
            // Apply live preview
            document.documentElement.style.setProperty(cssVar, this.value);
            this.nextElementSibling.textContent = this.value;
        });
    });
    
    // Show the customization panel
    document.getElementById('color-customization-panel').style.display = 'block';
}

// Apply current theme
async function applyCurrentTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    try {
        // Get current values from color inputs
        const themeData = {};
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            themeData[cssVar] = input.value;
        });
        
        // Apply theme variables to the document
        Object.entries(themeData).forEach(([cssVar, value]) => {
            document.documentElement.style.setProperty(cssVar, value);
        });
        
        // Save theme preference using themes API
        const response = await fetch('/api/themes/apply', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                theme_name: currentTheme.name  // Always use name, not ID
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to apply theme: ${response.status} - ${errorText}`);
        }
        
        // Update the global theme variable
        window.currentTheme = currentTheme.id || currentTheme.name;
        document.documentElement.setAttribute('data-theme', window.currentTheme);
        
        showSuccess(`Applied theme "${currentTheme.display_name}" successfully!`);
        
    } catch (error) {
        console.error('Failed to apply theme:', error);
        showError('Failed to apply theme: ' + error.message);
    }
}

// Reset to default colors
async function resetToDefault() {
    if (!currentTheme) return;
    
    try {
        // Reload the original theme
        await loadThemeForCustomization(currentTheme);
        showSuccess('Reset to default colors');
    } catch (error) {
        console.error('Failed to reset theme:', error);
        showError('Failed to reset theme: ' + error.message);
    }
}

// Save custom theme
async function saveCustomTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    const customName = prompt('Enter a name for your custom theme:', `${currentTheme.display_name || currentTheme.name} Custom`);
    if (!customName) return;
    
    try {
        // Get current values from color inputs
        const themeData = {};
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            themeData[cssVar] = input.value;
        });
        
        // Save custom theme
        const response = await fetch('/api/themes', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: customName.toLowerCase().replace(/\s+/g, '_'),
                display_name: customName,
                description: `Custom theme based on ${currentTheme.display_name || currentTheme.name}`,
                theme_data: themeData
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to save custom theme: ${response.status} - ${errorText}`);
        }
        
        showSuccess(`Custom theme "${customName}" saved successfully!`);
        loadThemes(); // Reload themes to show the new custom theme
        
    } catch (error) {
        console.error('Failed to save custom theme:', error);
        showError('Failed to save custom theme: ' + error.message);
    }
}

// Refresh themes
function refreshThemes() {
    loadThemes()
        .then(() => showSuccess('Themes refreshed successfully!'))
        .catch(error => showError('Failed to refresh themes: ' + error.message));
}

// Export all themes
async function exportAllThemes() {
    try {
        showInfo('Preparing theme export...');
        
        const response = await fetch('/api/themes/export/all', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            let errorMessage = 'Failed to export themes';
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (jsonError) {
                // If response isn't JSON, use status text or generic message
                errorMessage = response.statusText || `HTTP ${response.status}: ${errorMessage}`;
            }
            throw new Error(errorMessage);
        }

        // Create a blob from the response and trigger download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'mvidarr_themes_export.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showSuccess('All themes exported successfully!');
    } catch (error) {
        console.error('Export error:', error);
        showError('Failed to export themes: ' + error.message);
    }
}

// Export current theme
async function exportCurrentTheme() {
    try {
        if (!currentTheme) {
            showError('No theme selected to export');
            return;
        }

        // For built-in themes without database ID, we need to handle them differently
        let themeId = currentTheme.id;
        if (!themeId && currentTheme.name) {
            // For built-in themes, we'll need to create a temporary export
            showError('Built-in themes cannot be exported directly. Please save as custom theme first.');
            return;
        }

        showInfo('Preparing theme export...');
        
        const response = await fetch(`/api/themes/${themeId}/export`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            let errorMessage = 'Failed to export theme';
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (jsonError) {
                // If response isn't JSON, use status text or generic message
                errorMessage = response.statusText || `HTTP ${response.status}: ${errorMessage}`;
            }
            throw new Error(errorMessage);
        }

        // Create a blob from the response and trigger download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `${currentTheme.name}_theme.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        showSuccess(`Theme "${currentTheme.display_name}" exported successfully!`);
    } catch (error) {
        console.error('Export error:', error);
        showError('Failed to export theme: ' + error.message);
    }
}

// Import themes
function importThemes() {
    // Create a file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';
    
    fileInput.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            showInfo('Validating theme file...');
            
            // First validate the file
            const formData = new FormData();
            formData.append('file', file);
            
            const validateResponse = await fetch('/api/themes/import/validate', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });
            
            if (!validateResponse.ok) {
                const errorData = await validateResponse.json();
                throw new Error(errorData.error || 'Failed to validate theme file');
            }
            
            const validationResult = await validateResponse.json();
            
            // Show validation results to user
            let confirmMessage = `Validation Results:\n\n`;
            confirmMessage += `Total themes: ${validationResult.total_themes}\n`;
            confirmMessage += `Valid themes: ${validationResult.valid_themes_count}\n`;
            confirmMessage += `Invalid themes: ${validationResult.invalid_themes_count}\n`;
            confirmMessage += `Existing themes (will be skipped): ${validationResult.existing_themes_count}\n`;
            
            if (validationResult.validation_errors.length > 0) {
                confirmMessage += `\nErrors:\n${validationResult.validation_errors.join('\n')}\n`;
            }
            
            if (validationResult.existing_themes.length > 0) {
                confirmMessage += `\nExisting themes that will be skipped:\n${validationResult.existing_themes.join('\n')}\n`;
            }
            
            if (validationResult.valid_themes_count > 0) {
                confirmMessage += `\nValid themes to import:\n${validationResult.valid_themes.map(t => t.display_name).join('\n')}\n`;
                confirmMessage += `\nProceed with import?`;
                
                if (confirm(confirmMessage)) {
                    await performImport(file);
                }
            } else {
                alert(confirmMessage + '\nNo valid themes to import.');
            }
            
        } catch (error) {
            console.error('Import validation error:', error);
            showError('Failed to validate theme file: ' + error.message);
        }
        
        // Clean up
        document.body.removeChild(fileInput);
    };
    
    document.body.appendChild(fileInput);
    fileInput.click();
}

// Perform the actual import
async function performImport(file) {
    try {
        showInfo('Importing themes...');
        
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/themes/import', {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to import themes');
        }
        
        const result = await response.json();
        
        // Show detailed results
        let message = result.message + '\n\n';
        message += `Imported: ${result.imported_count} themes\n`;
        message += `Skipped: ${result.skipped_count} themes\n`;
        message += `Errors: ${result.error_count} themes\n`;
        
        if (result.imported_themes.length > 0) {
            message += `\nImported themes:\n${result.imported_themes.join('\n')}`;
        }
        
        if (result.errors.length > 0) {
            message += `\nErrors:\n${result.errors.join('\n')}`;
        }
        
        if (result.imported_count > 0) {
            showSuccess(message);
            // Refresh the themes list to show imported themes
            refreshThemes();
        } else {
            showWarning(message);
        }
        
    } catch (error) {
        console.error('Import error:', error);
        showError('Failed to import themes: ' + error.message);
    }
}


// Save current theme (update the theme that's currently applied)
async function saveCurrentTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    // Check if this is the Default theme
    if (currentTheme.is_built_in && currentTheme.name.toLowerCase() === 'default') {
        showError('The Default theme cannot be modified. Use "Save as Custom" to create a new theme based on Default.');
        return;
    }
    
    try {
        // Get current values from color inputs
        const themeData = {};
        
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            themeData[cssVar] = input.value;
        });

        // Get theme name and description
        const themeName = document.getElementById('theme-name-input').value.trim();
        const themeDescription = document.getElementById('theme-description-input').value.trim();
        
        // Prepare update data
        const updateData = {
            theme_data: themeData
        };
        
        if (themeName) {
            updateData.display_name = themeName;
        }
        if (themeDescription) {
            updateData.description = themeDescription;
        }
        
        // Choose endpoint based on theme type
        let url, method;
        if (currentTheme.is_built_in) {
            url = `/api/themes/built-in/${currentTheme.name}`;
            method = 'PUT';
        } else {
            url = `/api/themes/${currentTheme.id}`;
            method = 'PUT';
        }
        
        // Update the theme
        const response = await fetch(url, {
            method: method,
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to save theme: ${response.status}`);
        }
        
        const updatedTheme = await response.json();
        showSuccess(`Theme "${updatedTheme.display_name || updatedTheme.name}" saved successfully!`);
        
        // Reload themes and reapply the current theme
        await loadThemes();
        
        // Find and reselect the updated theme
        // For built-in themes, prioritize database records over hardcoded definitions
        let refreshedTheme;
        if (currentTheme.is_built_in) {
            // Look for the database record first (it will have an ID)
            refreshedTheme = allThemes.find(t => t.name === currentTheme.name && t.id);
            // Fallback to name-based lookup if no database record found
            if (!refreshedTheme) {
                refreshedTheme = allThemes.find(t => t.name === currentTheme.name);
            }
        } else {
            // For custom themes, use ID-based lookup
            refreshedTheme = allThemes.find(t => t.id === currentTheme.id);
        }
        
        if (refreshedTheme) {
            currentTheme = refreshedTheme;
            loadThemeForCustomization(currentTheme);
        } else {
            console.error('Could not find refreshed theme after save:', currentTheme);
        }
        
    } catch (error) {
        console.error('Failed to save current theme:', error);
        showError('Failed to save current theme: ' + error.message);
    }
}

// Helper functions for notifications
function showSuccess(message) {
    console.log('Success:', message);
    // You can implement toast notifications here if available
}

function showError(message) {
    console.error('Error:', message);
    // You can implement toast notifications here if available
}

// Edit theme function
async function editTheme(themeId) {
    const theme = allThemes.find(t => {
        const themeIdentifier = t.id || t.name;
        return String(themeIdentifier) === String(themeId);
    });
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    // Prevent editing the Default theme, but allow other built-in themes
    if (theme.is_built_in && theme.name.toLowerCase() === 'default') {
        showError('The Default theme cannot be edited');
        return;
    }
    
    // Switch to customize tab and select this theme for editing
    const customizeTab = document.querySelector('[onclick*="customize-themes-tab"]');
    if (customizeTab) {
        customizeTab.click();
        
        // Small delay to let tab switch complete
        setTimeout(() => {
            selectTheme(themeId);
            // Set the current theme as being edited
            window.editingThemeId = themeId;
            // Show the update button and hide save button while editing
            const updateBtn = document.getElementById('update-theme-btn');
            if (updateBtn) {
                updateBtn.style.display = 'inline-block';
            }
        }, 200);
    }
}

// Delete theme function with confirmation
async function deleteTheme(themeId, themeName) {
    const theme = allThemes.find(t => {
        const themeIdentifier = t.id || t.name;
        return String(themeIdentifier) === String(themeId);
    });
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    if (theme.is_built_in) {
        showError('Built-in themes cannot be deleted');
        return;
    }
    
    // Show confirmation dialog
    const message = `Are you sure you want to delete the theme "${themeName}"? This action cannot be undone.`;
    
    if (typeof toastConfirm === 'function') {
        toastConfirm(message, () => {
            proceedDeleteTheme(themeId);
        });
    } else {
        if (confirm(message)) {
            proceedDeleteTheme(themeId);
        }
    }
}

// Actually perform the theme deletion
async function proceedDeleteTheme(themeId) {
    try {
        const response = await fetch(`/api/themes/${themeId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showSuccess(`Theme "${data.theme_name}" deleted successfully`);
            
            // Remove from allThemes array
            const themeIndex = allThemes.findIndex(t => (t.id || t.name) === themeId);
            if (themeIndex !== -1) {
                allThemes.splice(themeIndex, 1);
            }
            
            // Re-render the themes grid
            renderThemesGrid();
            loadCustomizeThemeGrid();
            
            // If this was the currently applied theme, we might need to handle that
            // but the API should handle switching to a default theme
            
        } else {
            showError(data.error || 'Failed to delete theme');
        }
    } catch (error) {
        console.error('Error deleting theme:', error);
        showError('Failed to delete theme: ' + error.message);
    }
}

// Update current theme function (for editing existing themes)
async function updateCurrentTheme() {
    if (!currentTheme || !window.editingThemeId) {
        showError('No theme selected for editing');
        return;
    }
    
    const themeToUpdate = allThemes.find(t => {
        const themeIdentifier = t.id || t.name;
        return String(themeIdentifier) === String(window.editingThemeId);
    });
    if (!themeToUpdate) {
        showError('Theme to update not found');
        return;
    }
    
    // Prevent updating the Default theme
    if (themeToUpdate.is_built_in && themeToUpdate.name.toLowerCase() === 'default') {
        showError('The Default theme cannot be updated');
        return;
    }
    
    try {
        // Get current values from color inputs
        const themeData = {};
        
        const colorInputs = document.querySelectorAll('#color-customization-panel input[type="color"]');
        colorInputs.forEach(input => {
            const cssVar = input.dataset.cssVar;
            themeData[cssVar] = input.value;
        });
        
        // Get theme name and description
        const themeName = document.getElementById('theme-name-input').value.trim();
        const themeDescription = document.getElementById('theme-description-input').value.trim();
        
        // Prepare update data
        const updateData = {
            theme_data: themeData
        };
        
        if (themeName) {
            updateData.display_name = themeName;
        }
        if (themeDescription) {
            updateData.description = themeDescription;
        }
        
        // Choose endpoint based on theme type
        let url, method;
        if (themeToUpdate.is_built_in) {
            url = `/api/themes/built-in/${themeToUpdate.name}`;
            method = 'PUT';
        } else {
            url = `/api/themes/${window.editingThemeId}`;
            method = 'PUT';
        }
        
        // Update existing theme
        const response = await fetch(url, {
            method: method,
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Failed to update theme: ${response.status}`);
        }
        
        const updatedTheme = await response.json();
        showSuccess(`Theme "${updatedTheme.display_name}" updated successfully!`);
        
        // Clear editing state
        window.editingThemeId = null;
        const updateBtn = document.getElementById('update-theme-btn');
        if (updateBtn) {
            updateBtn.style.display = 'none';
        }
        
        // Reload themes to show the updated theme
        loadThemes();
        
    } catch (error) {
        console.error('Failed to update theme:', error);
        showError('Failed to update theme: ' + error.message);
    }
}

// Override the main switchTab function to initialize themes when themes tab is activated
const originalSwitchTab = switchTab;
switchTab = function(event, tabId) {
    originalSwitchTab(event, tabId);
    
    if (tabId === 'themes-tab') {
        // Small delay to ensure tab is fully activated
        setTimeout(initializeThemesTab, 100);
    } else if (tabId === 'blacklist-tab') {
        // Initialize blacklist when tab is activated
        setTimeout(initializeBlacklistTab, 100);
    }
};

// Blacklist Management Functions
let currentBlacklistPage = 1;
let totalBlacklistPages = 1;
let currentBlacklistSearchQuery = '';
let urlToRemove = '';

function initializeBlacklistTab() {
    if (document.getElementById('blacklist-tab').classList.contains('active')) {
        loadBlacklist();
    }
}

function loadBlacklist() {
    showBlacklistLoading();
    
    const params = new URLSearchParams({
        page: currentBlacklistPage,
        per_page: 20
    });
    
    if (currentBlacklistSearchQuery) {
        params.append('search', currentBlacklistSearchQuery);
    }
    
    fetch(`/api/videos/blacklist?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showBlacklistError(data.error);
                return;
            }
            
            displayBlacklist(data.blacklist);
            updateBlacklistPagination(data.pagination);
            updateBlacklistStats(data);
            
            if (data.blacklist.length === 0 && currentBlacklistPage === 1 && !currentBlacklistSearchQuery) {
                showBlacklistEmpty();
            } else {
                showBlacklistTable();
            }
        })
        .catch(error => {
            console.error('Error loading blacklist:', error);
            showBlacklistError('Failed to load blacklist. Please try again.');
        });
}

function loadBlacklistPage(page) {
    if (page < 1 || page > totalBlacklistPages) return;
    currentBlacklistPage = page;
    loadBlacklist();
}

function displayBlacklist(blacklistEntries) {
    const tbody = document.getElementById('blacklistTableBody');
    tbody.innerHTML = '';
    
    blacklistEntries.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <a href="${entry.youtube_url}" target="_blank" class="url-link" title="Open in new tab">
                    ${truncateUrl(entry.youtube_url)}
                    <iconify-icon icon="tabler:external-link" class="external-icon"></iconify-icon>
                </a>
            </td>
            <td>${entry.title || '<span class="text-muted">Not specified</span>'}</td>
            <td>${entry.artist_name || '<span class="text-muted">Not specified</span>'}</td>
            <td>${formatDate(entry.blacklisted_at)}</td>
            <td>${entry.blacklisted_by_username || '<span class="text-muted">Unknown</span>'}</td>
            <td>
                <button onclick="removeFromBlacklist('${escapeHtml(entry.youtube_url)}', '${escapeHtml(entry.title || '')}', '${escapeHtml(entry.artist_name || '')}')" 
                        class="btn btn-danger btn-sm" title="Remove from blacklist">
                    <iconify-icon icon="tabler:trash"></iconify-icon>
                    Remove
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateBlacklistPagination(pagination) {
    totalBlacklistPages = pagination.total_pages;
    currentBlacklistPage = pagination.page;
    
    const paginationInfo = document.getElementById('blacklistPaginationInfo');
    const start = (pagination.page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    paginationInfo.textContent = `Showing ${start}-${end} of ${pagination.total} entries`;
    
    const prevBtn = document.getElementById('blacklistPrevPage');
    const nextBtn = document.getElementById('blacklistNextPage');
    
    prevBtn.disabled = pagination.page <= 1;
    nextBtn.disabled = pagination.page >= pagination.total_pages;
    
    // Generate page numbers
    const pageNumbers = document.getElementById('blacklistPageNumbers');
    pageNumbers.innerHTML = '';
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, pagination.page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(pagination.total_pages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = `btn btn-sm ${i === pagination.page ? 'btn-primary' : 'btn-secondary'}`;
        pageBtn.onclick = () => loadBlacklistPage(i);
        pageNumbers.appendChild(pageBtn);
    }
}

function updateBlacklistStats(data) {
    document.getElementById('totalBlacklistCount').textContent = data.pagination.total;
    
    // Calculate recent additions (this week)
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    
    const recentCount = data.blacklist.filter(entry => {
        const blacklistedDate = new Date(entry.blacklisted_at);
        return blacklistedDate >= oneWeekAgo;
    }).length;
    
    document.getElementById('recentBlacklistCount').textContent = recentCount;
}

// UI State Management
function showBlacklistLoading() {
    document.getElementById('blacklistLoading').style.display = 'block';
    document.getElementById('blacklistError').style.display = 'none';
    document.getElementById('blacklistEmpty').style.display = 'none';
    document.getElementById('blacklistTable').style.display = 'none';
    document.getElementById('blacklistPagination').style.display = 'none';
}

function showBlacklistError(message) {
    document.getElementById('blacklistErrorMessage').textContent = message;
    document.getElementById('blacklistError').style.display = 'block';
    document.getElementById('blacklistLoading').style.display = 'none';
    document.getElementById('blacklistEmpty').style.display = 'none';
    document.getElementById('blacklistTable').style.display = 'none';
    document.getElementById('blacklistPagination').style.display = 'none';
}

function showBlacklistEmpty() {
    document.getElementById('blacklistEmpty').style.display = 'block';
    document.getElementById('blacklistLoading').style.display = 'none';
    document.getElementById('blacklistError').style.display = 'none';
    document.getElementById('blacklistTable').style.display = 'none';
    document.getElementById('blacklistPagination').style.display = 'none';
}

function showBlacklistTable() {
    document.getElementById('blacklistTable').style.display = 'block';
    document.getElementById('blacklistPagination').style.display = 'block';
    document.getElementById('blacklistLoading').style.display = 'none';
    document.getElementById('blacklistError').style.display = 'none';
    document.getElementById('blacklistEmpty').style.display = 'none';
}

// Search functionality
function handleBlacklistSearch(event) {
    const query = event.target.value.trim();
    
    // Debounce search
    clearTimeout(window.blacklistSearchTimeout);
    window.blacklistSearchTimeout = setTimeout(() => {
        currentBlacklistSearchQuery = query;
        currentBlacklistPage = 1;
        loadBlacklist();
    }, 300);
}

function refreshBlacklist() {
    currentBlacklistPage = 1;
    currentBlacklistSearchQuery = '';
    document.getElementById('blacklistSearchInput').value = '';
    loadBlacklist();
}

function exportBlacklist() {
    fetch('/api/videos/blacklist?export=true')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blacklist_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error exporting blacklist:', error);
            showError('Error exporting blacklist');
        });
}

function removeFromBlacklist(url, title, artist) {
    urlToRemove = url;
    
    document.getElementById('removePreviewUrl').textContent = url;
    document.getElementById('removePreviewTitle').textContent = title || 'Not specified';
    document.getElementById('removePreviewArtist').textContent = artist || 'Not specified';
    
    document.getElementById('confirmRemoveModal').style.display = 'block';
}

function confirmRemoveFromBlacklist() {
    if (!urlToRemove) return;
    
    fetch(`/api/videos/blacklist/${encodeURIComponent(urlToRemove)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showError('Error: ' + result.error);
            return;
        }
        
        showSuccess(result.message || 'URL removed from blacklist successfully');
        closeConfirmRemoveModal();
        loadBlacklist();
    })
    .catch(error => {
        console.error('Error removing from blacklist:', error);
        showError('Failed to remove URL from blacklist. Please try again.');
    });
}

// Utility functions
function truncateUrl(url) {
    if (url.length <= 50) return url;
    return url.substring(0, 47) + '...';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal Management
function showAddToBlacklistModal() {
    document.getElementById('addToBlacklistModal').style.display = 'block';
    document.getElementById('blacklistUrl').focus();
}

function closeAddToBlacklistModal() {
    document.getElementById('addToBlacklistModal').style.display = 'none';
    document.getElementById('addToBlacklistForm').reset();
}

function submitAddToBlacklist(event) {
    if (event) event.preventDefault();
    
    const form = document.getElementById('addToBlacklistForm');
    const formData = new FormData(form);
    
    const data = {
        youtube_url: formData.get('youtube_url'),
        title: formData.get('title') || null,
        artist_name: formData.get('artist_name') || null
    };
    
    fetch('/api/videos/blacklist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showError('Error: ' + result.error);
            return;
        }
        
        showSuccess(result.message || 'URL added to blacklist successfully');
        closeAddToBlacklistModal();
        loadBlacklist();
    })
    .catch(error => {
        console.error('Error adding to blacklist:', error);
        showError('Failed to add URL to blacklist. Please try again.');
    });
}

function closeConfirmRemoveModal() {
    document.getElementById('confirmRemoveModal').style.display = 'none';
    urlToRemove = '';
}

// Modal backdrop clicks
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        if (event.target.id === 'addToBlacklistModal') {
            closeAddToBlacklistModal();
        } else if (event.target.id === 'confirmRemoveModal') {
            closeConfirmRemoveModal();
        }
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAddToBlacklistModal();
        closeConfirmRemoveModal();
    }
});

</script>

<style>
/* Blacklist-specific styles */
.blacklist-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.blacklist-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.9em;
}

.search-panel {
    margin: 20px 0;
}

.search-input-container {
    position: relative;
    max-width: 500px;
}

.search-input-container input {
    width: 100%;
    padding: 12px 16px 12px 45px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    font-size: 14px;
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 18px;
}

.blacklist-table-container {
    margin-top: 20px;
}

.blacklist-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.blacklist-table th,
.blacklist-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.blacklist-table th {
    background: var(--header-bg);
    font-weight: 600;
    color: var(--header-text);
}

.blacklist-table tr:hover {
    background: var(--hover-bg);
}

.url-link {
    color: var(--primary-color);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.url-link:hover {
    text-decoration: underline;
}

.external-icon {
    font-size: 14px;
    opacity: 0.7;
}

.text-muted {
    color: var(--text-muted);
    font-style: italic;
}

.text-warning {
    color: var(--warning-color);
}

.blacklist-preview {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
}

.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 20px 0;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-numbers {
    display: flex;
    gap: 5px;
}

.loading-container,
.error-container,
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.error-icon,
.empty-icon {
    font-size: 4em;
    color: var(--text-muted);
    margin-bottom: 20px;
}

.loading-spinner {
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .blacklist-actions {
        flex-direction: column;
    }
    
    .blacklist-table {
        font-size: 14px;
    }
    
    .blacklist-table th,
    .blacklist-table td {
        padding: 10px 8px;
    }
    
    .pagination-container {
        flex-direction: column;
        gap: 15px;
    }
    
    .blacklist-stats {
        grid-template-columns: 1fr;
    }
}

/* Certificate Management Styles */
.certificate-status {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.certificate-status h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-secondary);
}

.status-item:last-child {
    border-bottom: none;
}

.status-label {
    font-weight: 500;
    color: var(--text-primary);
}

.status-value {
    font-weight: bold;
}

.status-value.text-success {
    color: var(--success, #28a745);
}

.status-value.text-warning {
    color: var(--warning, #ffc107);
}

.status-value.text-danger {
    color: var(--danger, #dc3545);
}

.certificate-upload {
    margin-bottom: 1.5rem;
}

.certificate-upload h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.certificate-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
}

.certificate-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: var(--bg-tertiary);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.validation-result {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.validation-result.text-success {
    background-color: rgba(40, 167, 69, 0.1);
    border: 1px solid var(--success, #28a745);
}

.validation-result.text-danger {
    background-color: rgba(220, 53, 69, 0.1);
    border: 1px solid var(--danger, #dc3545);
}

.validation-details p {
    margin: 0.5rem 0;
    color: var(--text-primary);
}

.validation-errors {
    margin-top: 1rem;
    padding: 1rem;
    background-color: rgba(220, 53, 69, 0.05);
    border-radius: 6px;
}

.validation-errors ul {
    margin: 0.5rem 0 0 0;
    padding-left: 1.5rem;
}

.validation-errors li {
    color: var(--danger, #dc3545);
    margin-bottom: 0.25rem;
}

/* File input styling */
input[type="file"] {
    width: 100%;
    padding: 0.5rem;
    border: 2px dashed var(--border-primary);
    border-radius: 8px;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
}

input[type="file"]:hover {
    border-color: var(--primary);
    background: var(--bg-hover);
}

input[type="file"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
}

/* Responsive design */
@media (max-width: 768px) {
    .certificate-actions {
        flex-direction: column;
    }
    
    .certificate-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .status-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
}
</style>

{% endblock %}