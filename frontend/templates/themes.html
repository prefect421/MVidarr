{% extends "base.html" %}

{% block title %}Theme Customizer - MVidarr{% endblock %}

{% block content %}
<div class="themes-container">
    
    <div class="themes-header">
        <h1><iconify-icon icon="tabler:palette"></iconify-icon> Theme Customizer</h1>
        <div class="themes-actions">
            <button onclick="createNewTheme()" class="btn btn-primary">
                <iconify-icon icon="tabler:plus"></iconify-icon> Create New Theme
            </button>
            <button onclick="refreshThemes()" class="btn btn-secondary">
                <iconify-icon icon="tabler:refresh"></iconify-icon> Refresh
            </button>
        </div>
    </div>

    <!-- Theme Management Tabs -->
    <div class="themes-tabs">
        <button class="themes-tab-btn active" onclick="switchThemeTab(event, 'browse-tab')">
            <iconify-icon icon="tabler:grid-3x3" class="tab-icon"></iconify-icon> Browse Themes
        </button>
        <button class="themes-tab-btn" onclick="switchThemeTab(event, 'customize-tab')">
            <iconify-icon icon="tabler:palette" class="tab-icon"></iconify-icon> Customize
        </button>
        <button class="themes-tab-btn" onclick="switchThemeTab(event, 'preview-tab')">
            <iconify-icon icon="tabler:eye" class="tab-icon"></iconify-icon> Preview
        </button>
    </div>

    <!-- Browse Themes Tab -->
    <div id="browse-tab" class="themes-tab-content active">
        <div class="themes-section">
            <h3>Available Themes</h3>
            <div class="themes-grid" id="themes-grid">
                <!-- Themes will be loaded dynamically -->
                <div class="theme-loading">
                    <iconify-icon icon="tabler:loader-2" class="loading-icon"></iconify-icon>
                    Loading themes...
                </div>
            </div>
        </div>
    </div>

    <!-- Customize Theme Tab -->
    <div id="customize-tab" class="themes-tab-content">
        <div class="customize-container">
            
            <!-- Theme Info Panel -->
            <div class="theme-info-panel">
                <h3 id="current-theme-title">Select a theme to customize</h3>
                <div class="theme-metadata" id="theme-metadata">
                    <p>Choose a theme from the Browse tab or create a new one to start customizing.</p>
                </div>
                
                <div class="theme-actions" id="theme-actions" style="display: none;">
                    <button onclick="saveCurrentTheme()" class="btn btn-primary">
                        <iconify-icon icon="tabler:device-floppy"></iconify-icon> Save Theme
                    </button>
                    <button onclick="duplicateCurrentTheme()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:copy"></iconify-icon> Duplicate
                    </button>
                    <button onclick="deleteCurrentTheme()" class="btn btn-danger">
                        <iconify-icon icon="tabler:trash"></iconify-icon> Delete
                    </button>
                </div>
            </div>

            <!-- Color Customization Panel -->
            <div class="color-customization-panel" id="color-panel" style="display: none;">
                <h4>Color Customization</h4>
                
                <!-- Base Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:color-swatch"></iconify-icon> Base Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="bg-primary">Primary Background</label>
                            <input type="color" id="bg-primary" data-css-var="--bg-primary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="bg-primary">
                        </div>
                        <div class="color-control">
                            <label for="bg-secondary">Secondary Background</label>
                            <input type="color" id="bg-secondary" data-css-var="--bg-secondary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="bg-secondary">
                        </div>
                        <div class="color-control">
                            <label for="bg-tertiary">Tertiary Background</label>
                            <input type="color" id="bg-tertiary" data-css-var="--bg-tertiary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="bg-tertiary">
                        </div>
                    </div>
                </div>

                <!-- Text Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:typography"></iconify-icon> Text Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="text-primary">Primary Text</label>
                            <input type="color" id="text-primary" data-css-var="--text-primary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="text-primary">
                        </div>
                        <div class="color-control">
                            <label for="text-secondary">Secondary Text</label>
                            <input type="color" id="text-secondary" data-css-var="--text-secondary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="text-secondary">
                        </div>
                        <div class="color-control">
                            <label for="text-accent">Accent Text</label>
                            <input type="color" id="text-accent" data-css-var="--text-accent" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="text-accent">
                        </div>
                    </div>
                </div>

                <!-- Button Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:click"></iconify-icon> Button Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="btn-primary-bg">Primary Button</label>
                            <input type="color" id="btn-primary-bg" data-css-var="--btn-primary-bg" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="btn-primary-bg">
                        </div>
                        <div class="color-control">
                            <label for="btn-secondary-bg">Secondary Button</label>
                            <input type="color" id="btn-secondary-bg" data-css-var="--btn-secondary-bg" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="btn-secondary-bg">
                        </div>
                        <div class="color-control">
                            <label for="btn-danger-bg">Danger Button</label>
                            <input type="color" id="btn-danger-bg" data-css-var="--btn-danger-bg" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="btn-danger-bg">
                        </div>
                    </div>
                </div>

                <!-- Status Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:info-circle"></iconify-icon> Status Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="success">Success</label>
                            <input type="color" id="success" data-css-var="--success" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="success">
                        </div>
                        <div class="color-control">
                            <label for="warning">Warning</label>
                            <input type="color" id="warning" data-css-var="--warning" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="warning">
                        </div>
                        <div class="color-control">
                            <label for="error">Error</label>
                            <input type="color" id="error" data-css-var="--error" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="error">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Tab -->
    <div id="preview-tab" class="themes-tab-content">
        <div class="preview-container">
            <div class="preview-header">
                <h3>Theme Preview</h3>
                <div class="preview-controls">
                    <button onclick="togglePreviewMode()" class="btn btn-secondary" id="preview-mode-btn">
                        <iconify-icon icon="tabler:sun"></iconify-icon> Switch to Light Mode
                    </button>
                    <button onclick="resetPreview()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:refresh"></iconify-icon> Reset Preview
                    </button>
                </div>
            </div>
            
            <div class="preview-area" id="preview-area">
                <!-- Component Preview Examples -->
                <div class="preview-section">
                    <h4>Navigation</h4>
                    <div class="preview-nav">
                        <div class="nav-item active">Dashboard</div>
                        <div class="nav-item">Artists</div>
                        <div class="nav-item">Videos</div>
                        <div class="nav-item">Settings</div>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Cards & Content</h4>
                    <div class="preview-cards">
                        <div class="preview-card">
                            <h5>Sample Card</h5>
                            <p>This is how cards will look with your theme.</p>
                            <div class="card-meta">Created: 2024-01-01</div>
                        </div>
                        <div class="preview-card">
                            <h5>Another Card</h5>
                            <p>Preview text in secondary color.</p>
                            <div class="card-meta">Updated: 2024-01-02</div>
                        </div>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Buttons & Controls</h4>
                    <div class="preview-buttons">
                        <button class="btn btn-primary">Primary Button</button>
                        <button class="btn btn-secondary">Secondary Button</button>
                        <button class="btn btn-danger">Danger Button</button>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Forms</h4>
                    <div class="preview-form">
                        <div class="form-group">
                            <label>Sample Input</label>
                            <input type="text" placeholder="Enter text here..." class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Sample Select</label>
                            <select class="form-control">
                                <option>Option 1</option>
                                <option>Option 2</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Status Messages</h4>
                    <div class="preview-alerts">
                        <div class="alert alert-success">Success message</div>
                        <div class="alert alert-warning">Warning message</div>
                        <div class="alert alert-error">Error message</div>
                        <div class="alert alert-info">Info message</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Theme Creation Modal -->
<div id="theme-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Create New Theme</h3>
            <button onclick="closeThemeModal()" class="modal-close">
                <iconify-icon icon="tabler:x"></iconify-icon>
            </button>
        </div>
        <div class="modal-body">
            <form id="theme-form">
                <div class="form-group">
                    <label for="theme-name">Theme Name</label>
                    <input type="text" id="theme-name" class="form-control" required>
                    <small>Internal name (lowercase, no spaces)</small>
                </div>
                <div class="form-group">
                    <label for="theme-display-name">Display Name</label>
                    <input type="text" id="theme-display-name" class="form-control" required>
                    <small>Name shown to users</small>
                </div>
                <div class="form-group">
                    <label for="theme-description">Description</label>
                    <textarea id="theme-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="base-theme">Base Theme</label>
                    <select id="base-theme" class="form-control">
                        <option value="default">Default</option>
                        <option value="cyber">Cyber</option>
                        <option value="vaporwave">VaporWave</option>
                        <option value="lcars_tng">LCARS - TNG</option>
                    </select>
                    <small>Starting point for your custom theme</small>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="theme-public"> Make theme public
                    </label>
                    <small>Allow other users to use this theme</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeThemeModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveThemeModal()" class="btn btn-primary">Create Theme</button>
        </div>
    </div>
</div>

<style>
/* Theme Customizer Styles */
.themes-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.themes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-primary);
}

.themes-header h1 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
}

.themes-actions {
    display: flex;
    gap: 10px;
}

/* Tabs */
.themes-tabs {
    display: flex;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border-primary);
}

.themes-tab-btn {
    background: none;
    border: none;
    padding: 15px 20px;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.themes-tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.themes-tab-btn.active {
    color: var(--text-accent);
    border-bottom-color: var(--text-accent);
}

.themes-tab-content {
    display: none;
}

.themes-tab-content.active {
    display: block;
}

/* Themes Grid */
.themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.theme-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.theme-card:hover {
    border-color: var(--border-focus);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.theme-card.active {
    border-color: var(--text-accent);
    background: var(--bg-hover);
}

.theme-preview {
    height: 60px;
    border-radius: 4px;
    margin-bottom: 15px;
    display: flex;
    overflow: hidden;
}

.theme-color {
    flex: 1;
    height: 100%;
}

.theme-info h4 {
    margin: 0 0 5px 0;
    color: var(--text-primary);
}

.theme-info p {
    margin: 0 0 10px 0;
    color: var(--text-secondary);
    font-size: 0.9em;
}

.theme-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8em;
    color: var(--text-muted);
}

.theme-badge {
    background: var(--text-accent);
    color: var(--bg-primary);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
}

/* Customize Panel */
.customize-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 30px;
    height: 70vh;
}

.theme-info-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
}

.theme-info-panel h3 {
    margin-top: 0;
    color: var(--text-primary);
}

.theme-metadata {
    margin: 20px 0;
    color: var(--text-secondary);
}

.theme-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.color-customization-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
    overflow-y: auto;
}

.color-section {
    margin-bottom: 30px;
}

.color-section h5 {
    margin-bottom: 15px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.color-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.color-control {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.color-control label {
    font-size: 0.9em;
    color: var(--text-secondary);
}

.color-control input[type="color"] {
    width: 100%;
    height: 40px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    cursor: pointer;
}

.color-hex {
    padding: 5px 8px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    color: var(--input-text);
    font-family: monospace;
    font-size: 0.8em;
}

/* Preview Styles */
.preview-container {
    max-width: 1000px;
    margin: 0 auto;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.preview-controls {
    display: flex;
    gap: 10px;
}

.preview-area {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 30px;
}

.preview-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-primary);
}

.preview-section:last-child {
    border-bottom: none;
}

.preview-section h4 {
    color: var(--text-primary);
    margin-bottom: 15px;
}

.preview-nav {
    display: flex;
    gap: 2px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 4px;
}

.nav-item {
    padding: 10px 20px;
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-item.active,
.nav-item:hover {
    background: var(--btn-primary-bg);
    color: var(--btn-primary-text);
}

.preview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.preview-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    padding: 15px;
}

.preview-card h5 {
    margin: 0 0 10px 0;
    color: var(--text-primary);
}

.preview-card p {
    margin: 0 0 10px 0;
    color: var(--text-secondary);
}

.card-meta {
    font-size: 0.8em;
    color: var(--text-muted);
}

.preview-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.preview-form {
    max-width: 400px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-secondary);
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    color: var(--input-text);
}

.preview-alerts {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.alert {
    padding: 10px 15px;
    border-radius: 4px;
    border-left: 4px solid;
}

.alert-success {
    background: color-mix(in srgb, var(--success) 20%, transparent);
    border-color: var(--success);
    color: var(--success);
}

.alert-warning {
    background: color-mix(in srgb, var(--warning) 20%, transparent);
    border-color: var(--warning);
    color: var(--warning);
}

.alert-error {
    background: color-mix(in srgb, var(--error) 20%, transparent);
    border-color: var(--error);
    color: var(--error);
}

.alert-info {
    background: color-mix(in srgb, var(--info) 20%, transparent);
    border-color: var(--info);
    color: var(--info);
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-primary);
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2em;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding: 20px;
    border-top: 1px solid var(--border-primary);
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.theme-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
    gap: 10px;
}

.loading-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 1200px) {
    .customize-container {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .color-customization-panel {
        max-height: 60vh;
    }
}

@media (max-width: 768px) {
    .themes-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .themes-tabs {
        flex-wrap: wrap;
    }
    
    .themes-tab-btn {
        padding: 10px 15px;
        font-size: 0.9em;
    }
    
    .color-controls {
        grid-template-columns: 1fr;
    }
    
    .preview-buttons {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
// Global variables
let allThemes = [];
let currentTheme = null;
let previewMode = 'dark';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadThemes();
    setupColorInputSynchronization();
});

// Theme tab switching
function switchThemeTab(event, tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.themes-tab-content');
    tabContents.forEach(tab => tab.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const tabBtns = document.querySelectorAll('.themes-tab-btn');
    tabBtns.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab and mark button as active
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// Load all themes from API
async function loadThemes() {
    try {
        const response = await fetch('/api/themes');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        allThemes = data.themes;
        renderThemesGrid();
        
    } catch (error) {
        console.error('Failed to load themes:', error);
        showError('Failed to load themes');
    }
}

// Render themes in the grid
function renderThemesGrid() {
    const grid = document.getElementById('themes-grid');
    
    if (allThemes.length === 0) {
        grid.innerHTML = '<div class="theme-loading">No themes found.</div>';
        return;
    }
    
    grid.innerHTML = allThemes.map(theme => `
        <div class="theme-card" onclick="selectTheme('${theme.id || theme.name}')" data-theme-id="${theme.id || theme.name}">
            <div class="theme-preview">
                ${generateThemePreview(theme)}
            </div>
            <div class="theme-info">
                <h4>${theme.display_name}</h4>
                <p>${theme.description || 'No description available'}</p>
                <div class="theme-meta">
                    ${theme.is_built_in ? '<span class="theme-badge">Built-in</span>' : ''}
                    ${theme.is_public ? '<span class="theme-badge">Public</span>' : ''}
                    ${theme.creator_username ? `<span>by ${theme.creator_username}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

// Generate theme preview colors
function generateThemePreview(theme) {
    if (theme.theme_data) {
        // Custom theme with data
        const colors = [
            theme.theme_data['--bg-primary'] || '#1a1a1a',
            theme.theme_data['--bg-secondary'] || '#2d2d2d',
            theme.theme_data['--text-accent'] || '#4a9eff',
            theme.theme_data['--btn-primary-bg'] || '#4a9eff',
            theme.theme_data['--success'] || '#28a745'
        ];
        return colors.map(color => `<div class="theme-color" style="background: ${color}"></div>`).join('');
    } else {
        // Built-in theme - use predefined colors
        const builtInColors = {
            'default': ['#1a1a1a', '#2d2d2d', '#4a9eff', '#28a745', '#dc3545'],
            'cyber': ['#0a0a0a', '#1a1a2e', '#00ff00', '#ff00ff', '#00ffff'],
            'vaporwave': ['#1a0d2e', '#2d1b4e', '#ff006e', '#8338ec', '#3a86ff'],
            'lcars_tng': ['#000000', '#cc6600', '#ff9900', '#9999ff', '#ff6600'],
            'lcars_ds9': ['#000000', '#0066cc', '#6699ff', '#ff0066', '#00cc99'],
            'lcars_voy': ['#000000', '#666666', '#9999cc', '#cc9966', '#cc6699'],
            'lcars_tng_e': ['#000000', '#003366', '#0066cc', '#ffcc00', '#ff6600']
        };
        
        const colors = builtInColors[theme.name] || builtInColors['default'];
        return colors.map(color => `<div class="theme-color" style="background: ${color}"></div>`).join('');
    }
}

// Select a theme
function selectTheme(themeId) {
    // Remove active class from all cards
    document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Find the theme
    currentTheme = allThemes.find(theme => (theme.id || theme.name) === themeId);
    
    if (currentTheme) {
        loadThemeForCustomization(currentTheme);
        // Switch to customize tab
        switchThemeTab({target: document.querySelector('[onclick*="customize-tab"]')}, 'customize-tab');
    }
}

// Load theme for customization
function loadThemeForCustomization(theme) {
    document.getElementById('current-theme-title').textContent = theme.display_name;
    
    const metadata = document.getElementById('theme-metadata');
    metadata.innerHTML = `
        <p><strong>Name:</strong> ${theme.name}</p>
        <p><strong>Description:</strong> ${theme.description || 'No description'}</p>
        <p><strong>Type:</strong> ${theme.is_built_in ? 'Built-in' : 'Custom'}</p>
        ${theme.creator_username ? `<p><strong>Creator:</strong> ${theme.creator_username}</p>` : ''}
    `;
    
    // Show/hide action buttons based on theme type
    const actions = document.getElementById('theme-actions');
    const colorPanel = document.getElementById('color-panel');
    
    if (theme.is_built_in) {
        actions.style.display = 'none';
        colorPanel.style.display = 'none';
        metadata.innerHTML += '<p><em>Built-in themes cannot be edited directly. Use "Duplicate" to create a customizable copy.</em></p>';
    } else {
        actions.style.display = 'block';
        colorPanel.style.display = 'block';
        
        if (theme.theme_data) {
            loadThemeVariables(theme.theme_data);
        }
    }
}

// Load theme variables into color controls
function loadThemeVariables(themeData) {
    Object.entries(themeData).forEach(([cssVar, value]) => {
        const control = document.querySelector(`[data-css-var="${cssVar}"]`);
        if (control) {
            control.value = value;
            // Update corresponding hex input
            const hexInput = document.querySelector(`.color-hex[data-for="${control.id}"]`);
            if (hexInput) {
                hexInput.value = value;
            }
        }
    });
}

// Update theme variable and apply to preview
function updateThemeVariable(input) {
    const cssVar = input.dataset.cssVar;
    const value = input.value;
    
    // Update hex input
    const hexInput = document.querySelector(`.color-hex[data-for="${input.id}"]`);
    if (hexInput) {
        hexInput.value = value;
    }
    
    // Apply to current theme data
    if (currentTheme && currentTheme.theme_data) {
        currentTheme.theme_data[cssVar] = value;
    }
    
    // Apply to preview
    document.documentElement.style.setProperty(cssVar, value);
}

// Setup color input synchronization
function setupColorInputSynchronization() {
    // Sync hex inputs with color inputs
    document.querySelectorAll('.color-hex').forEach(hexInput => {
        hexInput.addEventListener('input', function() {
            const colorInput = document.getElementById(this.dataset.for);
            if (colorInput && /^#[0-9A-F]{6}$/i.test(this.value)) {
                colorInput.value = this.value;
                updateThemeVariable(colorInput);
            }
        });
    });
}

// Create new theme
function createNewTheme() {
    document.getElementById('modal-title').textContent = 'Create New Theme';
    document.getElementById('theme-form').reset();
    document.getElementById('theme-modal').style.display = 'flex';
}

// Close theme modal
function closeThemeModal() {
    document.getElementById('theme-modal').style.display = 'none';
}

// Save theme from modal
async function saveThemeModal() {
    const name = document.getElementById('theme-name').value;
    const displayName = document.getElementById('theme-display-name').value;
    const description = document.getElementById('theme-description').value;
    const baseTheme = document.getElementById('base-theme').value;
    const isPublic = document.getElementById('theme-public').checked;
    
    if (!name || !displayName) {
        showError('Name and display name are required');
        return;
    }
    
    try {
        // Get base theme data
        let themeData = {};
        if (baseTheme !== 'default') {
            const extractResponse = await fetch(`/api/themes/built-in/${baseTheme}/extract`, {
                method: 'POST'
            });
            if (extractResponse.ok) {
                const extractData = await extractResponse.json();
                themeData = extractData.variables;
            }
        } else {
            // Default theme variables
            themeData = {
                '--bg-primary': '#1a1a1a',
                '--bg-secondary': '#2d2d2d',
                '--bg-tertiary': '#3a3a3a',
                '--text-primary': '#ffffff',
                '--text-secondary': '#cccccc',
                '--text-accent': '#4a9eff',
                '--btn-primary-bg': '#4a9eff',
                '--btn-primary-text': '#ffffff',
                '--btn-secondary-bg': '#666666',
                '--btn-danger-bg': '#dc3545',
                '--success': '#28a745',
                '--warning': '#ffc107',
                '--error': '#dc3545',
                '--info': '#17a2b8'
            };
        }
        
        const response = await fetch('/api/themes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                display_name: displayName,
                description: description,
                is_public: isPublic,
                theme_data: themeData
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to create theme');
        }
        
        const newTheme = await response.json();
        showSuccess('Theme created successfully');
        closeThemeModal();
        loadThemes();
        
        // Select the new theme
        setTimeout(() => selectTheme(newTheme.id), 500);
        
    } catch (error) {
        console.error('Failed to create theme:', error);
        showError('Failed to create theme: ' + error.message);
    }
}

// Save current theme
async function saveCurrentTheme() {
    if (!currentTheme || currentTheme.is_built_in) {
        showError('Cannot save built-in themes');
        return;
    }
    
    try {
        const response = await fetch(`/api/themes/${currentTheme.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                theme_data: currentTheme.theme_data
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save theme');
        }
        
        showSuccess('Theme saved successfully');
        loadThemes();
        
    } catch (error) {
        console.error('Failed to save theme:', error);
        showError('Failed to save theme: ' + error.message);
    }
}

// Duplicate current theme
async function duplicateCurrentTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    try {
        const endpoint = currentTheme.is_built_in 
            ? `/api/themes/built-in/${currentTheme.name}/extract`
            : `/api/themes/${currentTheme.id}/duplicate`;
            
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to duplicate theme');
        }
        
        showSuccess('Theme duplicated successfully');
        loadThemes();
        
    } catch (error) {
        console.error('Failed to duplicate theme:', error);
        showError('Failed to duplicate theme: ' + error.message);
    }
}

// Delete current theme
async function deleteCurrentTheme() {
    if (!currentTheme || currentTheme.is_built_in) {
        showError('Cannot delete built-in themes');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the theme "${currentTheme.display_name}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/themes/${currentTheme.id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to delete theme');
        }
        
        showSuccess('Theme deleted successfully');
        currentTheme = null;
        document.getElementById('current-theme-title').textContent = 'Select a theme to customize';
        document.getElementById('theme-metadata').innerHTML = 'Choose a theme from the Browse tab or create a new one to start customizing.';
        document.getElementById('theme-actions').style.display = 'none';
        document.getElementById('color-panel').style.display = 'none';
        
        loadThemes();
        
    } catch (error) {
        console.error('Failed to delete theme:', error);
        showError('Failed to delete theme: ' + error.message);
    }
}

// Toggle preview mode (light/dark)
function togglePreviewMode() {
    previewMode = previewMode === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-mode', previewMode);
    
    const btn = document.getElementById('preview-mode-btn');
    if (previewMode === 'light') {
        btn.innerHTML = '<iconify-icon icon="tabler:moon"></iconify-icon> Switch to Dark Mode';
    } else {
        btn.innerHTML = '<iconify-icon icon="tabler:sun"></iconify-icon> Switch to Light Mode';
    }
}

// Reset preview
function resetPreview() {
    document.documentElement.removeAttribute('style');
    previewMode = 'dark';
    document.documentElement.setAttribute('data-mode', 'dark');
    document.getElementById('preview-mode-btn').innerHTML = '<iconify-icon icon="tabler:sun"></iconify-icon> Switch to Light Mode';
}

// Refresh themes
function refreshThemes() {
    loadThemes();
}

// Utility functions
function showSuccess(message) {
    // You could implement a toast notification system here
    alert('Success: ' + message);
}

function showError(message) {
    // You could implement a toast notification system here
    alert('Error: ' + message);
}
</script>

{% endblock %}