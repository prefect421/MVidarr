{% extends "base.html" %}

{% block title %}Theme Customizer - MVidarr{% endblock %}

{% block content %}
<div class="themes-container">
    
    <div class="themes-header">
        <h1><iconify-icon icon="tabler:palette"></iconify-icon> Theme Customizer</h1>
        <div class="themes-actions">
            <button onclick="createNewTheme()" class="btn btn-primary">
                <iconify-icon icon="tabler:plus"></iconify-icon> Create New Theme
            </button>
            <button onclick="exportAllThemes()" class="btn btn-secondary">
                <iconify-icon icon="tabler:download"></iconify-icon> Export All
            </button>
            <button onclick="showImportDialog()" class="btn btn-secondary">
                <iconify-icon icon="tabler:upload"></iconify-icon> Import
            </button>
            <button onclick="refreshThemes()" class="btn btn-secondary">
                <iconify-icon icon="tabler:refresh"></iconify-icon> Refresh
            </button>
        </div>
    </div>

    <!-- Theme Management Tabs -->
    <div class="themes-tabs">
        <button class="themes-tab-btn active" onclick="switchThemeTab(event, 'browse-tab')">
            <iconify-icon icon="tabler:grid-3x3" class="tab-icon"></iconify-icon> Browse Themes
        </button>
        <button class="themes-tab-btn" onclick="switchThemeTab(event, 'customize-tab')">
            <iconify-icon icon="tabler:palette" class="tab-icon"></iconify-icon> Customize
        </button>
        <button class="themes-tab-btn" onclick="switchThemeTab(event, 'preview-tab')">
            <iconify-icon icon="tabler:eye" class="tab-icon"></iconify-icon> Preview
        </button>
    </div>

    <!-- Browse Themes Tab -->
    <div id="browse-tab" class="themes-tab-content active">
        <div class="themes-section">
            <h3>Available Themes</h3>
            <div class="themes-grid" id="themes-grid">
                <!-- Themes will be loaded dynamically -->
                <div class="theme-loading">
                    <iconify-icon icon="tabler:loader-2" class="loading-icon"></iconify-icon>
                    Loading themes...
                </div>
            </div>
        </div>
    </div>

    <!-- Customize Theme Tab -->
    <div id="customize-tab" class="themes-tab-content">
        <div class="customize-container">
            
            <!-- Theme Info Panel -->
            <div class="theme-info-panel">
                <h3 id="current-theme-title">Select a theme to customize</h3>
                <div class="theme-metadata" id="theme-metadata">
                    <p>Choose a theme from the Browse tab or create a new one to start customizing.</p>
                </div>
                
                <div class="theme-actions" id="theme-actions" style="display: none;">
                    <button onclick="applyCurrentTheme()" class="btn btn-success">
                        <iconify-icon icon="tabler:check"></iconify-icon> Apply Theme
                    </button>
                    <button onclick="saveCurrentTheme()" class="btn btn-primary">
                        <iconify-icon icon="tabler:device-floppy"></iconify-icon> Save Theme
                    </button>
                    <button onclick="exportCurrentTheme()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:download"></iconify-icon> Export
                    </button>
                    <button onclick="duplicateCurrentTheme()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:copy"></iconify-icon> Duplicate
                    </button>
                    <button onclick="deleteCurrentTheme()" class="btn btn-danger">
                        <iconify-icon icon="tabler:trash"></iconify-icon> Delete
                    </button>
                </div>
            </div>

            <!-- Color Customization Panel -->
            <div class="color-customization-panel" id="color-panel" style="display: none;">
                <h4>Color Customization</h4>
                
                <!-- Base Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:color-swatch"></iconify-icon> Base Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="bg-primary">Primary Background</label>
                            <input type="color" id="bg-primary" data-css-var="--bg-primary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="bg-primary">
                        </div>
                        <div class="color-control">
                            <label for="bg-secondary">Secondary Background</label>
                            <input type="color" id="bg-secondary" data-css-var="--bg-secondary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="bg-secondary">
                        </div>
                        <div class="color-control">
                            <label for="bg-tertiary">Tertiary Background</label>
                            <input type="color" id="bg-tertiary" data-css-var="--bg-tertiary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="bg-tertiary">
                        </div>
                    </div>
                </div>

                <!-- Text Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:typography"></iconify-icon> Text Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="text-primary">Primary Text</label>
                            <input type="color" id="text-primary" data-css-var="--text-primary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="text-primary">
                        </div>
                        <div class="color-control">
                            <label for="text-secondary">Secondary Text</label>
                            <input type="color" id="text-secondary" data-css-var="--text-secondary" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="text-secondary">
                        </div>
                        <div class="color-control">
                            <label for="text-accent">Accent Text</label>
                            <input type="color" id="text-accent" data-css-var="--text-accent" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="text-accent">
                        </div>
                    </div>
                </div>

                <!-- Button Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:click"></iconify-icon> Button Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="btn-primary-bg">Primary Button</label>
                            <input type="color" id="btn-primary-bg" data-css-var="--btn-primary-bg" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="btn-primary-bg">
                        </div>
                        <div class="color-control">
                            <label for="btn-secondary-bg">Secondary Button</label>
                            <input type="color" id="btn-secondary-bg" data-css-var="--btn-secondary-bg" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="btn-secondary-bg">
                        </div>
                        <div class="color-control">
                            <label for="btn-danger-bg">Danger Button</label>
                            <input type="color" id="btn-danger-bg" data-css-var="--btn-danger-bg" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="btn-danger-bg">
                        </div>
                    </div>
                </div>

                <!-- Status Colors -->
                <div class="color-section">
                    <h5><iconify-icon icon="tabler:info-circle"></iconify-icon> Status Colors</h5>
                    <div class="color-controls">
                        <div class="color-control">
                            <label for="success">Success</label>
                            <input type="color" id="success" data-css-var="--success" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="success">
                        </div>
                        <div class="color-control">
                            <label for="warning">Warning</label>
                            <input type="color" id="warning" data-css-var="--warning" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="warning">
                        </div>
                        <div class="color-control">
                            <label for="error">Error</label>
                            <input type="color" id="error" data-css-var="--error" onchange="updateThemeVariable(this)">
                            <input type="text" class="color-hex" data-for="error">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Tab -->
    <div id="preview-tab" class="themes-tab-content">
        <div class="preview-container">
            <div class="preview-header">
                <h3>Theme Preview</h3>
                <div class="preview-controls">
                    <button onclick="togglePreviewMode()" class="btn btn-secondary" id="preview-mode-btn">
                        <iconify-icon icon="tabler:sun"></iconify-icon> Switch to Light Mode
                    </button>
                    <button onclick="resetPreview()" class="btn btn-secondary">
                        <iconify-icon icon="tabler:refresh"></iconify-icon> Reset Preview
                    </button>
                </div>
            </div>
            
            <div class="preview-area" id="preview-area">
                <!-- Component Preview Examples -->
                <div class="preview-section">
                    <h4>Navigation</h4>
                    <div class="preview-nav">
                        <div class="nav-item active">Dashboard</div>
                        <div class="nav-item">Artists</div>
                        <div class="nav-item">Videos</div>
                        <div class="nav-item">Settings</div>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Cards & Content</h4>
                    <div class="preview-cards">
                        <div class="preview-card">
                            <h5>Sample Card</h5>
                            <p>This is how cards will look with your theme.</p>
                            <div class="card-meta">Created: 2024-01-01</div>
                        </div>
                        <div class="preview-card">
                            <h5>Another Card</h5>
                            <p>Preview text in secondary color.</p>
                            <div class="card-meta">Updated: 2024-01-02</div>
                        </div>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Buttons & Controls</h4>
                    <div class="preview-buttons">
                        <button class="btn btn-primary">Primary Button</button>
                        <button class="btn btn-secondary">Secondary Button</button>
                        <button class="btn btn-danger">Danger Button</button>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Forms</h4>
                    <div class="preview-form">
                        <div class="form-group">
                            <label>Sample Input</label>
                            <input type="text" placeholder="Enter text here..." class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Sample Select</label>
                            <select class="form-control">
                                <option>Option 1</option>
                                <option>Option 2</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Status Messages</h4>
                    <div class="preview-alerts">
                        <div class="alert alert-success">Success message</div>
                        <div class="alert alert-warning">Warning message</div>
                        <div class="alert alert-error">Error message</div>
                        <div class="alert alert-info">Info message</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Theme Creation Modal -->
<div id="theme-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Create New Theme</h3>
            <button onclick="closeThemeModal()" class="modal-close">
                <iconify-icon icon="tabler:x"></iconify-icon>
            </button>
        </div>
        <div class="modal-body">
            <form id="theme-form">
                <div class="form-group">
                    <label for="theme-name">Theme Name</label>
                    <input type="text" id="theme-name" class="form-control" required>
                    <small>Internal name (lowercase, no spaces)</small>
                </div>
                <div class="form-group">
                    <label for="theme-display-name">Display Name</label>
                    <input type="text" id="theme-display-name" class="form-control" required>
                    <small>Name shown to users</small>
                </div>
                <div class="form-group">
                    <label for="theme-description">Description</label>
                    <textarea id="theme-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="base-theme">Base Theme</label>
                    <select id="base-theme" class="form-control">
                        <option value="default">Default</option>
                        <option value="cyber">Cyber</option>
                        <option value="vaporwave">VaporWave</option>
                    </select>
                    <small>Starting point for your custom theme</small>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="theme-public"> Make theme public
                    </label>
                    <small>Allow other users to use this theme</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeThemeModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="saveThemeModal()" class="btn btn-primary">Create Theme</button>
        </div>
    </div>
</div>

<!-- Theme Import Modal -->
<div id="import-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Import Themes</h3>
            <button onclick="closeImportModal()" class="modal-close">
                <iconify-icon icon="tabler:x"></iconify-icon>
            </button>
        </div>
        <div class="modal-body">
            <div id="import-step-1" class="import-step">
                <h4><iconify-icon icon="tabler:upload"></iconify-icon> Select Theme File</h4>
                <p>Choose a MVidarr theme export file (.json) to import.</p>
                
                <div class="file-upload-area" id="file-upload-area">
                    <input type="file" id="theme-file-input" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
                    <div class="file-upload-content" onclick="document.getElementById('theme-file-input').click()">
                        <iconify-icon icon="tabler:cloud-upload" style="font-size: 3em; color: var(--text-secondary);"></iconify-icon>
                        <p>Click to select a theme file or drag and drop here</p>
                        <small>Accepts .json files only</small>
                    </div>
                </div>
                
                <div id="file-info" style="display: none; margin-top: 15px;">
                    <h5>Selected File:</h5>
                    <p id="file-name"></p>
                    <p id="file-size"></p>
                </div>
            </div>
            
            <div id="import-step-2" class="import-step" style="display: none;">
                <h4><iconify-icon icon="tabler:file-check"></iconify-icon> Validation Results</h4>
                <div id="validation-results"></div>
            </div>
            
            <div id="import-step-3" class="import-step" style="display: none;">
                <h4><iconify-icon icon="tabler:check-circle"></iconify-icon> Import Complete</h4>
                <div id="import-results"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeImportModal()" class="btn btn-secondary">Cancel</button>
            <button id="validate-btn" onclick="validateImportFile()" class="btn btn-primary" style="display: none;">
                <iconify-icon icon="tabler:file-check"></iconify-icon> Validate
            </button>
            <button id="import-btn" onclick="importThemes()" class="btn btn-success" style="display: none;">
                <iconify-icon icon="tabler:upload"></iconify-icon> Import
            </button>
            <button id="finish-btn" onclick="finishImport()" class="btn btn-primary" style="display: none;">
                <iconify-icon icon="tabler:check"></iconify-icon> Finish
            </button>
        </div>
    </div>
</div>

<style>
/* Theme Customizer Styles */
.themes-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.themes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-primary);
}

.themes-header h1 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-primary);
}

.themes-actions {
    display: flex;
    gap: 10px;
}

/* Tabs */
.themes-tabs {
    display: flex;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border-primary);
}

.themes-tab-btn {
    background: none;
    border: none;
    padding: 15px 20px;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.themes-tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.themes-tab-btn.active {
    color: var(--text-accent);
    border-bottom-color: var(--text-accent);
}

.themes-tab-content {
    display: none;
}

.themes-tab-content.active {
    display: block;
}

/* Themes Grid */
.themes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.theme-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.theme-card:hover {
    border-color: var(--border-focus);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.theme-card.active {
    border-color: var(--text-accent);
    background: var(--bg-hover);
}

.theme-card.applied {
    border-color: var(--success);
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
}

.theme-card.applied::after {
    content: 'âœ“ Applied';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--success);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.theme-preview {
    height: 60px;
    border-radius: 4px;
    margin-bottom: 15px;
    display: flex;
    overflow: hidden;
}

.theme-color {
    flex: 1;
    height: 100%;
}

.theme-info h4 {
    margin: 0 0 5px 0;
    color: var(--text-primary);
}

.theme-info p {
    margin: 0 0 10px 0;
    color: var(--text-secondary);
    font-size: 0.9em;
}

.theme-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8em;
    color: var(--text-muted);
}

.theme-badge {
    background: var(--text-accent);
    color: var(--bg-primary);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.btn-success {
    background: var(--success, #28a745);
    color: white;
}

.btn-success:hover {
    background: #218838;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--btn-secondary-bg, #6c757d);
    color: var(--btn-secondary-text, white);
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

/* Customize Panel */
.customize-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 30px;
    height: 70vh;
}

.theme-info-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
}

.theme-info-panel h3 {
    margin-top: 0;
    color: var(--text-primary);
}

.theme-metadata {
    margin: 20px 0;
    color: var(--text-secondary);
}

.theme-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.color-customization-panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 20px;
    overflow-y: auto;
}

.color-section {
    margin-bottom: 30px;
}

.color-section h5 {
    margin-bottom: 15px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.color-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.color-control {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.color-control label {
    font-size: 0.9em;
    color: var(--text-secondary);
}

.color-control input[type="color"] {
    width: 100%;
    height: 40px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    cursor: pointer;
}

.color-hex {
    padding: 5px 8px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    color: var(--input-text);
    font-family: monospace;
    font-size: 0.8em;
}

/* Preview Styles */
.preview-container {
    max-width: 1000px;
    margin: 0 auto;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.preview-controls {
    display: flex;
    gap: 10px;
}

.preview-area {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 30px;
}

.preview-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-primary);
}

.preview-section:last-child {
    border-bottom: none;
}

.preview-section h4 {
    color: var(--text-primary);
    margin-bottom: 15px;
}

.preview-nav {
    display: flex;
    gap: 2px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 4px;
}

.nav-item {
    padding: 10px 20px;
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-item.active,
.nav-item:hover {
    background: var(--btn-primary-bg);
    color: var(--btn-primary-text);
}

.preview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.preview-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    padding: 15px;
}

.preview-card h5 {
    margin: 0 0 10px 0;
    color: var(--text-primary);
}

.preview-card p {
    margin: 0 0 10px 0;
    color: var(--text-secondary);
}

.card-meta {
    font-size: 0.8em;
    color: var(--text-muted);
}

.preview-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.preview-form {
    max-width: 400px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-secondary);
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    color: var(--input-text);
}

.preview-alerts {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.alert {
    padding: 10px 15px;
    border-radius: 4px;
    border-left: 4px solid;
}

.alert-success {
    background: color-mix(in srgb, var(--success) 20%, transparent);
    border-color: var(--success);
    color: var(--success);
}

.alert-warning {
    background: color-mix(in srgb, var(--warning) 20%, transparent);
    border-color: var(--warning);
    color: var(--warning);
}

.alert-error {
    background: color-mix(in srgb, var(--error) 20%, transparent);
    border-color: var(--error);
    color: var(--error);
}

.alert-info {
    background: color-mix(in srgb, var(--info) 20%, transparent);
    border-color: var(--info);
    color: var(--info);
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-primary);
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2em;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding: 20px;
    border-top: 1px solid var(--border-primary);
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.theme-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
    gap: 10px;
}

.loading-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 1200px) {
    .customize-container {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .color-customization-panel {
        max-height: 60vh;
    }
}

@media (max-width: 768px) {
    .themes-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .themes-tabs {
        flex-wrap: wrap;
    }
    
    .themes-tab-btn {
        padding: 10px 15px;
        font-size: 0.9em;
    }
    
    .color-controls {
        grid-template-columns: 1fr;
    }
    
    .preview-buttons {
        flex-direction: column;
        align-items: flex-start;
    }
}

/* Import Modal Styles */
.file-upload-area {
    border: 2px dashed var(--border-primary);
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background: var(--bg-secondary);
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--text-accent);
    background: var(--bg-tertiary);
}

.file-upload-area.dragover {
    border-color: var(--text-accent);
    background: var(--bg-tertiary);
    transform: scale(1.02);
}

.file-upload-content p {
    margin: 10px 0 5px 0;
    color: var(--text-primary);
    font-weight: 500;
}

.file-upload-content small {
    color: var(--text-secondary);
}

.import-step {
    margin-bottom: 20px;
}

.import-step h4 {
    color: var(--text-primary);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#file-info {
    background: var(--bg-tertiary);
    padding: 15px;
    border-radius: 6px;
    border: 1px solid var(--border-primary);
}

#file-info h5 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
}

#file-info p {
    margin: 4px 0;
    color: var(--text-secondary);
}

.validation-item {
    background: var(--bg-tertiary);
    padding: 12px;
    margin: 8px 0;
    border-radius: 6px;
    border-left: 4px solid var(--border-primary);
}

.validation-item.success {
    border-left-color: var(--success);
}

.validation-item.warning {
    border-left-color: var(--warning);
}

.validation-item.error {
    border-left-color: var(--error);
}

.validation-summary {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.import-results {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
}

.import-results .success {
    color: var(--success);
}

.import-results .warning {
    color: var(--warning);
}

.import-results .error {
    color: var(--error);
}
</style>

<script>
// Global variables
let allThemes = [];
let currentTheme = null;
let previewMode = 'dark';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadThemes();
    setupColorInputSynchronization();
    loadCurrentlyAppliedTheme();
});

// Load currently applied theme and mark it as applied
async function loadCurrentlyAppliedTheme() {
    try {
        const response = await fetch('/api/settings/ui_theme');
        if (response.ok) {
            const data = await response.json();
            if (data && data.value) {
                const appliedThemeId = data.value;
                // Wait for themes to load, then mark the applied theme
                setTimeout(() => {
                    const appliedCard = document.querySelector(`[data-theme-id="${appliedThemeId}"]`);
                    if (appliedCard) {
                        appliedCard.classList.add('applied');
                    }
                }, 1000);
            }
        }
    } catch (error) {
        console.log('Could not load currently applied theme');
    }
}

// Helper function for API calls with authentication
async function apiCall(url, options = {}) {
    const defaultOptions = {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        }
    };
    
    const response = await fetch(url, { ...defaultOptions, ...options });
    
    if (response.status === 401) {
        // Handle authentication required
        try {
            const errorData = await response.json();
            if (errorData.login_url) {
                showError('Authentication required. Redirecting to login...');
                setTimeout(() => {
                    window.location.href = errorData.login_url;
                }, 2000);
                throw new Error('Authentication required');
            }
        } catch (e) {
            if (e.message !== 'Authentication required') {
                showError('Authentication required. Please log in.');
                setTimeout(() => {
                    window.location.href = '/simple-login';
                }, 2000);
            }
            throw new Error('Authentication required');
        }
    }
    
    return response;
}

// Theme tab switching
function switchThemeTab(event, tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.themes-tab-content');
    tabContents.forEach(tab => tab.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const tabBtns = document.querySelectorAll('.themes-tab-btn');
    tabBtns.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab and mark button as active
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// Load all themes from API
async function loadThemes() {
    try {
        const response = await apiCall('/api/themes');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        allThemes = data.themes;
        renderThemesGrid();
        
    } catch (error) {
        console.error('Failed to load themes:', error);
        
        if (error.message !== 'Authentication required') {
            // Check if this is a JSON parsing error (common when getting HTML instead of JSON)
            if (error.message.includes('JSON.parse') || error.message.includes('Unexpected token')) {
                showError('Failed to load themes. You may need to log in first.');
                setTimeout(() => {
                    window.location.href = '/simple-login';
                }, 2000);
            } else {
                showError('Failed to load themes: ' + error.message);
            }
        }
    }
}

// Render themes in the grid
function renderThemesGrid() {
    const grid = document.getElementById('themes-grid');
    
    if (allThemes.length === 0) {
        grid.innerHTML = '<div class="theme-loading">No themes found.</div>';
        return;
    }
    
    grid.innerHTML = allThemes.map(theme => `
        <div class="theme-card" data-theme-id="${theme.id || theme.name}">
            <div class="theme-preview">
                ${generateThemePreview(theme)}
            </div>
            <div class="theme-info">
                <h4>${theme.display_name}</h4>
                <p>${theme.description || 'No description available'}</p>
                <div class="theme-meta">
                    ${theme.is_built_in ? '<span class="theme-badge">Built-in</span>' : ''}
                    ${theme.is_public ? '<span class="theme-badge">Public</span>' : ''}
                    ${theme.creator_username ? `<span>by ${theme.creator_username}</span>` : ''}
                </div>
                <div class="theme-card-actions" style="margin-top: 10px; display: flex; gap: 5px;">
                    <button onclick="quickApplyTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-success">
                        <iconify-icon icon="tabler:check"></iconify-icon> Apply
                    </button>
                    <button onclick="exportSingleTheme('${theme.id || theme.name}'); event.stopPropagation();" class="btn btn-sm btn-secondary">
                        <iconify-icon icon="tabler:download"></iconify-icon> Export
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Generate theme preview colors
function generateThemePreview(theme) {
    if (theme.theme_data) {
        // Custom theme with data
        const colors = [
            theme.theme_data['--bg-primary'] || '#1a1a1a',
            theme.theme_data['--bg-secondary'] || '#2d2d2d',
            theme.theme_data['--text-accent'] || '#4a9eff',
            theme.theme_data['--btn-primary-bg'] || '#4a9eff',
            theme.theme_data['--success'] || '#28a745'
        ];
        return colors.map(color => `<div class="theme-color" style="background: ${color}"></div>`).join('');
    } else {
        // Built-in theme - use predefined colors
        const builtInColors = {
            'default': ['#1a1a1a', '#2d2d2d', '#4a9eff', '#28a745', '#dc3545'],
            'cyber': ['#0a0a0a', '#1a1a2e', '#00ff00', '#ff00ff', '#00ffff'],
            'vaporwave': ['#1a0d2e', '#2d1b4e', '#ff006e', '#8338ec', '#3a86ff'],
            'lcars_ds9': ['#000000', '#0066cc', '#6699ff', '#ff0066', '#00cc99'],
            'lcars_voy': ['#000000', '#666666', '#9999cc', '#cc9966', '#cc6699'],
            'lcars': ['#000000', '#3d66ab', '#daa520', '#00aaaa', '#ff9900']
        };
        
        const colors = builtInColors[theme.name] || builtInColors['default'];
        return colors.map(color => `<div class="theme-color" style="background: ${color}"></div>`).join('');
    }
}

// Quick apply theme directly from theme card
async function quickApplyTheme(themeId) {
    // Find the theme
    const theme = allThemes.find(theme => (theme.id || theme.name) === themeId);
    
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    try {
        let themeToApply = theme;
        
        // If this is a built-in theme, get its CSS variables
        if (theme.is_built_in) {
            const extractResponse = await apiCall(`/api/themes/built-in/${theme.name}/extract`, {
                method: 'POST'
            });
            if (extractResponse.ok) {
                const extractData = await extractResponse.json();
                themeToApply = {
                    ...theme,
                    theme_data: extractData.variables
                };
            }
        }
        
        // Apply theme variables to the document
        if (themeToApply.theme_data) {
            Object.entries(themeToApply.theme_data).forEach(([cssVar, value]) => {
                document.documentElement.style.setProperty(cssVar, value);
            });
        }
        
        // Save theme preference using themes API
        console.log('Attempting to save theme:', theme.id || theme.name);
        const response = await apiCall('/api/themes/apply', {
            method: 'POST',
            body: JSON.stringify({
                theme_name: theme.id || theme.name
            })
        });
        
        console.log('API response status:', response.status);
        console.log('API response ok:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Theme apply API error:', response.status, errorText);
            throw new Error(`Failed to apply theme: ${response.status} - ${errorText}`);
        }
        
        // Update the global theme variable
        window.currentTheme = theme.id || theme.name;
        document.documentElement.setAttribute('data-theme', window.currentTheme);
        
        // Update visual feedback on theme cards
        document.querySelectorAll('.theme-card').forEach(card => {
            card.classList.remove('applied');
        });
        const appliedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
        if (appliedCard) {
            appliedCard.classList.add('applied');
        }
        
        showSuccess(`Applied theme "${theme.display_name}" successfully!`);
        
    } catch (error) {
        console.error('Failed to apply theme:', error);
        showError('Failed to apply theme: ' + error.message);
    }
}

// Select a theme
function selectTheme(themeId) {
    // Remove active class from all cards
    document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Add active class to selected card
    const selectedCard = document.querySelector(`[data-theme-id="${themeId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Find the theme
    currentTheme = allThemes.find(theme => (theme.id || theme.name) === themeId);
    
    if (currentTheme) {
        loadThemeForCustomization(currentTheme);
        // Switch to customize tab
        switchThemeTab({target: document.querySelector('[onclick*="customize-tab"]')}, 'customize-tab');
    }
}

// Load theme for customization
function loadThemeForCustomization(theme) {
    document.getElementById('current-theme-title').textContent = theme.display_name;
    
    const metadata = document.getElementById('theme-metadata');
    metadata.innerHTML = `
        <p><strong>Name:</strong> ${theme.name}</p>
        <p><strong>Description:</strong> ${theme.description || 'No description'}</p>
        <p><strong>Type:</strong> ${theme.is_built_in ? 'Built-in' : 'Custom'}</p>
        ${theme.creator_username ? `<p><strong>Creator:</strong> ${theme.creator_username}</p>` : ''}
    `;
    
    // Show/hide action buttons based on theme type
    const actions = document.getElementById('theme-actions');
    const colorPanel = document.getElementById('color-panel');
    
    if (theme.is_built_in) {
        // Show apply and duplicate buttons for built-in themes
        actions.innerHTML = `
            <button onclick="applyCurrentTheme()" class="btn btn-success">
                <iconify-icon icon="tabler:check"></iconify-icon> Apply Theme
            </button>
            <button onclick="duplicateCurrentTheme()" class="btn btn-secondary">
                <iconify-icon icon="tabler:copy"></iconify-icon> Duplicate
            </button>
        `;
        actions.style.display = 'block';
        colorPanel.style.display = 'none';
        metadata.innerHTML += '<p><em>Built-in themes cannot be edited directly. Use "Duplicate" to create a customizable copy.</em></p>';
    } else {
        // Show all buttons for custom themes
        actions.innerHTML = `
            <button onclick="applyCurrentTheme()" class="btn btn-success">
                <iconify-icon icon="tabler:check"></iconify-icon> Apply Theme
            </button>
            <button onclick="saveCurrentTheme()" class="btn btn-primary">
                <iconify-icon icon="tabler:device-floppy"></iconify-icon> Save Theme
            </button>
            <button onclick="duplicateCurrentTheme()" class="btn btn-secondary">
                <iconify-icon icon="tabler:copy"></iconify-icon> Duplicate
            </button>
            <button onclick="deleteCurrentTheme()" class="btn btn-danger">
                <iconify-icon icon="tabler:trash"></iconify-icon> Delete
            </button>
        `;
        actions.style.display = 'block';
        colorPanel.style.display = 'block';
        
        if (theme.theme_data) {
            loadThemeVariables(theme.theme_data);
        }
    }
}

// Load theme variables into color controls
function loadThemeVariables(themeData) {
    Object.entries(themeData).forEach(([cssVar, value]) => {
        const control = document.querySelector(`[data-css-var="${cssVar}"]`);
        if (control) {
            control.value = value;
            // Update corresponding hex input
            const hexInput = document.querySelector(`.color-hex[data-for="${control.id}"]`);
            if (hexInput) {
                hexInput.value = value;
            }
        }
    });
}

// Update theme variable and apply to preview
function updateThemeVariable(input) {
    const cssVar = input.dataset.cssVar;
    const value = input.value;
    
    // Update hex input
    const hexInput = document.querySelector(`.color-hex[data-for="${input.id}"]`);
    if (hexInput) {
        hexInput.value = value;
    }
    
    // Apply to current theme data
    if (currentTheme && currentTheme.theme_data) {
        currentTheme.theme_data[cssVar] = value;
    }
    
    // Apply to preview
    document.documentElement.style.setProperty(cssVar, value);
}

// Setup color input synchronization
function setupColorInputSynchronization() {
    // Sync hex inputs with color inputs
    document.querySelectorAll('.color-hex').forEach(hexInput => {
        hexInput.addEventListener('input', function() {
            const colorInput = document.getElementById(this.dataset.for);
            if (colorInput && /^#[0-9A-F]{6}$/i.test(this.value)) {
                colorInput.value = this.value;
                updateThemeVariable(colorInput);
            }
        });
    });
}

// Create new theme
function createNewTheme() {
    document.getElementById('modal-title').textContent = 'Create New Theme';
    document.getElementById('theme-form').reset();
    document.getElementById('theme-modal').style.display = 'flex';
}

// Close theme modal
function closeThemeModal() {
    document.getElementById('theme-modal').style.display = 'none';
}

// Save theme from modal
async function saveThemeModal() {
    const name = document.getElementById('theme-name').value;
    const displayName = document.getElementById('theme-display-name').value;
    const description = document.getElementById('theme-description').value;
    const baseTheme = document.getElementById('base-theme').value;
    const isPublic = document.getElementById('theme-public').checked;
    
    if (!name || !displayName) {
        showError('Name and display name are required');
        return;
    }
    
    try {
        // Get base theme data
        let themeData = {};
        if (baseTheme !== 'default') {
            const extractResponse = await apiCall(`/api/themes/built-in/${baseTheme}/extract`, {
                method: 'POST'
            });
            if (extractResponse.ok) {
                const extractData = await extractResponse.json();
                themeData = extractData.variables;
            }
        } else {
            // Default theme variables
            themeData = {
                '--bg-primary': '#1a1a1a',
                '--bg-secondary': '#2d2d2d',
                '--bg-tertiary': '#3a3a3a',
                '--text-primary': '#ffffff',
                '--text-secondary': '#cccccc',
                '--text-accent': '#4a9eff',
                '--btn-primary-bg': '#4a9eff',
                '--btn-primary-text': '#ffffff',
                '--btn-secondary-bg': '#666666',
                '--btn-danger-bg': '#dc3545',
                '--success': '#28a745',
                '--warning': '#ffc107',
                '--error': '#dc3545',
                '--info': '#17a2b8'
            };
        }
        
        const response = await apiCall('/api/themes', {
            method: 'POST',
            body: JSON.stringify({
                name: name,
                display_name: displayName,
                description: description,
                is_public: isPublic,
                theme_data: themeData
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to create theme');
        }
        
        const newTheme = await response.json();
        showSuccess('Theme created successfully');
        closeThemeModal();
        loadThemes();
        
        // Select the new theme
        setTimeout(() => selectTheme(newTheme.id), 500);
        
    } catch (error) {
        console.error('Failed to create theme:', error);
        showError('Failed to create theme: ' + error.message);
    }
}

// Apply current theme to the application
async function applyCurrentTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    try {
        let themeToApply = currentTheme;
        
        // If this is a built-in theme, get its CSS variables
        if (currentTheme.is_built_in) {
            const extractResponse = await apiCall(`/api/themes/built-in/${currentTheme.name}/extract`, {
                method: 'POST'
            });
            if (extractResponse.ok) {
                const extractData = await extractResponse.json();
                themeToApply = {
                    ...currentTheme,
                    theme_data: extractData.variables
                };
            }
        }
        
        // Apply theme variables to the document
        if (themeToApply.theme_data) {
            Object.entries(themeToApply.theme_data).forEach(([cssVar, value]) => {
                document.documentElement.style.setProperty(cssVar, value);
            });
        }
        
        // Save theme preference using themes API
        console.log('Attempting to save current theme:', currentTheme.id || currentTheme.name);
        const response = await apiCall('/api/themes/apply', {
            method: 'POST',
            body: JSON.stringify({
                theme_name: currentTheme.id || currentTheme.name
            })
        });
        
        console.log('API response status:', response.status);
        console.log('API response ok:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Theme apply API error:', response.status, errorText);
            throw new Error(`Failed to apply theme: ${response.status} - ${errorText}`);
        }
        
        // Update the global theme variable
        window.currentTheme = currentTheme.id || currentTheme.name;
        document.documentElement.setAttribute('data-theme', window.currentTheme);
        
        showSuccess(`Applied theme "${currentTheme.display_name}" successfully!`);
        
    } catch (error) {
        console.error('Failed to apply theme:', error);
        showError('Failed to apply theme: ' + error.message);
    }
}

// Save current theme
async function saveCurrentTheme() {
    if (!currentTheme || currentTheme.is_built_in) {
        showError('Cannot save built-in themes');
        return;
    }
    
    try {
        const response = await apiCall(`/api/themes/${currentTheme.id}`, {
            method: 'PUT',
            body: JSON.stringify({
                theme_data: currentTheme.theme_data
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save theme');
        }
        
        showSuccess('Theme saved successfully');
        loadThemes();
        
    } catch (error) {
        console.error('Failed to save theme:', error);
        showError('Failed to save theme: ' + error.message);
    }
}

// Duplicate current theme
async function duplicateCurrentTheme() {
    if (!currentTheme) {
        showError('No theme selected');
        return;
    }
    
    try {
        const endpoint = currentTheme.is_built_in 
            ? `/api/themes/built-in/${currentTheme.name}/extract`
            : `/api/themes/${currentTheme.id}/duplicate`;
            
        const response = await apiCall(endpoint, {
            method: 'POST'
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to duplicate theme');
        }
        
        showSuccess('Theme duplicated successfully');
        loadThemes();
        
    } catch (error) {
        console.error('Failed to duplicate theme:', error);
        showError('Failed to duplicate theme: ' + error.message);
    }
}

// Delete current theme
async function deleteCurrentTheme() {
    if (!currentTheme || currentTheme.is_built_in) {
        showError('Cannot delete built-in themes');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete the theme "${currentTheme.display_name}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await apiCall(`/api/themes/${currentTheme.id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to delete theme');
        }
        
        showSuccess('Theme deleted successfully');
        currentTheme = null;
        document.getElementById('current-theme-title').textContent = 'Select a theme to customize';
        document.getElementById('theme-metadata').innerHTML = 'Choose a theme from the Browse tab or create a new one to start customizing.';
        document.getElementById('theme-actions').style.display = 'none';
        document.getElementById('color-panel').style.display = 'none';
        
        loadThemes();
        
    } catch (error) {
        console.error('Failed to delete theme:', error);
        showError('Failed to delete theme: ' + error.message);
    }
}

// Toggle preview mode (light/dark)
function togglePreviewMode() {
    previewMode = previewMode === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-mode', previewMode);
    
    const btn = document.getElementById('preview-mode-btn');
    if (previewMode === 'light') {
        btn.innerHTML = '<iconify-icon icon="tabler:moon"></iconify-icon> Switch to Dark Mode';
    } else {
        btn.innerHTML = '<iconify-icon icon="tabler:sun"></iconify-icon> Switch to Light Mode';
    }
}

// Reset preview
function resetPreview() {
    document.documentElement.removeAttribute('style');
    previewMode = 'dark';
    document.documentElement.setAttribute('data-mode', 'dark');
    document.getElementById('preview-mode-btn').innerHTML = '<iconify-icon icon="tabler:sun"></iconify-icon> Switch to Light Mode';
}

// Refresh themes
function refreshThemes() {
    loadThemes();
}

// Utility functions
function showSuccess(message) {
    // You could implement a toast notification system here
    alert('Success: ' + message);
}

function showError(message) {
    // You could implement a toast notification system here
    alert('Error: ' + message);
}

// Export/Import Functions
let selectedFile = null;

// Export all themes
function exportAllThemes() {
    fetch('/api/themes/export/all')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Get filename from Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'mvidarr_themes_export.json';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess('All themes exported successfully!');
        })
        .catch(error => {
            console.error('Export error:', error);
            showError('Failed to export themes: ' + error.message);
        });
}

// Export current theme
function exportCurrentTheme() {
    if (!currentTheme || !currentTheme.id) {
        showError('Please select a theme to export');
        return;
    }
    
    fetch(`/api/themes/${currentTheme.id}/export`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Get filename from Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `${currentTheme.name}_theme.json`;
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess(`Theme "${currentTheme.display_name}" exported successfully!`);
        })
        .catch(error => {
            console.error('Export error:', error);
            showError('Failed to export theme: ' + error.message);
        });
}

// Export single theme from theme card
function exportSingleTheme(themeId) {
    // Find theme in the loaded themes
    const theme = loadedThemes.find(t => (t.id || t.name) === themeId);
    if (!theme) {
        showError('Theme not found');
        return;
    }
    
    fetch(`/api/themes/${themeId}/export`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Get filename from Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `${theme.name}_theme.json`;
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess(`Theme "${theme.display_name}" exported successfully!`);
        })
        .catch(error => {
            console.error('Export error:', error);
            showError('Failed to export theme: ' + error.message);
        });
}

// Show import dialog
function showImportDialog() {
    // Reset import state
    selectedFile = null;
    document.getElementById('import-step-1').style.display = 'block';
    document.getElementById('import-step-2').style.display = 'none';
    document.getElementById('import-step-3').style.display = 'none';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('validate-btn').style.display = 'none';
    document.getElementById('import-btn').style.display = 'none';
    document.getElementById('finish-btn').style.display = 'none';
    document.getElementById('theme-file-input').value = '';
    
    // Show modal
    document.getElementById('import-modal').style.display = 'flex';
}

// Close import modal
function closeImportModal() {
    document.getElementById('import-modal').style.display = 'none';
    selectedFile = null;
}

// Handle file selection
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
        showError('Please select a JSON file');
        return;
    }
    
    selectedFile = file;
    
    // Show file info
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = `Size: ${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('validate-btn').style.display = 'inline-block';
}

// Validate import file
function validateImportFile() {
    if (!selectedFile) {
        showError('Please select a file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    fetch('/api/themes/import/validate', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Show validation results
        displayValidationResults(data);
        
        // Show step 2 and hide step 1
        document.getElementById('import-step-1').style.display = 'none';
        document.getElementById('import-step-2').style.display = 'block';
        document.getElementById('validate-btn').style.display = 'none';
        
        if (data.valid && data.valid_themes_count > 0) {
            document.getElementById('import-btn').style.display = 'inline-block';
        }
    })
    .catch(error => {
        console.error('Validation error:', error);
        showError('Validation failed: ' + error.message);
    });
}

// Display validation results
function displayValidationResults(data) {
    const resultsDiv = document.getElementById('validation-results');
    let html = '';
    
    // Summary
    html += `<div class="validation-summary">
        <h5>Validation Summary</h5>
        <p><strong>Total themes:</strong> ${data.total_themes || 0}</p>
        <p><strong>Valid themes:</strong> ${data.valid_themes_count || 0}</p>
        <p><strong>Invalid themes:</strong> ${data.invalid_themes_count || 0}</p>
        <p><strong>Existing themes (will be skipped):</strong> ${data.existing_themes_count || 0}</p>
        <p><strong>Status:</strong> ${data.message || 'Unknown'}</p>
    </div>`;
    
    // Valid themes
    if (data.valid_themes && data.valid_themes.length > 0) {
        html += '<div class="validation-item success">';
        html += '<h6><iconify-icon icon="tabler:check"></iconify-icon> Valid Themes</h6>';
        data.valid_themes.forEach(theme => {
            html += `<p>â€¢ ${theme.display_name} (${theme.name})</p>`;
        });
        html += '</div>';
    }
    
    // Existing themes
    if (data.existing_themes && data.existing_themes.length > 0) {
        html += '<div class="validation-item warning">';
        html += '<h6><iconify-icon icon="tabler:alert-triangle"></iconify-icon> Existing Themes (Will be Skipped)</h6>';
        data.existing_themes.forEach(themeName => {
            html += `<p>â€¢ ${themeName}</p>`;
        });
        html += '</div>';
    }
    
    // Invalid themes
    if (data.invalid_themes && data.invalid_themes.length > 0) {
        html += '<div class="validation-item error">';
        html += '<h6><iconify-icon icon="tabler:x"></iconify-icon> Invalid Themes</h6>';
        data.invalid_themes.forEach(themeName => {
            html += `<p>â€¢ ${themeName}</p>`;
        });
        html += '</div>';
    }
    
    // Validation errors
    if (data.validation_errors && data.validation_errors.length > 0) {
        html += '<div class="validation-item error">';
        html += '<h6><iconify-icon icon="tabler:alert-circle"></iconify-icon> Validation Errors</h6>';
        data.validation_errors.forEach(error => {
            html += `<p>â€¢ ${error}</p>`;
        });
        html += '</div>';
    }
    
    resultsDiv.innerHTML = html;
}

// Import themes
function importThemes() {
    if (!selectedFile) {
        showError('Please select a file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    fetch('/api/themes/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Show import results
        displayImportResults(data);
        
        // Show step 3 and hide step 2
        document.getElementById('import-step-2').style.display = 'none';
        document.getElementById('import-step-3').style.display = 'block';
        document.getElementById('import-btn').style.display = 'none';
        document.getElementById('finish-btn').style.display = 'inline-block';
        
        // Refresh themes list
        loadThemes();
    })
    .catch(error => {
        console.error('Import error:', error);
        showError('Import failed: ' + error.message);
    });
}

// Display import results
function displayImportResults(data) {
    const resultsDiv = document.getElementById('import-results');
    let html = '';
    
    if (data.success) {
        html += `<div class="import-results">
            <h5 class="success"><iconify-icon icon="tabler:check-circle"></iconify-icon> Import Successful!</h5>
            <p><strong>Imported:</strong> ${data.imported_count || 0} themes</p>
            <p><strong>Skipped:</strong> ${data.skipped_count || 0} themes</p>
            <p><strong>Errors:</strong> ${data.error_count || 0}</p>
            <p><strong>Message:</strong> ${data.message || ''}</p>
        `;
        
        if (data.imported_themes && data.imported_themes.length > 0) {
            html += '<h6>Imported Themes:</h6><ul>';
            data.imported_themes.forEach(themeName => {
                html += `<li>${themeName}</li>`;
            });
            html += '</ul>';
        }
        
        if (data.skipped_themes && data.skipped_themes.length > 0) {
            html += '<h6>Skipped Themes:</h6><ul>';
            data.skipped_themes.forEach(themeName => {
                html += `<li>${themeName}</li>`;
            });
            html += '</ul>';
        }
        
        if (data.errors && data.errors.length > 0) {
            html += '<h6 class="error">Errors:</h6><ul>';
            data.errors.forEach(error => {
                html += `<li class="error">${error}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
    } else {
        html += `<div class="import-results">
            <h5 class="error"><iconify-icon icon="tabler:x-circle"></iconify-icon> Import Failed</h5>
            <p class="error">${data.error || 'Unknown error occurred'}</p>
        </div>`;
    }
    
    resultsDiv.innerHTML = html;
}

// Finish import and close modal
function finishImport() {
    closeImportModal();
    showSuccess('Theme import completed successfully!');
}

// Add drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('file-upload-area');
    const fileInput = document.getElementById('theme-file-input');
    
    if (uploadArea && fileInput) {
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        uploadArea.addEventListener('drop', handleDrop, false);
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        uploadArea.classList.add('dragover');
    }
    
    function unhighlight(e) {
        uploadArea.classList.remove('dragover');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect({ target: fileInput });
        }
    }
});
</script>

{% endblock %}